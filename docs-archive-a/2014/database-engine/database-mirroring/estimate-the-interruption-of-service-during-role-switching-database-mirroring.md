---
title: Calcular la interrupción del servicio durante la conmutación de roles (creación de reflejo de la base de datos) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/04/2020
ms.locfileid: "87663669"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="f2c33-102">Calcular la interrupción del servicio durante la conmutación de roles (creación de reflejo de la base de datos)</span><span class="sxs-lookup"><span data-stu-id="f2c33-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="f2c33-103">Durante una conmutación de roles, la cantidad de tiempo que la creación de reflejo de la base de datos estará fuera de servicio depende del tipo y la causa de la conmutación de roles.</span><span class="sxs-lookup"><span data-stu-id="f2c33-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="f2c33-104">En el caso de la conmutación automática por error, existen dos factores que influyen en el tiempo durante el cual estará interrumpido el servicio: el tiempo necesario para que el servidor reflejado reconozca que ha fallado la instancia del servidor principal (es decir, detección del error) y el tiempo necesario para realizar una conmutación por error de la base de datos (es decir, tiempo de conmutación por error).</span><span class="sxs-lookup"><span data-stu-id="f2c33-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="f2c33-105">En una operación de servicio forzado, aunque se produzca un error, la detección y respuesta ante el error depende de la capacidad de respuesta humana.</span><span class="sxs-lookup"><span data-stu-id="f2c33-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="f2c33-106">Sin embargo, la estimación de la interrupción potencial del servicio se limita a la estimación del tiempo que tarda el servidor reflejado en conmutar los roles una vez que se emite el comando de servicio forzado.</span><span class="sxs-lookup"><span data-stu-id="f2c33-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="f2c33-107">Para reducir el tiempo necesario para detectar condiciones específicas, como algunos tipos de error, puede definir las alertas para estas condiciones.</span><span class="sxs-lookup"><span data-stu-id="f2c33-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="f2c33-108">En el caso de la conmutación por error manual, el único factor es el tiempo necesario para realizar la conmutación por error de la base de datos una vez que se emite el comando de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="f2c33-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="f2c33-109">Detección de errores</span><span class="sxs-lookup"><span data-stu-id="f2c33-109">Error detection</span></span>
 <span data-ttu-id="f2c33-110">El tiempo que necesita el sistema para detectar un error depende del tipo de error; por ejemplo, un error de red se detecta casi al instante, mientras que la detección de un servidor que no responde tarda 10 segundos (con el tiempo de espera predeterminado).</span><span class="sxs-lookup"><span data-stu-id="f2c33-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="f2c33-111">Para obtener información sobre los errores que pueden causar un error durante una sesión de creación de reflejo de la base de datos y detección del tiempo de espera en modo de seguridad alta con conmutación automática por error, vea [Posibles errores durante la creación de reflejo de la base de datos](possible-failures-during-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="f2c33-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="f2c33-112">Tiempo de la conmutación por error</span><span class="sxs-lookup"><span data-stu-id="f2c33-112">Failover time</span></span>
 <span data-ttu-id="f2c33-113">El tiempo de la conmutación por error consiste principalmente en el tiempo que el servidor reflejado anterior necesita para poner al día los registros pendientes en su cola rehecha más un breve tiempo adicional (para obtener más información sobre cómo procesa las entradas de registro el servidor reflejado, vea [Creación de reflejo de la base de datos &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span><span class="sxs-lookup"><span data-stu-id="f2c33-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="f2c33-114">Para obtener información acerca de cómo calcular el tiempo de la conmutación por error, vea Calcular la tasa de puesta al día de la conmutación por error, más adelante en este tema.</span><span class="sxs-lookup"><span data-stu-id="f2c33-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="f2c33-115">Si la conmutación por error se produce durante una transacción en la que se crea un índice o tabla y después se cambia, es posible que tarde más de lo habitual.</span><span class="sxs-lookup"><span data-stu-id="f2c33-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="f2c33-116">Por ejemplo, si se realiza una conmutación por error durante la siguiente secuencia de operaciones, es posible que el tiempo de conmutación por error sea mayor: BEGIN TRANSACTION, CREATE INDEX en una tabla y SELECT INTO en la tabla.</span><span class="sxs-lookup"><span data-stu-id="f2c33-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="f2c33-117">Existe la posibilidad de un mayor tiempo de conmutación por error durante una transacción de este tipo hasta su finalización con una instrucción COMMIT TRANSACTION o ROLLBACK TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="f2c33-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="f2c33-118">Cola rehecha</span><span class="sxs-lookup"><span data-stu-id="f2c33-118">The Redo Queue</span></span>
 <span data-ttu-id="f2c33-119">La confirmación de la base de datos conlleva aplicar las entradas de registro que se encuentren en la cola rehecha del servidor reflejado.</span><span class="sxs-lookup"><span data-stu-id="f2c33-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="f2c33-120">La *cola rehecha* está formada por las entradas de registro que se han escrito en el disco del servidor reflejado, pero todavía no se han puesto al día en la base de datos reflejada.</span><span class="sxs-lookup"><span data-stu-id="f2c33-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="f2c33-121">El tiempo de la conmutación por error para la base de datos depende de la rapidez con la que el servidor reflejado pueda poner al día el registro en la cola rehecha, que, a su vez, se determina principalmente por el hardware del sistema y la carga de trabajo actual.</span><span class="sxs-lookup"><span data-stu-id="f2c33-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="f2c33-122">Potencialmente, una base de datos principal puede estar tan ocupada que el servidor principal envía los registros al servidor reflejado mucho más rápidamente de lo que puede confirmarlos.</span><span class="sxs-lookup"><span data-stu-id="f2c33-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="f2c33-123">En esta situación, la conmutación por error puede tardar mucho tiempo mientras el servidor reflejado pone al día el registro en la cola rehecha.</span><span class="sxs-lookup"><span data-stu-id="f2c33-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="f2c33-124">Para conocer el tamaño actual de la cola rehecha, utilice el contador **Cola rehecha** en el objeto de rendimiento de creación de reflejo de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f2c33-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="f2c33-125">Para más información, consulte [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="f2c33-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="f2c33-126">Calcular la tasa de puesta al día de la conmutación por error</span><span class="sxs-lookup"><span data-stu-id="f2c33-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="f2c33-127">Puede medir la cantidad de tiempo que se necesita para poner al día las entradas de registro (*tasa de puesta al día*) mediante una copia de prueba de la base de datos de producción.</span><span class="sxs-lookup"><span data-stu-id="f2c33-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="f2c33-128">El método para calcular el tiempo de confirmación durante la conmutación por error depende del número de subprocesos que el servidor reflejado utiliza durante la fase de puesta al día.</span><span class="sxs-lookup"><span data-stu-id="f2c33-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="f2c33-129">El número de subprocesos depende de lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="f2c33-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="f2c33-130">En [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], el servidor reflejado siempre usa un único subproceso para la puesta al día de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="f2c33-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="f2c33-131">En [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], los servidores reflejados en equipos con menos de cinco CPUs también utilizan un único subproceso.</span><span class="sxs-lookup"><span data-stu-id="f2c33-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="f2c33-132">Con cinco CPU o más, un servidor reflejado distribuye las operaciones de puesta al día entre varios subprocesos durante una conmutación por error (esto se conoce como *puesta al día en paralelo*).</span><span class="sxs-lookup"><span data-stu-id="f2c33-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="f2c33-133">La puesta al día en paralelo está optimizada para utilizar un subproceso por cada cuatro CPU.</span><span class="sxs-lookup"><span data-stu-id="f2c33-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="f2c33-134">Calcular la tasa de puesta al día con un único subproceso</span><span class="sxs-lookup"><span data-stu-id="f2c33-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="f2c33-135">En la puesta al día con un único subproceso, la puesta al día de la base de datos reflejada durante la conmutación por error tarda aproximadamente lo mismo que la puesta al día de igual cantidad de registro por parte de la restauración de una copia de seguridad de registros.</span><span class="sxs-lookup"><span data-stu-id="f2c33-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="f2c33-136">Para calcular el tiempo de la conmutación por error, cree una base de datos de prueba en el entorno en el que pretende ejecutar la creación de reflejo.</span><span class="sxs-lookup"><span data-stu-id="f2c33-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="f2c33-137">Después, realice una copia de seguridad de registros de la base de datos de producción.</span><span class="sxs-lookup"><span data-stu-id="f2c33-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="f2c33-138">Para medir la tasa de puesta al día para esa copia de seguridad de registros, controle cuánto tiempo tarda en restaurar la copia de seguridad de registros con WITH NORECOVERY en la base de datos de prueba.</span><span class="sxs-lookup"><span data-stu-id="f2c33-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="f2c33-139">Cuando conozca la tasa de puesta al día del servidor reflejado, podrá calcular el tiempo necesario para realizar la conmutación por error de la base de datos en un momento dado, dividiendo la cantidad de registro actual que se debe poner al día en el servidor reflejado (según la medición efectuada por el contador de rendimiento **Cola rehecha** ) entre la tasa de puesta al día.</span><span class="sxs-lookup"><span data-stu-id="f2c33-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="f2c33-140">En condiciones normales, si el servidor reflejado puede hacer frente a la carga del servidor principal, el valor de **Cola rehecha** es pequeño o cercano a cero, y la conmutación por error solo tarda unos segundos.</span><span class="sxs-lookup"><span data-stu-id="f2c33-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="f2c33-141">Calcular la tasa de puesta al día en paralelo</span><span class="sxs-lookup"><span data-stu-id="f2c33-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="f2c33-142">En [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], la puesta al día en paralelo está optimizada para usar un subproceso por cada cuatro CPU.</span><span class="sxs-lookup"><span data-stu-id="f2c33-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="f2c33-143">Para calcular el tiempo de la puesta al día en paralelo, es más preciso obtener acceso a un sistema de prueba en ejecución que a una base de datos de prueba.</span><span class="sxs-lookup"><span data-stu-id="f2c33-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="f2c33-144">Durante la supervisión de la cola rehecha en el servidor reflejado, aumente la carga en el servidor principal.</span><span class="sxs-lookup"><span data-stu-id="f2c33-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="f2c33-145">Durante el funcionamiento normal, el valor de la cola rehecha es casi cero.</span><span class="sxs-lookup"><span data-stu-id="f2c33-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="f2c33-146">Aumente la carga en el servidor principal hasta que el valor de la Cola rehecha comience a aumentar de forma continua; el sistema estará en su valor máximo de tasa de puesta al día y el contador de rendimiento **Bytes rehechos/s** en ese momento representa la tasa máxima de puesta al día.</span><span class="sxs-lookup"><span data-stu-id="f2c33-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="f2c33-147">Para más información, consulte [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="f2c33-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="f2c33-148">Calcular la interrupción del servicio durante una conmutación automática por error</span><span class="sxs-lookup"><span data-stu-id="f2c33-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="f2c33-149">En la siguiente ilustración se muestra cómo la detección de errores y el tiempo de la conmutación por error influyen en el tiempo completo necesario para que una conmutación automática por error finalice en **Partner_B**.</span><span class="sxs-lookup"><span data-stu-id="f2c33-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="f2c33-150">La conmutación por error necesita tiempo para confirmar la base de datos (fase de puesta al día) más una pequeña cantidad de tiempo para poner la base de datos en línea.</span><span class="sxs-lookup"><span data-stu-id="f2c33-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="f2c33-151">La fase de deshacer, que consiste en revertir las transacciones no confirmadas, tiene lugar después de poner en línea la nueva base de datos principal y continúa después de la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="f2c33-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="f2c33-152">Durante esta fase, la base de datos está disponible.</span><span class="sxs-lookup"><span data-stu-id="f2c33-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="f2c33-153">![Detección de errores y tiempo de la conmutación por error](../media/dbm-failovauto-time.gif "Detección de errores y tiempo de la conmutación por error")</span><span class="sxs-lookup"><span data-stu-id="f2c33-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="f2c33-154">Consulte también</span><span class="sxs-lookup"><span data-stu-id="f2c33-154">See Also</span></span>
 <span data-ttu-id="f2c33-155">[Modos de funcionamiento](database-mirroring-operating-modes.md) [de la creación de reflejo de la base de datos conmutación de roles durante una sesión de creación de reflejo de la base de datos &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [supervisión de creación de SQL Server &#40;reflejo de base](monitoring-database-mirroring-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="f2c33-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>


