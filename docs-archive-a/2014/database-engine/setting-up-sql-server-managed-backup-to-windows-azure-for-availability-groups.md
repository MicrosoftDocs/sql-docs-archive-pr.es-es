---
title: Configuración de SQL Server copia de seguridad administrada en Azure para grupos de disponibilidad | Microsoft Docs
description: En este tutorial se muestra cómo configurar SQL Server copia de seguridad administrada en Microsoft Azure para las bases de datos que participan en Always On grupos de disponibilidad.
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 0c4553cd-d8e4-4691-963a-4e414cc0f1ba
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: ebae9f75ac25698582b7f3e4c78c2fb773bd803e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/04/2020
ms.locfileid: "87662232"
---
# <a name="setting-up-sql-server-managed-backup-to-azure-for-availability-groups"></a><span data-ttu-id="3412d-103">Configuración de copia de seguridad administrada de SQL Server para Azure para grupos de disponibilidad</span><span class="sxs-lookup"><span data-stu-id="3412d-103">Setting up SQL Server Managed Backup to Azure for Availability Groups</span></span>
  <span data-ttu-id="3412d-104">Este tema es un tutorial sobre la configuración de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para las bases de datos participantes en Grupos de disponibilidad AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="3412d-104">This topic is a tutorial on configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Groups.</span></span>  
  
## <a name="availability-group-configurations"></a><span data-ttu-id="3412d-105">Configuraciones de grupo de disponibilidad</span><span class="sxs-lookup"><span data-stu-id="3412d-105">Availability Group Configurations</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="3412d-106">se admite para las bases de datos del grupo de disponibilidad, tanto si todas las réplicas están configuradas de forma local o completamente en Azure, como si se trata de una implementación híbrida entre el entorno local y una o varias máquinas virtuales de Azure.</span><span class="sxs-lookup"><span data-stu-id="3412d-106">is supported for Availability Group databases, whether the replicas are all configured on-premises, or entirely on Azure, or a Hybrid implementation between on-premises and on one or more Azure virtual machines.</span></span> <span data-ttu-id="3412d-107">No obstante, puede ser necesario tener en cuenta lo siguiente para una o varias implementaciones:</span><span class="sxs-lookup"><span data-stu-id="3412d-107">However you might need to consider the following for one or more implementations:</span></span>  
  
-   <span data-ttu-id="3412d-108">Frecuencia de copia de seguridad de registros: la frecuencia de la copia de seguridad de registros es tanto el tiempo como el crecimiento de los registros.</span><span class="sxs-lookup"><span data-stu-id="3412d-108">Log Backup Frequency: The frequency of log backup is both time and log growth.</span></span> <span data-ttu-id="3412d-109">Por ejemplo, la copia de seguridad de registros se realiza una vez cada 2 horas a menos que el espacio de registro usado en ese período de dos horas sea 5 MB o más.</span><span class="sxs-lookup"><span data-stu-id="3412d-109">For example, the log backup is taken once every 2 hours unless the log space used within the two hour period is 5 MB or more.</span></span> <span data-ttu-id="3412d-110">Esto se aplica a todas las implementaciones, ya sean locales, en la nube o híbridas.</span><span class="sxs-lookup"><span data-stu-id="3412d-110">This applies to all implementations, on-premises, cloud, or a Hybrid.</span></span>  
  
-   <span data-ttu-id="3412d-111">Ancho de banda de red: se aplica a las implementaciones en las que las réplicas se encuentran en diferentes ubicaciones físicas, como en una nube híbrida, o en distintas regiones de Azure en una configuración solo en la nube.</span><span class="sxs-lookup"><span data-stu-id="3412d-111">Network Bandwidth: This applies to implementations where the replicas are located in different physical locations, like in a hybrid cloud, or across different Azure regions in a cloud only configuration.</span></span> <span data-ttu-id="3412d-112">El ancho de banda de red puede afectar a la latencia de las secundarias y, si las secundarias están establecidas en replicación sincrónica, esto puede provocar el crecimiento de los registros en la principal.</span><span class="sxs-lookup"><span data-stu-id="3412d-112">The network bandwidth can affect the latency of the secondaries and if the secondaries are set to synchronous replication, then this can cause log growth on the primary.</span></span> <span data-ttu-id="3412d-113">Si las secundarias están establecidas en replicación sincrónica, las secundarias quizás no puedan seguir el ritmo debido a la latencia de red, que puede provocar la pérdida de datos en caso de conmutación por error a la réplica secundaria.</span><span class="sxs-lookup"><span data-stu-id="3412d-113">If the secondaries are set to synchronous replication, the secondaries may not be able to keep up due to network latency, which can result in data loss in the event of a failover to the secondary replica.</span></span>  
  
### <a name="configuring-ss_smartbackup-for-availability-databases"></a><span data-ttu-id="3412d-114">Configurar [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para las bases de datos de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-114">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for Availability Databases.</span></span>  
 <span data-ttu-id="3412d-115">**Permisos:**</span><span class="sxs-lookup"><span data-stu-id="3412d-115">**Permissions:**</span></span>  
  
-   <span data-ttu-id="3412d-116">Requiere la pertenencia al rol de base de datos **db_backupoperator** , con permisos **ALTER any Credential** y `EXECUTE` permisos en **sp_delete_backuphistory**procedimiento almacenado.</span><span class="sxs-lookup"><span data-stu-id="3412d-116">Requires membership in **db_backupoperator** database role, with **ALTER ANY CREDENTIAL** permissions, and `EXECUTE` permissions on **sp_delete_backuphistory**stored procedure.</span></span>  
  
-   <span data-ttu-id="3412d-117">Requiere permisos **Select** en la función **smart_admin. fn_get_current_xevent_settings**.</span><span class="sxs-lookup"><span data-stu-id="3412d-117">Requires **SELECT** permissions on the **smart_admin.fn_get_current_xevent_settings**function.</span></span>  
  
-   <span data-ttu-id="3412d-118">Requiere `EXECUTE` permisos en el procedimiento almacenado **smart_admin. sp_get_backup_diagnostics** .</span><span class="sxs-lookup"><span data-stu-id="3412d-118">Requires `EXECUTE` permissions on the **smart_admin.sp_get_backup_diagnostics** stored procedure.</span></span> <span data-ttu-id="3412d-119">Además, requiere permisos `VIEW SERVER STATE` ya que internamente llama a otros objetos del sistema que requieren este permiso.</span><span class="sxs-lookup"><span data-stu-id="3412d-119">In addition, it requires `VIEW SERVER STATE` permissions as it internally calls other system objects that require this permission.</span></span>  
  
-   <span data-ttu-id="3412d-120">Requiere `EXECUTE` permisos en los `smart_admin.sp_set_instance_backup` `smart_admin.sp_backup_master_switch` procedimientos almacenados y.</span><span class="sxs-lookup"><span data-stu-id="3412d-120">Requires `EXECUTE` permissions on the `smart_admin.sp_set_instance_backup` and `smart_admin.sp_backup_master_switch` stored procedures.</span></span>  
  
 <span data-ttu-id="3412d-121">Los siguientes son los pasos básicos para configurar un Grupo de disponibilidad AlwaysOn con [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="3412d-121">The following are the basic steps to setting up an AlwaysOn Availability Group with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="3412d-122">Más adelante en este tema se describe un tutorial detallado paso a paso.</span><span class="sxs-lookup"><span data-stu-id="3412d-122">A detailed step-by step tutorial is described later in this topic.</span></span>  
  
1.  <span data-ttu-id="3412d-123">Una vez que haya creado el Grupo de disponibilidad, configure la réplica de copia de seguridad que prefiera.</span><span class="sxs-lookup"><span data-stu-id="3412d-123">Once you have created Availability Group, configure the preferred backup replica.</span></span> <span data-ttu-id="3412d-124">Este valor para el Grupo de disponibilidad también es usado por [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para determinar qué réplica usar para la copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-124">This setting for the Availability Group is also used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which replica to use for backup.</span></span> <span data-ttu-id="3412d-125">Para obtener instrucciones paso a paso sobre cómo configurar las preferencias de copia de seguridad, vea [configurar la copia de seguridad en réplicas de disponibilidad &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-125">For step by step instructions about how to set up the backup preference, see [Configure Backup on Availability Replicas &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span></span>  <span data-ttu-id="3412d-126">Si va a crear un nuevo grupo de disponibilidad AlwaysOn, consulte [Introducción con Grupos de disponibilidad AlwaysOn &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-126">If you are creating a new AlwaysOn Availability Group, see [Getting Started with AlwaysOn Availability Groups &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="3412d-127">Configure el acceso de conexión de solo lectura en las réplicas secundarias.</span><span class="sxs-lookup"><span data-stu-id="3412d-127">Configure read only connection access to the secondary replicas.</span></span> <span data-ttu-id="3412d-128">Para obtener instrucciones paso a paso sobre cómo configurar el acceso de solo lectura, vea [configurar el acceso de solo lectura en una réplica de disponibilidad &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="3412d-128">For step by step instructions about how to configure read only access, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span></span>  
  
3.  <span data-ttu-id="3412d-129">Especifique la réplica de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-129">Specify Backup replica.</span></span> <span data-ttu-id="3412d-130">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] usa la configuración de la réplica de copia de seguridad preferida para determinar qué base de datos usar para programar las copias de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-130">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which database to use for scheduling backups from..</span></span>  <span data-ttu-id="3412d-131">Para determinar si la réplica actual es la réplica de copia de seguridad preferida, use la función de [&#41;de Transact-SQL &#40;sys. fn_hadr_backup_is_preferred_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="3412d-131">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
4.  <span data-ttu-id="3412d-132">En cada [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuración de ejecución de réplicas para la base de datos, use el procedimiento almacenado **Smart-admin. sp_set_db_backup** .</span><span class="sxs-lookup"><span data-stu-id="3412d-132">On each replica run [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration for the database using the **smart-admin.sp_set_db_backup** stored procedure.</span></span>  
  
     <span data-ttu-id="3412d-133">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] comportamiento después de una conmutación por error:\*\* seguirá [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] funcionando y manteniendo las copias de seguridad y la capacidad de recuperación después de un evento de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="3412d-133">**[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] behavior after a failover:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will continue to work and maintain backup copies and recoverability after a failover event.</span></span> <span data-ttu-id="3412d-134">No se requiere ninguna acción concreta después de una conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="3412d-134">No specific action is required after a failover.</span></span>  
  
#### <a name="considerations-and-requirements"></a><span data-ttu-id="3412d-135">Consideraciones y requisitos:</span><span class="sxs-lookup"><span data-stu-id="3412d-135">Considerations and Requirements:</span></span>  
 <span data-ttu-id="3412d-136">La configuración de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para las bases de datos participantes en el Grupo de disponibilidad AlwaysOn requiere consideraciones y requisitos concretos.</span><span class="sxs-lookup"><span data-stu-id="3412d-136">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Group requires specific considerations and requirements.</span></span> <span data-ttu-id="3412d-137">La siguiente es una lista de las consideraciones y los requisitos:</span><span class="sxs-lookup"><span data-stu-id="3412d-137">Following is a list of considerations and requirements:</span></span>  
  
-   <span data-ttu-id="3412d-138">La configuración de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] debe ser la misma para todas las bases de datos en todos los nodos de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] que participan en el mismo Grupo de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-138">The [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings should be the same for all the databases on all the nodes of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] participating in the same Availability Group.</span></span> <span data-ttu-id="3412d-139">Puede lograr esto estableciendo la misma configuración de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para las réplicas principales y para todas las réplicas en la base de datos, o estableciendo los mismos valores predeterminados de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] en todos los nodos participantes en los Grupos de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-139">You can achieve this either by setting  the same [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configurations for the primary and all the replicas at the database level, or by setting the same default [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] settings on all the nodes participating in the Availability Groups.</span></span> <span data-ttu-id="3412d-140">Se recomienda establecer [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] en la base de datos porque la configuración de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] en el nivel de base de datos permite aislar los valores para las bases de datos y los cambios en la configuración predeterminada afectan a todas las demás bases de datos en la instancia.</span><span class="sxs-lookup"><span data-stu-id="3412d-140">We recommend setting [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database because configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database level lets you isolate the settings to the databases and changes to default settings affect all other databases on the instance.</span></span>  
  
-   <span data-ttu-id="3412d-141">Especifique la réplica de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-141">Specify Backup replica.</span></span> <span data-ttu-id="3412d-142">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] usa la configuración de la réplica de copia de seguridad preferida para programar las copias de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-142">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to schedule the backups.</span></span> <span data-ttu-id="3412d-143">Para determinar si la réplica actual es la réplica de copia de seguridad preferida, use la función de [&#41;de Transact-SQL &#40;sys. fn_hadr_backup_is_preferred_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="3412d-143">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
-   <span data-ttu-id="3412d-144">Si la réplica secundaria está configurada como la preferida, debe configurarse para que tenga al menos acceso de conexión de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="3412d-144">If the secondary replica is configured as the preferred replica, it should be configured to have at least read only connection access.</span></span> <span data-ttu-id="3412d-145">Los grupos de disponibilidad que no tienen acceso de conexión a las bases de datos secundarias no se admiten.</span><span class="sxs-lookup"><span data-stu-id="3412d-145">Availability groups that have no connection access to secondary databases are not supported.</span></span>  <span data-ttu-id="3412d-146">Para obtener más información, vea [Configurar el acceso de solo lectura en una réplica de disponibilidad &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-146">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
-   <span data-ttu-id="3412d-147">Si configura [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] después de configurar el Grupo de disponibilidad, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] intentará copiar las copias de seguridad existentes y las copiará en el contenedor de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="3412d-147">If you are configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] after you configure the Availability Group, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to copy any existing backups based and copy them over to the storage container.</span></span>  <span data-ttu-id="3412d-148">Si [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] no encuentra o no tiene acceso a las copias de seguridad existentes, programará una copia de seguridad completa de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3412d-148">If [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is unable to find or access existing backups, it will schedule a full database backup.</span></span> <span data-ttu-id="3412d-149">Esto se hace específicamente para optimizar las operaciones de copia de seguridad para las bases de datos del Grupo de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-149">This is done specifically to optimize the backup operations for Availability Group databases.</span></span>  
  
-   <span data-ttu-id="3412d-150">Es posible que desee considerar la posibilidad de deshabilitar la configuración de nivel de instancia si está creando una nueva base de datos de disponibilidad y no pretende aplicar la configuración de nivel de instancia a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3412d-150">You may want to consider disabling the instance level settings if you are creating a new availability database, and you don't intend to apply the instance level settings to the database</span></span>  
  
-   <span data-ttu-id="3412d-151">Cuando se usa cifrado, emplee el mismo certificado en todas las réplicas.</span><span class="sxs-lookup"><span data-stu-id="3412d-151">When using encryption, use the same certificate on all the replicas.</span></span> <span data-ttu-id="3412d-152">Esto facilita operaciones de copia de seguridad continuadas e ininterrumpidas en caso de conmutación por error o restauraciones en otra réplica diferente.</span><span class="sxs-lookup"><span data-stu-id="3412d-152">This facilitates continued and uninterrupted backup operations in the event of a failover or restores to a different replica.</span></span>  
  
#### <a name="enable-and-configure-ss_smartbackup-for-an-availability-database"></a><span data-ttu-id="3412d-153">Habilitar y configurar [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para una base de datos de disponibilidad</span><span class="sxs-lookup"><span data-stu-id="3412d-153">Enable and Configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for an Availability Database</span></span>  
 <span data-ttu-id="3412d-154">En este tutorial se describen los pasos para habilitar y configurar [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para una base de datos (AGTestDB) en los equipos Node1 y Node2, además de los pasos para habilitar la supervisión del estado de mantenimiento de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="3412d-154">This tutorial describes the steps to enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a database (AGTestDB) on computers Node1 and Node2, followed by steps to enable monitoring the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] health status.</span></span>  
  
1.  <span data-ttu-id="3412d-155">**Cree una cuenta de almacenamiento de Azure:** Las copias de seguridad se almacenan en el servicio de almacenamiento de blobs de Azure.</span><span class="sxs-lookup"><span data-stu-id="3412d-155">**Create an Azure storage account:** The backups are stored in the Azure Blob storage service.</span></span> <span data-ttu-id="3412d-156">En primer lugar, debe crear una cuenta de almacenamiento de Azure, si aún no tiene una.</span><span class="sxs-lookup"><span data-stu-id="3412d-156">You must first create an Azure storage account, if you do not already have one.</span></span> <span data-ttu-id="3412d-157">Para obtener más información, consulte [crear una cuenta de Azure Storage](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span><span class="sxs-lookup"><span data-stu-id="3412d-157">For more information, see [Creating an Azure Storage Account](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span></span> <span data-ttu-id="3412d-158">Anote el nombre, las claves de acceso y la dirección URL de la cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="3412d-158">Make a note of the storage account name, access keys, and URL of the storage account.</span></span> <span data-ttu-id="3412d-159">La información del nombre de cuenta y de la clave de acceso se utiliza para crear una credencial SQL.</span><span class="sxs-lookup"><span data-stu-id="3412d-159">The storage account name and access key information is used to create a SQL Credential.</span></span> <span data-ttu-id="3412d-160">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] usa la credencial de SQL durante las operaciones de copia de seguridad para autenticarse en la cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="3412d-160">The SQL Credential is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] during backup operations to authenticate to the storage account.</span></span>  
  
2.  <span data-ttu-id="3412d-161">**Cree una credencial de SQL:** Cree una credencial de SQL con el nombre de la cuenta de almacenamiento como identidad y la clave de acceso de almacenamiento como contraseña.</span><span class="sxs-lookup"><span data-stu-id="3412d-161">**Create a SQL Credential:** Create a SQL Credential using the name of the storage account as the Identity and the storage access key as the password.</span></span>  
  
3.  <span data-ttu-id="3412d-162">**Asegúrese de que el servicio del Agente SQL Server está iniciado y en ejecutándose:** inicie el Agente SQL Server si no se está ejecutando actualmente.</span><span class="sxs-lookup"><span data-stu-id="3412d-162">**Ensure SQL Server Agent service is Started and Running:** Start SQL Server Agent if it is not currently running.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="3412d-163">requiere que el Agente SQL Server se ejecute en la instancia para realizar operaciones de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-163">requires SQL Server Agent to be running on the instance to perform backup operations.</span></span>  <span data-ttu-id="3412d-164">Puede ser conveniente configurar el Agente SQL Server para que se ejecute automáticamente con el fin de asegurarse de que las operaciones de copia de seguridad pueden realizarse periódicamente.</span><span class="sxs-lookup"><span data-stu-id="3412d-164">You may want to set SQL Agent to run automatically to make sure that backup operations can occur regularly.</span></span>  
  
4.  <span data-ttu-id="3412d-165">**Determinar el período de retención:** Determine el período de retención que desea para los archivos de copia de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-165">**Determine the retention period:** Determine the retention period that you want for the backup files.</span></span> <span data-ttu-id="3412d-166">El período de retención se especifica en días y puede abarcar de 1 a 30.</span><span class="sxs-lookup"><span data-stu-id="3412d-166">The retention period is specified in days and can range from 1 to 30.</span></span> <span data-ttu-id="3412d-167">Este período de retención determina el margen de tiempo durante el cual se puede recuperar la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3412d-167">The retention period determines the recoverability time frame for the database.</span></span>  
  
5.  <span data-ttu-id="3412d-168">**Cree un certificado o una clave asimétrica que se usará para el cifrado durante la copia de seguridad:** Cree el certificado en el primer nodo Nodo1 y, a continuación, expórtelo a un archivo mediante el [certificado de copia de seguridad &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="3412d-168">**Create a Certificate or Asymmetric key to use for encryption during back up:** Create the certificate on the first node Node1, and then export it to a file using [BACKUP CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span></span> <span data-ttu-id="3412d-169">En el Nodo 2, cree un certificado mediante el archivo exportado del Nodo 1.</span><span class="sxs-lookup"><span data-stu-id="3412d-169">On Node 2, create a certificate using the file exported from Node 1 .</span></span> <span data-ttu-id="3412d-170">Para obtener más información sobre cómo crear un certificado a partir de un archivo, vea el ejemplo de [Create certificate &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="3412d-170">For more information on creating a certificate from a file, see the example in [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span></span>  
  
6.  <span data-ttu-id="3412d-171">**Habilite y configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para AGTestDB en nodo1:** inicie SQL Server Management Studio y conéctese a la instancia en el nodo1 donde está instalada la base de datos de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-171">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node1:** Start SQL Server Management Studio  and connect to the instance on Node1 where the availability database  is installed.</span></span> <span data-ttu-id="3412d-172">En la ventana de consulta, ejecute la siguiente instrucción después de modificar los valores correspondientes al nombre de la base de datos, la dirección URL de almacenamiento, la credencial SQL y el período de retención según sus requisitos:</span><span class="sxs-lookup"><span data-stu-id="3412d-172">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     <span data-ttu-id="3412d-173">Para obtener más información sobre la creación de un certificado para el cifrado, vea el paso **crear un certificado de copia** de seguridad en [creación de una copia de seguridad cifrada](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-173">For more information on creating a certificate for encryption, see the **Create a Backup Certificate** step in [Create an Encrypted Backup](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span></span>  
  
7.  <span data-ttu-id="3412d-174">**Habilite y configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para AGTestDB en nodo2:** inicie SQL Server Management Studio y conéctese a la instancia en el nodo 2, donde está instalada la base de datos de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-174">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node2:** Start SQL Server Management Studio and connect to the instance on Node2 where the availability database  is installed.</span></span> <span data-ttu-id="3412d-175">En la ventana de consulta, ejecute la siguiente instrucción después de modificar los valores correspondientes al nombre de la base de datos, la dirección URL de almacenamiento, la credencial SQL y el período de retención según sus requisitos:</span><span class="sxs-lookup"><span data-stu-id="3412d-175">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="3412d-176">está habilitada ahora en la base de datos especificada.</span><span class="sxs-lookup"><span data-stu-id="3412d-176">is now enabled on the database you specified.</span></span> <span data-ttu-id="3412d-177">Puede tardarse hasta 15 minutos en que las operaciones de copia de seguridad de la base de datos empiecen a ejecutarse.</span><span class="sxs-lookup"><span data-stu-id="3412d-177">It may take up to 15 minutes for the backup operations on the database to start to run.</span></span> <span data-ttu-id="3412d-178">La copia de seguridad tendrá lugar en la réplica de la copia de seguridad preferida.</span><span class="sxs-lookup"><span data-stu-id="3412d-178">The backup will occur on the preferred backup replica.</span></span>  
  
8.  <span data-ttu-id="3412d-179">**Revise la configuración predeterminada del evento extendido:**  Revise la configuración de eventos extendidos ejecutando la siguiente instrucción Transact-SQL en la réplica que [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] usa para programar las copias de seguridad.</span><span class="sxs-lookup"><span data-stu-id="3412d-179">**Review Extended Event Default Configuration:**  Review the Extended Event configuration by running the following transact-SQL statement on the replica that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using to schedule the backups from.</span></span> <span data-ttu-id="3412d-180">Esta suele ser la configuración de la réplica de copia de seguridad preferida para el Grupo de disponibilidad al que pertenece la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3412d-180">This is usually the preferred backup replica setting for the Availability Group that the database belongs to.</span></span>  
  
    ```sql  
    SELECT * FROM smart_admin.fn_get_current_xevent_settings(); 
    ```  
  
     <span data-ttu-id="3412d-181">Debe ver que los eventos de canal Administración, Operativo y Analítico están habilitados de forma predeterminada y no se pueden deshabilitar.</span><span class="sxs-lookup"><span data-stu-id="3412d-181">You should see that Admin, Operational  and Analytical channel events are enabled by default and cannot be disabled.</span></span> <span data-ttu-id="3412d-182">Debe ser suficiente supervisar los eventos que requieren intervención manual.</span><span class="sxs-lookup"><span data-stu-id="3412d-182">This should be sufficient to monitor the events that require manual intervention.</span></span>  <span data-ttu-id="3412d-183">Puede habilitar los eventos de depuración, pero estos canales incluyen eventos informativos y de depuración que [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] usa para detectar problemas y solucionarlos.</span><span class="sxs-lookup"><span data-stu-id="3412d-183">You can enable the debug events, but these channels include informational and debug events that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] uses to detect issues and solve them.</span></span> <span data-ttu-id="3412d-184">Para obtener más información, consulte [supervisión SQL Server copia de seguridad administrada en Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-184">For more information, see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
9. <span data-ttu-id="3412d-185">**Habilite y configure la notificación del estado de mantenimiento:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] tiene un procedimiento almacenado que crea un trabajo del agente para enviar notificaciones por correo electrónico de los errores o las advertencias que puedan requerir atención.</span><span class="sxs-lookup"><span data-stu-id="3412d-185">**Enable and Configure Notification for Health Status:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] has a stored procedure that creates an agent job to send out e-mail notifications of errors or warnings that may require attention.</span></span>  <span data-ttu-id="3412d-186">Para recibir dichas notificaciones, debe habilitar el procedimiento almacenado que crea un trabajo del Agente SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3412d-186">To receive such notifications, you must enable run the stored procedure which creates a SQL Server Agent Job.</span></span> <span data-ttu-id="3412d-187">En los pasos siguientes se describe el proceso para habilitar y configurar las notificaciones por correo electrónico:</span><span class="sxs-lookup"><span data-stu-id="3412d-187">The following steps describe the process to enable and configure e-mail notifications:</span></span>  
  
    1.  <span data-ttu-id="3412d-188">Configure Correo electrónico de base de datos si aún no está habilitado en la instancia.</span><span class="sxs-lookup"><span data-stu-id="3412d-188">Setup Database Mail if it is not already enabled on the instance.</span></span> <span data-ttu-id="3412d-189">Para obtener más información, vea [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-189">For more information, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span>  
  
    2.  <span data-ttu-id="3412d-190">Configure la notificación del Agente SQL Server para que use Correo electrónico de base de datos.</span><span class="sxs-lookup"><span data-stu-id="3412d-190">Configure SQL Server Agent Notification to use Database Mail.</span></span> <span data-ttu-id="3412d-191">Para más información, consulte [Configurar el Agente SQL Server para que use el Correo electrónico de base de datos](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-191">For more information, see [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span></span>  
  
    3.  <span data-ttu-id="3412d-192">**Habilite las notificaciones por correo electrónico para recibir advertencias y errores de copia de seguridad:** En la ventana de consulta, ejecute las siguientes instrucciones Transact-SQL:</span><span class="sxs-lookup"><span data-stu-id="3412d-192">**Enable e-mail notifications to receive backup errors and warnings:** From the query window, run the following Transact-SQL statements:</span></span>  
  
        ```sql  
        EXEC msdb.smart_admin.sp_set_parameter  
        @parameter_name = 'SSMBackup2WANotificationEmailIds',  
        @parameter_value = '<email>'  
        ```  
  
         <span data-ttu-id="3412d-193">Para obtener más información y un script de ejemplo completo, vea [Monitor SQL Server copia de seguridad administrada en Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-193">For more information and a full sample script see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
10. <span data-ttu-id="3412d-194">**Ver los archivos de copia de seguridad en la cuenta de Azure Storage:** Conéctese a la cuenta de almacenamiento desde SQL Server Management Studio o el Portal de administración de Azure.</span><span class="sxs-lookup"><span data-stu-id="3412d-194">**View backup files in the Azure Storage Account:** Connect to the storage account from SQL Server Management Studio or the Azure Management Portal.</span></span> <span data-ttu-id="3412d-195">Verá un contenedor para la instancia de SQL Server que hospeda la base de datos que configuró para utilizar [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="3412d-195">You will see a container for the instance of SQL Server that hosts the database you configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="3412d-196">También puede ver una base de datos y una copia de seguridad de registros antes de 15 minutos después de habilitar [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3412d-196">You may also see a database and a log backup within 15 minutes of enabling [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span>  
  
11. <span data-ttu-id="3412d-197">**Supervise el estado de mantenimiento:**  puede supervisar a través de notificaciones por correo electrónico que ha configurado previamente, o bien supervisar los eventos registrados de forma activa.</span><span class="sxs-lookup"><span data-stu-id="3412d-197">**Monitor the Health Status:**  You can monitor through e-mail notifications you configured previously, or actively monitor the events logged.</span></span> <span data-ttu-id="3412d-198">Las siguientes son algunas instrucciones de Transact-SQL de ejemplo que se utilizan para ver los eventos:</span><span class="sxs-lookup"><span data-stu-id="3412d-198">The following are some example Transact-SQL Statements used to view the events:</span></span>  
  
    ```sql  
    --  view all admin events  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    DECLARE @eventresult TABLE  
    (event_type nvarchar(512),  
    event varchar (512),  
    timestamp datetime  
    )  
  
    INSERT INTO @eventresult  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek  
  
    SELECT * from @eventresult  
    WHERE event_type LIKE '%admin%'  
    ```  
  
    ```sql  
    -- to enable debug events  
    Use msdb;  
    Go  
    EXEC smart_admin.sp_set_parameter 'FileRetentionDebugXevent', 'True'  
    ```  
  
    ```sql  
    --  View all events in the current week  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek;  
    ```  
  
 <span data-ttu-id="3412d-199">Los pasos descritos en esta sección son específicos para configurar [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] por primera vez en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3412d-199">The steps described in this section are specifically for configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the first time on the database.</span></span> <span data-ttu-id="3412d-200">Puede modificar las configuraciones existentes mediante el mismo procedimiento almacenado del sistema **smart_admin. sp_set_db_backup** y proporcionar los nuevos valores.</span><span class="sxs-lookup"><span data-stu-id="3412d-200">You can modify the existing configurations using the same system stored procedure **smart_admin.sp_set_db_backup** and provide the new values.</span></span> <span data-ttu-id="3412d-201">Para obtener más información, consulte [SQL Server la copia de seguridad administrada en Azure: configuración de retención y almacenamiento](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span><span class="sxs-lookup"><span data-stu-id="3412d-201">For more information, see [SQL Server Managed Backup to Azure - Retention and Storage Settings](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span></span>  
  
### <a name="considerations-when-removing-a-database-from-alwayson-availability-group-configuration"></a><span data-ttu-id="3412d-202">Consideraciones al quitar una base de datos de la configuración del Grupo de disponibilidad AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="3412d-202">Considerations when Removing a Database from AlwaysOn Availability Group Configuration</span></span>  
 <span data-ttu-id="3412d-203">Si se quita una base de datos de la configuración del grupo de disponibilidad AlwaysOn y ahora es una base de datos independiente, se recomienda realizar la copia de seguridad mediante [smart_admin. sp_backup_on_demand &#40;&#41;de Transact-SQL ](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="3412d-203">If a database is removed from the AlwaysOn Availability Group configuration and is now a stand-alone database, we recommend doing backup using [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span></span> <span data-ttu-id="3412d-204">Al crear una copia de seguridad de la base de datos de esta manera, establece una nueva cadena de copias de seguridad y el archivo se colocará en el contenedor específico de la instancia en lugar de en el contenedor Disponibilidad donde se almacenaban las copias de seguridad cuando la base de datos formaba parte del Grupo de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-204">When you create a database backup  this way, it establishes  a new backup chain and the file will be placed in the instance specific container as opposed to Availability container where the backups were stored when the database was part of Availability Group.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="3412d-205">No se garantiza la posibilidad de recuperación de la base de datos en este escenario a partir de las copias de seguridad anteriores al cambio en el estado del Grupo de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="3412d-205">The recoverability of the database in this scenario from backups previous to the change in the Availability Group status is not guaranteed.</span></span>  
  
