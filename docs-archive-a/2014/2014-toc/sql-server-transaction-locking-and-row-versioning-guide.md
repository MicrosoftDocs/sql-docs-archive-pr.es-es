---
title: Guía de versiones de fila y bloqueo de transacciones de SQL Server | Microsoft Docs
ms.custom: ''
ms.date: 01/24/2019
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
ms.assetid: c7757153-9697-4f01-881c-800e254918c9
author: rothja
ms.author: jroth
ms.openlocfilehash: c79f9997249568c88409394441d28c71da453d63
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/04/2020
ms.locfileid: "87663868"
---
# <a name="sql-server-transaction-locking-and-row-versioning-guide"></a><span data-ttu-id="33c05-102">Guía de versiones de fila y bloqueo de transacciones de SQL Server</span><span class="sxs-lookup"><span data-stu-id="33c05-102">SQL Server Transaction Locking and Row Versioning Guide</span></span>

  <span data-ttu-id="33c05-103">En cualquier base de datos, la falta de administración de las transacciones a menudo produce problemas de contención y de rendimiento en sistemas con muchos usuarios.</span><span class="sxs-lookup"><span data-stu-id="33c05-103">In any database, mismanagement of transactions often leads to contention and performance problems in systems that have many users.</span></span> <span data-ttu-id="33c05-104">A medida que aumenta el número de usuarios que obtienen acceso a los datos, adquiere importancia el que las aplicaciones utilicen las transacciones eficazmente.</span><span class="sxs-lookup"><span data-stu-id="33c05-104">As the number of users that access the data increases, it becomes important to have applications that use transactions efficiently.</span></span> <span data-ttu-id="33c05-105">En esta guía se describen los mecanismos de versiones de fila y bloqueo que el [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utiliza para garantizar la integridad física de cada transacción y proporciona información acerca de cómo las aplicaciones pueden controlar las transacciones de manera eficaz.</span><span class="sxs-lookup"><span data-stu-id="33c05-105">This guide describes the locking and row versioning mechanisms the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses to ensure the physical integrity of each transaction and provides information on how applications can control transactions efficiently.</span></span>  
  
<span data-ttu-id="33c05-106">**Se aplica a**: a [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] menos que se indique lo contrario.</span><span class="sxs-lookup"><span data-stu-id="33c05-106">**Applies to**: [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] through [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] unless noted otherwise.</span></span>  
  
##  <a name="in-this-guide"></a><a name="Top"></a><span data-ttu-id="33c05-107">En esta guía</span><span class="sxs-lookup"><span data-stu-id="33c05-107">In This Guide</span></span>  

 [<span data-ttu-id="33c05-108">Aspectos básicos de las transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-108">Transaction Basics</span></span>](#Basics)  
  
 [<span data-ttu-id="33c05-109">Aspectos básicos de las versiones de fila y bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-109">Locking and Row Versioning Basics</span></span>](#Lock_Basics)  
  
 [<span data-ttu-id="33c05-110">Bloqueo en el Motor de base de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-110">Locking in the Database Engine</span></span>](#Lock_Engine)  
  
 [<span data-ttu-id="33c05-111">Niveles de aislamiento basado en versiones de fila del motor de base de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-111">Row Versioning-based Isolation Levels in the Database Engine</span></span>](#Row_versioning)  
  
 [<span data-ttu-id="33c05-112">Personalizar el bloqueo de un índice</span><span class="sxs-lookup"><span data-stu-id="33c05-112">Customizing Locking for an Index</span></span>](#Customize)  
  
 [<span data-ttu-id="33c05-113">Información avanzada de transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-113">Advanced Transaction Information</span></span>](#Advanced)  
  
##  <a name="transaction-basics"></a><a name="Basics"></a> <span data-ttu-id="33c05-114">Conceptos básicos sobre las transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-114">Transaction Basics</span></span>  

 <span data-ttu-id="33c05-115">Una transacción es una secuencia de operaciones realizadas como una sola unidad lógica de trabajo.</span><span class="sxs-lookup"><span data-stu-id="33c05-115">A transaction is a sequence of operations performed as a single logical unit of work.</span></span> <span data-ttu-id="33c05-116">Una unidad lógica de trabajo debe exhibir cuatro propiedades, conocidas como propiedades de atomicidad, coherencia, aislamiento y durabilidad (ACID), para ser calificada como transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-116">A logical unit of work must exhibit four properties, called the atomicity, consistency, isolation, and durability (ACID) properties, to qualify as a transaction.</span></span>  
  
 <span data-ttu-id="33c05-117">Atomicidad</span><span class="sxs-lookup"><span data-stu-id="33c05-117">Atomicity</span></span>  
 <span data-ttu-id="33c05-118">Una transacción debe ser una unidad atómica de trabajo, tanto si se realizan todas sus modificaciones en los datos, como si no se realiza ninguna de ellas.</span><span class="sxs-lookup"><span data-stu-id="33c05-118">A transaction must be an atomic unit of work; either all of its data modifications are performed, or none of them are performed.</span></span>  
  
 <span data-ttu-id="33c05-119">Coherencia</span><span class="sxs-lookup"><span data-stu-id="33c05-119">Consistency</span></span>  
 <span data-ttu-id="33c05-120">Cuando finaliza, una transacción debe dejar todos los datos en un estado coherente.</span><span class="sxs-lookup"><span data-stu-id="33c05-120">When completed, a transaction must leave all data in a consistent state.</span></span> <span data-ttu-id="33c05-121">En una base de datos relacional, se deben aplicar todas las reglas a las modificaciones de la transacción para mantener la integridad de todos los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-121">In a relational database, all rules must be applied to the transaction's modifications to maintain all data integrity.</span></span> <span data-ttu-id="33c05-122">Todas las estructuras internas de datos, como índices de árbol b o listas doblemente vinculadas, deben estar correctas al final de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-122">All internal data structures, such as B-tree indexes or doubly-linked lists, must be correct at the end of the transaction.</span></span>  
  
 <span data-ttu-id="33c05-123">Aislamiento</span><span class="sxs-lookup"><span data-stu-id="33c05-123">Isolation</span></span>  
 <span data-ttu-id="33c05-124">Las modificaciones realizadas por transacciones simultáneas se deben aislar de las modificaciones llevadas a cabo por otras transacciones simultáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-124">Modifications made by concurrent transactions must be isolated from the modifications made by any other concurrent transactions.</span></span> <span data-ttu-id="33c05-125">Una transacción reconoce los datos en el estado en que estaban antes de que otra transacción simultánea los modificara o después de que la segunda transacción haya concluido, pero no reconoce un estado intermedio.</span><span class="sxs-lookup"><span data-stu-id="33c05-125">A transaction either recognizes data in the state it was in before another concurrent transaction modified it, or it recognizes the data after the second transaction has completed, but it does not recognize an intermediate state.</span></span> <span data-ttu-id="33c05-126">Esto se conoce como seriabilidad, ya que deriva en la capacidad de volver a cargar los datos iniciales y reproducir una serie de transacciones para finalizar con los datos en el mismo estado en que estaban después de realizar las transacciones originales.</span><span class="sxs-lookup"><span data-stu-id="33c05-126">This is referred to as serializability because it results in the ability to reload the starting data and replay a series of transactions to end up with the data in the same state it was in after the original transactions were performed.</span></span>  
  
 <span data-ttu-id="33c05-127">Durabilidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-127">Durability</span></span>  
 <span data-ttu-id="33c05-128">Una vez concluida una transacción totalmente durable, sus efectos son permanentes en el sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-128">After a fully durable transaction has completed, its effects are permanently in place in the system.</span></span> <span data-ttu-id="33c05-129">Las modificaciones persisten aún en el caso de producirse un error del sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-129">The modifications persist even in the event of a system failure.</span></span> [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] <span data-ttu-id="33c05-130">y versiones posteriores habilitan las transacciones durables diferidas.</span><span class="sxs-lookup"><span data-stu-id="33c05-130">and later enable delayed durable transactions.</span></span> <span data-ttu-id="33c05-131">Las transacciones durables diferidas se confirman antes de que la entrada de registro de transacciones se guarde en el disco.</span><span class="sxs-lookup"><span data-stu-id="33c05-131">Delayed durable transactions commit before the transaction log record is persisted to disk.</span></span> <span data-ttu-id="33c05-132">Para más información sobre la durabilidad de las transacciones diferidas, vea el tema [Durabilidad de transacciones](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="33c05-132">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="33c05-133">Los programadores de SQL son los responsables de iniciar y finalizar las transacciones en puntos que exijan la coherencia lógica de los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-133">SQL programmers are responsible for starting and ending transactions at points that enforce the logical consistency of the data.</span></span> <span data-ttu-id="33c05-134">El programador debe definir la secuencia de modificaciones de datos que los dejan en un estado coherente en relación con las reglas de negocios de la organización.</span><span class="sxs-lookup"><span data-stu-id="33c05-134">The programmer must define the sequence of data modifications that leave the data in a consistent state relative to the organization's business rules.</span></span> <span data-ttu-id="33c05-135">El programador incluye estas instrucciones de modificación en una sola transacción de forma que [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] puede hacer cumplir la integridad física de la misma.</span><span class="sxs-lookup"><span data-stu-id="33c05-135">The programmer includes these modification statements in a single transaction so that the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can enforce the physical integrity of the transaction.</span></span>  
  
 <span data-ttu-id="33c05-136">Es responsabilidad de un sistema de base de datos corporativo, como una instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)], proporcionar los mecanismos que aseguren la integridad física de cada transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-136">It is the responsibility of an enterprise database system, such as an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], to provide mechanisms ensuring the physical integrity of each transaction.</span></span> <span data-ttu-id="33c05-137">[!INCLUDE[ssDE](../includes/ssde-md.md)] proporciona:</span><span class="sxs-lookup"><span data-stu-id="33c05-137">The [!INCLUDE[ssDE](../includes/ssde-md.md)] provides:</span></span>  
  
-   <span data-ttu-id="33c05-138">Servicios de bloqueo que preservan el aislamiento de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-138">Locking facilities that preserve transaction isolation.</span></span>  
  
-   <span data-ttu-id="33c05-139">Los servicios de registro garantizan la durabilidad de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-139">Logging facilities ensure transaction durability.</span></span> <span data-ttu-id="33c05-140">Para las transacciones totalmente durables, la entrada de registro se graba en el disco antes de la confirmación de las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-140">For fully durable transactions the log record is hardened to disk before the transactions commits.</span></span> <span data-ttu-id="33c05-141">De este modo, aunque se produzca un error en el hardware del servidor, el sistema operativo o la instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)], la instancia usa los registros de transacciones al reiniciar para revertir automáticamente las transacciones incompletas al punto en que se produjo el error del sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-141">Thus, even if the server hardware, operating system, or the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] itself fails, the instance uses the transaction logs upon restart to automatically roll back any uncompleted transactions to the point of the system failure.</span></span> <span data-ttu-id="33c05-142">Las transacciones durables diferidas se confirman antes de que la entrada del registro de transacciones se grabe en el disco.</span><span class="sxs-lookup"><span data-stu-id="33c05-142">Delayed durable transactions commit before the transaction log record is hardened to disk.</span></span> <span data-ttu-id="33c05-143">Este tipo de transacciones se puede perder si se produce un error del sistema antes de que la entrada del registro se grabe en el disco.</span><span class="sxs-lookup"><span data-stu-id="33c05-143">Such transactions may be lost if there is a system failure before the log record is hardened to disk.</span></span> <span data-ttu-id="33c05-144">Para más información sobre la durabilidad de las transacciones diferidas, vea el tema [Durabilidad de transacciones](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="33c05-144">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
-   <span data-ttu-id="33c05-145">Características de administración de transacciones que exigen la atomicidad y coherencia de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-145">Transaction management features that enforce transaction atomicity and consistency.</span></span> <span data-ttu-id="33c05-146">Una vez iniciada una transacción, debe concluirse correctamente (confirmarse); en caso contrario, la instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)] deshará todas las modificaciones de datos realizadas desde que se inició la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-146">After a transaction has started, it must be successfully completed (committed), or the [!INCLUDE[ssDE](../includes/ssde-md.md)] undoes all of the data modifications made since the transaction started.</span></span> <span data-ttu-id="33c05-147">Nos referimos a esta operación como revertir una transacción porque devuelve los datos al estado en el que estaban antes de esos cambios.</span><span class="sxs-lookup"><span data-stu-id="33c05-147">This operation is referred to as rolling back a transaction because it returns the data to the state it was prior to those changes.</span></span>  
  
### <a name="controlling-transactions"></a><span data-ttu-id="33c05-148">Control de transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-148">Controlling Transactions</span></span>  

 <span data-ttu-id="33c05-149">Las aplicaciones controlan las transacciones principalmente al especificar cuándo se inicia y finaliza una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-149">Applications control transactions mainly by specifying when a transaction starts and ends.</span></span> <span data-ttu-id="33c05-150">Se pueden especificar mediante instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)] o funciones de la interfaz de programación de aplicaciones (API) de bases de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-150">This can be specified by using either [!INCLUDE[tsql](../includes/tsql-md.md)] statements or database application programming interface (API) functions.</span></span> <span data-ttu-id="33c05-151">El sistema también debe ser capaz de controlar correctamente los errores que terminan una transacción antes de que se concluya.</span><span class="sxs-lookup"><span data-stu-id="33c05-151">The system must also be able to correctly handle errors that terminate a transaction before it completes.</span></span> <span data-ttu-id="33c05-152">Para obtener más información, vea [instrucciones de transacción &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/transactions-transact-sql), [transacciones en ODBC](https://technet.microsoft.com/library/ms131281.aspx) y [transacciones en SQL Server Native Client (OleDb)](https://msdn.microsoft.com/library/ms130918.aspx).</span><span class="sxs-lookup"><span data-stu-id="33c05-152">For more information, see [Transaction Statements &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/transactions-transact-sql), [Transactions in ODBC](https://technet.microsoft.com/library/ms131281.aspx) and [Transactions in SQL Server Native Client (OLEDB)](https://msdn.microsoft.com/library/ms130918.aspx).</span></span>  
  
 <span data-ttu-id="33c05-153">De manera predeterminada, las transacciones se administran en las conexiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-153">By default, transactions are managed at the connection level.</span></span> <span data-ttu-id="33c05-154">Cuando se inicia una transacción en una conexión, todas las instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)] ejecutadas en esa conexión forman parte de la transacción hasta que ésta finaliza.</span><span class="sxs-lookup"><span data-stu-id="33c05-154">When a transaction is started on a connection, all [!INCLUDE[tsql](../includes/tsql-md.md)] statements executed on that connection are part of the transaction until the transaction ends.</span></span> <span data-ttu-id="33c05-155">No obstante, en una sesión de conjunto de resultados activos múltiples (MARS), una transacción de [!INCLUDE[tsql](../includes/tsql-md.md)] explícita o implícita se convierte en una transacción de lote que se administra en los lotes.</span><span class="sxs-lookup"><span data-stu-id="33c05-155">However, under a multiple active result set (MARS) session, a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction becomes a batch-scoped transaction that is managed at the batch level.</span></span> <span data-ttu-id="33c05-156">Cuando se termina el lote, si la transacción de lote no se confirma ni se revierte, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] la revierte automáticamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-156">When the batch completes, if the batch-scoped transaction is not committed or rolled back, it is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="33c05-157">Para obtener más información, vea [conjuntos de resultados activos múltiples (Mars) en SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="33c05-157">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
#### <a name="starting-transactions"></a><span data-ttu-id="33c05-158">Iniciar transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-158">Starting Transactions</span></span>  

 <span data-ttu-id="33c05-159">Mediante funciones de la API e instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)], puede iniciar transacciones en una instancia de [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] como transacciones explícitas, de confirmación automática o implícitas.</span><span class="sxs-lookup"><span data-stu-id="33c05-159">Using API functions and [!INCLUDE[tsql](../includes/tsql-md.md)] statements, you can start transactions in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] as explicit, autocommit, or implicit transactions.</span></span>  
  
 <span data-ttu-id="33c05-160">**Transacciones explícitas**</span><span class="sxs-lookup"><span data-stu-id="33c05-160">**Explicit Transactions**</span></span>  
 <span data-ttu-id="33c05-161">En una transacción explícita se define explícitamente tanto el inicio como el final de la transacción a través de una función API o emitiendo las instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)][!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION o ROLLBACK WORK.</span><span class="sxs-lookup"><span data-stu-id="33c05-161">An explicit transaction is one in which you explicitly define both the start and end of the transaction through an API function or by issuing the [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION, or ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)] statements.</span></span> <span data-ttu-id="33c05-162">Cuando la transacción termina, la conexión vuelve al modo de transacción en que estaba antes de iniciar la transacción explícita, es decir, el modo implícito o el modo de confirmación automática.</span><span class="sxs-lookup"><span data-stu-id="33c05-162">When the transaction ends, the connection returns to the transaction mode it was in before the explicit transaction was started, either implicit or autocommit mode.</span></span>  
  
 <span data-ttu-id="33c05-163">En una transacción explícita se pueden utilizar todas las instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)], excepto las siguientes:</span><span class="sxs-lookup"><span data-stu-id="33c05-163">You can use all [!INCLUDE[tsql](../includes/tsql-md.md)] statements in an explicit transaction, except for the following statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="33c05-164">ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="33c05-164">ALTER DATABASE</span></span>|<span data-ttu-id="33c05-165">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="33c05-165">CREATE DATABASE</span></span>|<span data-ttu-id="33c05-166">DROP FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="33c05-166">DROP FULLTEXT INDEX</span></span>|  
|<span data-ttu-id="33c05-167">ALTER FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="33c05-167">ALTER FULLTEXT CATALOG</span></span>|<span data-ttu-id="33c05-168">CREATE FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="33c05-168">CREATE FULLTEXT CATALOG</span></span>|<span data-ttu-id="33c05-169">RECONFIGURE</span><span class="sxs-lookup"><span data-stu-id="33c05-169">RECONFIGURE</span></span>|  
|<span data-ttu-id="33c05-170">ALTER FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="33c05-170">ALTER FULLTEXT INDEX</span></span>|<span data-ttu-id="33c05-171">CREATE FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="33c05-171">CREATE FULLTEXT INDEX</span></span>|<span data-ttu-id="33c05-172">RESTORE</span><span class="sxs-lookup"><span data-stu-id="33c05-172">RESTORE</span></span>|  
|<span data-ttu-id="33c05-173">BACKUP</span><span class="sxs-lookup"><span data-stu-id="33c05-173">BACKUP</span></span>|<span data-ttu-id="33c05-174">DROP DATABASE</span><span class="sxs-lookup"><span data-stu-id="33c05-174">DROP DATABASE</span></span>|<span data-ttu-id="33c05-175">Procedimientos almacenados de la búsqueda de texto completo</span><span class="sxs-lookup"><span data-stu-id="33c05-175">Full-text system stored procedures</span></span>|  
|<span data-ttu-id="33c05-176">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="33c05-176">CREATE DATABASE</span></span>|<span data-ttu-id="33c05-177">DROP FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="33c05-177">DROP FULLTEXT CATALOG</span></span>|<span data-ttu-id="33c05-178">sp_dboption para establecer opciones de base de datos ni utilizar ningún procedimiento del sistema que modifique la base de datos maestra en transacciones explícitas o implícitas.</span><span class="sxs-lookup"><span data-stu-id="33c05-178">sp_dboption to set database options or any system procedure that modifies the master database inside explicit or implicit transactions.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-179">UPDATE STATISTICS se puede utilizar dentro de una transacción explícita.</span><span class="sxs-lookup"><span data-stu-id="33c05-179">UPDATE STATISTICS can be used inside an explicit transaction.</span></span> <span data-ttu-id="33c05-180">Sin embargo, UPDATE STATISTICS se confirma independientemente de la transacción que la incluye y no se puede revertir.</span><span class="sxs-lookup"><span data-stu-id="33c05-180">However, UPDATE STATISTICS commits independently of the enclosing transaction and cannot be rolled back.</span></span>  
  
 <span data-ttu-id="33c05-181">**Transacciones de confirmación automática**</span><span class="sxs-lookup"><span data-stu-id="33c05-181">**Autocommit Transactions**</span></span>  
 <span data-ttu-id="33c05-182">El modo de confirmación automática es el modo de administración de transacciones predeterminado de SQL Server Database Engine.</span><span class="sxs-lookup"><span data-stu-id="33c05-182">Autocommit mode is the default transaction management mode of the SQL Server Database Engine.</span></span> <span data-ttu-id="33c05-183">Cada instrucción Transact-SQL se confirma o se revierte cuando finaliza.</span><span class="sxs-lookup"><span data-stu-id="33c05-183">Every Transact-SQL statement is committed or rolled back when it completes.</span></span> <span data-ttu-id="33c05-184">Si una instrucción termina correctamente, se confirma; si encuentra un error, se revierte.</span><span class="sxs-lookup"><span data-stu-id="33c05-184">If a statement completes successfully, it is committed; if it encounters any error, it is rolled back.</span></span> <span data-ttu-id="33c05-185">Una conexión a una instancia del motor de base de datos funciona en modo de confirmación automática siempre que no se suplante el modo predeterminado mediante transacciones explícitas o implícitas.</span><span class="sxs-lookup"><span data-stu-id="33c05-185">A connection to an instance of the Database Engine operates in autocommit mode whenever this default mode has not been overridden by either explicit or implicit transactions.</span></span> <span data-ttu-id="33c05-186">El modo de confirmación automática es también el modo predeterminado para ADO, OLE DB, ODBC y DB-Library.</span><span class="sxs-lookup"><span data-stu-id="33c05-186">Autocommit mode is also the default mode for ADO, OLE DB, ODBC, and DB-Library.</span></span>  
  
 <span data-ttu-id="33c05-187">**Transacciones implícitas**</span><span class="sxs-lookup"><span data-stu-id="33c05-187">**Implicit Transactions**</span></span>  
 <span data-ttu-id="33c05-188">Cuando una conexión funciona en modo de transacciones implícitas, la instancia del motor de base de datos inicia automáticamente una nueva transacción después de confirmar o revertir la transacción actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-188">When a connection is operating in implicit transaction mode, the instance of the Database Engine automatically starts a new transaction after the current transaction is committed or rolled back.</span></span> <span data-ttu-id="33c05-189">No tiene que realizar ninguna acción para delinear el inicio de una transacción, solo tiene que confirmar o revertir cada transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-189">You do nothing to delineate the start of a transaction; you only commit or roll back each transaction.</span></span> <span data-ttu-id="33c05-190">El modo de transacciones implícitas genera una cadena continua de transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-190">Implicit transaction mode generates a continuous chain of transactions.</span></span> <span data-ttu-id="33c05-191">Establezca el modo de transacción implícita a través de una función de la API o la instrucción SET IMPLICIT_TRANSACTIONS ON de [!INCLUDE[tsql](../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-191">Set implicit transaction mode on through either an API function or the [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON statement.</span></span>  
  
 <span data-ttu-id="33c05-192">Tras establecer el modo de transacciones implícitas en una conexión, la instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)] inicia automáticamente una transacción la primera vez que ejecuta una de estas instrucciones:</span><span class="sxs-lookup"><span data-stu-id="33c05-192">After implicit transaction mode has been set on for a connection, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically starts a transaction when it first executes any of these statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="33c05-193">ALTER TABLE</span><span class="sxs-lookup"><span data-stu-id="33c05-193">ALTER TABLE</span></span>|<span data-ttu-id="33c05-194">FETCH</span><span class="sxs-lookup"><span data-stu-id="33c05-194">FETCH</span></span>|<span data-ttu-id="33c05-195">REVOKE</span><span class="sxs-lookup"><span data-stu-id="33c05-195">REVOKE</span></span>|  
|<span data-ttu-id="33c05-196">CREATE</span><span class="sxs-lookup"><span data-stu-id="33c05-196">CREATE</span></span>|<span data-ttu-id="33c05-197">GRANT</span><span class="sxs-lookup"><span data-stu-id="33c05-197">GRANT</span></span>|<span data-ttu-id="33c05-198">SELECT</span><span class="sxs-lookup"><span data-stu-id="33c05-198">SELECT</span></span>|  
|<span data-ttu-id="33c05-199">Delete</span><span class="sxs-lookup"><span data-stu-id="33c05-199">DELETE</span></span>|<span data-ttu-id="33c05-200">INSERT</span><span class="sxs-lookup"><span data-stu-id="33c05-200">INSERT</span></span>|<span data-ttu-id="33c05-201">TRUNCATE TABLE</span><span class="sxs-lookup"><span data-stu-id="33c05-201">TRUNCATE TABLE</span></span>|  
|<span data-ttu-id="33c05-202">DROP</span><span class="sxs-lookup"><span data-stu-id="33c05-202">DROP</span></span>|<span data-ttu-id="33c05-203">OPEN</span><span class="sxs-lookup"><span data-stu-id="33c05-203">OPEN</span></span>|<span data-ttu-id="33c05-204">UPDATE</span><span class="sxs-lookup"><span data-stu-id="33c05-204">UPDATE</span></span>|  
  
 <span data-ttu-id="33c05-205">**Transacciones de ámbito de lote**</span><span class="sxs-lookup"><span data-stu-id="33c05-205">**Batch-scoped Transactions**</span></span>  
 <span data-ttu-id="33c05-206">Una transacción implícita o explícita de [!INCLUDE[tsql](../includes/tsql-md.md)] que se inicia en una sesión de MARS (conjuntos de resultados activos múltiples), que solo es aplicable a MARS, se convierte en una transacción de ámbito de lote.</span><span class="sxs-lookup"><span data-stu-id="33c05-206">Applicable only to multiple active result sets (MARS), a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction that starts under a MARS session becomes a batch-scoped transaction.</span></span> <span data-ttu-id="33c05-207">Si no se confirma o revierte una transacción de ámbito de lote cuando se completa el lote, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] la revierte automáticamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-207">A batch-scoped transaction that is not committed or rolled back when a batch completes is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="33c05-208">**Transacciones distribuidas**</span><span class="sxs-lookup"><span data-stu-id="33c05-208">**Distributed Transactions**</span></span>  
 <span data-ttu-id="33c05-209">Las transacciones distribuidas abarcan dos o más servidores conocidos como administradores de recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-209">Distributed transactions span two or more servers known as resource managers.</span></span> <span data-ttu-id="33c05-210">La administración de la transacción debe ser coordinada entre los administradores de recursos mediante un componente de servidor llamado administrador de transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-210">The management of the transaction must be coordinated between the resource managers by a server component called a transaction manager.</span></span> <span data-ttu-id="33c05-211">Cada instancia de [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] puede funcionar como administrador de recursos en las transacciones distribuidas que coordinan los administradores de transacciones, como el Coordinador de transacciones distribuidas de [!INCLUDE[msCoName](../includes/msconame-md.md)] (MS DTC) u otros administradores que admitan la especificación Open Group XA del procesamiento de transacciones distribuidas.</span><span class="sxs-lookup"><span data-stu-id="33c05-211">Each instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can operate as a resource manager in distributed transactions coordinated by transaction managers, such as [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC), or other transaction managers that support the Open Group XA specification for distributed transaction processing.</span></span> <span data-ttu-id="33c05-212">Para obtener más información, consulte la documentación de MS DTC.</span><span class="sxs-lookup"><span data-stu-id="33c05-212">For more information, see the MS DTC documentation.</span></span>  
  
 <span data-ttu-id="33c05-213">Una transacción de una sola instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)] que abarque dos o más bases de datos es, de hecho, una transacción distribuida.</span><span class="sxs-lookup"><span data-stu-id="33c05-213">A transaction within a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] that spans two or more databases is actually a distributed transaction.</span></span> <span data-ttu-id="33c05-214">La instancia administra la transacción distribuida internamente; para el usuario funciona como una transacción local.</span><span class="sxs-lookup"><span data-stu-id="33c05-214">The instance manages the distributed transaction internally; to the user, it operates as a local transaction.</span></span>  
  
 <span data-ttu-id="33c05-215">En la aplicación, una transacción distribuida se administra de forma muy parecida a una transacción local.</span><span class="sxs-lookup"><span data-stu-id="33c05-215">At the application, a distributed transaction is managed much the same as a local transaction.</span></span> <span data-ttu-id="33c05-216">Al final de la transacción, la aplicación solicita que se confirme o se revierta la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-216">At the end of the transaction, the application requests the transaction to be either committed or rolled back.</span></span> <span data-ttu-id="33c05-217">El administrador de transacciones debe administrar una confirmación distribuida de forma diferente para reducir al mínimo el riesgo de que, si se produce un error en la red, algunos administradores de recursos realicen confirmaciones mientras los demás revierten la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-217">A distributed commit must be managed differently by the transaction manager to minimize the risk that a network failure may result in some resource managers successfully committing while others roll back the transaction.</span></span> <span data-ttu-id="33c05-218">Esto se consigue mediante la administración del proceso de confirmación en dos fases (la fase de preparación y la fase de confirmación), que se conoce como confirmación en dos fases (2PC).</span><span class="sxs-lookup"><span data-stu-id="33c05-218">This is achieved by managing the commit process in two phases (the prepare phase and the commit phase), which is known as a two-phase commit (2PC).</span></span>  
  
 <span data-ttu-id="33c05-219">Fase de preparación</span><span class="sxs-lookup"><span data-stu-id="33c05-219">Prepare phase</span></span>  
 <span data-ttu-id="33c05-220">Cuando el administrador de transacciones recibe una solicitud de confirmación, envía un comando de preparación a todos los administradores de recursos implicados en la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-220">When the transaction manager receives a commit request, it sends a prepare command to all of the resource managers involved in the transaction.</span></span> <span data-ttu-id="33c05-221">Cada administrador de recursos hace lo necesario para que la transacción sea duradera y todos los búferes que contienen imágenes del registro de la transacción se pasan a disco.</span><span class="sxs-lookup"><span data-stu-id="33c05-221">Each resource manager then does everything required to make the transaction durable, and all buffers holding log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="33c05-222">A medida que cada administrador de recursos completa la fase de preparación, notifica si la preparación ha tenido éxito o no al administrador de transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-222">As each resource manager completes the prepare phase, it returns success or failure of the prepare to the transaction manager.</span></span> [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] <span data-ttu-id="33c05-223">introdujo la durabilidad diferida de transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-223">introduced delayed transaction durability.</span></span> <span data-ttu-id="33c05-224">Las transacciones durables diferidas se confirman antes de que las imágenes del registro de la transacción se vacíen en el disco.</span><span class="sxs-lookup"><span data-stu-id="33c05-224">Delayed durable transactions commit before log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="33c05-225">Para más información sobre la durabilidad de las transacciones diferidas, vea el tema [Durabilidad de transacciones](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="33c05-225">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="33c05-226">Fase de confirmación</span><span class="sxs-lookup"><span data-stu-id="33c05-226">Commit phase</span></span>  
 <span data-ttu-id="33c05-227">Si el administrador de transacciones recibe la notificación de que todas las preparaciones son correctas por parte de todos los administradores de recursos, envía comandos de confirmación a cada administrador de recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-227">If the transaction manager receives successful prepares from all of the resource managers, it sends commit commands to each resource manager.</span></span> <span data-ttu-id="33c05-228">A continuación, los administradores de recursos pueden completar la confirmación.</span><span class="sxs-lookup"><span data-stu-id="33c05-228">The resource managers can then complete the commit.</span></span> <span data-ttu-id="33c05-229">Si todos los administradores de recursos indican que la confirmación ha sido correcta, el administrador de transacciones envía una notificación de éxito a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-229">If all of the resource managers report a successful commit, the transaction manager then sends a success notification to the application.</span></span> <span data-ttu-id="33c05-230">Si algún administrador de recursos informó de un error al realizar la preparación, el administrador de transacciones envía un comando para revertir la transacción a cada administrador de recursos e indica a la aplicación que se ha producido un error de confirmación.</span><span class="sxs-lookup"><span data-stu-id="33c05-230">If any resource manager reported a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="33c05-231">Las aplicaciones de [!INCLUDE[ssDE](../includes/ssde-md.md)] pueden administrar transacciones distribuidas a través de [!INCLUDE[tsql](../includes/tsql-md.md)] o de la API de base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-231">[!INCLUDE[ssDE](../includes/ssde-md.md)] applications can manage distributed transactions either through [!INCLUDE[tsql](../includes/tsql-md.md)] or the database API.</span></span> <span data-ttu-id="33c05-232">Para obtener más información, vea [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-232">For more information, see [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span></span>  
  
#### <a name="ending-transactions"></a><span data-ttu-id="33c05-233">Finalizar transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-233">Ending Transactions</span></span>  

 <span data-ttu-id="33c05-234">Puede finalizar las transacciones con una instrucción COMMIT o ROLLBACK, o mediante una función de la API correspondiente.</span><span class="sxs-lookup"><span data-stu-id="33c05-234">You can end transactions with either a COMMIT or ROLLBACK statement, or through a corresponding API function.</span></span>  
  
 <span data-ttu-id="33c05-235">COMMIT</span><span class="sxs-lookup"><span data-stu-id="33c05-235">COMMIT</span></span>  
 <span data-ttu-id="33c05-236">Si una transacción es correcta, confírmela.</span><span class="sxs-lookup"><span data-stu-id="33c05-236">If a transaction is successful, commit it.</span></span> <span data-ttu-id="33c05-237">La instrucción COMMIT garantiza que todas las modificaciones de la transacción se conviertan en una parte permanente de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-237">A COMMIT statement guarantees all of the transaction's modifications are made a permanent part of the database.</span></span> <span data-ttu-id="33c05-238">La instrucción COMMIT también libera recursos que utiliza la transacción como, por ejemplo, los bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-238">A COMMIT also frees resources, such as locks, used by the transaction.</span></span>  
  
 <span data-ttu-id="33c05-239">ROLLBACK</span><span class="sxs-lookup"><span data-stu-id="33c05-239">ROLLBACK</span></span>  
 <span data-ttu-id="33c05-240">Si se produce un error en una transacción o el usuario decide cancelar la transacción, revierta la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-240">If an error occurs in a transaction, or if the user decides to cancel the transaction, then roll the transaction back.</span></span> <span data-ttu-id="33c05-241">La instrucción ROLLBACK revierte todas las modificaciones realizadas en la transacción al devolver los datos al estado en que estaban al inicio de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-241">A ROLLBACK statement backs out all modifications made in the transaction by returning the data to the state it was in at the start of the transaction.</span></span> <span data-ttu-id="33c05-242">La instrucción ROLLBACK también libera los recursos que mantiene la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-242">A ROLLBACK also frees resources held by the transaction.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-243">En conexiones habilitadas para admitir varios conjuntos de resultados activos (MARS), una transacción explícita que se haya iniciado mediante una función de la API no se puede confirmar mientras haya solicitudes de ejecución pendientes.</span><span class="sxs-lookup"><span data-stu-id="33c05-243">Under connections enabled to support multiple active result sets (MARS), an explicit transaction started through an API function cannot be committed while there are pending requests for execution.</span></span> <span data-ttu-id="33c05-244">Cualquier intento de confirmación de una transacción de este tipo mientras se ejecutan operaciones pendientes tendrá como resultado un error.</span><span class="sxs-lookup"><span data-stu-id="33c05-244">Any attempt to commit this type of  transaction while there are outstanding operations running will result in an error.</span></span>  
  
#### <a name="errors-during-transaction-processing"></a><span data-ttu-id="33c05-245">Errores al procesar la transacción</span><span class="sxs-lookup"><span data-stu-id="33c05-245">Errors During Transaction Processing</span></span>  

 <span data-ttu-id="33c05-246">Si un error impide la terminación correcta de una transacción, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] revierte automáticamente la transacción y libera todos los recursos que mantiene la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-246">If an error prevents the successful completion of a transaction, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] automatically rolls back the transaction and frees all resources held by the transaction.</span></span> <span data-ttu-id="33c05-247">Si se interrumpe la conexión de red del cliente con una instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)], las transacciones pendientes de la conexión revierten al estado anterior cuando la red notifica la interrupción a la instancia.</span><span class="sxs-lookup"><span data-stu-id="33c05-247">If the client's network connection to an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] is broken, any outstanding transactions for the connection are rolled back when the network notifies the instance of the break.</span></span> <span data-ttu-id="33c05-248">Si la aplicación cliente falla o si el equipo cliente se bloquea o se reinicia, también se interrumpe la conexión y la instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)] revierte las conexiones pendientes cuando la red le notifica la interrupción.</span><span class="sxs-lookup"><span data-stu-id="33c05-248">If the client application fails or if the client computer goes down or is restarted, this also breaks the connection, and the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] rolls back any outstanding connections when the network notifies it of the break.</span></span> <span data-ttu-id="33c05-249">Si el cliente cierra la aplicación, las transacciones pendientes se revierten.</span><span class="sxs-lookup"><span data-stu-id="33c05-249">If the client logs off the application, any outstanding transactions are rolled back.</span></span>  
  
 <span data-ttu-id="33c05-250">Si se produce el error de una instrucción en tiempo de ejecución (como una infracción de restricciones) en un archivo por lotes, el comportamiento predeterminado de [!INCLUDE[ssDE](../includes/ssde-md.md)] consiste en revertir solamente la instrucción que generó el error.</span><span class="sxs-lookup"><span data-stu-id="33c05-250">If a run-time statement error (such as a constraint violation) occurs in a batch, the default behavior in the [!INCLUDE[ssDE](../includes/ssde-md.md)] is to roll back only the statement that generated the error.</span></span> <span data-ttu-id="33c05-251">Puede modificar este comportamiento con la instrucción SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="33c05-251">You can change this behavior using the SET XACT_ABORT statement.</span></span> <span data-ttu-id="33c05-252">Una vez ejecutada la instrucción SET XACT_ABORT ON, los errores de instrucciones en tiempo de ejecución hacen que se revierta automáticamente la transacción actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-252">After SET XACT_ABORT ON is executed, any run-time statement error causes an automatic rollback of the current transaction.</span></span> <span data-ttu-id="33c05-253">Los errores de compilación, como los de sintaxis, no se ven afectados por SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="33c05-253">Compile errors, such as syntax errors, are not affected by SET XACT_ABORT.</span></span> <span data-ttu-id="33c05-254">Para obtener más información, vea [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-254">For more information, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-255">Cuando se producen errores, la acción correctora (COMMIT o ROLLBACK) debería incluirse en el código de aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-255">When errors occur, corrective action (COMMIT or ROLLBACK) should be included in application code.</span></span> <span data-ttu-id="33c05-256">Una herramienta eficaz para controlar errores, incluidos los de transacciones, es la [!INCLUDE[tsql](../includes/tsql-md.md)] instrucción try... Instrucción CATCH.</span><span class="sxs-lookup"><span data-stu-id="33c05-256">One effective tool for handling errors, including those in transactions, is the [!INCLUDE[tsql](../includes/tsql-md.md)] TRY...CATCH construct.</span></span> <span data-ttu-id="33c05-257">Para obtener más información y ejemplos que incluyan transacciones, vea [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-257">For more information with examples that include transactions, see [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span></span> <span data-ttu-id="33c05-258">A partir de [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] , puede usar la instrucción throw para generar una excepción y transferir la ejecución a un bloque catch de una instrucción try... Instrucción CATCH.</span><span class="sxs-lookup"><span data-stu-id="33c05-258">Beginning with [!INCLUDE[ssSQL11](../includes/sssql11-md.md)], you can use the THROW statement to raise an exception and transfers execution to a CATCH block of a TRY...CATCH construct.</span></span> <span data-ttu-id="33c05-259">Para obtener más información, vea [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-259">For more information, see [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span></span>  
  
##### <a name="compile-and-run-time-errors-in-autocommit-mode"></a><span data-ttu-id="33c05-260">Errores de compilación y tiempo de ejecución del modo de confirmación automática</span><span class="sxs-lookup"><span data-stu-id="33c05-260">Compile and Run-time Errors in Autocommit mode</span></span>  

 <span data-ttu-id="33c05-261">En el modo de confirmación automática, a veces parece que [!INCLUDE[ssDE](../includes/ssde-md.md)] ha revertido un proceso por lotes completo en vez de revertir solamente una instrucción SQL.</span><span class="sxs-lookup"><span data-stu-id="33c05-261">In autocommit mode, it sometimes appears as if an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] has rolled back an entire batch instead of just one SQL statement.</span></span> <span data-ttu-id="33c05-262">Esto sucede si se trata de un error de compilación, no en el caso de un error en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="33c05-262">This happens if the error encountered is a compile error, not a run-time error.</span></span> <span data-ttu-id="33c05-263">Los errores de compilación impiden que [!INCLUDE[ssDE](../includes/ssde-md.md)] genere un plan de ejecución, por lo que no se ejecuta ninguna instrucción del proceso por lotes.</span><span class="sxs-lookup"><span data-stu-id="33c05-263">A compile error prevents the [!INCLUDE[ssDE](../includes/ssde-md.md)] from building an execution plan, so nothing in the batch is executed.</span></span> <span data-ttu-id="33c05-264">Aunque parezca que se han revertido todas las instrucciones anteriores a la que generó el error, el error impidió que se ejecutara ninguna instrucción del proceso por lotes.</span><span class="sxs-lookup"><span data-stu-id="33c05-264">Although it appears that all of the statements before the one generating the error were rolled back, the error prevented anything in the batch from being executed.</span></span> <span data-ttu-id="33c05-265">En el ejemplo siguiente, no se ejecutó ninguna de las instrucciones `INSERT` del tercer proceso por lotes debido a un error de compilación.</span><span class="sxs-lookup"><span data-stu-id="33c05-265">In the following example, none of the `INSERT` statements in the third batch are executed because of a compile error.</span></span> <span data-ttu-id="33c05-266">Parece que se han revertido las dos primeras instrucciones `INSERT` cuando, en realidad, nunca se ejecutaron.</span><span class="sxs-lookup"><span data-stu-id="33c05-266">It appears that the first two `INSERT` statements are rolled back when they are never executed.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUSE (3, 'ccc');  -- Syntax error.  
GO  
SELECT * FROM TestBatch;  -- Returns no rows.  
GO  
```  
  
 <span data-ttu-id="33c05-267">En el ejemplo siguiente, la tercera instrucción `INSERT` genera un error de clave principal duplicada en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="33c05-267">In the following example, the third `INSERT` statement generates a run-time duplicate primary key error.</span></span> <span data-ttu-id="33c05-268">Las dos primeras instrucciones `INSERT` eran correctas y se han confirmado, por lo que permanecen después de producirse el error en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="33c05-268">The first two `INSERT` statements are successful and committed, so they remain after the run-time error.</span></span>  
  
```sql  
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUES (1, 'ccc');  -- Duplicate key error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="33c05-269">[!INCLUDE[ssDE](../includes/ssde-md.md)] utiliza la resolución demorada de nombres, en la que no se resuelven los nombres de los objetos hasta la ejecución.</span><span class="sxs-lookup"><span data-stu-id="33c05-269">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses deferred name resolution, in which object names are not resolved until execution time.</span></span> <span data-ttu-id="33c05-270">En el ejemplo siguiente, se ejecutaron y confirmaron las dos primeras instrucciones `INSERT` y las dos filas permanecen en la tabla `TestBatch` después de que la tercera instrucción `INSERT` generara un error en tiempo de ejecución al hacer referencia a una tabla que no existe.</span><span class="sxs-lookup"><span data-stu-id="33c05-270">In the following example, the first two `INSERT` statements are executed and committed, and those two rows remain in the `TestBatch` table after the third `INSERT` statement generates a run-time error by referring to a table that does not exist.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBch VALUES (3, 'ccc');  -- Table name error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="33c05-271">![Icono de flecha usado con el vínculo volver al principio](media/uparrow16x16.gif "Icono de flecha usado con el vínculo Volver al principio") [de esta guía](#Top)</span><span class="sxs-lookup"><span data-stu-id="33c05-271">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-and-row-versioning-basics"></a><a name="Lock_Basics"></a> <span data-ttu-id="33c05-272">Conceptos básicos sobre las versiones de fila y bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-272">Locking and Row Versioning Basics</span></span>  

 <span data-ttu-id="33c05-273">El [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utiliza los siguientes mecanismos para garantizar la integridad de las transacciones y mantener la coherencia de las bases de datos cuando varios usuarios obtienen acceso a los datos al mismo tiempo:</span><span class="sxs-lookup"><span data-stu-id="33c05-273">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses the following mechanisms to ensure the integrity of transactions and maintain the consistency of databases when multiple users are accessing data at the same time:</span></span>  
  
-   <span data-ttu-id="33c05-274">Bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-274">Locking</span></span>  
  
     <span data-ttu-id="33c05-275">Cada transacción solicita diferentes tipos de bloqueo en los recursos como, por ejemplo, filas, páginas o tablas de los que depende la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-275">Each transaction requests locks of different types on the resources, such as rows, pages, or tables, on which the transaction is dependent.</span></span> <span data-ttu-id="33c05-276">Estos bloqueos impiden que otras transacciones puedan modificar los recursos de forma que esto provoque problemas para la transacción que solicita el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-276">The locks block other transactions from modifying the resources in a way that would cause problems for the transaction requesting the lock.</span></span> <span data-ttu-id="33c05-277">Cada transacción libera sus bloqueos cuando ya no depende de los recursos bloqueados.</span><span class="sxs-lookup"><span data-stu-id="33c05-277">Each transaction frees its locks when it no longer has a dependency on the locked resources.</span></span>  
  
-   <span data-ttu-id="33c05-278">Versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-278">Row versioning</span></span>  
  
     <span data-ttu-id="33c05-279">Cuando un nivel de aislamiento basado en versiones de fila está habilitado, [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene versiones de cada fila que se ha modificado.</span><span class="sxs-lookup"><span data-stu-id="33c05-279">When a row versioning-based isolation level is enabled, the [!INCLUDE[ssDE](../includes/ssde-md.md)] maintains versions of each row that is modified.</span></span> <span data-ttu-id="33c05-280">Las aplicaciones pueden especificar que una transacción utilice las versiones de fila para ver los datos tal como eran al empezar la transacción o la consulta en lugar de proteger todas las lecturas con bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-280">Applications can specify that a transaction use the row versions to view data as it existed at the start of the transaction or query instead of protecting all reads with locks.</span></span> <span data-ttu-id="33c05-281">Mediante las versiones de fila, las probabilidades de que una operación de lectura bloquee otras transacciones se reduce notablemente.</span><span class="sxs-lookup"><span data-stu-id="33c05-281">By using row versioning, the chance that a read operation will block other transactions is greatly reduced.</span></span>  
  
 <span data-ttu-id="33c05-282">El bloqueo y las versiones de fila impiden a los usuarios leer los datos no confirmados así como cualquier intento de cambiar los mismos datos a la vez.</span><span class="sxs-lookup"><span data-stu-id="33c05-282">Locking and row versioning prevent users from reading uncommitted data and prevent multiple users from attempting to change the same data at the same time.</span></span> <span data-ttu-id="33c05-283">Sin el bloqueo o las versiones de fila, las consultas ejecutadas para esos datos podrían generar resultados inesperados al devolver datos que todavía no se han confirmado en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-283">Without locking or row versioning, queries executed against that data could produce unexpected results by returning data that has not yet been committed in the database.</span></span>  
  
 <span data-ttu-id="33c05-284">Las aplicaciones pueden elegir los niveles de aislamiento de las transacciones, que definen el nivel de protección de la transacción frente a las modificaciones efectuadas por otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-284">Applications can choose transaction isolation levels, which define the level of protection for the transaction from modifications made by other transactions.</span></span> <span data-ttu-id="33c05-285">Las sugerencias de nivel de tabla pueden especificarse para instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)] concretas para personalizar el comportamiento con el fin de que se ajuste a los requisitos de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-285">Table-level hints can be specified for individual [!INCLUDE[tsql](../includes/tsql-md.md)] statements to further tailor behavior to fit the requirements of the application.</span></span>  
  
### <a name="managing-concurrent-data-access"></a><span data-ttu-id="33c05-286">Administrar el acceso simultáneo a datos</span><span class="sxs-lookup"><span data-stu-id="33c05-286">Managing Concurrent Data Access</span></span>  

 <span data-ttu-id="33c05-287">En ocasiones, los usuarios tienen acceso a un recurso al mismo tiempo, es decir, simultáneamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-287">Users who access a resource at the same time are said to be accessing the resource concurrently.</span></span> <span data-ttu-id="33c05-288">El acceso simultáneo a los datos requiere la utilización de mecanismos para impedir efectos negativos cuando varios usuarios intentan modificar recursos que otros usuarios están utilizando.</span><span class="sxs-lookup"><span data-stu-id="33c05-288">Concurrent data access requires mechanisms to prevent adverse effects when multiple users try to modify resources that other users are actively using.</span></span>  
  
#### <a name="concurrency-effects"></a><span data-ttu-id="33c05-289">Efectos de la simultaneidad</span><span class="sxs-lookup"><span data-stu-id="33c05-289">Concurrency Effects</span></span>  

 <span data-ttu-id="33c05-290">Los usuarios que modifican datos pueden afectar a otros usuarios que leen o modifican los mismos datos a la vez.</span><span class="sxs-lookup"><span data-stu-id="33c05-290">Users modifying data can affect other users who are reading or modifying the same data at the same time.</span></span> <span data-ttu-id="33c05-291">Se dice que estos usuarios tienen acceso a los datos de forma simultánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-291">These users are said to be accessing the data concurrently.</span></span> <span data-ttu-id="33c05-292">Si un sistema de almacenamiento de datos no dispone de control de simultaneidad, los usuarios se pueden encontrar con los siguientes efectos secundarios:</span><span class="sxs-lookup"><span data-stu-id="33c05-292">If a data storage system has no concurrency control, users could see the following side effects:</span></span>  
  
-   <span data-ttu-id="33c05-293">Actualizaciones perdidas</span><span class="sxs-lookup"><span data-stu-id="33c05-293">Lost updates</span></span>  
  
     <span data-ttu-id="33c05-294">Este problema surge cuando dos o más transacciones seleccionan la misma fila y, a continuación, la actualizan de acuerdo con el valor seleccionado originalmente.</span><span class="sxs-lookup"><span data-stu-id="33c05-294">Lost updates occur when two or more transactions select the same row and then update the row based on the value originally selected.</span></span> <span data-ttu-id="33c05-295">Ninguna transacción es consciente de las otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-295">Each transaction is unaware of the other transactions.</span></span> <span data-ttu-id="33c05-296">La última actualización sobrescribe las actualizaciones realizadas por las otras transacciones y, en consecuencia, se pierden datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-296">The last update overwrites updates made by the other transactions, which results in lost data.</span></span>  
  
     <span data-ttu-id="33c05-297">Por ejemplo, dos editores realizan una copia electrónica del mismo documento.</span><span class="sxs-lookup"><span data-stu-id="33c05-297">For example, two editors make an electronic copy of the same document.</span></span> <span data-ttu-id="33c05-298">Cada editor modifica la copia de forma independiente y después la guarda, sobrescribiendo el documento original.</span><span class="sxs-lookup"><span data-stu-id="33c05-298">Each editor changes the copy independently and then saves the changed copy thereby overwriting the original document.</span></span> <span data-ttu-id="33c05-299">El editor que guarda la copia modificada en último lugar sobrescribe las modificaciones que realizó el otro editor.</span><span class="sxs-lookup"><span data-stu-id="33c05-299">The editor who saves the changed copy last overwrites the changes made by the other editor.</span></span> <span data-ttu-id="33c05-300">Este problema se puede evitar si un editor no tiene acceso al archivo hasta que el otro finaliza y confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-300">This problem could be avoided if one editor could not access the file until the other editor had finished and committed the transaction.</span></span>  
  
-   <span data-ttu-id="33c05-301">Dependencia no confirmada (lectura no actualizada)</span><span class="sxs-lookup"><span data-stu-id="33c05-301">Uncommitted dependency (dirty read)</span></span>  
  
     <span data-ttu-id="33c05-302">Este problema se produce cuando una transacción selecciona una fila que está siendo actualizada por otra transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-302">Uncommitted dependency occurs when a second transaction selects a row that is being updated by another transaction.</span></span> <span data-ttu-id="33c05-303">La segunda transacción lee datos que no han sido confirmados aún y pueden ser modificados por la transacción que está actualizando la fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-303">The second transaction is reading data that has not been committed yet and may be changed by the transaction updating the row.</span></span>  
  
     <span data-ttu-id="33c05-304">Por ejemplo, un editor realiza cambios en un documento electrónico.</span><span class="sxs-lookup"><span data-stu-id="33c05-304">For example, an editor is making changes to an electronic document.</span></span> <span data-ttu-id="33c05-305">Durante las modificaciones, un segundo editor toma una copia del documento que contiene todas las modificaciones realizadas hasta el momento y la distribuye a los destinatarios.</span><span class="sxs-lookup"><span data-stu-id="33c05-305">During the changes, a second editor takes a copy of the document that includes all the changes made so far, and distributes the document to the intended audience.</span></span> <span data-ttu-id="33c05-306">El primer editor decide que los cambios realizados son erróneos, así que los elimina y guarda el documento.</span><span class="sxs-lookup"><span data-stu-id="33c05-306">The first editor then decides the changes made so far are wrong and removes the edits and saves the document.</span></span> <span data-ttu-id="33c05-307">El documento distribuido contiene modificaciones que ya no existen y deben tratarse como si nunca hubieran existido.</span><span class="sxs-lookup"><span data-stu-id="33c05-307">The distributed document contains edits that no longer exist and should be treated as if they never existed.</span></span> <span data-ttu-id="33c05-308">Este problema se puede evitar si nadie lee el documento modificado hasta que el primer editor realiza el almacenamiento final de las modificaciones y confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-308">This problem could be avoided if no one could read the changed document until the first editor does the final save of modifications and commits the transaction.</span></span>  
  
-   <span data-ttu-id="33c05-309">Análisis contradictorios (lectura irrepetible)</span><span class="sxs-lookup"><span data-stu-id="33c05-309">Inconsistent analysis (nonrepeatable read)</span></span>  
  
     <span data-ttu-id="33c05-310">Este problema se produce cuando una transacción obtiene acceso a la misma fila varias veces y en cada ocasión lee datos diferentes.</span><span class="sxs-lookup"><span data-stu-id="33c05-310">Inconsistent analysis occurs when a second transaction accesses the same row several times and reads different data each time.</span></span> <span data-ttu-id="33c05-311">El análisis incoherente es similar a la dependencia no confirmada en tanto que una transacción está modificando los datos que está leyendo una segunda transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-311">Inconsistent analysis is similar to uncommitted dependency in that another transaction is changing the data that a second transaction is reading.</span></span> <span data-ttu-id="33c05-312">Sin embargo, en el caso del análisis incoherente, los datos que lee la segunda transacción están confirmados por la transacción que realizó el cambio.</span><span class="sxs-lookup"><span data-stu-id="33c05-312">However, in inconsistent analysis, the data read by the second transaction was committed by the transaction that made the change.</span></span> <span data-ttu-id="33c05-313">Además, el análisis incoherente comprende varias lecturas (dos o más) de la misma fila y las transacciones modifican la información cada vez; de ahí el término de lectura irrepetible.</span><span class="sxs-lookup"><span data-stu-id="33c05-313">Also, inconsistent analysis involves multiple reads (two or more) of the same row, and each time the information is changed by another transaction; thus, the term nonrepeatable read.</span></span>  
  
     <span data-ttu-id="33c05-314">Por ejemplo, un editor lee el mismo documento dos veces pero, entre cada lectura, el escritor vuelve a escribir el documento.</span><span class="sxs-lookup"><span data-stu-id="33c05-314">For example, an editor reads the same document twice, but between each reading the writer rewrites the document.</span></span> <span data-ttu-id="33c05-315">Cuando el editor lee el documento por segunda vez, éste ha cambiado.</span><span class="sxs-lookup"><span data-stu-id="33c05-315">When the editor reads the document for the second time, it has changed.</span></span> <span data-ttu-id="33c05-316">La lectura original no era repetible.</span><span class="sxs-lookup"><span data-stu-id="33c05-316">The original read was not repeatable.</span></span> <span data-ttu-id="33c05-317">Este problema se puede evitar si el escritor no cambia el documento hasta que el editor finaliza la lectura por última vez.</span><span class="sxs-lookup"><span data-stu-id="33c05-317">This problem could be avoided if the writer could not change the document until the editor has finished reading it for the last time.</span></span>  
  
-   <span data-ttu-id="33c05-318">Lecturas fantasma</span><span class="sxs-lookup"><span data-stu-id="33c05-318">Phantom reads</span></span>  
  
     <span data-ttu-id="33c05-319">Una lectura fantasma es una situación que se produce cuando se ejecutan dos consultas idénticas y la recopilación de filas devuelta por la segunda consulta es diferente.</span><span class="sxs-lookup"><span data-stu-id="33c05-319">A phantom read is a situation that occurs when two identical queries are executed and the collection of rows returned by the second query is different.</span></span> <span data-ttu-id="33c05-320">En el siguiente ejemplo se muestra cómo se puede producir esto.</span><span class="sxs-lookup"><span data-stu-id="33c05-320">The example below shows how this may occur.</span></span> <span data-ttu-id="33c05-321">Suponga que las dos transacciones siguientes se están ejecutando al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="33c05-321">Assume the two transactions below are executing at the same time.</span></span> <span data-ttu-id="33c05-322">Las dos instrucciones SELECT de la primera transacción pueden devolver resultados diferentes porque la instrucción INSERT de la segunda transacción cambia los datos utilizados por ambas.</span><span class="sxs-lookup"><span data-stu-id="33c05-322">The two SELECT statements in the first transaction may return different results because the INSERT statement in the second transaction changes the data used by both.</span></span>  
  
    ```sql  
    --Transaction 1  
    BEGIN TRAN;  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    --The INSERT statement from the second transaction occurs here.  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    COMMIT;  
    ```  
  
    ```sql  
    --Transaction 2  
    BEGIN TRAN;  
    INSERT INTO dbo.employee  
       SET name = 'New' WHERE ID = 5;  
    COMMIT;   
    ```  
  
-   <span data-ttu-id="33c05-323">Dobles lecturas o lecturas que faltan por causa de las actualizaciones de las filas</span><span class="sxs-lookup"><span data-stu-id="33c05-323">Missing and double reads caused by row updates</span></span>  
  
    -   <span data-ttu-id="33c05-324">No se encuentra una fila actualizada o una fila actualizada aparece varias veces</span><span class="sxs-lookup"><span data-stu-id="33c05-324">Missing a updated row or seeing an updated row multiple times</span></span>  
  
         <span data-ttu-id="33c05-325">Las transacciones que se ejecutan en el nivel READ UNCOMMITTED no emiten bloqueos compartidos para impedir que otras transacciones modifiquen los datos leídos por la transacción actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-325">Transactions that are running at the READ UNCOMMITTED level do not issue shared locks to prevent other transactions from modifying data read by the current transaction.</span></span> <span data-ttu-id="33c05-326">Las transacciones que se están ejecutando en el nivel de READ COMMITTED emiten bloqueos compartidos, pero los bloqueos de fila o página se liberan una vez leída la fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-326">Transactions that are running at the READ COMMITTED level do issue shared locks, but the row or page locks are released after the row is read.</span></span> <span data-ttu-id="33c05-327">En cualquier caso, al recorrer un índice, si otro usuario cambia la columna de clave de índice de la fila mientras usted lo está leyendo, la fila podría aparecer de nuevo si el cambio en la clave movió la fila a una posición situada por delante de su punto de recorrido.</span><span class="sxs-lookup"><span data-stu-id="33c05-327">In either case, when you are scanning an index, if another user changes the index key column of the row during your read, the row might appear again if the key change moved the row to a position ahead of your scan.</span></span> <span data-ttu-id="33c05-328">De igual forma, la fila podría no aparecer si el cambio en la clave movió la fila a una posición en el índice que ya había sido leída.</span><span class="sxs-lookup"><span data-stu-id="33c05-328">Similarly, the row might not appear if the key change moved the row to a position in the index that you had already read.</span></span> <span data-ttu-id="33c05-329">Para evitar esto, utilice las sugerencias SERIALIZABLE o HOLDLOCK, o bien las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-329">To avoid this, use the SERIALIZABLE or HOLDLOCK hint, or row versioning.</span></span> <span data-ttu-id="33c05-330">Para obtener más información, vea [Sugerencias de tabla &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="33c05-330">For more information, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
    -   <span data-ttu-id="33c05-331">Faltan una o más filas que no eran objeto de la actualización</span><span class="sxs-lookup"><span data-stu-id="33c05-331">Missing one or more rows that were not the target of update</span></span>  
  
         <span data-ttu-id="33c05-332">Cuando utilice READ UNCOMMITTED, si su consulta lee filas mediante recorrido del orden de asignación (uso de páginas IAM), podría perder filas si otra transacción está produciendo una división de página.</span><span class="sxs-lookup"><span data-stu-id="33c05-332">When you are using READ UNCOMMITTED, if your query reads rows using an allocation order scan (using IAM pages), you might miss rows if another transaction is causing a page split.</span></span> <span data-ttu-id="33c05-333">Esto no puede suceder si utiliza la lectura confirmada porque la tabla se mantiene bloqueada durante la división de la página y no pasa si la tabla no tiene un índice clúster, porque las actualizaciones no producen divisiones de página.</span><span class="sxs-lookup"><span data-stu-id="33c05-333">This cannot occur when you are using read committed because a table lock is held during a page split and does not happen if the table does not have a clustered index, because updates do not cause page splits.</span></span>  
  
#### <a name="types-of-concurrency"></a><span data-ttu-id="33c05-334">Tipos de simultaneidad</span><span class="sxs-lookup"><span data-stu-id="33c05-334">Types of Concurrency</span></span>  

 <span data-ttu-id="33c05-335">Cuando varias personas intentan modificar los datos de una base de datos al mismo tiempo, debe implementarse un sistema de controles de forma que las modificaciones realizadas por una persona no afecten negativamente a las de otra.</span><span class="sxs-lookup"><span data-stu-id="33c05-335">When many people attempt to modify data in a database at the same time, a system of controls must be implemented so that modifications made by one person do not adversely affect those of another person.</span></span> <span data-ttu-id="33c05-336">Esto se denomina control de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-336">This is called concurrency control.</span></span>  
  
 <span data-ttu-id="33c05-337">La teoría del control de simultaneidad tiene dos clasificaciones para los métodos que establecen dicho control:</span><span class="sxs-lookup"><span data-stu-id="33c05-337">Concurrency control theory has two classifications for the methods of instituting concurrency control:</span></span>  
  
-   <span data-ttu-id="33c05-338">Control de simultaneidad pesimista</span><span class="sxs-lookup"><span data-stu-id="33c05-338">Pessimistic concurrency control</span></span>  
  
     <span data-ttu-id="33c05-339">Un sistema de bloqueos impide que los usuarios modifiquen los datos de forma que afecte a otros usuarios.</span><span class="sxs-lookup"><span data-stu-id="33c05-339">A system of locks prevents users from modifying data in a way that affects other users.</span></span> <span data-ttu-id="33c05-340">Cuando un usuario lleve a cabo una acción que da lugar a que se aplique un bloqueo, los demás usuarios no podrán realizar acciones que crearían conflictos con el bloqueo hasta que el propietario lo libere.</span><span class="sxs-lookup"><span data-stu-id="33c05-340">After a user performs an action that causes a lock to be applied, other users cannot perform actions that would conflict with the lock until the owner releases it.</span></span> <span data-ttu-id="33c05-341">Esto se denomina control pesimista porque se utiliza principalmente en entornos donde hay muchos conflictos por la obtención de datos, y en los que el coste de la protección de datos con bloqueos es menor que el de revertir las transacciones si se producen conflictos de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-341">This is called pessimistic control because it is mainly used in environments where there is high contention for data, where the cost of protecting data with locks is less than the cost of rolling back transactions if concurrency conflicts occur.</span></span>  
  
-   <span data-ttu-id="33c05-342">Control de simultaneidad optimista</span><span class="sxs-lookup"><span data-stu-id="33c05-342">Optimistic concurrency control</span></span>  
  
     <span data-ttu-id="33c05-343">En el control de simultaneidad optimista, los usuarios no bloquean los datos cuando los leen.</span><span class="sxs-lookup"><span data-stu-id="33c05-343">In optimistic concurrency control, users do not lock data when they read it.</span></span> <span data-ttu-id="33c05-344">Cuando un usuario realiza una actualización de datos, el sistema comprueba si otro usuario ha cambiado los datos después de la lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-344">When a user updates data, the system checks to see if another user changed the data after it was read.</span></span> <span data-ttu-id="33c05-345">Si otro usuario actualizó los datos, se produce un error.</span><span class="sxs-lookup"><span data-stu-id="33c05-345">If another user updated the data, an error is raised.</span></span> <span data-ttu-id="33c05-346">Normalmente, el usuario que recibe el error revierte la transacción y comienza de nuevo.</span><span class="sxs-lookup"><span data-stu-id="33c05-346">Typically, the user receiving the error rolls back the transaction and starts over.</span></span> <span data-ttu-id="33c05-347">Este tipo de control se denomina optimista porque se utiliza principalmente en entornos donde hay pocos problemas de contención por la obtención de datos y en los que el coste de revertir ocasionalmente una transacción es menor que el de bloquear los datos cuando se leen.</span><span class="sxs-lookup"><span data-stu-id="33c05-347">This is called optimistic because it is mainly used in environments where there is low contention for data, and where the cost of occasionally rolling back a transaction is lower than the cost of locking data when read.</span></span>  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="33c05-348">permite el uso de una serie de controles de simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-348">supports a range of concurrency control.</span></span> <span data-ttu-id="33c05-349">Los usuarios especifican el tipo de control de simultaneidad seleccionando niveles de aislamiento de transacción para las conexiones u opciones de simultaneidad en cursores.</span><span class="sxs-lookup"><span data-stu-id="33c05-349">Users specify the type of concurrency control by selecting transaction isolation levels for connections or concurrency options on cursors.</span></span> <span data-ttu-id="33c05-350">Estos atributos se pueden definir mediante instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)] o bien mediante las propiedades y los atributos de interfaces de programación de aplicaciones (API) de bases de datos como ADO, ADO.NET, OLE DB y ODBC.</span><span class="sxs-lookup"><span data-stu-id="33c05-350">These attributes can be defined using [!INCLUDE[tsql](../includes/tsql-md.md)] statements, or through the properties and attributes of database application programming interfaces (APIs) such as ADO, ADO.NET, OLE DB, and ODBC.</span></span>  
  
#### <a name="isolation-levels-in-the-database-engine"></a><span data-ttu-id="33c05-351">Niveles de aislamiento del motor de base de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-351">Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="33c05-352">Las transacciones especifican un nivel de aislamiento que define el grado en que se debe aislar una transacción de las modificaciones de recursos o datos realizadas por otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-352">Transactions specify an isolation level that defines the degree to which one transaction must be isolated from resource or data modifications made by other transactions.</span></span> <span data-ttu-id="33c05-353">Los niveles de aislamiento se describen en cuanto a los efectos secundarios de la simultaneidad que se permiten, como las lecturas desfasadas o fantasma.</span><span class="sxs-lookup"><span data-stu-id="33c05-353">Isolation levels are described in terms of which concurrency side-effects, such as dirty reads or phantom reads, are allowed.</span></span>  
  
 <span data-ttu-id="33c05-354">Control de los niveles de aislamiento de transacción:</span><span class="sxs-lookup"><span data-stu-id="33c05-354">Transaction isolation levels control:</span></span>  
  
-   <span data-ttu-id="33c05-355">Controla si se realizan bloqueos cuando se leen los datos y qué tipos de bloqueos se solicitan.</span><span class="sxs-lookup"><span data-stu-id="33c05-355">Whether locks are taken when data is read, and what type of locks are requested.</span></span>  
  
-   <span data-ttu-id="33c05-356">Duración de los bloqueos de lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-356">How long the read locks are held.</span></span>  
  
-   <span data-ttu-id="33c05-357">Si una operación de lectura que hace referencia a filas modificadas por otra transacción:</span><span class="sxs-lookup"><span data-stu-id="33c05-357">Whether a read operation referencing rows modified by another transaction:</span></span>  
  
    -   <span data-ttu-id="33c05-358">Se bloquea hasta que se libera el bloqueo exclusivo de la fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-358">Blocks until the exclusive lock on the row is freed.</span></span>  
  
    -   <span data-ttu-id="33c05-359">Recupera la versión confirmada de la fila que existía en el momento en el que empezó la instrucción o la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-359">Retrieves the committed version of the row that existed at the time the statement or transaction started.</span></span>  
  
    -   <span data-ttu-id="33c05-360">Lee la modificación de los datos no confirmados.</span><span class="sxs-lookup"><span data-stu-id="33c05-360">Reads the uncommitted data modification.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="33c05-361">La elección de un nivel de aislamiento de transacción no afecta a los bloqueos adquiridos para proteger la modificación de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-361">Choosing a transaction isolation level does not affect the locks acquired to protect data modifications.</span></span> <span data-ttu-id="33c05-362">Siempre se obtiene un bloqueo exclusivo en los datos modificados de una transacción, bloqueo que se mantiene hasta que se completa la transacción, independientemente del nivel de aislamiento seleccionado para la misma.</span><span class="sxs-lookup"><span data-stu-id="33c05-362">A transaction always gets an exclusive lock on any data it modifies, and holds that lock until the transaction completes, regardless of the isolation level set for that transaction.</span></span> <span data-ttu-id="33c05-363">En el caso de las operaciones de lectura, los niveles de aislamiento de transacción definen básicamente el nivel de protección contra los efectos de las modificaciones que realizan otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-363">For read operations, transaction isolation levels primarily define the level of protection from the effects of modifications made by other transactions.</span></span>  
  
 <span data-ttu-id="33c05-364">Un nivel de aislamiento menor significa que los usuarios tienen un mayor acceso a los datos simultáneamente, con lo que aumentan los efectos de simultaneidad que pueden experimentar, como las lecturas desfasadas o la pérdida de actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-364">A lower isolation level increases the ability of many users to access data at the same time, but increases the number of concurrency effects (such as dirty reads or lost updates) users might encounter.</span></span> <span data-ttu-id="33c05-365">Por el contrario, un nivel de aislamiento mayor reduce los tipos de efectos de simultaneidad, pero requiere más recursos del sistema y aumenta las posibilidades de que una transacción bloquee otra.</span><span class="sxs-lookup"><span data-stu-id="33c05-365">Conversely, a higher isolation level reduces the types of concurrency effects that users may encounter, but requires more system resources and increases the chances that one transaction will block another.</span></span> <span data-ttu-id="33c05-366">El nivel de aislamiento apropiado depende del equilibrio entre los requisitos de integridad de los datos de la aplicación y la sobrecarga de cada nivel de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-366">Choosing the appropriate isolation level depends on balancing the data integrity requirements of the application against the overhead of each isolation level.</span></span> <span data-ttu-id="33c05-367">El nivel de aislamiento superior, que es serializable, garantiza que una transacción recuperará exactamente los mismos datos cada vez que repita una operación de lectura, aunque para ello aplicará un nivel de bloqueo que puede afectar a los demás usuarios en los sistemas multiusuario.</span><span class="sxs-lookup"><span data-stu-id="33c05-367">The highest isolation level, serializable, guarantees that a transaction will retrieve exactly the same data every time it repeats a read operation, but it does this by performing a level of locking that is likely to impact other users in multi-user systems.</span></span> <span data-ttu-id="33c05-368">El nivel de aislamiento inferior, de lectura sin confirmar, puede recuperar datos modificados pero no confirmados por otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-368">The lowest isolation level, read uncommitted, may retrieve data that has been modified but not committed by other transactions.</span></span> <span data-ttu-id="33c05-369">En este nivel se pueden producir todos los efectos secundarios de simultaneidad, pero no hay bloqueos ni versiones de lectura, por lo que se minimiza la sobrecarga.</span><span class="sxs-lookup"><span data-stu-id="33c05-369">All of the concurrency side effects can happen in read uncommitted, but there is no read locking or versioning, so overhead is minimized.</span></span>  
  
##### <a name="database-engine-isolation-levels"></a><span data-ttu-id="33c05-370">Niveles de aislamiento del motor de base de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-370">Database Engine Isolation Levels</span></span>  

 <span data-ttu-id="33c05-371">El estándar ISO define los niveles de aislamiento siguientes, todos ellos compatibles con el [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="33c05-371">The ISO standard defines the following isolation levels, all of which are supported by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span></span>  
  
|<span data-ttu-id="33c05-372">Nivel de aislamiento</span><span class="sxs-lookup"><span data-stu-id="33c05-372">Isolation Level</span></span>|<span data-ttu-id="33c05-373">Definición</span><span class="sxs-lookup"><span data-stu-id="33c05-373">Definition</span></span>|  
|---------------------|----------------|  
|<span data-ttu-id="33c05-374">Lectura no confirmada</span><span class="sxs-lookup"><span data-stu-id="33c05-374">Read uncommitted</span></span>|<span data-ttu-id="33c05-375">El nivel más bajo de aislamiento donde se aíslan las transacciones lo suficiente como para garantizar que no se leen datos físicamente dañados.</span><span class="sxs-lookup"><span data-stu-id="33c05-375">The lowest isolation level where transactions are isolated only enough to ensure that physically corrupt data is not read.</span></span> <span data-ttu-id="33c05-376">En este nivel, se permiten las lecturas no actualizadas por lo que es posible que una transacción vea cambios que no se han confirmado aún efectuados por otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-376">In this level, dirty reads are allowed, so one transaction may see not-yet-committed changes made by other transactions.</span></span>|  
|<span data-ttu-id="33c05-377">Lectura confirmada</span><span class="sxs-lookup"><span data-stu-id="33c05-377">Read committed</span></span>|<span data-ttu-id="33c05-378">Permite que una transacción lea los datos previamente leídos (no modificados) por otra transacción, sin tener que esperar a que la primera transacción finalice.</span><span class="sxs-lookup"><span data-stu-id="33c05-378">Allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="33c05-379">El [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene los bloqueos de lectura (adquiridos en datos seleccionados) hasta el final de la transacción, pero los bloqueos de lectura se liberan tan pronto se efectúa la operación SELECT.</span><span class="sxs-lookup"><span data-stu-id="33c05-379">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps write locks (acquired on selected data) until the end of the transaction, but read locks are released as soon as the SELECT operation is performed.</span></span> <span data-ttu-id="33c05-380">Este es el nivel predeterminado del [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-380">This is the [!INCLUDE[ssDE](../includes/ssde-md.md)] default level.</span></span>|  
|<span data-ttu-id="33c05-381">Lectura repetible</span><span class="sxs-lookup"><span data-stu-id="33c05-381">Repeatable read</span></span>|<span data-ttu-id="33c05-382">El [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene los bloqueos de lectura y escritura adquiridos en datos seleccionados hasta el final de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-382">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks that are acquired on selected data until the end of the transaction.</span></span> <span data-ttu-id="33c05-383">Sin embargo, puesto que los bloqueos de rangos no están administrados, pueden darse lecturas fantasma.</span><span class="sxs-lookup"><span data-stu-id="33c05-383">However, because range-locks are not managed, phantom reads can occur.</span></span>|  
|<span data-ttu-id="33c05-384">Serializable</span><span class="sxs-lookup"><span data-stu-id="33c05-384">Serializable</span></span>|<span data-ttu-id="33c05-385">El nivel más alto, en el que se aíslan completamente las transacciones entre sí.</span><span class="sxs-lookup"><span data-stu-id="33c05-385">The highest level where transactions are completely isolated from one another.</span></span> <span data-ttu-id="33c05-386">El [!INCLUDE[ssDE](../includes/ssde-md.md)] mantiene los bloqueos de lectura y escritura adquiridos en datos seleccionados y que se liberarán al final de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-386">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks acquired on selected data to be released at the end of the transaction.</span></span> <span data-ttu-id="33c05-387">Los bloqueos de rangos se adquieren cuando una operación SELECT utiliza una cláusula WHERE con rango, especialmente para evitar lecturas fantasma.</span><span class="sxs-lookup"><span data-stu-id="33c05-387">Range-locks are acquired when a SELECT operation uses a ranged WHERE clause, especially to avoid phantom reads.</span></span><br /><br /> <span data-ttu-id="33c05-388">**Nota:** Al solicitar el nivel de aislamiento serializable se puede producir un error en las operaciones DDL y las transacciones de tablas replicadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-388">**Note:** DDL operations and transactions on replicated tables may fail when serializable isolation level is requested.</span></span> <span data-ttu-id="33c05-389">La causa es que en las consultas de replicación se utilizan sugerencias que pueden ser incompatibles con el nivel de aislamiento serializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-389">This is because replication queries use hints that may be incompatible with serializable isolation level.</span></span>|  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="33c05-390">también admite dos niveles de aislamiento de transacción adicionales que utilizan versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-390">also supports two additional transaction isolation levels that use row versioning.</span></span> <span data-ttu-id="33c05-391">Uno es una implementación de aislamiento de lectura confirmada y el otro un nivel de aislamiento de transacción, la instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-391">One is an implementation of read committed isolation, and one is a transaction isolation level, snapshot.</span></span>  
  
|<span data-ttu-id="33c05-392">Nivel de aislamiento de versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-392">Row Versioning Isolation Level</span></span>|<span data-ttu-id="33c05-393">Definición</span><span class="sxs-lookup"><span data-stu-id="33c05-393">Definition</span></span>|  
|------------------------------------|----------------|  
|<span data-ttu-id="33c05-394">Instantánea de lectura confirmada</span><span class="sxs-lookup"><span data-stu-id="33c05-394">Read Committed Snapshot</span></span>|<span data-ttu-id="33c05-395">Cuando el valor de la opción de base de datos READ_COMMITTED_SNAPSHOT es ON, el aislamiento de lectura confirmada utiliza las versiones de fila para proporcionar una coherencia de lectura en las instrucciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-395">When the READ_COMMITTED_SNAPSHOT database option is set ON, read committed isolation uses row versioning to provide statement-level read consistency.</span></span> <span data-ttu-id="33c05-396">Las operaciones de lectura solo requieren bloqueos de tablas SCH-S, pero no bloqueos de páginas ni filas.</span><span class="sxs-lookup"><span data-stu-id="33c05-396">Read operations require only SCH-S table level locks and no page or row locks.</span></span> <span data-ttu-id="33c05-397">Es decir, el motor de base de datos utiliza versiones de fila para presentar a cada instrucción una instantánea coherente, desde el punto de vista transaccional, de los datos tal como se encontraban al comenzar la instrucción.</span><span class="sxs-lookup"><span data-stu-id="33c05-397">That is, the Database Engine uses row versioning to present each statement with a transactionally consistent snapshot of the data as it existed at the start of the statement.</span></span> <span data-ttu-id="33c05-398">No se emplean bloqueos para impedir que otras transacciones actualicen los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-398">Locks are not used to protect the data from updates by other transactions.</span></span> <span data-ttu-id="33c05-399">Una función definida por el usuario puede devolver datos confirmados después del inicio de la instrucción que contiene que la UDF.</span><span class="sxs-lookup"><span data-stu-id="33c05-399">A user-defined function can return data that was committed after the time the statement containing the UDF began.</span></span><br /><br /> <span data-ttu-id="33c05-400">Cuando la opción de base de datos READ_COMMITTED_SNAPSHOT está establecida en OFF, que es el valor de configuración predeterminado, el aislamiento confirmado de lectura utiliza bloqueos compartidos para evitar que otras transacciones modifiquen filas mientras la transacción actual está ejecutando una operación de lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-400">When the READ_COMMITTED_SNAPSHOT database option is set OFF, which is the default setting, read committed isolation uses shared locks to prevent other transactions from modifying rows while the current transaction is running a read operation.</span></span> <span data-ttu-id="33c05-401">Los bloqueos compartidos impiden también que la instrucción lea las filas modificadas por otras transacciones hasta que la otra transacción haya finalizado.</span><span class="sxs-lookup"><span data-stu-id="33c05-401">The shared locks also block the statement from reading rows modified by other transactions until the other transaction is completed.</span></span> <span data-ttu-id="33c05-402">Ambas implementaciones cumplen la definición ISO del aislamiento de lectura confirmada.</span><span class="sxs-lookup"><span data-stu-id="33c05-402">Both implementations meet the ISO definition of read committed isolation.</span></span>|  
|<span data-ttu-id="33c05-403">Instantánea</span><span class="sxs-lookup"><span data-stu-id="33c05-403">Snapshot</span></span>|<span data-ttu-id="33c05-404">El nivel de aislamiento de instantánea utiliza las versiones de fila para proporcionar una coherencia de lectura en las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-404">The snapshot isolation level uses row versioning to provide transaction-level read consistency.</span></span> <span data-ttu-id="33c05-405">No se adquiere ningún bloqueo de páginas ni filas en las operaciones de lectura, solo los bloqueos de tabla SCH-S.</span><span class="sxs-lookup"><span data-stu-id="33c05-405">Read operations acquire no page or row locks; only SCH-S table locks are acquired.</span></span> <span data-ttu-id="33c05-406">Cuando se leen filas modificadas por otras transacciones, se recupera la versión de la fila que existía cuando empezó la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-406">When reading rows modified by another transaction, they retrieve the version of the row that existed when the transaction started.</span></span> <span data-ttu-id="33c05-407">El aislamiento de instantánea solo se puede utilizar en una base de datos cuando la opción de base de datos ALLOW_SNAPSHOT_ISOLATION es ON.</span><span class="sxs-lookup"><span data-stu-id="33c05-407">You can only use Snapshot isolation against a database when the ALLOW_SNAPSHOT_ISOLATION database option is set ON.</span></span> <span data-ttu-id="33c05-408">De forma predeterminada, el valor de esta opción es OFF para las bases de datos de usuarios.</span><span class="sxs-lookup"><span data-stu-id="33c05-408">By default, this option is set OFF for user databases.</span></span><br /><br /> <span data-ttu-id="33c05-409">**Nota:** [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] no permite controlar las versiones de los metadatos.</span><span class="sxs-lookup"><span data-stu-id="33c05-409">**Note:**  [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] does not support versioning of metadata.</span></span> <span data-ttu-id="33c05-410">Por ello, hay restricciones en qué operaciones de DDL se puede realizar en una transacción explícita que se está ejecutando bajo el aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-410">For this reason, there are restrictions on what DDL operations can be performed in an explicit transaction that is running under snapshot isolation.</span></span> <span data-ttu-id="33c05-411">No se permiten las siguientes instrucciones DDL en el aislamiento de instantánea después de una instrucción BEGIN TRANSACTION: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME o cualquier instrucción de DDL de Common Language Runtime (CLR).</span><span class="sxs-lookup"><span data-stu-id="33c05-411">The following DDL statements are not permitted under snapshot isolation after a BEGIN TRANSACTION statement: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME, or any common language runtime (CLR) DDL statement.</span></span> <span data-ttu-id="33c05-412">Estas instrucciones se permiten cuando usa el aislamiento de la instantánea en transacciones implícitas.</span><span class="sxs-lookup"><span data-stu-id="33c05-412">These statements are permitted when you are using snapshot isolation within implicit transactions.</span></span> <span data-ttu-id="33c05-413">Una transacción implícita, por definición, es una instrucción única que permite aplicar la semántica del aislamiento de instantánea, incluso con instrucciones de DDL.</span><span class="sxs-lookup"><span data-stu-id="33c05-413">An implicit transaction, by definition, is a single statement that makes it possible to enforce the semantics of snapshot isolation, even with DDL statements.</span></span> <span data-ttu-id="33c05-414">Las infracciones de este principio pueden producir error 3961: "Error de la transacción de aislamiento de instantánea en la base de datos '%. \* ls' porque el objeto al que tuvo acceso la instrucción ha sido modificado por una instrucción DDL de otra transacción simultánea desde el inicio de esta transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-414">Violations of this principle can cause error 3961: "Snapshot isolation transaction failed in database '%.\*ls' because the object accessed by the statement has been modified by a DDL statement in another concurrent transaction since the start of this transaction.</span></span> <span data-ttu-id="33c05-415">No se permite porque los metadatos no tienen control de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-415">It is not allowed because the metadata is not versioned.</span></span> <span data-ttu-id="33c05-416">Una actualización simultánea de los metadatos puede dar lugar a incoherencias si se combina con aislamiento de instantánea."</span><span class="sxs-lookup"><span data-stu-id="33c05-416">A concurrent update to metadata could lead to inconsistency if mixed with snapshot isolation."</span></span>|  
  
 <span data-ttu-id="33c05-417">En la tabla siguiente se muestran los efectos secundarios de la simultaneidad habilitados por los distintos niveles de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-417">The following table shows the concurrency side effects enabled by the different isolation levels.</span></span>  
  
|<span data-ttu-id="33c05-418">Nivel de aislamiento</span><span class="sxs-lookup"><span data-stu-id="33c05-418">Isolation level</span></span>|<span data-ttu-id="33c05-419">Lectura desfasada</span><span class="sxs-lookup"><span data-stu-id="33c05-419">Dirty read</span></span>|<span data-ttu-id="33c05-420">Lectura no repetible</span><span class="sxs-lookup"><span data-stu-id="33c05-420">Nonrepeatable read</span></span>|<span data-ttu-id="33c05-421">Fantasma</span><span class="sxs-lookup"><span data-stu-id="33c05-421">Phantom</span></span>|  
|---------------------|----------------|------------------------|-------------|  
|<span data-ttu-id="33c05-422">**Lectura pendiente de confirmación**</span><span class="sxs-lookup"><span data-stu-id="33c05-422">**Read uncommitted**</span></span>|<span data-ttu-id="33c05-423">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-423">Yes</span></span>|<span data-ttu-id="33c05-424">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-424">Yes</span></span>|<span data-ttu-id="33c05-425">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-425">Yes</span></span>|  
|<span data-ttu-id="33c05-426">**Lectura confirmada**</span><span class="sxs-lookup"><span data-stu-id="33c05-426">**Read committed**</span></span>|<span data-ttu-id="33c05-427">No</span><span class="sxs-lookup"><span data-stu-id="33c05-427">No</span></span>|<span data-ttu-id="33c05-428">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-428">Yes</span></span>|<span data-ttu-id="33c05-429">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-429">Yes</span></span>|  
|<span data-ttu-id="33c05-430">**Lectura repetible**</span><span class="sxs-lookup"><span data-stu-id="33c05-430">**Repeatable read**</span></span>|<span data-ttu-id="33c05-431">No</span><span class="sxs-lookup"><span data-stu-id="33c05-431">No</span></span>|<span data-ttu-id="33c05-432">No</span><span class="sxs-lookup"><span data-stu-id="33c05-432">No</span></span>|<span data-ttu-id="33c05-433">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-433">Yes</span></span>|  
|<span data-ttu-id="33c05-434">**Instantánea**</span><span class="sxs-lookup"><span data-stu-id="33c05-434">**Snapshot**</span></span>|<span data-ttu-id="33c05-435">No</span><span class="sxs-lookup"><span data-stu-id="33c05-435">No</span></span>|<span data-ttu-id="33c05-436">No</span><span class="sxs-lookup"><span data-stu-id="33c05-436">No</span></span>|<span data-ttu-id="33c05-437">No</span><span class="sxs-lookup"><span data-stu-id="33c05-437">No</span></span>|  
|<span data-ttu-id="33c05-438">**Serializable**</span><span class="sxs-lookup"><span data-stu-id="33c05-438">**Serializable**</span></span>|<span data-ttu-id="33c05-439">No</span><span class="sxs-lookup"><span data-stu-id="33c05-439">No</span></span>|<span data-ttu-id="33c05-440">No</span><span class="sxs-lookup"><span data-stu-id="33c05-440">No</span></span>|<span data-ttu-id="33c05-441">No</span><span class="sxs-lookup"><span data-stu-id="33c05-441">No</span></span>|  
  
 <span data-ttu-id="33c05-442">Para obtener más información sobre los tipos de bloqueo específicos o las versiones de fila que controlan cada nivel de aislamiento de transacción, vea [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-442">For more information about the specific types of locking or row versioning controlled by each transaction isolation level, see [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-443">Se pueden establecer los niveles de aislamiento de transacción con [!INCLUDE[tsql](../includes/tsql-md.md)] o mediante una API de bases de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-443">Transaction isolation levels can be set using [!INCLUDE[tsql](../includes/tsql-md.md)] or through a database API.</span></span>  
  
 [!INCLUDE[tsql](../includes/tsql-md.md)]  
 <span data-ttu-id="33c05-444">Los scripts [!INCLUDE[tsql](../includes/tsql-md.md)] utilizan la instrucción SET TRANSACTION ISOLATION LEVEL.</span><span class="sxs-lookup"><span data-stu-id="33c05-444">[!INCLUDE[tsql](../includes/tsql-md.md)] scripts use the SET TRANSACTION ISOLATION LEVEL statement.</span></span>  
  
 <span data-ttu-id="33c05-445">ADO</span><span class="sxs-lookup"><span data-stu-id="33c05-445">ADO</span></span>  
 <span data-ttu-id="33c05-446">Las aplicaciones ADO establecen la propiedad `IsolationLevel` del objeto **Connection** como adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead o adXactReadSerializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-446">ADO applications set the `IsolationLevel` property of the **Connection** object to adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead, or adXactReadSerializable.</span></span>  
  
 <span data-ttu-id="33c05-447">ADO.NET</span><span class="sxs-lookup"><span data-stu-id="33c05-447">ADO.NET</span></span>  
 <span data-ttu-id="33c05-448">Las aplicaciones ADO.NET que usan el espacio de nombres administrado por `System.Data.SqlClient` pueden llamar al método `SqlConnection.BeginTransaction` y establecer la opción *IsolationLevel* en Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable y Snapshot.</span><span class="sxs-lookup"><span data-stu-id="33c05-448">ADO.NET applications using the `System.Data.SqlClient` managed namespace can call the `SqlConnection.BeginTransaction` method and set the *IsolationLevel* option to Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable, and Snapshot.</span></span>  
  
 <span data-ttu-id="33c05-449">OLE DB</span><span class="sxs-lookup"><span data-stu-id="33c05-449">OLE DB</span></span>  
 <span data-ttu-id="33c05-450">Cuando se inicia una transacción, las aplicaciones que utilizan OLE DB llaman a `ITransactionLocal::StartTransaction` con *isoLevel* establecido en ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT o ISOLATIONLEVEL_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="33c05-450">When starting a transaction, applications using OLE DB call `ITransactionLocal::StartTransaction` with *isoLevel* set to ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT, or ISOLATIONLEVEL_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="33c05-451">Cuando se especifica el nivel de aislamiento de transacción en el modo de confirmación automática, las aplicaciones OLE DB pueden establecer la propiedad DBPROP_SESS_AUTOCOMMITISOLEVELS de DBPROPSET_SESSION en DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED o DBPROPVAL_TI_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="33c05-451">When specifying the transaction isolation level in autocommit mode, OLE DB applications can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED, or DBPROPVAL_TI_SNAPSHOT.</span></span>  
  
 <span data-ttu-id="33c05-452">ODBC</span><span class="sxs-lookup"><span data-stu-id="33c05-452">ODBC</span></span>  
 <span data-ttu-id="33c05-453">Las aplicaciones de ODBC llaman a `SQLSetConnectAttr` con *Attribute* establecido en SQL_ATTR_TXN_ISOLATION y *ValuePtr* establecido en SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ o SQL_TXN_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="33c05-453">ODBC applications call `SQLSetConnectAttr` with *Attribute* set to SQL_ATTR_TXN_ISOLATION and *ValuePtr* set to SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ, or SQL_TXN_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="33c05-454">Para las transacciones de instantáneas, las aplicaciones llaman a `SQLSetConnectAttr` con Attribute establecido en SQL_COPT_SS_TXN_ISOLATION y ValuePtr establecido en SQL_TXN_SS_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="33c05-454">For snapshot transactions, applications call `SQLSetConnectAttr` with Attribute set to SQL_COPT_SS_TXN_ISOLATION and ValuePtr set to SQL_TXN_SS_SNAPSHOT.</span></span> <span data-ttu-id="33c05-455">Una transacción de instantánea se puede recuperar mediante SQL_COPT_SS_TXN_ISOLATION o SQL_ATTR_TXN_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="33c05-455">A snapshot transaction can be retrieved using either SQL_COPT_SS_TXN_ISOLATION or SQL_ATTR_TXN_ISOLATION.</span></span>  
  
 <span data-ttu-id="33c05-456">![Icono de flecha usado con el vínculo volver al principio](media/uparrow16x16.gif "Icono de flecha usado con el vínculo Volver al principio") [de esta guía](#Top)</span><span class="sxs-lookup"><span data-stu-id="33c05-456">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-in-the-database-engine"></a><a name="Lock_Engine"></a> <span data-ttu-id="33c05-457">Bloqueo del motor de base de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-457">Locking in the Database Engine</span></span>  

 <span data-ttu-id="33c05-458">El bloqueo es el mecanismo que utiliza el [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] para sincronizar el acceso por parte de varios usuarios al mismo elemento de datos simultáneamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-458">Locking is a mechanism used by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] to synchronize access by multiple users to the same piece of data at the same time.</span></span>  
  
 <span data-ttu-id="33c05-459">Antes de que una transacción obtenga una dependencia del estado actual de un elemento de datos, como la lectura o modificación de los datos, debe protegerse de los efectos de otra transacción que modifica los mismos datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-459">Before a transaction acquires a dependency on the current state of a piece of data, such as by reading or modifying the data, it must protect itself from the effects of another transaction modifying the same data.</span></span> <span data-ttu-id="33c05-460">Para ello, la transacción solicita un bloqueo en el elemento de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-460">The transaction does this by requesting a lock on the piece of data.</span></span> <span data-ttu-id="33c05-461">Los bloqueos disponen de diferentes modos, como compartido o exclusivo.</span><span class="sxs-lookup"><span data-stu-id="33c05-461">Locks have different modes, such as shared or exclusive.</span></span> <span data-ttu-id="33c05-462">El modo del bloqueo indica el nivel de dependencia que la transacción tiene sobre los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-462">The lock mode defines the level of dependency the transaction has on the data.</span></span> <span data-ttu-id="33c05-463">No se puede conceder a una transacción un bloqueo que genere un conflicto con el modo de un bloqueo ya concedido para unos datos a otra transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-463">No transaction can be granted a lock that would conflict with the mode of a lock already granted on that data to another transaction.</span></span> <span data-ttu-id="33c05-464">Si una transacción solicita un modo de bloqueo que cree un conflicto con otro bloqueo ya concedido sobre los mismos datos, la instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)] pausará la transacción que realiza la solicitud hasta que se libere el primer bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-464">If a transaction requests a lock mode that conflicts with a lock that has already been granted on the same data, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] will pause the requesting transaction until the first lock is released.</span></span>  
  
 <span data-ttu-id="33c05-465">Si una transacción modifica un elemento de datos, conserva el bloqueo que protege la modificación hasta el final de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-465">When a transaction modifies a piece of data, it holds the lock protecting the modification until the end of the transaction.</span></span> <span data-ttu-id="33c05-466">El tiempo que una transacción conserva los bloqueos obtenidos para proteger operaciones de lectura depende de la configuración del nivel de aislamiento de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-466">How long a transaction holds the locks acquired to protect read operations depends on the transaction isolation level setting.</span></span> <span data-ttu-id="33c05-467">Todos los bloqueos de una transacción se liberan cuando ésta finaliza (se confirma o se revierte).</span><span class="sxs-lookup"><span data-stu-id="33c05-467">All locks held by a transaction are released when the transaction completes (either commits or rolls back).</span></span>  
  
 <span data-ttu-id="33c05-468">Por regla general, las aplicaciones no solicitan los bloqueos directamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-468">Applications do not typically request locks directly.</span></span> <span data-ttu-id="33c05-469">Una parte de [!INCLUDE[ssDE](../includes/ssde-md.md)], denominada administrador de bloqueos, es la que se encarga de administrar los bloqueos de forma interna.</span><span class="sxs-lookup"><span data-stu-id="33c05-469">Locks are managed internally by a part of the [!INCLUDE[ssDE](../includes/ssde-md.md)] called the lock manager.</span></span> <span data-ttu-id="33c05-470">Cuando una instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)] procesa una instrucción [!INCLUDE[tsql](../includes/tsql-md.md)], el procesador de consultas de [!INCLUDE[ssDE](../includes/ssde-md.md)] determina los recursos a los que se va a tener acceso.</span><span class="sxs-lookup"><span data-stu-id="33c05-470">When an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] processes a [!INCLUDE[tsql](../includes/tsql-md.md)] statement, the [!INCLUDE[ssDE](../includes/ssde-md.md)] query processor determines which resources are to be accessed.</span></span> <span data-ttu-id="33c05-471">El procesador de consultas determina también qué tipos de bloqueos se necesitan para proteger cada recurso, basándose en el tipo de acceso y en la configuración del nivel de aislamiento de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-471">The query processor determines what types of locks are required to protect each resource based on the type of access and the transaction isolation level setting.</span></span> <span data-ttu-id="33c05-472">A continuación, el procesador de consultas solicita los bloqueos adecuados al administrador de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-472">The query processor then requests the appropriate locks from the lock manager.</span></span> <span data-ttu-id="33c05-473">Éste concede los bloqueos si no existen bloqueos en conflicto de otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-473">The lock manager grants the locks if there are no conflicting locks held by other transactions.</span></span>  
  
### <a name="lock-granularity-and-hierarchies"></a><span data-ttu-id="33c05-474">Granularidad y jerarquías de bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-474">Lock Granularity and Hierarchies</span></span>  

 <span data-ttu-id="33c05-475">El [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] admite bloqueo multigranular. Esta función permite que una transacción bloquee diferentes tipos de recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-475">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] has multigranular locking that allows different types of resources to be locked by a transaction.</span></span> <span data-ttu-id="33c05-476">Para minimizar el costo del bloqueo, [!INCLUDE[ssDE](../includes/ssde-md.md)] bloquea automáticamente los recursos en el nivel apropiado para la tarea.</span><span class="sxs-lookup"><span data-stu-id="33c05-476">To minimize the cost of locking, the [!INCLUDE[ssDE](../includes/ssde-md.md)] locks resources automatically at a level appropriate to the task.</span></span> <span data-ttu-id="33c05-477">Los bloqueos de menor granularidad, como es el caso de las filas, aumentan la simultaneidad. Sin embargo, se produce una sobrecarga mayor porque cuantas más filas se bloquean, más bloqueos se deben mantener.</span><span class="sxs-lookup"><span data-stu-id="33c05-477">Locking at a smaller granularity, such as rows, increases concurrency but has a higher overhead because more locks must be held if many rows are locked.</span></span> <span data-ttu-id="33c05-478">Los bloqueos realizados en una granularidad alta, por ejemplo en tablas, reducen la simultaneidad porque el bloqueo de toda una tabla restringe el acceso de otras transacciones a cualquier parte de la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-478">Locking at a larger granularity, such as tables, are expensive in terms of concurrency because locking an entire table restricts access to any part of the table by other transactions.</span></span> <span data-ttu-id="33c05-479">Sin embargo, produce una sobrecarga menor debido a que se mantienen menos bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-479">However, it has a lower overhead because fewer locks are being maintained.</span></span>  
  
 <span data-ttu-id="33c05-480">El [!INCLUDE[ssDE](../includes/ssde-md.md)] a menudo se ve en la obligación de adquirir bloqueos en distintos niveles de granularidad para brindar una protección completa a un recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-480">The [!INCLUDE[ssDE](../includes/ssde-md.md)] often has to acquire locks at multiple levels of granularity to fully protect a resource.</span></span> <span data-ttu-id="33c05-481">Este grupo de bloqueos en distintos niveles de granularidad se denomina jerarquía de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-481">This group of locks at multiple levels of granularity is called a lock hierarchy.</span></span> <span data-ttu-id="33c05-482">Por ejemplo, para brindar protección completa a la lectura de un índice, probablemente sea necesario que una instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)] adquiera bloqueos compartidos en filas y bloqueos con intención compartida en las páginas y la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-482">For example, to fully protect a read of an index, an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] may have to acquire share locks on rows and intent share locks on the pages and table.</span></span>  
  
 <span data-ttu-id="33c05-483">En la siguiente tabla se muestran los recursos que el [!INCLUDE[ssDE](../includes/ssde-md.md)] puede bloquear.</span><span class="sxs-lookup"><span data-stu-id="33c05-483">The following table shows the resources that the [!INCLUDE[ssDE](../includes/ssde-md.md)] can lock.</span></span>  
  
|<span data-ttu-id="33c05-484">Recurso</span><span class="sxs-lookup"><span data-stu-id="33c05-484">Resource</span></span>|<span data-ttu-id="33c05-485">Descripción</span><span class="sxs-lookup"><span data-stu-id="33c05-485">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="33c05-486">RID</span><span class="sxs-lookup"><span data-stu-id="33c05-486">RID</span></span>|<span data-ttu-id="33c05-487">Identificador de fila que se utiliza para bloquear una sola fila de un montón.</span><span class="sxs-lookup"><span data-stu-id="33c05-487">A row identifier used to lock a single row within a heap.</span></span>|  
|<span data-ttu-id="33c05-488">KEY</span><span class="sxs-lookup"><span data-stu-id="33c05-488">KEY</span></span>|<span data-ttu-id="33c05-489">Bloqueo de fila dentro de un índice que se utiliza para proteger intervalos de claves en transacciones serializables.</span><span class="sxs-lookup"><span data-stu-id="33c05-489">A row lock within an index used to protect key ranges in serializable transactions.</span></span>|  
|<span data-ttu-id="33c05-490">PAGE</span><span class="sxs-lookup"><span data-stu-id="33c05-490">PAGE</span></span>|<span data-ttu-id="33c05-491">Página de 8 kilobytes (KB) de una base de datos, como páginas de datos o de índices.</span><span class="sxs-lookup"><span data-stu-id="33c05-491">An 8-kilobyte (KB) page in a database, such as data or index pages.</span></span>|  
|<span data-ttu-id="33c05-492">EXTENT</span><span class="sxs-lookup"><span data-stu-id="33c05-492">EXTENT</span></span>|<span data-ttu-id="33c05-493">Grupo contiguo de ocho páginas, como páginas de datos o de índices.</span><span class="sxs-lookup"><span data-stu-id="33c05-493">A contiguous group of eight pages, such as data or index pages.</span></span>|  
|<span data-ttu-id="33c05-494">HoBT</span><span class="sxs-lookup"><span data-stu-id="33c05-494">HoBT</span></span>|<span data-ttu-id="33c05-495">Montón o árbol b.</span><span class="sxs-lookup"><span data-stu-id="33c05-495">A heap or B-tree.</span></span> <span data-ttu-id="33c05-496">Bloqueo que protege un árbol B (índice) o las páginas de datos del montón en una tabla que no posee un índice clúster.</span><span class="sxs-lookup"><span data-stu-id="33c05-496">A lock protecting a B-tree (index) or the heap data pages in a table that does not have a clustered index.</span></span>|  
|<span data-ttu-id="33c05-497">TABLE</span><span class="sxs-lookup"><span data-stu-id="33c05-497">TABLE</span></span>|<span data-ttu-id="33c05-498">Tabla completa, con todos los datos e índices.</span><span class="sxs-lookup"><span data-stu-id="33c05-498">The entire table, including all data and indexes.</span></span>|  
|<span data-ttu-id="33c05-499">FILE</span><span class="sxs-lookup"><span data-stu-id="33c05-499">FILE</span></span>|<span data-ttu-id="33c05-500">Archivos de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-500">A database file.</span></span>|  
|<span data-ttu-id="33c05-501">APPLICATION</span><span class="sxs-lookup"><span data-stu-id="33c05-501">APPLICATION</span></span>|<span data-ttu-id="33c05-502">Recurso especificado por la aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-502">An application-specified resource.</span></span>|  
|<span data-ttu-id="33c05-503">METADATOS</span><span class="sxs-lookup"><span data-stu-id="33c05-503">METADATA</span></span>|<span data-ttu-id="33c05-504">Bloqueos de metadatos.</span><span class="sxs-lookup"><span data-stu-id="33c05-504">Metadata locks.</span></span>|  
|<span data-ttu-id="33c05-505">ALLOCATION_UNIT</span><span class="sxs-lookup"><span data-stu-id="33c05-505">ALLOCATION_UNIT</span></span>|<span data-ttu-id="33c05-506">Unidad de asignación.</span><span class="sxs-lookup"><span data-stu-id="33c05-506">An allocation unit.</span></span>|  
|<span data-ttu-id="33c05-507">DATABASE</span><span class="sxs-lookup"><span data-stu-id="33c05-507">DATABASE</span></span>|<span data-ttu-id="33c05-508">Base de datos completa.</span><span class="sxs-lookup"><span data-stu-id="33c05-508">The entire database.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-509">La opción LOCK_ESCALATION de [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql) puede afectar a los bloqueos HoBT y TABLE.</span><span class="sxs-lookup"><span data-stu-id="33c05-509">HoBT and TABLE locks can be affected by the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="lock-modes"></a><span data-ttu-id="33c05-510">Modos de bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-510">Lock Modes</span></span>  

 <span data-ttu-id="33c05-511">El [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] bloquea los recursos con diferentes modos de bloqueo que determinan el modo en que las transacciones simultáneas pueden tener acceso a los recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-511">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] locks resources using different lock modes that determine how the resources can be accessed by concurrent transactions.</span></span>  
  
 <span data-ttu-id="33c05-512">En la siguiente tabla se indican los modos de bloqueo de recursos que emplea [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-512">The following table shows the resource lock modes that the [!INCLUDE[ssDE](../includes/ssde-md.md)] uses.</span></span>  
  
|<span data-ttu-id="33c05-513">Modo de bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-513">Lock mode</span></span>|<span data-ttu-id="33c05-514">Descripción</span><span class="sxs-lookup"><span data-stu-id="33c05-514">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="33c05-515">Compartido (S)</span><span class="sxs-lookup"><span data-stu-id="33c05-515">Shared (S)</span></span>|<span data-ttu-id="33c05-516">Se utiliza para operaciones de lectura que no cambian ni actualizan datos, como la instrucción SELECT.</span><span class="sxs-lookup"><span data-stu-id="33c05-516">Used for read operations that do not change or update data, such as a SELECT statement.</span></span>|  
|<span data-ttu-id="33c05-517">Actualizar (U)</span><span class="sxs-lookup"><span data-stu-id="33c05-517">Update (U)</span></span>|<span data-ttu-id="33c05-518">Se utiliza en recursos que se pueden actualizar.</span><span class="sxs-lookup"><span data-stu-id="33c05-518">Used on resources that can be updated.</span></span> <span data-ttu-id="33c05-519">Evita una forma común de interbloqueo que se produce cuando varias sesiones leen, bloquean y actualizan recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-519">Prevents a common form of deadlock that occurs when multiple sessions are reading, locking, and potentially updating resources later.</span></span>|  
|<span data-ttu-id="33c05-520">Exclusivo (X)</span><span class="sxs-lookup"><span data-stu-id="33c05-520">Exclusive (X)</span></span>|<span data-ttu-id="33c05-521">Se utiliza para operaciones de modificación de datos, como INSERT, UPDATE o DELETE.</span><span class="sxs-lookup"><span data-stu-id="33c05-521">Used for data-modification operations, such as INSERT, UPDATE, or DELETE.</span></span> <span data-ttu-id="33c05-522">Garantiza que no puedan realizarse varias actualizaciones simultáneamente en el mismo recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-522">Ensures that multiple updates cannot be made to the same resource at the same time.</span></span>|  
|<span data-ttu-id="33c05-523">Intención</span><span class="sxs-lookup"><span data-stu-id="33c05-523">Intent</span></span>|<span data-ttu-id="33c05-524">Se utiliza para establecer una jerarquía de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-524">Used to establish a lock hierarchy.</span></span> <span data-ttu-id="33c05-525">Los tipos de bloqueo de intención son: intención compartido (IS), intención exclusivo (IX) y compartido con intención exclusivo (SIX).</span><span class="sxs-lookup"><span data-stu-id="33c05-525">The types of intent locks are: intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>|  
|<span data-ttu-id="33c05-526">Schema</span><span class="sxs-lookup"><span data-stu-id="33c05-526">Schema</span></span>|<span data-ttu-id="33c05-527">Se utiliza cuando se ejecuta una operación que depende del esquema de una tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-527">Used when an operation dependent on the schema of a table is executing.</span></span> <span data-ttu-id="33c05-528">Hay dos tipos de bloqueo de esquema: modificación del esquema (Sch-M) y modificación de estabilidad (Sch-S).</span><span class="sxs-lookup"><span data-stu-id="33c05-528">The types of schema locks are: schema modification (Sch-M) and schema stability (Sch-S).</span></span>|  
|<span data-ttu-id="33c05-529">Actualización masiva (BU)</span><span class="sxs-lookup"><span data-stu-id="33c05-529">Bulk Update (BU)</span></span>|<span data-ttu-id="33c05-530">Se usa cuando se copian datos de forma masiva en una tabla y se especifica la sugerencia **TABLOCK**.</span><span class="sxs-lookup"><span data-stu-id="33c05-530">Used when bulk copying data into a table and the **TABLOCK** hint is specified.</span></span>|  
|<span data-ttu-id="33c05-531">Intervalo de claves</span><span class="sxs-lookup"><span data-stu-id="33c05-531">Key-range</span></span>|<span data-ttu-id="33c05-532">Protege el intervalo de filas que lee una consulta cuando se utiliza el nivel de aislamiento de transacciones serializables.</span><span class="sxs-lookup"><span data-stu-id="33c05-532">Protects the range of rows read by a query when using the serializable transaction isolation level.</span></span> <span data-ttu-id="33c05-533">Garantiza que otras transacciones no puedan insertar filas que podrían incluirse como respuesta de las consultas de la transacción serializable si las consultas se volvieran a ejecutar.</span><span class="sxs-lookup"><span data-stu-id="33c05-533">Ensures that other transactions cannot insert rows that would qualify for the queries of the serializable transaction if the queries were run again.</span></span>|  
  
#### <a name="shared-locks"></a><span data-ttu-id="33c05-534">Bloqueos compartidos</span><span class="sxs-lookup"><span data-stu-id="33c05-534">Shared Locks</span></span>  

 <span data-ttu-id="33c05-535">Los bloqueos compartidos (S) permiten que varias transacciones simultáneas lean (SELECT) un recurso en situaciones de control de simultaneidad pesimista.</span><span class="sxs-lookup"><span data-stu-id="33c05-535">Shared (S) locks allow concurrent transactions to read (SELECT) a resource under pessimistic concurrency control.</span></span> <span data-ttu-id="33c05-536">Ninguna otra transacción podrá modificar los datos mientras el bloqueo compartido (S) exista en el recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-536">No other transactions can modify the data while shared (S) locks exist on the resource.</span></span> <span data-ttu-id="33c05-537">Los bloqueos compartidos (S) en un recurso se liberan tan pronto como finaliza la operación de lectura, a menos que se haya establecido el nivel de aislamiento de la transacción como REPEATABLE READ o más alto, o bien se utilice una sugerencia de bloqueo para mantener los bloqueos compartidos (S) durante la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-537">Shared (S) locks on a resource are released as soon as the read operation completes, unless the transaction isolation level is set to repeatable read or higher, or a locking hint is used to retain the shared (S) locks for the duration of the transaction.</span></span>  
  
#### <a name="update-locks"></a><span data-ttu-id="33c05-538">Bloqueos de actualización</span><span class="sxs-lookup"><span data-stu-id="33c05-538">Update Locks</span></span>  

 <span data-ttu-id="33c05-539">Los bloqueos de actualización (U) evitan una forma común de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-539">Update (U) locks prevent a common form of deadlock.</span></span> <span data-ttu-id="33c05-540">En una transacción de lectura repetible o serializable, la transacción lee los datos, adquiere un bloqueo compartido (S) en el recurso (página o fila) y, a continuación, modifica los datos, lo que requiere una conversión del bloqueo en un bloqueo exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="33c05-540">In a repeatable read or serializable transaction, the transaction reads data, acquiring a shared (S) lock on the resource (page or row), and then modifies the data, which requires lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="33c05-541">Si dos transacciones adquieren bloqueos compartidos en un recurso y, a continuación, intentan actualizar los datos simultáneamente, una de ellas intenta convertir el bloqueo en un bloqueo exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="33c05-541">If two transactions acquire shared-mode locks on a resource and then attempt to update data concurrently, one transaction attempts the lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="33c05-542">La conversión de bloqueo compartido en exclusivo debe esperar, ya que el bloqueo exclusivo de una transacción no es compatible con el bloqueo compartido de la otra. Por tanto, se produce una espera de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-542">The shared-mode-to-exclusive lock conversion must wait because the exclusive lock for one transaction is not compatible with the shared-mode lock of the other transaction; a lock wait occurs.</span></span> <span data-ttu-id="33c05-543">La segunda transacción intenta adquirir un bloqueo exclusivo (X) para realizar su actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-543">The second transaction attempts to acquire an exclusive (X) lock for its update.</span></span> <span data-ttu-id="33c05-544">Debido a que ambas transacciones intentan convertir los bloqueos en exclusivos (X) y cada una espera a que la otra libere su bloqueo de modo compartido, se produce un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-544">Because both transactions are converting to exclusive (X) locks, and they are each waiting for the other transaction to release its shared-mode lock, a deadlock occurs.</span></span>  
  
 <span data-ttu-id="33c05-545">Para evitar este posible problema de interbloqueo, se utilizan los bloqueos de actualización (U).</span><span class="sxs-lookup"><span data-stu-id="33c05-545">To avoid this potential deadlock problem, update (U) locks are used.</span></span> <span data-ttu-id="33c05-546">Dos transacciones no pueden obtener simultáneamente un bloqueo de actualización (U) para un recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-546">Only one transaction can obtain an update (U) lock to a resource at a time.</span></span> <span data-ttu-id="33c05-547">Si una transacción modifica un recurso, el bloqueo de actualización (U) se convierte en un bloqueo exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="33c05-547">If a transaction modifies a resource, the update (U) lock is converted to an exclusive (X) lock.</span></span>  
  
#### <a name="exclusive-locks"></a><span data-ttu-id="33c05-548">Bloqueos exclusivos</span><span class="sxs-lookup"><span data-stu-id="33c05-548">Exclusive Locks</span></span>  

 <span data-ttu-id="33c05-549">Los bloqueos exclusivos (X) evitan que transacciones simultáneas tengan acceso a un recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-549">Exclusive (X) locks prevent access to a resource by concurrent transactions.</span></span> <span data-ttu-id="33c05-550">Al utilizar un bloqueo exclusivo (X), el resto de las transacciones no pueden modificar los datos; las operaciones de lectura solo se pueden realizar si se utiliza la sugerencia NOLOCK o el nivel de aislamiento de lectura no confirmada.</span><span class="sxs-lookup"><span data-stu-id="33c05-550">With an exclusive (X) lock, no other transactions can modify data; read operations can take place only with the use of the NOLOCK hint or read uncommitted isolation level.</span></span>  
  
 <span data-ttu-id="33c05-551">Las instrucciones para modificar datos, como INSERT, UPDATE y DELETE combinan las operaciones de modificación con las de lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-551">Data modification statements, such as INSERT, UPDATE, and DELETE combine both modification and read operations.</span></span> <span data-ttu-id="33c05-552">En primer lugar, la instrucción lleva a cabo operaciones de lectura para adquirir los datos antes de proceder a ejecutar las operaciones de modificación necesarias.</span><span class="sxs-lookup"><span data-stu-id="33c05-552">The statement first performs read operations to acquire data before performing the required modification operations.</span></span> <span data-ttu-id="33c05-553">Por tanto, las instrucciones de modificación de datos suelen solicitar bloqueos compartidos y exclusivos.</span><span class="sxs-lookup"><span data-stu-id="33c05-553">Data modification statements, therefore, typically request both shared locks and exclusive locks.</span></span> <span data-ttu-id="33c05-554">Por ejemplo, una instrucción UPDATE puede modificar las filas de una tabla a partir de una combinación con otra tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-554">For example, an UPDATE statement might modify rows in one table based on a join with another table.</span></span> <span data-ttu-id="33c05-555">En este caso, la instrucción UPDATE solicita bloqueos compartidos para la filas leídas en la tabla de combinación, además de bloqueos exclusivos para las filas actualizadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-555">In this case, the UPDATE statement requests shared locks on the rows read in the join table in addition to requesting exclusive locks on the updated rows.</span></span>  
  
#### <a name="intent-locks"></a><span data-ttu-id="33c05-556">Bloqueos con intención</span><span class="sxs-lookup"><span data-stu-id="33c05-556">Intent Locks</span></span>  

 <span data-ttu-id="33c05-557">[!INCLUDE[ssDE](../includes/ssde-md.md)] utiliza bloqueos con intención para proteger la aplicación de un bloqueo compartido (S) o exclusivo (X) en un recurso inferior en la jerarquía de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-557">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses intent locks to protect placing a shared (S) lock or exclusive (X) lock on a resource lower in the lock hierarchy.</span></span> <span data-ttu-id="33c05-558">Los bloqueos con intención se denominan así porque se adquieren antes que los bloqueos de los niveles inferiores y, por lo tanto, señalan la intención de aplicar bloqueos en un nivel inferior.</span><span class="sxs-lookup"><span data-stu-id="33c05-558">Intent locks are named intent locks because they are acquired before a lock at the lower level, and therefore signal intent to place locks at a lower level.</span></span>  
  
 <span data-ttu-id="33c05-559">Los bloqueos con intención se utilizan con dos fines:</span><span class="sxs-lookup"><span data-stu-id="33c05-559">Intent locks serve two purposes:</span></span>  
  
-   <span data-ttu-id="33c05-560">Para evitar que otras transacciones modifiquen el recurso de nivel superior de forma que invaliden el bloqueo del nivel inferior.</span><span class="sxs-lookup"><span data-stu-id="33c05-560">To prevent other transactions from modifying the higher-level resource in a way that would invalidate the lock at the lower level.</span></span>  
  
-   <span data-ttu-id="33c05-561">Para mejorar la eficacia de [!INCLUDE[ssDE](../includes/ssde-md.md)] para detectar conflictos de bloqueo en el nivel superior de granularidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-561">To improve the efficiency of the [!INCLUDE[ssDE](../includes/ssde-md.md)] in detecting lock conflicts at the higher level of granularity.</span></span>  
  
 <span data-ttu-id="33c05-562">Por ejemplo, un bloqueo con intención compartida para el nivel de tabla se solicita antes que los bloqueos compartidos (S) para las páginas o filas de la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-562">For example, a shared intent lock is requested at the table level before shared (S) locks are requested on pages or rows within that table.</span></span> <span data-ttu-id="33c05-563">Establecer un bloqueo con intención en una tabla evita que otra transacción adquiera un bloqueo exclusivo (X) para la tabla que contiene esa página.</span><span class="sxs-lookup"><span data-stu-id="33c05-563">Setting an intent lock at the table level prevents another transaction from subsequently acquiring an exclusive (X) lock on the table containing that page.</span></span> <span data-ttu-id="33c05-564">Los bloqueos con intención mejoran el rendimiento, porque [!INCLUDE[ssDE](../includes/ssde-md.md)] examina los bloqueos con intención solo en el nivel de tabla para determinar si una transacción puede adquirir un bloqueo de dicha tabla de forma segura.</span><span class="sxs-lookup"><span data-stu-id="33c05-564">Intent locks improve performance because the [!INCLUDE[ssDE](../includes/ssde-md.md)] examines intent locks only at the table level to determine if a transaction can safely acquire a lock on that table.</span></span> <span data-ttu-id="33c05-565">Esto elimina la necesidad de examinar cada bloqueo de fila o de página de la tabla para determinar si una transacción puede bloquear toda la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-565">This removes the requirement to examine every row or page lock on the table to determine if a transaction can lock the entire table.</span></span>  
  
 <span data-ttu-id="33c05-566">Los bloqueos con intención incluyen: Intención compartida (IS), Intención exclusiva (IX) e Intención compartida exclusiva (SIX).</span><span class="sxs-lookup"><span data-stu-id="33c05-566">Intent locks include intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>  
  
|<span data-ttu-id="33c05-567">Modo de bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-567">Lock mode</span></span>|<span data-ttu-id="33c05-568">Descripción</span><span class="sxs-lookup"><span data-stu-id="33c05-568">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="33c05-569">Intención compartida (IS)</span><span class="sxs-lookup"><span data-stu-id="33c05-569">Intent shared (IS)</span></span>|<span data-ttu-id="33c05-570">Protege los bloqueos compartidos solicitados o adquiridos de algunos recursos (aunque no todos) situados en un nivel inferior de la jerarquía.</span><span class="sxs-lookup"><span data-stu-id="33c05-570">Protects requested or acquired shared locks on some (but not all) resources lower in the hierarchy.</span></span>|  
|<span data-ttu-id="33c05-571">Con intención exclusivo (IX)</span><span class="sxs-lookup"><span data-stu-id="33c05-571">Intent exclusive (IX)</span></span>|<span data-ttu-id="33c05-572">Protege los bloqueos exclusivos solicitados o adquiridos de algunos recursos (aunque no todos) situados en un nivel inferior de la jerarquía.</span><span class="sxs-lookup"><span data-stu-id="33c05-572">Protects requested or acquired exclusive locks on some (but not all) resources lower in the hierarchy.</span></span> <span data-ttu-id="33c05-573">IX es un superconjunto de IS, y protege las solicitudes de bloqueos compartidos en recursos de niveles inferiores.</span><span class="sxs-lookup"><span data-stu-id="33c05-573">IX is a superset of IS, and it also protects requesting shared locks on lower level resources.</span></span>|  
|<span data-ttu-id="33c05-574">Compartido con intención exclusivo (SIX)</span><span class="sxs-lookup"><span data-stu-id="33c05-574">Shared with intent exclusive (SIX)</span></span>|<span data-ttu-id="33c05-575">Protege los bloqueos compartidos solicitados o adquiridos de todos los recursos situados en un nivel inferior de la jerarquía y los bloqueos con intención exclusiva de algunos (aunque no todos) los recursos de niveles inferiores.</span><span class="sxs-lookup"><span data-stu-id="33c05-575">Protects requested or acquired shared locks on all resources lower in the hierarchy and intent exclusive locks on some (but not all) of the lower level resources.</span></span> <span data-ttu-id="33c05-576">Se permiten los bloqueos IS simultáneos en el recurso de nivel superior.</span><span class="sxs-lookup"><span data-stu-id="33c05-576">Concurrent IS locks at the top-level resource are allowed.</span></span> <span data-ttu-id="33c05-577">Por ejemplo, al adquirir un bloqueo SIX para una tabla, también se adquieren bloqueos con intención exclusiva de las páginas que se modifican y bloqueos exclusivos de las filas modificadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-577">For example, acquiring a SIX lock on a table also acquires intent exclusive locks on the pages being modified and exclusive locks on the modified rows.</span></span> <span data-ttu-id="33c05-578">Solo puede haber un bloqueo SIX simultáneo por recurso, para impedir que otras transacciones lo actualicen, aunque otras transacciones pueden leer los recursos inferiores de la jerarquía obteniendo bloqueos IS en el nivel de tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-578">There can be only one SIX lock per resource at one time, preventing updates to the resource made by other transactions, although other transactions can read resources lower in the hierarchy by obtaining IS locks at the table level.</span></span>|  
|<span data-ttu-id="33c05-579">Actualizar intención (IU)</span><span class="sxs-lookup"><span data-stu-id="33c05-579">Intent update (IU)</span></span>|<span data-ttu-id="33c05-580">Protege los bloqueos de actualización solicitados o adquiridos de todos los recursos de niveles inferiores de la jerarquía.</span><span class="sxs-lookup"><span data-stu-id="33c05-580">Protects requested or acquired update locks on all resources lower in the hierarchy.</span></span> <span data-ttu-id="33c05-581">Los bloqueos IU solo se utilizan para los recursos de página.</span><span class="sxs-lookup"><span data-stu-id="33c05-581">IU locks are used only on page resources.</span></span> <span data-ttu-id="33c05-582">Los bloqueos IU se convierten en bloqueos IX cuando se ejecutan operaciones de actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-582">IU locks are converted to IX locks if an update operation takes place.</span></span>|  
|<span data-ttu-id="33c05-583">Actualizar intención compartida (SIU)</span><span class="sxs-lookup"><span data-stu-id="33c05-583">Shared intent update (SIU)</span></span>|<span data-ttu-id="33c05-584">Combinación de bloqueos S e IU que resulta de adquirir estos bloqueos por separado y de mantenerlos simultáneamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-584">A combination of S and IU locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span> <span data-ttu-id="33c05-585">Por ejemplo, sería el caso de una transacción que ejecuta una consulta con la sugerencia PAGLOCK y luego ejecuta una operación de actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-585">For example, a transaction executes a query with the PAGLOCK hint and then executes an update operation.</span></span> <span data-ttu-id="33c05-586">La consulta con la sugerencia PAGLOCK adquiere el bloqueo S y la operación de actualización, el bloqueo IU.</span><span class="sxs-lookup"><span data-stu-id="33c05-586">The query with the PAGLOCK hint acquires the S lock, and the update operation acquires the IU lock.</span></span>|  
|<span data-ttu-id="33c05-587">Actualizar intención exclusiva (UIX)</span><span class="sxs-lookup"><span data-stu-id="33c05-587">Update intent exclusive (UIX)</span></span>|<span data-ttu-id="33c05-588">Combinación de bloqueos U e IX que resulta de adquirir estos bloqueos por separado y de mantenerlos simultáneamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-588">A combination of U and IX locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span>|  
  
#### <a name="schema-locks"></a><span data-ttu-id="33c05-589">Bloqueos de esquema</span><span class="sxs-lookup"><span data-stu-id="33c05-589">Schema Locks</span></span>  

 <span data-ttu-id="33c05-590">[!INCLUDE[ssDE](../includes/ssde-md.md)] utiliza bloqueos de modificación del esquema (Sch-M) cuando se realiza una operación de lenguaje de definición de datos (DDL) en tablas como, por ejemplo, agregar una columna o quitar una tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-590">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema modification (Sch-M) locks during a table data definition language (DDL) operation, such as adding a column or dropping a table.</span></span> <span data-ttu-id="33c05-591">Mientras se conserva, el bloqueo Sch-M evita el acceso simultáneo a la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-591">During the time that it is held, the Sch-M lock prevents concurrent access to the table.</span></span> <span data-ttu-id="33c05-592">Esto significa que el bloqueo Sch-M bloquea todas las operaciones externas hasta que el bloqueo se libera.</span><span class="sxs-lookup"><span data-stu-id="33c05-592">This means the Sch-M lock blocks all outside operations until the lock is released.</span></span>  
  
 <span data-ttu-id="33c05-593">Algunas operaciones del lenguaje de manipulación de datos (DML), como el truncamiento de tablas, utilizan los bloqueos Sch-M para impedir el acceso a las tablas afectadas por operaciones simultáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-593">Some data manipulation language (DML) operations, such as table truncation, use Sch-M locks to prevent access to affected tables by concurrent operations.</span></span>  
  
 <span data-ttu-id="33c05-594">[!INCLUDE[ssDE](../includes/ssde-md.md)] usa bloqueos de estabilidad del esquema (Sch-S) al compilar y ejecutar consultas.</span><span class="sxs-lookup"><span data-stu-id="33c05-594">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema stability (Sch-S) locks when compiling and executing queries.</span></span> <span data-ttu-id="33c05-595">Los bloqueos Sch-S no impiden los bloqueos de transacciones, incluidos los bloqueos exclusivos (X).</span><span class="sxs-lookup"><span data-stu-id="33c05-595">Sch-S locks do not block any transactional locks, including exclusive (X) locks.</span></span> <span data-ttu-id="33c05-596">Por tanto, otras transacciones, incluidas las que tienen bloqueos X de una tabla, pueden seguir ejecutándose mientras se compila una consulta.</span><span class="sxs-lookup"><span data-stu-id="33c05-596">Therefore, other transactions, including those with X locks on a table, continue to run while a query is being compiled.</span></span> <span data-ttu-id="33c05-597">No obstante, en la tabla no se pueden realizar operaciones DDL simultáneas ni operaciones DML simultáneas que adquieren bloqueos Sch-M.</span><span class="sxs-lookup"><span data-stu-id="33c05-597">However, concurrent DDL operations, and concurrent DML operations that acquire Sch-M locks, cannot be performed on the table.</span></span>  
  
#### <a name="bulk-update-locks"></a><span data-ttu-id="33c05-598">Bloqueos de actualización masiva</span><span class="sxs-lookup"><span data-stu-id="33c05-598">Bulk Update Locks</span></span>  

 <span data-ttu-id="33c05-599">Los bloqueos de actualización masiva (BU) permiten que varios subprocesos copien datos de forma masiva y simultánea en la misma tabla, pero impiden que otros procesos que no están copiando datos de forma masiva tengan acceso a la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-599">Bulk update (BU) locks allow multiple threads to bulk load data concurrently into the same table while preventing other processes that are not bulk loading data from accessing the table.</span></span> <span data-ttu-id="33c05-600">El [!INCLUDE[ssDE](../includes/ssde-md.md)] utiliza bloqueos de actualización masiva cuando las dos condiciones siguientes son verdaderas.</span><span class="sxs-lookup"><span data-stu-id="33c05-600">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses bulk update (BU) locks when both of the following conditions are true.</span></span>  
  
-   <span data-ttu-id="33c05-601">Está usando la instrucción Transact-SQL BULK INSERT o la función OPENROWSET(BULK), o está usando uno de los comandos de API Bulk Insert como .NET SqlBulkCopy, las API de carga rápida de OLEDB o las API de copia masiva de ODBC para copiar de forma masiva datos en una tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-601">You use the Transact-SQL BULK INSERT statement, or the OPENROWSET(BULK) function, or you use one of the Bulk Insert API commands such as .NET SqlBulkCopy, OLEDB Fast Load APIs, or the ODBC Bulk Copy APIs to bulk copy data into a table.</span></span>  
  
-   <span data-ttu-id="33c05-602">Se especifica la sugerencia **TABLOCK** o se establece la opción de tabla **table lock on bulk load** con **sp_tableoption**.</span><span class="sxs-lookup"><span data-stu-id="33c05-602">The **TABLOCK** hint is specified or the **table lock on bulk load** table option is set using **sp_tableoption**.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="33c05-603">A diferencia de la instrucción BULK INSERT, que contiene un bloqueo Bulk Update menos restrictivo, INSERT INTO…SELECT con la sugerencia TABLOCK retiene un bloqueo exclusivo (X) en la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-603">Unlike the BULK INSERT statement, which holds a less restrictive Bulk Update lock, INSERT INTO...SELECT with the TABLOCK hint holds an exclusive (X) lock on the table.</span></span> <span data-ttu-id="33c05-604">Esto significa que no se pueden insertar filas mediante operaciones de inserción en paralelo.</span><span class="sxs-lookup"><span data-stu-id="33c05-604">This means that you cannot insert rows using parallel insert operations.</span></span>  
  
#### <a name="key-range-locks"></a><span data-ttu-id="33c05-605">Bloqueos de intervalo de claves</span><span class="sxs-lookup"><span data-stu-id="33c05-605">Key-Range Locks</span></span>  

 <span data-ttu-id="33c05-606">Los bloqueos de rangos con clave protegen un intervalo de filas incluido implícitamente en un conjunto de registros que se lee con una instrucción [!INCLUDE[tsql](../includes/tsql-md.md)] mientras se utiliza el nivel de aislamiento de transacción serializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-606">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="33c05-607">El bloqueo de intervalos con clave impide las lecturas fantasma.</span><span class="sxs-lookup"><span data-stu-id="33c05-607">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="33c05-608">Al proteger los intervalos de claves entre filas, también se evitan inserciones o eliminaciones fantasma en los conjuntos de registros a los que obtienen acceso las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-608">By protecting the ranges of keys between rows, it also prevents phantom insertions or deletions into a record set accessed by a transaction.</span></span>  
  
### <a name="lock-compatibility"></a><span data-ttu-id="33c05-609">Compatibilidad de bloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-609">Lock Compatibility</span></span>  

 <span data-ttu-id="33c05-610">La compatibilidad de bloqueos controla si varias transacciones pueden adquirir bloqueos sobre el mismo recurso a la vez.</span><span class="sxs-lookup"><span data-stu-id="33c05-610">Lock compatibility controls whether multiple transactions can acquire locks on the same resource at the same time.</span></span> <span data-ttu-id="33c05-611">Si un recurso ya está bloqueado por otra transacción, solo se puede conceder una nueva solicitud de bloqueo si el bloqueo solicitado es compatible con el modo del bloqueo existente.</span><span class="sxs-lookup"><span data-stu-id="33c05-611">If a resource is already locked by another transaction, a new lock request can be granted only if the mode of the requested lock is compatible with the mode of the existing lock.</span></span> <span data-ttu-id="33c05-612">Si el modo del bloqueo solicitado no es compatible con el bloqueo existente, la transacción que solicita el nuevo bloqueo espera a que se libere el bloqueo existente o a que expire el intervalo de tiempo de espera del bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-612">If the mode of the requested lock is not compatible with the existing lock, the transaction requesting the new lock waits for the existing lock to be released or for the lock timeout interval to expire.</span></span> <span data-ttu-id="33c05-613">Por ejemplo, ningún modo de bloqueo es compatible con bloqueos exclusivos.</span><span class="sxs-lookup"><span data-stu-id="33c05-613">For example, no lock modes are compatible with exclusive locks.</span></span> <span data-ttu-id="33c05-614">Mientras se mantiene un bloqueo exclusivo (X), ninguna otra transacción puede adquirir un bloqueo de ninguna clase (compartido, de actualización o exclusivo) en dicho recurso hasta que se libere el bloqueo exclusivo.</span><span class="sxs-lookup"><span data-stu-id="33c05-614">While an exclusive (X) lock is held, no other transaction can acquire a lock of any kind (shared, update, or exclusive) on that resource until the exclusive (X) lock is released.</span></span> <span data-ttu-id="33c05-615">Como alternativa, si se ha aplicado un bloqueo compartido (S) a un recurso, otras transacciones también pueden adquirir un bloqueo compartido o de actualización (U) en el elemento, aunque la primera transacción no haya terminado.</span><span class="sxs-lookup"><span data-stu-id="33c05-615">Alternatively, if a shared (S) lock has been applied to a resource, other transactions can also acquire a shared lock or an update (U) lock on that item even if the first transaction has not completed.</span></span> <span data-ttu-id="33c05-616">Sin embargo, otras transacciones no pueden adquirir un bloqueo exclusivo si no se anula el bloqueo compartido.</span><span class="sxs-lookup"><span data-stu-id="33c05-616">However, other transactions cannot acquire an exclusive lock until the shared lock has been released.</span></span>  
  
 <span data-ttu-id="33c05-617">En la tabla siguiente se muestra la compatibilidad de los modos de bloqueo más frecuentes.</span><span class="sxs-lookup"><span data-stu-id="33c05-617">The following table shows the compatibility of the most commonly encountered lock modes.</span></span>  
  
||<span data-ttu-id="33c05-618">Modo concedido existente</span><span class="sxs-lookup"><span data-stu-id="33c05-618">Existing granted mode</span></span>||||||  
|------|---------------------------|------|------|------|------|------|  
|<span data-ttu-id="33c05-619">**Modo solicitado**</span><span class="sxs-lookup"><span data-stu-id="33c05-619">**Requested mode**</span></span>|<span data-ttu-id="33c05-620">**IS**</span><span class="sxs-lookup"><span data-stu-id="33c05-620">**IS**</span></span>|<span data-ttu-id="33c05-621">**S**</span><span class="sxs-lookup"><span data-stu-id="33c05-621">**S**</span></span>|<span data-ttu-id="33c05-622">**U**</span><span class="sxs-lookup"><span data-stu-id="33c05-622">**U**</span></span>|<span data-ttu-id="33c05-623">**IX**</span><span class="sxs-lookup"><span data-stu-id="33c05-623">**IX**</span></span>|<span data-ttu-id="33c05-624">**SIX**</span><span class="sxs-lookup"><span data-stu-id="33c05-624">**SIX**</span></span>|<span data-ttu-id="33c05-625">**X**</span><span class="sxs-lookup"><span data-stu-id="33c05-625">**X**</span></span>|  
|<span data-ttu-id="33c05-626">**Intención compartida (IS)**</span><span class="sxs-lookup"><span data-stu-id="33c05-626">**Intent shared (IS)**</span></span>|<span data-ttu-id="33c05-627">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-627">Yes</span></span>|<span data-ttu-id="33c05-628">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-628">Yes</span></span>|<span data-ttu-id="33c05-629">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-629">Yes</span></span>|<span data-ttu-id="33c05-630">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-630">Yes</span></span>|<span data-ttu-id="33c05-631">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-631">Yes</span></span>|<span data-ttu-id="33c05-632">No</span><span class="sxs-lookup"><span data-stu-id="33c05-632">No</span></span>|  
|<span data-ttu-id="33c05-633">**Compartido (S)**</span><span class="sxs-lookup"><span data-stu-id="33c05-633">**Shared (S)**</span></span>|<span data-ttu-id="33c05-634">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-634">Yes</span></span>|<span data-ttu-id="33c05-635">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-635">Yes</span></span>|<span data-ttu-id="33c05-636">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-636">Yes</span></span>|<span data-ttu-id="33c05-637">No</span><span class="sxs-lookup"><span data-stu-id="33c05-637">No</span></span>|<span data-ttu-id="33c05-638">No</span><span class="sxs-lookup"><span data-stu-id="33c05-638">No</span></span>|<span data-ttu-id="33c05-639">No</span><span class="sxs-lookup"><span data-stu-id="33c05-639">No</span></span>|  
|<span data-ttu-id="33c05-640">**Actualizado (U)**</span><span class="sxs-lookup"><span data-stu-id="33c05-640">**Update (U)**</span></span>|<span data-ttu-id="33c05-641">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-641">Yes</span></span>|<span data-ttu-id="33c05-642">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-642">Yes</span></span>|<span data-ttu-id="33c05-643">No</span><span class="sxs-lookup"><span data-stu-id="33c05-643">No</span></span>|<span data-ttu-id="33c05-644">No</span><span class="sxs-lookup"><span data-stu-id="33c05-644">No</span></span>|<span data-ttu-id="33c05-645">No</span><span class="sxs-lookup"><span data-stu-id="33c05-645">No</span></span>|<span data-ttu-id="33c05-646">No</span><span class="sxs-lookup"><span data-stu-id="33c05-646">No</span></span>|  
|<span data-ttu-id="33c05-647">**Intención exclusiva (IX)**</span><span class="sxs-lookup"><span data-stu-id="33c05-647">**Intent exclusive (IX)**</span></span>|<span data-ttu-id="33c05-648">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-648">Yes</span></span>|<span data-ttu-id="33c05-649">No</span><span class="sxs-lookup"><span data-stu-id="33c05-649">No</span></span>|<span data-ttu-id="33c05-650">No</span><span class="sxs-lookup"><span data-stu-id="33c05-650">No</span></span>|<span data-ttu-id="33c05-651">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-651">Yes</span></span>|<span data-ttu-id="33c05-652">No</span><span class="sxs-lookup"><span data-stu-id="33c05-652">No</span></span>|<span data-ttu-id="33c05-653">No</span><span class="sxs-lookup"><span data-stu-id="33c05-653">No</span></span>|  
|<span data-ttu-id="33c05-654">**Compartido con intención exclusiva (SIX)**</span><span class="sxs-lookup"><span data-stu-id="33c05-654">**Shared with intent exclusive (SIX)**</span></span>|<span data-ttu-id="33c05-655">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-655">Yes</span></span>|<span data-ttu-id="33c05-656">No</span><span class="sxs-lookup"><span data-stu-id="33c05-656">No</span></span>|<span data-ttu-id="33c05-657">No</span><span class="sxs-lookup"><span data-stu-id="33c05-657">No</span></span>|<span data-ttu-id="33c05-658">No</span><span class="sxs-lookup"><span data-stu-id="33c05-658">No</span></span>|<span data-ttu-id="33c05-659">No</span><span class="sxs-lookup"><span data-stu-id="33c05-659">No</span></span>|<span data-ttu-id="33c05-660">No</span><span class="sxs-lookup"><span data-stu-id="33c05-660">No</span></span>|  
|<span data-ttu-id="33c05-661">**Exclusivo (X)**</span><span class="sxs-lookup"><span data-stu-id="33c05-661">**Exclusive (X)**</span></span>|<span data-ttu-id="33c05-662">No</span><span class="sxs-lookup"><span data-stu-id="33c05-662">No</span></span>|<span data-ttu-id="33c05-663">No</span><span class="sxs-lookup"><span data-stu-id="33c05-663">No</span></span>|<span data-ttu-id="33c05-664">No</span><span class="sxs-lookup"><span data-stu-id="33c05-664">No</span></span>|<span data-ttu-id="33c05-665">No</span><span class="sxs-lookup"><span data-stu-id="33c05-665">No</span></span>|<span data-ttu-id="33c05-666">No</span><span class="sxs-lookup"><span data-stu-id="33c05-666">No</span></span>|<span data-ttu-id="33c05-667">No</span><span class="sxs-lookup"><span data-stu-id="33c05-667">No</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-668">Un bloqueo con intención exclusivo (IX) es compatible con un modo de bloqueo IX, porque IX indica la intención de actualizar solamente algunas de las filas, no todas.</span><span class="sxs-lookup"><span data-stu-id="33c05-668">An intent exclusive (IX) lock is compatible with an IX lock mode because IX means the intention is to update only some of the rows rather than all of them.</span></span> <span data-ttu-id="33c05-669">También se permite que otras transacciones intenten leer o actualizar algunas filas, siempre y cuando no se trate de las mismas filas que están actualizando las demás transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-669">Other transactions that attempt to read or update some of the rows are also permitted as long as they are not the same rows being updated by other transactions.</span></span> <span data-ttu-id="33c05-670">Además, si dos transacciones intentan actualizar la misma fila, se permitirá a ambas transacciones un bloqueo IX en el nivel de tabla y de página.</span><span class="sxs-lookup"><span data-stu-id="33c05-670">Further, if two transactions attempt to update the same row, both transactions will be granted an IX lock at table and page level.</span></span> <span data-ttu-id="33c05-671">Sin embargo, un bloqueo X en el nivel de fila solo se permitirá a una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-671">However, one transaction will be granted an X lock at row level.</span></span> <span data-ttu-id="33c05-672">La otra transacción deberá esperar a que se quite el bloqueo en el nivel de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-672">The other transaction must wait until the row-level lock is removed.</span></span>  
  
 <span data-ttu-id="33c05-673">Utilice la siguiente tabla para determinar la compatibilidad de todos los modos de bloqueo disponibles en [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-673">Use the following table to determine the compatibility of all the lock modes available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="33c05-674">![Diagrama en el que se muestra la matriz de compatibilidad de un bloqueo](media/lockconflicttable.gif "Diagrama en el que se muestra la matriz de compatibilidad de un bloqueo")</span><span class="sxs-lookup"><span data-stu-id="33c05-674">![Diagram showing lock compatibility matrix](media/lockconflicttable.gif "Diagram showing lock compatibility matrix")</span></span>  
  
### <a name="key-range-locking"></a><span data-ttu-id="33c05-675">Bloquear intervalos con clave</span><span class="sxs-lookup"><span data-stu-id="33c05-675">Key-Range Locking</span></span>  

 <span data-ttu-id="33c05-676">Los bloqueos de rangos con clave protegen un intervalo de filas incluido implícitamente en un conjunto de registros que se lee con una instrucción [!INCLUDE[tsql](../includes/tsql-md.md)] mientras se utiliza el nivel de aislamiento de transacción serializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-676">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="33c05-677">El nivel de aislamiento serializable requiere que las consultas ejecutadas durante una transacción deben obtener el mismo conjunto de filas cada vez que se ejecutan en la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-677">The serializable isolation level requires that any query executed during a transaction must obtain the same set of rows every time it is executed during the transaction.</span></span> <span data-ttu-id="33c05-678">El bloqueo de intervalos con clave protege este requisito, ya que impide que otras transacciones inserten nuevas filas cuyas claves se incluirían en el intervalo de claves leído por la transacción serializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-678">A key range lock protects this requirement by preventing other transactions from inserting new rows whose keys would fall in the range of keys read by the serializable transaction.</span></span>  
  
 <span data-ttu-id="33c05-679">El bloqueo de intervalos con clave impide las lecturas fantasma.</span><span class="sxs-lookup"><span data-stu-id="33c05-679">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="33c05-680">La protección de los intervalos de claves entre filas también impide las inserciones fantasma en un conjunto de registros a los que tiene acceso una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-680">By protecting the ranges of keys between rows, it also prevents phantom insertions into a set of records accessed by a transaction.</span></span>  
  
 <span data-ttu-id="33c05-681">El bloqueo de intervalos con clave se incluye en un índice, especificando los valores de clave inicial y final.</span><span class="sxs-lookup"><span data-stu-id="33c05-681">A key-range lock is placed on an index, specifying a beginning and ending key value.</span></span> <span data-ttu-id="33c05-682">Este bloqueo impide la inserción, actualización o eliminación de filas con un valor de clave incluido en el intervalo, ya que estas operaciones deben obtener en primer lugar un bloqueo en el índice.</span><span class="sxs-lookup"><span data-stu-id="33c05-682">This lock blocks any attempt to insert, update, or delete any row with a key value that falls in the range because those operations would first have to acquire a lock on the index.</span></span> <span data-ttu-id="33c05-683">Por ejemplo, una transacción serializable podría emitir una instrucción SELECT que lee todas las filas cuyos valores clave se encuentran entre **'** AAA **'** y **'** CZZ **'**.</span><span class="sxs-lookup"><span data-stu-id="33c05-683">For example, a serializable transaction could issue a SELECT statement that reads all rows whose key values are between **'** AAA **'** and **'** CZZ **'**.</span></span> <span data-ttu-id="33c05-684">El bloqueo de intervalos con clave en los valores de clave del intervalo **'** AAA **'** a **'** CZZ **'** impide que otras transacciones inserten filas con valores de clave situados en dicho intervalo, como **'** ADG **'** , **'** BBD **'** o **'** CAL **'** .</span><span class="sxs-lookup"><span data-stu-id="33c05-684">A key-range lock on the key values in the range from **'** AAA **'** to **'** CZZ **'** prevents other transactions from inserting rows with key values anywhere in that range, such as **'** ADG **'**, **'** BBD **'**, or **'** CAL **'**.</span></span>  
  
#### <a name="key-range-lock-modes"></a><span data-ttu-id="33c05-685">Modos de bloqueo de intervalos con clave</span><span class="sxs-lookup"><span data-stu-id="33c05-685">Key-Range Lock Modes</span></span>  

 <span data-ttu-id="33c05-686">Los bloqueos de intervalos con clave incluyen dos componentes, una fila y un intervalo, especificados con el formato intervalo-fila:</span><span class="sxs-lookup"><span data-stu-id="33c05-686">Key-range locks include both a range and a row component specified in range-row format:</span></span>  
  
-   <span data-ttu-id="33c05-687">El intervalo representa el modo de bloqueo que protege el intervalo entre dos entradas de índice consecutivas.</span><span class="sxs-lookup"><span data-stu-id="33c05-687">Range represents the lock mode protecting the range between two consecutive index entries.</span></span>  
  
-   <span data-ttu-id="33c05-688">La fila representa el modo de bloqueo que protege la entrada de índice.</span><span class="sxs-lookup"><span data-stu-id="33c05-688">Row represents the lock mode protecting the index entry.</span></span>  
  
-   <span data-ttu-id="33c05-689">El modo representa el modo de bloqueo combinado que se utiliza.</span><span class="sxs-lookup"><span data-stu-id="33c05-689">Mode represents the combined lock mode used.</span></span> <span data-ttu-id="33c05-690">Los modos de bloqueo del intervalo de claves constan de dos partes.</span><span class="sxs-lookup"><span data-stu-id="33c05-690">Key-range lock modes consist of two parts.</span></span> <span data-ttu-id="33c05-691">La primera representa el tipo de bloqueo que se utiliza para bloquear el intervalo del índice (Range*T*) y la segunda representa el tipo de bloqueo que se utiliza para bloquear una clave específica (*K*).</span><span class="sxs-lookup"><span data-stu-id="33c05-691">The first represents the type of lock used to lock the index range (Range*T*) and the second represents the lock type used to lock a specific key (*K*).</span></span> <span data-ttu-id="33c05-692">Ambas partes se conectan con un guion (-), como Range*T*-*K*.</span><span class="sxs-lookup"><span data-stu-id="33c05-692">The two parts are connected with a hyphen (-), such as Range*T*-*K*.</span></span>  
  
    |<span data-ttu-id="33c05-693">Intervalo</span><span class="sxs-lookup"><span data-stu-id="33c05-693">Range</span></span>|<span data-ttu-id="33c05-694">Row</span><span class="sxs-lookup"><span data-stu-id="33c05-694">Row</span></span>|<span data-ttu-id="33c05-695">Mode</span><span class="sxs-lookup"><span data-stu-id="33c05-695">Mode</span></span>|<span data-ttu-id="33c05-696">Descripción</span><span class="sxs-lookup"><span data-stu-id="33c05-696">Description</span></span>|  
    |-----------|---------|----------|-----------------|  
    |<span data-ttu-id="33c05-697">RangeS</span><span class="sxs-lookup"><span data-stu-id="33c05-697">RangeS</span></span>|<span data-ttu-id="33c05-698">S</span><span class="sxs-lookup"><span data-stu-id="33c05-698">S</span></span>|<span data-ttu-id="33c05-699">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="33c05-699">RangeS-S</span></span>|<span data-ttu-id="33c05-700">Intervalo compartido, bloqueo de recurso compartido; recorrido de intervalo serializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-700">Shared range, shared resource lock; serializable range scan.</span></span>|  
    |<span data-ttu-id="33c05-701">RangeS</span><span class="sxs-lookup"><span data-stu-id="33c05-701">RangeS</span></span>|<span data-ttu-id="33c05-702">U</span><span class="sxs-lookup"><span data-stu-id="33c05-702">U</span></span>|<span data-ttu-id="33c05-703">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="33c05-703">RangeS-U</span></span>|<span data-ttu-id="33c05-704">Intervalo compartido, bloqueo de recurso de actualización; recorrido de actualización serializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-704">Shared range, update resource lock; serializable update scan.</span></span>|  
    |<span data-ttu-id="33c05-705">RangeI</span><span class="sxs-lookup"><span data-stu-id="33c05-705">RangeI</span></span>|<span data-ttu-id="33c05-706">Null</span><span class="sxs-lookup"><span data-stu-id="33c05-706">Null</span></span>|<span data-ttu-id="33c05-707">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="33c05-707">RangeI-N</span></span>|<span data-ttu-id="33c05-708">Intervalo de inserción, bloqueo de recurso nulo; se utiliza para comprobar los intervalos antes de insertar una nueva clave en un índice.</span><span class="sxs-lookup"><span data-stu-id="33c05-708">Insert range, null resource lock; used to test ranges before inserting a new key into an index.</span></span>|  
    |<span data-ttu-id="33c05-709">RangeX</span><span class="sxs-lookup"><span data-stu-id="33c05-709">RangeX</span></span>|<span data-ttu-id="33c05-710">X</span><span class="sxs-lookup"><span data-stu-id="33c05-710">X</span></span>|<span data-ttu-id="33c05-711">RangeX-X</span><span class="sxs-lookup"><span data-stu-id="33c05-711">RangeX-X</span></span>|<span data-ttu-id="33c05-712">Intervalo exclusivo, bloqueo de recurso exclusivo; se utiliza al actualizar una clave de un intervalo.</span><span class="sxs-lookup"><span data-stu-id="33c05-712">Exclusive range, exclusive resource lock; used when updating a key in a range.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-713">El modo de bloqueo Null interno es compatible con los demás modos de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-713">The internal Null lock mode is compatible with all other lock modes.</span></span>  
  
 <span data-ttu-id="33c05-714">Los modos de bloqueo de intervalos con clave tienen una matriz de compatibilidad que muestra los bloqueos que son compatibles con otros bloqueos obtenidos en claves e intervalos superpuestos.</span><span class="sxs-lookup"><span data-stu-id="33c05-714">Key-range lock modes have a compatibility matrix that shows which locks are compatible with other locks obtained on overlapping keys and ranges.</span></span>  
  
||<span data-ttu-id="33c05-715">Modo concedido existente</span><span class="sxs-lookup"><span data-stu-id="33c05-715">Existing granted mode</span></span>|||||||  
|------|---------------------------|------|------|------|------|------|------|  
|<span data-ttu-id="33c05-716">**Modo solicitado**</span><span class="sxs-lookup"><span data-stu-id="33c05-716">**Requested mode**</span></span>|<span data-ttu-id="33c05-717">**S**</span><span class="sxs-lookup"><span data-stu-id="33c05-717">**S**</span></span>|<span data-ttu-id="33c05-718">**U**</span><span class="sxs-lookup"><span data-stu-id="33c05-718">**U**</span></span>|<span data-ttu-id="33c05-719">**X**</span><span class="sxs-lookup"><span data-stu-id="33c05-719">**X**</span></span>|<span data-ttu-id="33c05-720">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="33c05-720">**RangeS-S**</span></span>|<span data-ttu-id="33c05-721">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="33c05-721">**RangeS-U**</span></span>|<span data-ttu-id="33c05-722">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="33c05-722">**RangeI-N**</span></span>|<span data-ttu-id="33c05-723">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="33c05-723">**RangeX-X**</span></span>|  
|<span data-ttu-id="33c05-724">**Compartido (S)**</span><span class="sxs-lookup"><span data-stu-id="33c05-724">**Shared (S)**</span></span>|<span data-ttu-id="33c05-725">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-725">Yes</span></span>|<span data-ttu-id="33c05-726">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-726">Yes</span></span>|<span data-ttu-id="33c05-727">No</span><span class="sxs-lookup"><span data-stu-id="33c05-727">No</span></span>|<span data-ttu-id="33c05-728">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-728">Yes</span></span>|<span data-ttu-id="33c05-729">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-729">Yes</span></span>|<span data-ttu-id="33c05-730">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-730">Yes</span></span>|<span data-ttu-id="33c05-731">No</span><span class="sxs-lookup"><span data-stu-id="33c05-731">No</span></span>|  
|<span data-ttu-id="33c05-732">**Actualizado (U)**</span><span class="sxs-lookup"><span data-stu-id="33c05-732">**Update (U)**</span></span>|<span data-ttu-id="33c05-733">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-733">Yes</span></span>|<span data-ttu-id="33c05-734">No</span><span class="sxs-lookup"><span data-stu-id="33c05-734">No</span></span>|<span data-ttu-id="33c05-735">No</span><span class="sxs-lookup"><span data-stu-id="33c05-735">No</span></span>|<span data-ttu-id="33c05-736">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-736">Yes</span></span>|<span data-ttu-id="33c05-737">No</span><span class="sxs-lookup"><span data-stu-id="33c05-737">No</span></span>|<span data-ttu-id="33c05-738">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-738">Yes</span></span>|<span data-ttu-id="33c05-739">No</span><span class="sxs-lookup"><span data-stu-id="33c05-739">No</span></span>|  
|<span data-ttu-id="33c05-740">**Exclusivo (X)**</span><span class="sxs-lookup"><span data-stu-id="33c05-740">**Exclusive (X)**</span></span>|<span data-ttu-id="33c05-741">No</span><span class="sxs-lookup"><span data-stu-id="33c05-741">No</span></span>|<span data-ttu-id="33c05-742">No</span><span class="sxs-lookup"><span data-stu-id="33c05-742">No</span></span>|<span data-ttu-id="33c05-743">No</span><span class="sxs-lookup"><span data-stu-id="33c05-743">No</span></span>|<span data-ttu-id="33c05-744">No</span><span class="sxs-lookup"><span data-stu-id="33c05-744">No</span></span>|<span data-ttu-id="33c05-745">No</span><span class="sxs-lookup"><span data-stu-id="33c05-745">No</span></span>|<span data-ttu-id="33c05-746">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-746">Yes</span></span>|<span data-ttu-id="33c05-747">No</span><span class="sxs-lookup"><span data-stu-id="33c05-747">No</span></span>|  
|<span data-ttu-id="33c05-748">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="33c05-748">**RangeS-S**</span></span>|<span data-ttu-id="33c05-749">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-749">Yes</span></span>|<span data-ttu-id="33c05-750">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-750">Yes</span></span>|<span data-ttu-id="33c05-751">No</span><span class="sxs-lookup"><span data-stu-id="33c05-751">No</span></span>|<span data-ttu-id="33c05-752">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-752">Yes</span></span>|<span data-ttu-id="33c05-753">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-753">Yes</span></span>|<span data-ttu-id="33c05-754">No</span><span class="sxs-lookup"><span data-stu-id="33c05-754">No</span></span>|<span data-ttu-id="33c05-755">No</span><span class="sxs-lookup"><span data-stu-id="33c05-755">No</span></span>|  
|<span data-ttu-id="33c05-756">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="33c05-756">**RangeS-U**</span></span>|<span data-ttu-id="33c05-757">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-757">Yes</span></span>|<span data-ttu-id="33c05-758">No</span><span class="sxs-lookup"><span data-stu-id="33c05-758">No</span></span>|<span data-ttu-id="33c05-759">No</span><span class="sxs-lookup"><span data-stu-id="33c05-759">No</span></span>|<span data-ttu-id="33c05-760">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-760">Yes</span></span>|<span data-ttu-id="33c05-761">No</span><span class="sxs-lookup"><span data-stu-id="33c05-761">No</span></span>|<span data-ttu-id="33c05-762">No</span><span class="sxs-lookup"><span data-stu-id="33c05-762">No</span></span>|<span data-ttu-id="33c05-763">No</span><span class="sxs-lookup"><span data-stu-id="33c05-763">No</span></span>|  
|<span data-ttu-id="33c05-764">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="33c05-764">**RangeI-N**</span></span>|<span data-ttu-id="33c05-765">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-765">Yes</span></span>|<span data-ttu-id="33c05-766">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-766">Yes</span></span>|<span data-ttu-id="33c05-767">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-767">Yes</span></span>|<span data-ttu-id="33c05-768">No</span><span class="sxs-lookup"><span data-stu-id="33c05-768">No</span></span>|<span data-ttu-id="33c05-769">No</span><span class="sxs-lookup"><span data-stu-id="33c05-769">No</span></span>|<span data-ttu-id="33c05-770">Sí</span><span class="sxs-lookup"><span data-stu-id="33c05-770">Yes</span></span>|<span data-ttu-id="33c05-771">No</span><span class="sxs-lookup"><span data-stu-id="33c05-771">No</span></span>|  
|<span data-ttu-id="33c05-772">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="33c05-772">**RangeX-X**</span></span>|<span data-ttu-id="33c05-773">No</span><span class="sxs-lookup"><span data-stu-id="33c05-773">No</span></span>|<span data-ttu-id="33c05-774">No</span><span class="sxs-lookup"><span data-stu-id="33c05-774">No</span></span>|<span data-ttu-id="33c05-775">No</span><span class="sxs-lookup"><span data-stu-id="33c05-775">No</span></span>|<span data-ttu-id="33c05-776">No</span><span class="sxs-lookup"><span data-stu-id="33c05-776">No</span></span>|<span data-ttu-id="33c05-777">No</span><span class="sxs-lookup"><span data-stu-id="33c05-777">No</span></span>|<span data-ttu-id="33c05-778">No</span><span class="sxs-lookup"><span data-stu-id="33c05-778">No</span></span>|<span data-ttu-id="33c05-779">No</span><span class="sxs-lookup"><span data-stu-id="33c05-779">No</span></span>|  
  
#### <a name="conversion-locks"></a><span data-ttu-id="33c05-780">Bloqueos de conversión</span><span class="sxs-lookup"><span data-stu-id="33c05-780">Conversion Locks</span></span>  

 <span data-ttu-id="33c05-781">Los bloqueos de conversión se crean cuando un bloqueo de intervalos con clave se superpone a otro bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-781">Conversion locks are created when a key-range lock overlaps another lock.</span></span>  
  
|<span data-ttu-id="33c05-782">Bloqueo 1</span><span class="sxs-lookup"><span data-stu-id="33c05-782">Lock 1</span></span>|<span data-ttu-id="33c05-783">Bloqueo 2</span><span class="sxs-lookup"><span data-stu-id="33c05-783">Lock 2</span></span>|<span data-ttu-id="33c05-784">Bloqueo de conversión</span><span class="sxs-lookup"><span data-stu-id="33c05-784">Conversion lock</span></span>|  
|------------|------------|---------------------|  
|<span data-ttu-id="33c05-785">S</span><span class="sxs-lookup"><span data-stu-id="33c05-785">S</span></span>|<span data-ttu-id="33c05-786">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="33c05-786">RangeI-N</span></span>|<span data-ttu-id="33c05-787">RangeI-S</span><span class="sxs-lookup"><span data-stu-id="33c05-787">RangeI-S</span></span>|  
|<span data-ttu-id="33c05-788">U</span><span class="sxs-lookup"><span data-stu-id="33c05-788">U</span></span>|<span data-ttu-id="33c05-789">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="33c05-789">RangeI-N</span></span>|<span data-ttu-id="33c05-790">RangeI-U</span><span class="sxs-lookup"><span data-stu-id="33c05-790">RangeI-U</span></span>|  
|<span data-ttu-id="33c05-791">X</span><span class="sxs-lookup"><span data-stu-id="33c05-791">X</span></span>|<span data-ttu-id="33c05-792">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="33c05-792">RangeI-N</span></span>|<span data-ttu-id="33c05-793">RangeI-X</span><span class="sxs-lookup"><span data-stu-id="33c05-793">RangeI-X</span></span>|  
|<span data-ttu-id="33c05-794">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="33c05-794">RangeI-N</span></span>|<span data-ttu-id="33c05-795">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="33c05-795">RangeS-S</span></span>|<span data-ttu-id="33c05-796">RangeX-S</span><span class="sxs-lookup"><span data-stu-id="33c05-796">RangeX-S</span></span>|  
|<span data-ttu-id="33c05-797">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="33c05-797">RangeI-N</span></span>|<span data-ttu-id="33c05-798">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="33c05-798">RangeS-U</span></span>|<span data-ttu-id="33c05-799">RangeX-U</span><span class="sxs-lookup"><span data-stu-id="33c05-799">RangeX-U</span></span>|  
  
 <span data-ttu-id="33c05-800">Los bloqueos de conversión se producen durante breves períodos de tiempo en circunstancias diversas y complejas, y en ocasiones mientras se ejecutan procesos simultáneos.</span><span class="sxs-lookup"><span data-stu-id="33c05-800">Conversion locks can be observed for a short period of time under different complex circumstances, sometimes while running concurrent processes.</span></span>  
  
#### <a name="serializable-range-scan-singleton-fetch-delete-and-insert"></a><span data-ttu-id="33c05-801">Recorrido de intervalo serializable, captura de singleton, eliminación e inserción</span><span class="sxs-lookup"><span data-stu-id="33c05-801">Serializable Range Scan, Singleton Fetch, Delete, and Insert</span></span>  

 <span data-ttu-id="33c05-802">El bloqueo de intervalos con clave garantiza que las siguientes operaciones son serializables:</span><span class="sxs-lookup"><span data-stu-id="33c05-802">Key-range locking ensures that the following operations are serializable:</span></span>  
  
-   <span data-ttu-id="33c05-803">Consulta de recorrido de intervalos</span><span class="sxs-lookup"><span data-stu-id="33c05-803">Range scan query</span></span>  
  
-   <span data-ttu-id="33c05-804">Captura de singleton de fila inexistente</span><span class="sxs-lookup"><span data-stu-id="33c05-804">Singleton fetch of nonexistent row</span></span>  
  
-   <span data-ttu-id="33c05-805">Operación de eliminación</span><span class="sxs-lookup"><span data-stu-id="33c05-805">Delete operation</span></span>  
  
-   <span data-ttu-id="33c05-806">Operación de inserción</span><span class="sxs-lookup"><span data-stu-id="33c05-806">Insert operation</span></span>  
  
 <span data-ttu-id="33c05-807">Para que el bloqueo de intervalos con clave se produzca, es necesario que se cumplan las condiciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="33c05-807">Before key-range locking can occur, the following conditions must be satisfied:</span></span>  
  
-   <span data-ttu-id="33c05-808">El nivel de aislamiento de las transacciones se debe establecer en SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="33c05-808">The transaction-isolation level must be set to SERIALIZABLE.</span></span>  
  
-   <span data-ttu-id="33c05-809">El procesador de consultas debe utilizar un índice para implementar el predicado del filtro de intervalo.</span><span class="sxs-lookup"><span data-stu-id="33c05-809">The query processor must use an index to implement the range filter predicate.</span></span> <span data-ttu-id="33c05-810">Por ejemplo, la cláusula WHERE de una instrucción SELECT puede establecer una condición de intervalo con este predicado: ColumnX BETWEEN N **"** AAA **"** AND N **"** CZZ **"** .</span><span class="sxs-lookup"><span data-stu-id="33c05-810">For example, the WHERE clause in a SELECT statement could establish a range condition with this predicate: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'**.</span></span> <span data-ttu-id="33c05-811">El bloqueo de intervalos con clave solo se puede adquirir si una clave de índice abarca **ColumnX**.</span><span class="sxs-lookup"><span data-stu-id="33c05-811">A key-range lock can only be acquired if **ColumnX** is covered by an index key.</span></span>  
  
#### <a name="examples"></a><span data-ttu-id="33c05-812">Ejemplos</span><span class="sxs-lookup"><span data-stu-id="33c05-812">Examples</span></span>  

 <span data-ttu-id="33c05-813">La tabla y el índice siguientes se utilizan como base para los ejemplos de bloqueo de intervalos con clave que se muestran a continuación.</span><span class="sxs-lookup"><span data-stu-id="33c05-813">The following table and index are used as a basis for the key-range locking examples that follow.</span></span>  
  
 <span data-ttu-id="33c05-814">![Ilustración de tabla de base de datos con árbol b del índice](media/btree4.gif "Ilustración de tabla de base de datos con árbol b del índice")</span><span class="sxs-lookup"><span data-stu-id="33c05-814">![Database table with index b-tree illustration](media/btree4.gif "Database table with index b-tree illustration")</span></span>  
  
##### <a name="range-scan-query"></a><span data-ttu-id="33c05-815">Consulta de recorrido de intervalos</span><span class="sxs-lookup"><span data-stu-id="33c05-815">Range Scan Query</span></span>  

 <span data-ttu-id="33c05-816">Para poder asegurar que una consulta de recorrido de intervalos es serializable, la misma consulta debe devolver los mismos resultados cada vez que se ejecuta en la misma transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-816">To ensure a range scan query is serializable, the same query should return the same results each time it is executed within the same transaction.</span></span> <span data-ttu-id="33c05-817">Otras transacciones no deben insertar nuevas filas en la consulta de recorrido de intervalos; de lo contrario, se convierten en inserciones fantasma.</span><span class="sxs-lookup"><span data-stu-id="33c05-817">New rows must not be inserted within the range scan query by other transactions; otherwise, these become phantom inserts.</span></span> <span data-ttu-id="33c05-818">Por ejemplo, la siguiente consulta utiliza la tabla y el índice de la ilustración anterior:</span><span class="sxs-lookup"><span data-stu-id="33c05-818">For example, the following query uses the table and index in the previous illustration:</span></span>  
  
```sql  
SELECT name  
    FROM mytable  
    WHERE name BETWEEN 'A' AND 'C';  
```  
  
 <span data-ttu-id="33c05-819">Los bloqueos de intervalos con clave se colocan en las entradas de índice que corresponden al intervalo de filas de datos cuyo nombre se encuentra entre los valores Adam y Dale, impidiendo así que se agreguen o eliminen nuevas filas obtenidas en la consulta anterior.</span><span class="sxs-lookup"><span data-stu-id="33c05-819">Key-range locks are placed on the index entries corresponding to the range of data rows where the name is between the values Adam and Dale, preventing new rows qualifying in the previous query from being added or deleted.</span></span> <span data-ttu-id="33c05-820">Aunque el primer nombre del intervalo es Adam, el bloqueo de intervalos con clave RangeS-S en esta entrada de índice garantiza que no se pueden agregar nombres nuevos que empiecen por la letra A delante de Adam, como Abigail.</span><span class="sxs-lookup"><span data-stu-id="33c05-820">Although the first name in this range is Adam, the RangeS-S mode key-range lock on this index entry ensures that no new names beginning with the letter A can be added before Adam, such as Abigail.</span></span> <span data-ttu-id="33c05-821">De forma similar, el bloqueo de intervalos con clave RangeS-S en la entrada de índice de Dale garantiza que no se van a agregar nombres nuevos que empiecen por la letra C detrás de Carlos, como Clive.</span><span class="sxs-lookup"><span data-stu-id="33c05-821">Similarly, the RangeS-S key-range lock on the index entry for Dale ensures that no new names beginning with the letter C can be added after Carlos, such as Clive.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-822">El número de bloqueos RangeS-S que se mantiene es *n*+1, siendo *n* el número de filas que satisfacen la consulta.</span><span class="sxs-lookup"><span data-stu-id="33c05-822">The number of RangeS-S locks held is *n*+1, where *n* is the number of rows that satisfy the query.</span></span>  
  
##### <a name="singleton-fetch-of-nonexistent-data"></a><span data-ttu-id="33c05-823">Captura de singleton de datos inexistentes</span><span class="sxs-lookup"><span data-stu-id="33c05-823">Singleton Fetch of Nonexistent Data</span></span>  

 <span data-ttu-id="33c05-824">Si una consulta de una transacción intenta seleccionar una fila que no existe, la ejecución de la consulta en un punto posterior de la misma transacción tiene que devolver el mismo resultado.</span><span class="sxs-lookup"><span data-stu-id="33c05-824">If a query within a transaction attempts to select a row that does not exist, issuing the query at a later point within the same transaction has to return the same result.</span></span> <span data-ttu-id="33c05-825">No se puede permitir a otra transacción insertar la fila inexistente.</span><span class="sxs-lookup"><span data-stu-id="33c05-825">No other transaction can be allowed to insert that nonexistent row.</span></span> <span data-ttu-id="33c05-826">Por ejemplo, con esta consulta:</span><span class="sxs-lookup"><span data-stu-id="33c05-826">For example, given this query:</span></span>  
  
```sql 
SELECT name  
    FROM mytable  
    WHERE name = 'Bill';  
```  
  
 <span data-ttu-id="33c05-827">Se aplica un bloqueo de intervalos con clave a la entrada de índice correspondiente al intervalo de nombres comprendido entre `Ben` y `Bing`, ya que se podría insertar el nombre `Bill` entre estas dos entradas de índice adyacentes.</span><span class="sxs-lookup"><span data-stu-id="33c05-827">A key-range lock is placed on the index entry corresponding to the name range from `Ben` to `Bing` because the name `Bill` would be inserted between these two adjacent index entries.</span></span> <span data-ttu-id="33c05-828">El bloqueo de intervalos con clave del modo RangeS-S se coloca en la entrada de índice `Bing`.</span><span class="sxs-lookup"><span data-stu-id="33c05-828">The RangeS-S mode key-range lock is placed on the index entry `Bing`.</span></span> <span data-ttu-id="33c05-829">Esto impide que otra transacción inserte valores, como `Bill`, entre las entradas de índice `Ben` y `Bing`.</span><span class="sxs-lookup"><span data-stu-id="33c05-829">This prevents any other transaction from inserting values, such as `Bill`, between the index entries `Ben` and `Bing`.</span></span>  
  
##### <a name="delete-operation"></a><span data-ttu-id="33c05-830">Operación de eliminación</span><span class="sxs-lookup"><span data-stu-id="33c05-830">Delete Operation</span></span>  

 <span data-ttu-id="33c05-831">Cuando se elimina un valor en una transacción, el intervalo en el que entra el valor no debe estar bloqueado mientras se ejecuta la transacción que realiza la operación de eliminación.</span><span class="sxs-lookup"><span data-stu-id="33c05-831">When deleting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the delete operation.</span></span> <span data-ttu-id="33c05-832">Para mantener la seriabilidad basta con bloquear el valor de la clave eliminada hasta el final de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-832">Locking the deleted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="33c05-833">Por ejemplo, con esta instrucción DELETE:</span><span class="sxs-lookup"><span data-stu-id="33c05-833">For example, given this DELETE statement:</span></span>  
  
```sql  
DELETE mytable  
    WHERE name = 'Bob';  
```  
  
 <span data-ttu-id="33c05-834">Se ha colocado un bloqueo exclusivo (X) en la entrada de índice correspondiente al nombre `Bob`.</span><span class="sxs-lookup"><span data-stu-id="33c05-834">An exclusive (X) lock is placed on the index entry corresponding to the name `Bob`.</span></span> <span data-ttu-id="33c05-835">Otras transacciones pueden insertar o eliminar valores antes o después del valor eliminado `Bob`.</span><span class="sxs-lookup"><span data-stu-id="33c05-835">Other transactions can insert or delete values before or after the deleted value `Bob`.</span></span> <span data-ttu-id="33c05-836">Sin embargo, cualquier transacción que intente leer, insertar o eliminar el valor `Bob` se bloqueará hasta que la transacción de eliminación se confirme o se revierta.</span><span class="sxs-lookup"><span data-stu-id="33c05-836">However, any transaction that attempts to read, insert, or delete the value `Bob` will be blocked until the deleting transaction either commits or rolls back.</span></span>  
  
 <span data-ttu-id="33c05-837">La eliminación del intervalo se puede ejecutar con tres modos de bloqueo básicos: bloqueo de fila, de página o de tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-837">Range delete can be executed using three basic lock modes: row, page, or table lock.</span></span> <span data-ttu-id="33c05-838">El optimizador de consultas decide la estrategia de bloqueo de página, tabla o fila, o bien la especifica el usuario mediante sugerencias del optimizador como ROWLOCK, PAGLOCK o TABLOCK.</span><span class="sxs-lookup"><span data-stu-id="33c05-838">The row, page, or table locking strategy is decided by query optimizer or can be specified by the user through optimizer hints such as ROWLOCK, PAGLOCK, or TABLOCK.</span></span> <span data-ttu-id="33c05-839">Cuando se utiliza PAGLOCK o TABLOCK, [!INCLUDE[ssDE](../includes/ssde-md.md)] anula de forma inmediata la asignación de una página de índice si se eliminan todas sus filas.</span><span class="sxs-lookup"><span data-stu-id="33c05-839">When PAGLOCK or TABLOCK is used, the [!INCLUDE[ssDE](../includes/ssde-md.md)] immediately deallocates an index page if all rows are deleted from this page.</span></span> <span data-ttu-id="33c05-840">Por el contrario, cuando se utiliza ROWLOCK, todas las filas eliminadas se marcan solo como eliminadas, y se quitan de la página de índice posteriormente mediante una tarea en segundo plano.</span><span class="sxs-lookup"><span data-stu-id="33c05-840">In contrast, when ROWLOCK is used, all deleted rows are marked only as deleted; they are removed from the index page later using a background task.</span></span>  
  
##### <a name="insert-operation"></a><span data-ttu-id="33c05-841">Operación de inserción</span><span class="sxs-lookup"><span data-stu-id="33c05-841">Insert Operation</span></span>  

 <span data-ttu-id="33c05-842">Cuando se inserta un valor en una transacción, el intervalo en el que entra el valor no debe estar bloqueado mientras se ejecuta la transacción que realiza la operación de inserción.</span><span class="sxs-lookup"><span data-stu-id="33c05-842">When inserting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="33c05-843">Basta con bloquear el valor de clave insertado hasta el final de la transacción para mantener la seriabilidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-843">Locking the inserted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="33c05-844">Por ejemplo, con esta instrucción INSERT:</span><span class="sxs-lookup"><span data-stu-id="33c05-844">For example, given this INSERT statement:</span></span>  
  
```sql  
INSERT mytable VALUES ('Dan');  
```  
  
 <span data-ttu-id="33c05-845">El bloqueo de intervalos con clave de modo RangeI-N se coloca en la entrada de índice correspondiente al nombre David para probar el intervalo.</span><span class="sxs-lookup"><span data-stu-id="33c05-845">The RangeI-N mode key-range lock is placed on the index entry corresponding to the name David to test the range.</span></span> <span data-ttu-id="33c05-846">Si se concede el bloqueo, se inserta `Dan` y se coloca un bloqueo exclusivo (X) en el valor `Dan`.</span><span class="sxs-lookup"><span data-stu-id="33c05-846">If the lock is granted, `Dan` is inserted and an exclusive (X) lock is placed on the value `Dan`.</span></span> <span data-ttu-id="33c05-847">El bloqueo de intervalos con clave de modo RangeI-N solo es necesario para probar el intervalo y no se mantiene mientras se ejecuta la transacción que realiza la operación de inserción.</span><span class="sxs-lookup"><span data-stu-id="33c05-847">The RangeI-N mode key-range lock is necessary only to test the range and is not held for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="33c05-848">Otras transacciones pueden insertar o eliminar valores antes o después del valor insertado `Dan`.</span><span class="sxs-lookup"><span data-stu-id="33c05-848">Other transactions can insert or delete values before or after the inserted value `Dan`.</span></span> <span data-ttu-id="33c05-849">Sin embargo, cualquier transacción que intente leer, insertar o eliminar el valor `Dan` se bloqueará hasta que se confirme o se revierta la transacción de inserción.</span><span class="sxs-lookup"><span data-stu-id="33c05-849">However, any transaction attempting to read, insert, or delete the value `Dan` will be locked until the inserting transaction either commits or rolls back.</span></span>  
  
### <a name="dynamic-locking"></a><span data-ttu-id="33c05-850">Bloqueo dinámico</span><span class="sxs-lookup"><span data-stu-id="33c05-850">Dynamic Locking</span></span>  

 <span data-ttu-id="33c05-851">La utilización de bloqueos de bajo nivel, como los de fila, aumenta la simultaneidad reduciendo la probabilidad de que dos transacciones soliciten bloqueos de los mismos datos al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="33c05-851">Using low-level locks, such as row locks, increases concurrency by decreasing the probability that two transactions will request locks on the same piece of data at the same time.</span></span> <span data-ttu-id="33c05-852">También aumenta el número de bloqueos y los recursos necesarios para administrarlos.</span><span class="sxs-lookup"><span data-stu-id="33c05-852">Using low-level locks also increases the number of locks and the resources needed to manage them.</span></span> <span data-ttu-id="33c05-853">Los bloqueos de alto nivel de tabla o página producen una sobrecarga menor, pero a costa de reducir la simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-853">Using high-level table or page locks lowers overhead, but at the expense of lowering concurrency.</span></span>  
  
 <span data-ttu-id="33c05-854">![Diagrama que muestra el costo frente a la granularidad](media/lockcht.gif "Diagrama que muestra el costo frente a la granularidad")</span><span class="sxs-lookup"><span data-stu-id="33c05-854">![Diagram showing cost versus granularity](media/lockcht.gif "Diagram showing cost versus granularity")</span></span>  
  
 <span data-ttu-id="33c05-855">El [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utiliza una estrategia de bloqueo dinámico para determinar los bloqueos que son más eficaces.</span><span class="sxs-lookup"><span data-stu-id="33c05-855">The [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy to determine the most cost-effective locks.</span></span> <span data-ttu-id="33c05-856">El [!INCLUDE[ssDE](../includes/ssde-md.md)] determina automáticamente los bloqueos más apropiados cuando se ejecuta la consulta, basándose en las características del esquema y de la consulta.</span><span class="sxs-lookup"><span data-stu-id="33c05-856">The [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically determines what locks are most appropriate when the query is executed, based on the characteristics of the schema and query.</span></span> <span data-ttu-id="33c05-857">Por ejemplo, para reducir la sobrecarga de bloqueos, el optimizador puede decidir la realización de bloqueos de página en un índice al realizar un recorrido del índice.</span><span class="sxs-lookup"><span data-stu-id="33c05-857">For example, to reduce the overhead of locking, the optimizer may choose page-level locks in an index when performing an index scan.</span></span>  
  
 <span data-ttu-id="33c05-858">El bloqueo dinámico presenta las ventajas siguientes:</span><span class="sxs-lookup"><span data-stu-id="33c05-858">Dynamic locking has the following advantages:</span></span>  
  
-   <span data-ttu-id="33c05-859">Administración simplificada de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-859">Simplified database administration.</span></span> <span data-ttu-id="33c05-860">Los administradores de bases de datos no tienen que preocuparse de ajustar los umbrales de extensión de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-860">Database administrators do not have to adjust lock escalation thresholds.</span></span>  
  
-   <span data-ttu-id="33c05-861">Mayor rendimiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-861">Increased performance.</span></span> <span data-ttu-id="33c05-862">El [!INCLUDE[ssDE](../includes/ssde-md.md)] minimiza la sobrecarga del sistema al utilizar los bloqueos apropiados para la tarea.</span><span class="sxs-lookup"><span data-stu-id="33c05-862">The [!INCLUDE[ssDE](../includes/ssde-md.md)] minimizes system overhead by using locks appropriate to the task.</span></span>  
  
-   <span data-ttu-id="33c05-863">Los programadores de aplicaciones se pueden concentrar en la programación.</span><span class="sxs-lookup"><span data-stu-id="33c05-863">Application developers can concentrate on development.</span></span> <span data-ttu-id="33c05-864">El [!INCLUDE[ssDE](../includes/ssde-md.md)] ajusta los bloqueos automáticamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-864">The [!INCLUDE[ssDE](../includes/ssde-md.md)] adjusts locking automatically.</span></span>  
  
 <span data-ttu-id="33c05-865">En [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] y versiones posteriores, el comportamiento de la extensión de bloqueo ha cambiado con la introducción de la opción LOCK_ESCALATION.</span><span class="sxs-lookup"><span data-stu-id="33c05-865">In [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] and later versions, the behavior of lock escalation has changed with the introduction of the LOCK_ESCALATION option.</span></span> <span data-ttu-id="33c05-866">Para obtener más información, vea la opción LOCK_ESCALATION de [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-866">For more information, see the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="deadlocking"></a><span data-ttu-id="33c05-867">Interbloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-867">Deadlocking</span></span>  

 <span data-ttu-id="33c05-868">Un interbloqueo se produce cuando dos o más tareas se bloquean entre sí permanentemente teniendo cada tarea un bloqueo en un recurso que las otras tareas intentan bloquear.</span><span class="sxs-lookup"><span data-stu-id="33c05-868">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="33c05-869">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="33c05-869">For example:</span></span>  
  
-   <span data-ttu-id="33c05-870">La transacción A tiene un bloqueo compartido de la fila 1.</span><span class="sxs-lookup"><span data-stu-id="33c05-870">Transaction A acquires a share lock on row 1.</span></span>  
  
-   <span data-ttu-id="33c05-871">La transacción B tiene un bloqueo compartido de la fila 2.</span><span class="sxs-lookup"><span data-stu-id="33c05-871">Transaction B acquires a share lock on row 2.</span></span>  
  
-   <span data-ttu-id="33c05-872">La transacción A ahora solicita un bloqueo exclusivo de la fila 2 y se bloquea hasta que la transacción B finalice y libere el bloqueo compartido que tiene de la fila 2.</span><span class="sxs-lookup"><span data-stu-id="33c05-872">Transaction A now requests an exclusive lock on row 2, and is blocked until transaction B finishes and releases the share lock it has on row 2.</span></span>  
  
-   <span data-ttu-id="33c05-873">La transacción B ahora solicita un bloqueo exclusivo de la fila 1 y se bloquea hasta que la transacción A finalice y libere el bloqueo compartido que tiene de la fila 1.</span><span class="sxs-lookup"><span data-stu-id="33c05-873">Transaction B now requests an exclusive lock on row 1, and is blocked until transaction A finishes and releases the share lock it has on row 1.</span></span>  
  
 <span data-ttu-id="33c05-874">La transacción A no se puede completar hasta que se complete la transacción B, pero la transacción B está bloqueada por la transacción A. Esta condición también se denomina una dependencia cíclica: La transacción A tiene una dependencia de la transacción B y la transacción B cierra el círculo con una dependencia en la transacción A.</span><span class="sxs-lookup"><span data-stu-id="33c05-874">Transaction A cannot complete until transaction B completes, but transaction B is blocked by transaction A. This condition is also called a cyclic dependency: Transaction A has a dependency on transaction B, and transaction B closes the circle by having a dependency on transaction A.</span></span>  
  
 <span data-ttu-id="33c05-875">Ambas transacciones con un interbloqueo esperarán para siempre, a no ser que un proceso externo rompa el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-875">Both transactions in a deadlock will wait forever unless the deadlock is broken by an external process.</span></span> <span data-ttu-id="33c05-876">La supervisión de interbloqueos del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] comprueba periódicamente si hay tareas con un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-876">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] deadlock monitor periodically checks for tasks that are in a deadlock.</span></span> <span data-ttu-id="33c05-877">Si el monitor detecta una dependencia cíclica, elige una de las tareas como el sujeto y finaliza su transacción con un error.</span><span class="sxs-lookup"><span data-stu-id="33c05-877">If the monitor detects a cyclic dependency, it chooses one of the tasks as a victim and terminates its transaction with an error.</span></span> <span data-ttu-id="33c05-878">Esto permite a la otra tarea completar su transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-878">This allows the other task to complete its transaction.</span></span> <span data-ttu-id="33c05-879">La aplicación con la transacción que terminó con un error puede reintentar la transacción, que suele completarse después de que la otra transacción interbloqueada haya finalizado.</span><span class="sxs-lookup"><span data-stu-id="33c05-879">The application with the transaction that terminated with an error can retry the transaction, which usually completes after the other deadlocked transaction has finished.</span></span>  
  
 <span data-ttu-id="33c05-880">A menudo se confunden los interbloqueos con los bloqueos normales.</span><span class="sxs-lookup"><span data-stu-id="33c05-880">Deadlocking is often confused with normal blocking.</span></span> <span data-ttu-id="33c05-881">Cuando una transacción solicita un bloqueo en un recurso bloqueado por otra transacción, la transacción solicitante espera hasta que se libere el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-881">When a transaction requests a lock on a resource locked by another transaction, the requesting transaction waits until the lock is released.</span></span> <span data-ttu-id="33c05-882">De forma predeterminada, las transacciones de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] no tienen tiempo de espera, a menos que se establezca LOCK_TIMEOUT.</span><span class="sxs-lookup"><span data-stu-id="33c05-882">By default, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] transactions do not time out, unless LOCK_TIMEOUT is set.</span></span> <span data-ttu-id="33c05-883">La transacción solicitante está bloqueada, no interbloqueada, porque la transacción solicitante no ha hecho nada para bloquear la transacción a la que pertenece el bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-883">The requesting transaction is blocked, not deadlocked, because the requesting transaction has not done anything to block the transaction owning the lock.</span></span> <span data-ttu-id="33c05-884">Finalmente, la transacción a la que pertenece el bloqueo se completará y liberará el bloqueo, y a la transacción solicitante se le concederá el bloqueo y continuará.</span><span class="sxs-lookup"><span data-stu-id="33c05-884">Eventually, the owning transaction will complete and release the lock, and then the requesting transaction will be granted the lock and proceed.</span></span>  
  
 <span data-ttu-id="33c05-885">A veces, los interbloqueos se denominan "abrazo mortal".</span><span class="sxs-lookup"><span data-stu-id="33c05-885">Deadlocks are sometimes called a deadly embrace.</span></span>  
  
 <span data-ttu-id="33c05-886">Un interbloqueo es una condición que se puede dar en cualquier sistema con varios subprocesos, no solo en un sistema de administración de bases de datos relacionales, y puede producirse para recursos distintos a los bloqueos en objetos de base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-886">Deadlock is a condition that can occur on any system with multiple threads, not just on a relational database management system, and can occur for resources other than locks on database objects.</span></span> <span data-ttu-id="33c05-887">Por ejemplo, un subproceso en un sistema operativo con varios subprocesos puede adquirir uno o más recursos, como bloqueos de memoria.</span><span class="sxs-lookup"><span data-stu-id="33c05-887">For example, a thread in a multithreaded operating system might acquire one or more resources, such as blocks of memory.</span></span> <span data-ttu-id="33c05-888">Si el recurso que se desea adquirir pertenece actualmente a otro subproceso, puede que el primer subproceso deba esperar a que el otro libere el recurso de destino.</span><span class="sxs-lookup"><span data-stu-id="33c05-888">If the resource being acquired is currently owned by another thread, the first thread may have to wait for the owning thread to release the target resource.</span></span> <span data-ttu-id="33c05-889">En consecuencia, se dice que el subproceso que está en espera depende del subproceso que posee ese recurso concreto.</span><span class="sxs-lookup"><span data-stu-id="33c05-889">The waiting thread is said to have a dependency on the owning thread for that particular resource.</span></span> <span data-ttu-id="33c05-890">En una instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)], las sesiones pueden interbloquearse cuando adquieren recursos ajenos a la base de datos, como memoria o subprocesos.</span><span class="sxs-lookup"><span data-stu-id="33c05-890">In an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], sessions can deadlock when acquiring nondatabase resources, such as memory or threads.</span></span>  
  
 <span data-ttu-id="33c05-891">![Diagrama en el que se muestra un interbloqueo de transacciones](media/dedlck1.gif "Diagrama en el que se muestra un interbloqueo de transacciones")</span><span class="sxs-lookup"><span data-stu-id="33c05-891">![Diagram showing transaction deadlock](media/dedlck1.gif "Diagram showing transaction deadlock")</span></span>  
  
 <span data-ttu-id="33c05-892">En la ilustración, la transacción T1 tiene una dependencia de la transacción T2 para el recurso de bloqueo de la tabla **Part**.</span><span class="sxs-lookup"><span data-stu-id="33c05-892">In the illustration, transaction T1 has a dependency on transaction T2 for the **Part** table lock resource.</span></span> <span data-ttu-id="33c05-893">Del mismo modo, la transacción T2 tiene una dependencia de la transacción T1 para el recurso de bloqueo de la tabla **Supplier**.</span><span class="sxs-lookup"><span data-stu-id="33c05-893">Similarly, transaction T2 has a dependency on transaction T1 for the **Supplier** table lock resource.</span></span> <span data-ttu-id="33c05-894">Puesto que estas dependencias forman un ciclo, hay un interbloqueo entre las transacciones T1 y T2.</span><span class="sxs-lookup"><span data-stu-id="33c05-894">Because these dependencies form a cycle, there is a deadlock between transactions T1 and T2.</span></span>  
  
 <span data-ttu-id="33c05-895">Los interbloqueos también se pueden producir cuando se crean particiones en una tabla y el valor de LOCK_ESCALATION en ALTER TABLE se fija en AUTO.</span><span class="sxs-lookup"><span data-stu-id="33c05-895">Deadlocks can also occur when a table is partitioned and the LOCK_ESCALATION setting of ALTER TABLE is set to AUTO.</span></span> <span data-ttu-id="33c05-896">Cuando LOCK_ESCALATION se establece en AUTO, la simultaneidad aumenta permitiendo que [!INCLUDE[ssDE](../includes/ssde-md.md)] bloquee las particiones de tabla en el nivel de HoBT en lugar de en el nivel de tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-896">When LOCK_ESCALATION is set to AUTO, concurrency increases by allowing the [!INCLUDE[ssDE](../includes/ssde-md.md)] to lock table partitions at the HoBT level instead of at the TABLE level.</span></span> <span data-ttu-id="33c05-897">Sin embargo, cuando transacciones independientes mantienen bloqueos de partición en una tabla y desean un bloqueo en algún punto de la partición de otras transacciones, se produce un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-897">However, when separate transactions hold partition locks in a table and want a lock somewhere on the other transactions partition, this causes a deadlock.</span></span> <span data-ttu-id="33c05-898">Este tipo de interbloqueo se puede evitar asignando a LOCK_ESCALATION el valor TABLE; aunque este valor reducirá la simultaneidad obligando a las grandes actualizaciones de las particiones a esperar a que se produzca un bloqueo de la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-898">This type of deadlock can be avoided by setting LOCK_ESCALATION to TABLE; although this setting will reduce concurrency by forcing large updates to a partition to wait for a table lock.</span></span>  
  
#### <a name="detecting-and-ending-deadlocks"></a><span data-ttu-id="33c05-899">Detectar y finalizar interbloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-899">Detecting and Ending Deadlocks</span></span>  

 <span data-ttu-id="33c05-900">Un interbloqueo se produce cuando dos o más tareas se bloquean entre sí permanentemente teniendo cada tarea un bloqueo en un recurso que las otras tareas intentan bloquear.</span><span class="sxs-lookup"><span data-stu-id="33c05-900">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="33c05-901">En el siguiente gráfico se presenta una vista de alto nivel de un estado de interbloqueo donde:</span><span class="sxs-lookup"><span data-stu-id="33c05-901">The following graph presents a high level view of a deadlock state where:</span></span>  
  
-   <span data-ttu-id="33c05-902">La tarea T1 tiene un bloqueo en el recurso R1 (indicado por la flecha de R1 a T1) y ha solicitado un bloqueo en el recurso R2 (indicado por la flecha de T1 a R2).</span><span class="sxs-lookup"><span data-stu-id="33c05-902">Task T1 has a lock on resource R1 (indicated by the arrow from R1 to T1) and has requested a lock on resource R2 (indicated by the arrow from T1 to R2).</span></span>  
  
-   <span data-ttu-id="33c05-903">La tarea T2 tiene un bloqueo en el recurso R2 (indicado por la flecha de R2 a T2) y ha solicitado un bloqueo en el recurso R1 (indicado por la flecha de T2 a R1).</span><span class="sxs-lookup"><span data-stu-id="33c05-903">Task T2 has a lock on resource R2 (indicated by the arrow from R2 to T2) and has requested a lock on resource R1 (indicated by the arrow from T2 to R1).</span></span>  
  
-   <span data-ttu-id="33c05-904">Dado que ninguna tarea puede continuar hasta que un recurso esté disponible y ningún recurso puede liberarse hasta que continúe una tarea, existe un estado de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-904">Because neither task can continue until a resource is available and neither resource can be released until a task continues, a deadlock state exists.</span></span>  
  
 <span data-ttu-id="33c05-905">![Diagrama en el que se muestran tareas en un estado de interbloqueo](media/task-deadlock-state.gif "Diagrama en el que se muestran tareas en un estado de interbloqueo")</span><span class="sxs-lookup"><span data-stu-id="33c05-905">![Diagram showing tasks in a deadlock state](media/task-deadlock-state.gif "Diagram showing tasks in a deadlock state")</span></span>  
  
 <span data-ttu-id="33c05-906">El [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] detecta automáticamente los ciclos de interbloqueo en [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-906">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] automatically detects deadlock cycles within [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="33c05-907">El [!INCLUDE[ssDE](../includes/ssde-md.md)] elige una de las sesiones como sujeto del interbloqueo y la transacción actual finaliza con un error para romper el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-907">The [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses one of the sessions as a deadlock victim and the current transaction is terminated with an error to break the deadlock.</span></span>  
  
##### <a name="resources-that-can-deadlock"></a><span data-ttu-id="33c05-908">Recursos que pueden causar interbloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-908">Resources That Can Deadlock</span></span>  

 <span data-ttu-id="33c05-909">Cada sesión de usuario puede tener una o más tareas en ejecución y cada tarea puede adquirir o esperar para adquirir una serie de recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-909">Each user session might have one or more tasks running on its behalf where each task might acquire or wait to acquire a variety of resources.</span></span> <span data-ttu-id="33c05-910">Los siguientes tipos de recursos pueden causar bloqueos que podrían dar como resultado un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-910">The following types of resources can cause blocking that could result in a deadlock.</span></span>  
  
-   <span data-ttu-id="33c05-911">**Bloqueos**.</span><span class="sxs-lookup"><span data-stu-id="33c05-911">**Locks**.</span></span> <span data-ttu-id="33c05-912">Esperar para adquirir bloqueos en recursos, como objetos, páginas, filas, metadatos y aplicaciones, puede causar un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-912">Waiting to acquire locks on resources, such as objects, pages, rows, metadata, and applications can cause deadlock.</span></span> <span data-ttu-id="33c05-913">Por ejemplo, la transacción T1 tiene un bloqueo compartido (S) en la fila f1 y está esperando para obtener un bloqueo exclusivo (X) en f2.</span><span class="sxs-lookup"><span data-stu-id="33c05-913">For example, transaction T1 has a shared (S) lock on row r1 and is waiting to get an exclusive (X) lock on r2.</span></span> <span data-ttu-id="33c05-914">La transacción T2 tiene un bloqueo compartido (S) en f2 y está esperando para obtener un bloqueo exclusivo (X) en la fila f1.</span><span class="sxs-lookup"><span data-stu-id="33c05-914">Transaction T2 has a shared (S) lock on r2 and is waiting to get an exclusive (X) lock on row r1.</span></span> <span data-ttu-id="33c05-915">Esta situación tiene como resultado un ciclo de bloqueo en el que T1 y T2 esperan que la otra transacción libere los recursos bloqueados.</span><span class="sxs-lookup"><span data-stu-id="33c05-915">This results in a lock cycle in which T1 and T2 wait for each other to release the locked resources.</span></span>  
  
-   <span data-ttu-id="33c05-916">**Subprocesos de trabajo**.</span><span class="sxs-lookup"><span data-stu-id="33c05-916">**Worker threads**.</span></span> <span data-ttu-id="33c05-917">Una tarea en cola que espera un subproceso de trabajo disponible puede causar un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-917">A queued task waiting for an available worker thread can cause deadlock.</span></span> <span data-ttu-id="33c05-918">Si la tarea en cola es propietaria de recursos que están bloqueando todos los subprocesos de trabajo, se generará un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-918">If the queued task owns resources that are blocking all worker threads, a deadlock will result.</span></span> <span data-ttu-id="33c05-919">Por ejemplo, la sesión S1 inicia una transacción y adquiere un bloqueo compartido (S) en la fila f1 y, a continuación, se suspende.</span><span class="sxs-lookup"><span data-stu-id="33c05-919">For example, session S1 starts a transaction and acquires a shared (S) lock on row r1 and then goes to sleep.</span></span> <span data-ttu-id="33c05-920">Las sesiones activas que se ejecutan en todos los subprocesos de trabajo disponibles intentan adquirir bloqueos exclusivos (X) en la fila f1.</span><span class="sxs-lookup"><span data-stu-id="33c05-920">Active sessions running on all available worker threads are trying to acquire exclusive (X) locks on row r1.</span></span> <span data-ttu-id="33c05-921">Dado que la sesión S1 no puede adquirir un subproceso de trabajo, no puede confirmar la transacción y liberar el bloqueo de la fila f1.</span><span class="sxs-lookup"><span data-stu-id="33c05-921">Because session S1 cannot acquire a worker thread, it cannot commit the transaction and release the lock on row r1.</span></span> <span data-ttu-id="33c05-922">Esta situación tiene como resultado un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-922">This results in a deadlock.</span></span>  
  
-   <span data-ttu-id="33c05-923">**Memoria**.</span><span class="sxs-lookup"><span data-stu-id="33c05-923">**Memory**.</span></span> <span data-ttu-id="33c05-924">Cuando hay solicitudes simultáneas esperando concesiones de memoria que no se pueden satisfacer con la memoria disponible, puede producirse un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-924">When concurrent requests are waiting for memory grants that cannot be satisfied with the available memory, a deadlock can occur.</span></span> <span data-ttu-id="33c05-925">Por ejemplo, dos consultas simultáneas, C1 y C2, se ejecutan como funciones definidas por el usuario que adquieren 10 MB y 20 MB de memoria respectivamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-925">For example, two concurrent queries, Q1 and Q2, execute as user-defined functions that acquire 10MB and 20MB of memory respectively.</span></span> <span data-ttu-id="33c05-926">Si cada consulta necesita 30 MB y el total de memoria disponible es 20 MB, C1 y C2 tienen que esperar a que la otra consulta libere memoria, y esta situación tiene como resultado un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-926">If each query needs 30MB and the total available memory is 20MB, then Q1 and Q2 must wait for each other to release memory, and this results in a deadlock.</span></span>  
  
-   <span data-ttu-id="33c05-927">**Recursos relacionados con la ejecución de consultas en paralelo**. Los subprocesos de coordinador, productor o consumidor asociados a un puerto de intercambio pueden bloquearse entre sí y provocar un interbloqueo si incluyen al menos otro proceso que no forma parte de la consulta en paralelo.</span><span class="sxs-lookup"><span data-stu-id="33c05-927">**Parallel query execution-related resources** Coordinator, producer, or consumer threads associated with an exchange port may block each other causing a deadlock usually when including at least one other process that is not a part of the parallel query.</span></span> <span data-ttu-id="33c05-928">Además, cuando se inicia la ejecución de una consulta en paralelo, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determina el grado de paralelismo, o el número de subprocesos de trabajo, en función de la carga de trabajo actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-928">Also, when a parallel query starts execution, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines the degree of parallelism, or the number of worker threads, based upon the current workload.</span></span> <span data-ttu-id="33c05-929">Si la carga de trabajo del sistema cambia de forma inesperada, por ejemplo, si se empiezan a ejecutar nuevas consultas en el servidor o el sistema se queda sin subprocesos de trabajo, se puede producir un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-929">If the system workload unexpectedly changes, for example, where new queries start running on the server or the system runs out of worker threads, then a deadlock could occur.</span></span>  
  
-   <span data-ttu-id="33c05-930">**Conjuntos de resultados activos múltiples (MARS)** .</span><span class="sxs-lookup"><span data-stu-id="33c05-930">**Multiple Active Result Sets (MARS) resources**.</span></span> <span data-ttu-id="33c05-931">Estos recursos se utilizan para controlar la intercalación de varias solicitudes activas en MARS.</span><span class="sxs-lookup"><span data-stu-id="33c05-931">These resources are used to control interleaving of multiple active requests under MARS.</span></span> <span data-ttu-id="33c05-932">Para obtener más información, vea [conjuntos de resultados activos múltiples (Mars) en SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="33c05-932">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
    -   <span data-ttu-id="33c05-933">**Recurso de usuario**.</span><span class="sxs-lookup"><span data-stu-id="33c05-933">**User resource**.</span></span> <span data-ttu-id="33c05-934">Cuando un subproceso espera un recurso que potencialmente está controlado por una aplicación de usuario, se considera que el recurso es externo o de usuario y se trata como un bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-934">When a thread is waiting for a resource that is potentially controlled by a user application, the resource is considered to be an external or user resource and is treated like a lock.</span></span>  
  
    -   <span data-ttu-id="33c05-935">**Exclusión mutua de sesión**.</span><span class="sxs-lookup"><span data-stu-id="33c05-935">**Session mutex**.</span></span> <span data-ttu-id="33c05-936">Las tareas que se ejecutan en una sesión se intercalan, lo que significa que solo puede ejecutarse una tarea en la sesión en un momento dado.</span><span class="sxs-lookup"><span data-stu-id="33c05-936">The tasks running in one session are interleaved, meaning that only one task can run under the session at a given time.</span></span> <span data-ttu-id="33c05-937">Antes de que se pueda ejecutar la tarea, debe tener acceso exclusivo a la exclusión mutua de sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-937">Before the task can run, it must have exclusive access to the session mutex.</span></span>  
  
    -   <span data-ttu-id="33c05-938">**Exclusión mutua de transacción**.</span><span class="sxs-lookup"><span data-stu-id="33c05-938">**Transaction mutex**.</span></span> <span data-ttu-id="33c05-939">Todas las tareas que se ejecutan en una transacción se intercalan, lo que significa que solo puede ejecutarse una tarea en la transacción en un momento dado.</span><span class="sxs-lookup"><span data-stu-id="33c05-939">All tasks running in one transaction are interleaved, meaning that only one task can run under the transaction at a given time.</span></span> <span data-ttu-id="33c05-940">Antes de que se pueda ejecutar la tarea, debe tener acceso exclusivo a la exclusión mutua de transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-940">Before the task can run, it must have exclusive access to the transaction mutex.</span></span>  
  
     <span data-ttu-id="33c05-941">Para que una tarea se ejecute en MARS, debe adquirir la exclusión mutua de sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-941">In order for a task to run under MARS, it must acquire the session mutex.</span></span> <span data-ttu-id="33c05-942">Si la tarea se ejecuta en una transacción, debe adquirir la exclusión mutua de transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-942">If the task is running under a transaction, it must then acquire the transaction mutex.</span></span> <span data-ttu-id="33c05-943">Esto garantiza que solo una tarea esté activa en un momento dado en una sesión determinada y en una transacción concreta.</span><span class="sxs-lookup"><span data-stu-id="33c05-943">This guarantees that only one task is active at one time in a given session and a given transaction.</span></span> <span data-ttu-id="33c05-944">Una vez adquiridas las exclusiones mutuas necesarias, se puede ejecutar la tarea.</span><span class="sxs-lookup"><span data-stu-id="33c05-944">Once the required mutexes have been acquired, the task can execute.</span></span> <span data-ttu-id="33c05-945">Cuando finaliza la tarea, o se produce en medio de la solicitud, primero liberará la exclusión mutua de transacción seguida de la exclusión mutua de sesión en el orden inverso a la adquisición.</span><span class="sxs-lookup"><span data-stu-id="33c05-945">When the task finishes, or yields in the middle of the request, it will first release transaction mutex followed by the session mutex in reverse order of acquisition.</span></span> <span data-ttu-id="33c05-946">Sin embargo, pueden producirse interbloqueos con estos recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-946">However, deadlocks can occur with these resources.</span></span> <span data-ttu-id="33c05-947">En el ejemplo de código siguiente hay dos tareas, la solicitud de usuario U1 y la solicitud de usuario U2, que se ejecutan en la misma sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-947">In the following code example, two tasks, user request U1 and user request U2, are running in the same session.</span></span>  
  
    ```  
    U1:    Rs1=Command1.Execute("insert sometable EXEC usp_someproc");  
    U2:    Rs2=Command2.Execute("select colA from sometable");  
    ```  
  
     <span data-ttu-id="33c05-948">El procedimiento almacenado que se ejecuta a partir de la solicitud de usuario U1 ha adquirido la exclusión mutua de sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-948">The stored procedure executing from user request U1 has acquired the session mutex.</span></span> <span data-ttu-id="33c05-949">Si el procedimiento almacenado tarda mucho tiempo en ejecutarse, el [!INCLUDE[ssDE](../includes/ssde-md.md)] considerará que el procedimiento almacenado está esperando la intervención del usuario.</span><span class="sxs-lookup"><span data-stu-id="33c05-949">If the stored procedure takes a long time to execute, it is assumed by the [!INCLUDE[ssDE](../includes/ssde-md.md)] that the stored procedure is waiting for input from the user.</span></span> <span data-ttu-id="33c05-950">La solicitud de usuario U2 está esperando la exclusión mutua de sesión mientras que el usuario está esperando el conjunto de resultados de U2, y U1 está esperando un recurso de usuario.</span><span class="sxs-lookup"><span data-stu-id="33c05-950">User request U2 is waiting for the session mutex while the user is waiting for the result set from U2, and U1 is waiting for a user resource.</span></span> <span data-ttu-id="33c05-951">Éste es un estado de interbloqueo que se ilustra de forma lógica como:</span><span class="sxs-lookup"><span data-stu-id="33c05-951">This is deadlock state logically illustrated as:</span></span>  
  
 <span data-ttu-id="33c05-952">![Diagrama lógico que muestra el interbloqueo de procesos de usuario.](media/udb9-logicflowexamplec.gif "Diagrama lógico que muestra el interbloqueo de procesos de usuario.")</span><span class="sxs-lookup"><span data-stu-id="33c05-952">![Logic diagram showing user process deadlock.](media/udb9-logicflowexamplec.gif "Logic diagram showing user process deadlock.")</span></span>  
  
##### <a name="deadlock-detection"></a><span data-ttu-id="33c05-953">Detección de interbloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-953">Deadlock Detection</span></span>  

 <span data-ttu-id="33c05-954">Todos los recursos enumerados en la sección anterior participan en el esquema de detección de interbloqueos del [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-954">All of the resources listed in the section above participate in the [!INCLUDE[ssDE](../includes/ssde-md.md)] deadlock detection scheme.</span></span> <span data-ttu-id="33c05-955">La detección de interbloqueos la realiza un subproceso de supervisión de bloqueos que periódicamente inicia una búsqueda por todas las tareas de una instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-955">Deadlock detection is performed by a lock monitor thread that periodically initiates a search through all of the tasks in an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="33c05-956">En los siguientes puntos se describe el proceso de búsqueda:</span><span class="sxs-lookup"><span data-stu-id="33c05-956">The following points describe the search process:</span></span>  
  
-   <span data-ttu-id="33c05-957">El intervalo predeterminado es de 5 segundos.</span><span class="sxs-lookup"><span data-stu-id="33c05-957">The default interval is 5 seconds.</span></span>  
  
-   <span data-ttu-id="33c05-958">Si el subproceso de supervisión de bloqueos encuentra interbloqueos, el intervalo de detección de interbloqueos pasará de 5 segundos a hasta solo 100 milisegundos, en función de la frecuencia de los interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-958">If the lock monitor thread finds deadlocks, the deadlock detection interval will drop from 5 seconds to as low as 100 milliseconds depending on the frequency of deadlocks.</span></span>  
  
-   <span data-ttu-id="33c05-959">Si el subproceso de supervisión de bloqueos deja de encontrar interbloqueos, el [!INCLUDE[ssDE](../includes/ssde-md.md)] aumentará los intervalos entre las búsquedas a 5 segundos.</span><span class="sxs-lookup"><span data-stu-id="33c05-959">If the lock monitor thread stops finding deadlocks, the [!INCLUDE[ssDE](../includes/ssde-md.md)] increases the intervals between searches to 5 seconds.</span></span>  
  
-   <span data-ttu-id="33c05-960">Si se acaba de detectar un interbloqueo, se considera que los siguientes subprocesos que deben esperar un bloqueo entran en el ciclo de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-960">If a deadlock has just been detected, it is assumed that the next threads that must wait for a lock are entering the deadlock cycle.</span></span> <span data-ttu-id="33c05-961">La primera pareja de esperas de bloqueo después de que se haya detectado un interbloqueo desencadenará inmediatamente una búsqueda de interbloqueos, en vez de esperar al siguiente intervalo de detección de interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-961">The first couple of lock waits after a deadlock has been detected will immediately trigger a deadlock search rather than wait for the next deadlock detection interval.</span></span> <span data-ttu-id="33c05-962">Por ejemplo, si el intervalo actual es de 5 segundos y se acaba de detectar un interbloqueo, la siguiente espera de bloqueo activará inmediatamente el detector de interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-962">For example, if the current interval is 5 seconds, and a deadlock was just detected, the next lock wait will kick off the deadlock detector immediately.</span></span> <span data-ttu-id="33c05-963">Si esta espera de bloqueo forma parte de un interbloqueo, se detectará en seguida en lugar de durante la siguiente búsqueda de interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-963">If this lock wait is part of a deadlock, it will be detected right away rather than during next deadlock search.</span></span>  
  
 <span data-ttu-id="33c05-964">El [!INCLUDE[ssDE](../includes/ssde-md.md)] solo suele realizar detecciones de interbloqueos periódicas.</span><span class="sxs-lookup"><span data-stu-id="33c05-964">The [!INCLUDE[ssDE](../includes/ssde-md.md)] typically performs periodic deadlock detection only.</span></span> <span data-ttu-id="33c05-965">Dado que el número de interbloqueos que se encuentran en el sistema suele ser pequeño, si se detectan periódicamente, el sistema no se ve sobrecargado por este tipo de detecciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-965">Because the number of deadlocks encountered in the system is usually small, periodic deadlock detection helps to reduce the overhead of deadlock detection in the system.</span></span>  
  
 <span data-ttu-id="33c05-966">Cuando el monitor de bloqueos inicia una búsqueda de interbloqueos para un subproceso determinado, identifica el recurso que está esperando.</span><span class="sxs-lookup"><span data-stu-id="33c05-966">When the lock monitor initiates deadlock search for a particular thread, it identifies the resource on which the thread is waiting.</span></span> <span data-ttu-id="33c05-967">Después, el monitor de bloqueos encuentra al propietario o a los propietarios de ese recurso y continúa recursivamente la búsqueda de interbloqueos para esos subprocesos hasta que encuentra un ciclo.</span><span class="sxs-lookup"><span data-stu-id="33c05-967">The lock monitor then finds the owner(s) for that particular resource and recursively continues the deadlock search for those threads until it finds a cycle.</span></span> <span data-ttu-id="33c05-968">Un ciclo que se identifica de esta manera forma un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-968">A cycle identified in this manner forms a deadlock.</span></span>  
  
 <span data-ttu-id="33c05-969">Una vez detectado un interbloqueo, el [!INCLUDE[ssDE](../includes/ssde-md.md)] finaliza un interbloqueo eligiendo uno de los subprocesos como sujeto del interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-969">After a deadlock is detected, the [!INCLUDE[ssDE](../includes/ssde-md.md)] ends a deadlock by choosing one of the threads as a deadlock victim.</span></span> <span data-ttu-id="33c05-970">El [!INCLUDE[ssDE](../includes/ssde-md.md)] finaliza el lote actual que se está ejecutando para el subproceso, revierte la transacción del sujeto del interbloqueo y devuelve un error 1205 a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-970">The [!INCLUDE[ssDE](../includes/ssde-md.md)] terminates the current batch being executed for the thread, rolls back the transaction of the deadlock victim, and returns a 1205 error to the application.</span></span> <span data-ttu-id="33c05-971">Revertir la transacción para el sujeto del interbloqueo libera todos los bloqueos que tiene la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-971">Rolling back the transaction for the deadlock victim releases all locks held by the transaction.</span></span> <span data-ttu-id="33c05-972">Esto permite que las transacciones de otros subprocesos se desbloqueen y continúen.</span><span class="sxs-lookup"><span data-stu-id="33c05-972">This allows the transactions of the other threads to become unblocked and continue.</span></span> <span data-ttu-id="33c05-973">El error 1205 del sujeto del interbloqueo registra información sobre los subprocesos y recursos implicados en un interbloqueo en el registro de errores.</span><span class="sxs-lookup"><span data-stu-id="33c05-973">The 1205 deadlock victim error records information about the threads and resources involved in a deadlock in the error log.</span></span>  
  
 <span data-ttu-id="33c05-974">De forma predeterminada, el [!INCLUDE[ssDE](../includes/ssde-md.md)] elige como sujeto del interbloqueo la sesión que ejecuta la transacción cuya reversión resulta menos costosa.</span><span class="sxs-lookup"><span data-stu-id="33c05-974">By default, the [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses as the deadlock victim the session running the transaction that is least expensive to roll back.</span></span> <span data-ttu-id="33c05-975">Como alternativa, un usuario puede especificar la prioridad de las sesiones en una situación de interbloqueo mediante la instrucción SET DEADLOCK_PRIORITY.</span><span class="sxs-lookup"><span data-stu-id="33c05-975">Alternatively, a user can specify the priority of sessions in a deadlock situation using the SET DEADLOCK_PRIORITY statement.</span></span> <span data-ttu-id="33c05-976">DEADLOCK_PRIORITY puede establecerse como LOW, NORMAL o HIGH; también puede establecerse como un valor entero en el intervalo de -10 a 10.</span><span class="sxs-lookup"><span data-stu-id="33c05-976">DEADLOCK_PRIORITY can be set to LOW, NORMAL, or HIGH, or alternatively can be set to any integer value in the range (-10 to 10).</span></span> <span data-ttu-id="33c05-977">El valor predeterminado de la prioridad de interbloqueo es NORMAL.</span><span class="sxs-lookup"><span data-stu-id="33c05-977">The deadlock priority defaults to NORMAL.</span></span> <span data-ttu-id="33c05-978">Si dos sesiones tienen distintas prioridades de interbloqueo, la sesión con la prioridad menor se elige como el sujeto del interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-978">If two sessions have different deadlock priorities, the session with the lower priority is chosen as the deadlock victim.</span></span> <span data-ttu-id="33c05-979">Si ambas sesiones tienen la misma prioridad de interbloqueo, se elige la sesión con la transacción cuya reversión resulta menos costosa.</span><span class="sxs-lookup"><span data-stu-id="33c05-979">If both sessions have the same deadlock priority, the session with the transaction that is least expensive to roll back is chosen.</span></span> <span data-ttu-id="33c05-980">Si las sesiones implicadas en el ciclo de interbloqueo tienen la misma prioridad de interbloqueo y el mismo costo, se elige un sujeto de forma aleatoria.</span><span class="sxs-lookup"><span data-stu-id="33c05-980">If sessions involved in the deadlock cycle have the same deadlock priority and the same cost, a victim is chosen randomly.</span></span>  
  
 <span data-ttu-id="33c05-981">Cuando se trabaja con CLR, el monitor de interbloqueos detecta automáticamente el interbloqueo de los recursos de sincronización (monitores, bloqueo de lectura y escritura, y combinación de subprocesos) a los que se ha tenido acceso dentro de los procedimientos administrados.</span><span class="sxs-lookup"><span data-stu-id="33c05-981">When working with CLR, the deadlock monitor automatically detects deadlock for synchronization resources (monitors, reader/writer lock and thread join) accessed inside managed procedures.</span></span> <span data-ttu-id="33c05-982">Si embargo, el interbloqueo se resuelve iniciando una excepción en el procedimiento que se seleccionó como sujeto del interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-982">However, the deadlock is resolved by throwing an exception in the procedure that was selected to be the deadlock victim.</span></span> <span data-ttu-id="33c05-983">Es importante comprender que la excepción no libera automáticamente los recursos que posee actualmente el sujeto; los recursos se tienen que liberar de forma explícita.</span><span class="sxs-lookup"><span data-stu-id="33c05-983">It is important to understand that the exception does not automatically release resources currently owned by the victim; the resources must be explicitly released.</span></span> <span data-ttu-id="33c05-984">De forma coherente con el comportamiento de la excepción, la excepción utilizada para identificar un sujeto del interbloqueo se puede interceptar y descartar.</span><span class="sxs-lookup"><span data-stu-id="33c05-984">Consistent with exception behavior, the exception used to identify a deadlock victim can be caught and dismissed.</span></span>  
  
##### <a name="deadlock-information-tools"></a><span data-ttu-id="33c05-985">Herramientas de información de interbloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-985">Deadlock Information Tools</span></span>  

 <span data-ttu-id="33c05-986">Para ver la información de interbloqueos, [!INCLUDE[ssDE](../includes/ssde-md.md)] proporciona herramientas de supervisión en la forma de dos marcas de seguimiento, y el evento deadlock graph del [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-986">To view deadlock information, the [!INCLUDE[ssDE](../includes/ssde-md.md)] provides monitoring tools in the form of two trace flags, and the deadlock graph event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span></span>  
  
###### <a name="trace-flag-1204-and-trace-flag-1222"></a><span data-ttu-id="33c05-987">Marcas de seguimiento 1204 y 1222</span><span class="sxs-lookup"><span data-stu-id="33c05-987">Trace Flag 1204 and Trace Flag 1222</span></span>  

 <span data-ttu-id="33c05-988">Cuando se produce el interbloqueo, los marcadores de seguimiento 1204 y 1222 devuelven la información que se ha capturado en el registro de errores de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-988">When deadlocks occur, trace flag 1204 and trace flag 1222 return information that is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="33c05-989">El marcador de seguimiento 1204 informa sobre el interbloqueo con un formato que especifica cada nodo implicado en el mismo.</span><span class="sxs-lookup"><span data-stu-id="33c05-989">Trace flag 1204 reports deadlock information formatted by each node involved in the deadlock.</span></span> <span data-ttu-id="33c05-990">El marcador de seguimiento 1222 aplica formato a la información de interbloqueo, primero por procesos y luego por recursos.</span><span class="sxs-lookup"><span data-stu-id="33c05-990">Trace flag 1222 formats deadlock information, first by processes and then by resources.</span></span> <span data-ttu-id="33c05-991">Es posible habilitar ambas marcas de seguimiento para obtener dos representaciones del mismo evento de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-991">It is possible to enable both trace flags to obtain two representations of the same deadlock event.</span></span>  
  
 <span data-ttu-id="33c05-992">Además de definir las propiedades de las marcas de seguimiento 1204 y 1222, en la siguiente tabla se muestran las similitudes y las diferencias.</span><span class="sxs-lookup"><span data-stu-id="33c05-992">In addition to defining the properties of trace flag 1204 and 1222, the following table also shows the similarities and differences.</span></span>  
  
|<span data-ttu-id="33c05-993">Propiedad</span><span class="sxs-lookup"><span data-stu-id="33c05-993">Property</span></span>|<span data-ttu-id="33c05-994">Marcas de seguimiento 1204 y 1222</span><span class="sxs-lookup"><span data-stu-id="33c05-994">Trace Flag 1204 and Trace Flag 1222</span></span>|<span data-ttu-id="33c05-995">Solo marca de seguimiento 1204</span><span class="sxs-lookup"><span data-stu-id="33c05-995">Trace Flag 1204 only</span></span>|<span data-ttu-id="33c05-996">Solo marca de seguimiento 1222</span><span class="sxs-lookup"><span data-stu-id="33c05-996">Trace Flag 1222 only</span></span>|  
|--------------|-----------------------------------------|--------------------------|--------------------------|  
|<span data-ttu-id="33c05-997">Formato de salida</span><span class="sxs-lookup"><span data-stu-id="33c05-997">Output format</span></span>|<span data-ttu-id="33c05-998">Los resultados se capturan en el registro de errores de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-998">Output is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>|<span data-ttu-id="33c05-999">Se centra en los nodos implicados en el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-999">Focused on the nodes involved in the deadlock.</span></span> <span data-ttu-id="33c05-1000">Cada nodo tiene una sección dedicada y la última sección describe al sujeto del interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1000">Each node has a dedicated section, and the final section describes the deadlock victim.</span></span>|<span data-ttu-id="33c05-1001">Devuelve información en un formato XML que no se ajusta a un esquema de definición de esquemas XML (XSD).</span><span class="sxs-lookup"><span data-stu-id="33c05-1001">Returns information in an XML-like format that does not conform to an XML Schema Definition (XSD) schema.</span></span> <span data-ttu-id="33c05-1002">El formato tiene tres secciones principales.</span><span class="sxs-lookup"><span data-stu-id="33c05-1002">The format has three major sections.</span></span> <span data-ttu-id="33c05-1003">La primera sección declara el sujeto del interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1003">The first section declares the deadlock victim.</span></span> <span data-ttu-id="33c05-1004">La segunda sección describe los procesos implicados en el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1004">The second section describes each process involved in the deadlock.</span></span> <span data-ttu-id="33c05-1005">La tercera sección describe los recursos que son sinónimos de nodos en la marca de seguimiento 1204.</span><span class="sxs-lookup"><span data-stu-id="33c05-1005">The third section describes the resources that are synonymous with nodes in trace flag 1204.</span></span>|  
|<span data-ttu-id="33c05-1006">Atributos de identificación</span><span class="sxs-lookup"><span data-stu-id="33c05-1006">Identifying attributes</span></span>|<span data-ttu-id="33c05-1007">**SPID: \<x> ECID: \<x> .**</span><span class="sxs-lookup"><span data-stu-id="33c05-1007">**SPID:\<x> ECID:\<x>.**</span></span> <span data-ttu-id="33c05-1008">Identifica el subproceso del identificador de proceso del sistema en los casos de procesos paralelos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1008">Identifies the system process ID thread in cases of parallel processes.</span></span> <span data-ttu-id="33c05-1009">La entrada `SPID:<x> ECID:0` , donde \<x> se reemplaza por el valor de SPID, representa el subproceso principal.</span><span class="sxs-lookup"><span data-stu-id="33c05-1009">The entry `SPID:<x> ECID:0`, where \<x> is replaced by the SPID value, represents the main thread.</span></span> <span data-ttu-id="33c05-1010">La entrada `SPID:<x> ECID:<y>` , donde \<x> se reemplaza por el valor de SPID y \<y> es mayor que 0, representa los subprocesos secundarios del mismo SPID.</span><span class="sxs-lookup"><span data-stu-id="33c05-1010">The entry `SPID:<x> ECID:<y>`, where \<x> is replaced by the SPID value and \<y> is greater than 0, represents the sub-threads for the same SPID.</span></span><br /><br /> <span data-ttu-id="33c05-1011">**BatchID** (**sbid** para la marca de seguimiento 1222).</span><span class="sxs-lookup"><span data-stu-id="33c05-1011">**BatchID** (**sbid** for trace flag 1222).</span></span> <span data-ttu-id="33c05-1012">Identifica el lote desde el que la ejecución del código está solicitando o manteniendo un bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1012">Identifies the batch from which code execution is requesting or holding a lock.</span></span> <span data-ttu-id="33c05-1013">Cuando se deshabilita Multiple Active Result Sets (MARTE), el valor de BatchID es 0.</span><span class="sxs-lookup"><span data-stu-id="33c05-1013">When Multiple Active Result Sets (MARS) is disabled, the BatchID value is 0.</span></span> <span data-ttu-id="33c05-1014">Cuando se habilita MART, el valor para los lotes activos es 1 para *n*.</span><span class="sxs-lookup"><span data-stu-id="33c05-1014">When MARS is enabled, the value for active batches is 1 to *n*.</span></span> <span data-ttu-id="33c05-1015">Si en la sesión no hay lotes activos, BatchID es 0.</span><span class="sxs-lookup"><span data-stu-id="33c05-1015">If there are no active batches in the session, BatchID is 0.</span></span><br /><br /> <span data-ttu-id="33c05-1016">**Mode**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1016">**Mode**.</span></span> <span data-ttu-id="33c05-1017">Especifica el tipo de bloqueo de un recurso en concreto que un subproceso solicita, concede o espera.</span><span class="sxs-lookup"><span data-stu-id="33c05-1017">Specifies the type of lock for a particular resource that is requested, granted, or waited on by a thread.</span></span> <span data-ttu-id="33c05-1018">Mode puede ser IS (Intención compartida), S (Compartido), U (Actualizar), IX (Intención exclusiva), SIX (Intención compartida exclusiva) y X (Exclusiva).</span><span class="sxs-lookup"><span data-stu-id="33c05-1018">Mode can be IS (Intent Shared), S (Shared), U (Update), IX (Intent Exclusive), SIX (Shared with Intent Exclusive), and X (Exclusive).</span></span><br /><br /> <span data-ttu-id="33c05-1019">**Line #** (**line** para la marca de seguimiento 1222).</span><span class="sxs-lookup"><span data-stu-id="33c05-1019">**Line #** (**line** for trace flag 1222).</span></span> <span data-ttu-id="33c05-1020">Indica el número de línea en el lote actual de instrucciones que se estaba ejecutando cuando se produjo el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1020">Lists the line number in the current batch of statements that was being executed when the deadlock occurred.</span></span><br /><br /> <span data-ttu-id="33c05-1021">**Input Buf** (**inputbuf** para la marca de seguimiento 1222).</span><span class="sxs-lookup"><span data-stu-id="33c05-1021">**Input Buf** (**inputbuf** for trace flag 1222).</span></span> <span data-ttu-id="33c05-1022">Indica todas las instrucciones del lote actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1022">Lists all the statements in the current batch.</span></span>|<span data-ttu-id="33c05-1023">**Node**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1023">**Node**.</span></span> <span data-ttu-id="33c05-1024">Representa el numero de entrada en la cadena de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1024">Represents the entry number in the deadlock chain.</span></span><br /><br /> <span data-ttu-id="33c05-1025">**Lists**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1025">**Lists**.</span></span> <span data-ttu-id="33c05-1026">El propietario del bloqueo puede formar parte de estas listas:</span><span class="sxs-lookup"><span data-stu-id="33c05-1026">The lock owner can be part of these lists:</span></span><br /><br /> <span data-ttu-id="33c05-1027">**Grant List**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1027">**Grant List**.</span></span> <span data-ttu-id="33c05-1028">Enumera los propietarios actuales del recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-1028">Enumerates the current owners of the resource.</span></span><br /><br /> <span data-ttu-id="33c05-1029">**Convert List**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1029">**Convert List**.</span></span> <span data-ttu-id="33c05-1030">Enumera los propietarios actuales que están intentando convertir sus bloqueos a un nivel más alto.</span><span class="sxs-lookup"><span data-stu-id="33c05-1030">Enumerates the current owners that are trying to convert their locks to a higher level.</span></span><br /><br /> <span data-ttu-id="33c05-1031">**Wait List**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1031">**Wait List**.</span></span> <span data-ttu-id="33c05-1032">Enumera las solicitudes actuales del nuevo bloqueo para el recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-1032">Enumerates current new lock requests for the resource.</span></span><br /><br /> <span data-ttu-id="33c05-1033">**Statement Type**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1033">**Statement Type**.</span></span> <span data-ttu-id="33c05-1034">Describe el tipo de instrucción DML (SELECT, INSERT, UPDATE o DELETE) en que los subprocesos tienen permisos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1034">Describes the type of DML statement (SELECT, INSERT, UPDATE, or DELETE) on which the threads have permissions.</span></span><br /><br /> <span data-ttu-id="33c05-1035">**Victim Resource Owner**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1035">**Victim Resource Owner**.</span></span> <span data-ttu-id="33c05-1036">Especifica el subproceso participante que [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] elige como sujeto para interrumpir el ciclo de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1036">Specifies the participating thread that [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] chooses as the victim to break the deadlock cycle.</span></span> <span data-ttu-id="33c05-1037">El subproceso elegido y todos los subprocesos secundarios finalizan.</span><span class="sxs-lookup"><span data-stu-id="33c05-1037">The chosen thread and all existing sub-threads are terminated.</span></span><br /><br /> <span data-ttu-id="33c05-1038">**Next Branch**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1038">**Next Branch**.</span></span> <span data-ttu-id="33c05-1039">Representa los dos o más subprocesos secundarios del mismo SPID que están implicados en el ciclo de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1039">Represents the two or more sub-threads from the same SPID that are involved in the deadlock cycle.</span></span>|<span data-ttu-id="33c05-1040">**deadlock victim**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1040">**deadlock victim**.</span></span> <span data-ttu-id="33c05-1041">Representa la dirección de la memoria física de la tarea (vea [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) que se seleccionó como sujeto del interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1041">Represents the physical memory address of the task (see [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) that was selected as a deadlock victim.</span></span> <span data-ttu-id="33c05-1042">Puede ser 0 (cero) en caso de un interbloqueo no resuelto.</span><span class="sxs-lookup"><span data-stu-id="33c05-1042">It may be 0 (zero) in the case of an unresolved deadlock.</span></span> <span data-ttu-id="33c05-1043">Una tarea que se está revirtiendo no se puede seleccionar como sujeto del interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1043">A task that is rolling back cannot be chosen as a deadlock victim.</span></span><br /><br /> <span data-ttu-id="33c05-1044">**executionstack**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1044">**executionstack**.</span></span> <span data-ttu-id="33c05-1045">Representa el código [!INCLUDE[tsql](../includes/tsql-md.md)] que se está ejecutando en el momento en que se produce el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1045">Represents [!INCLUDE[tsql](../includes/tsql-md.md)] code that is being executed at the time the deadlock occurs.</span></span><br /><br /> <span data-ttu-id="33c05-1046">**priority**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1046">**priority**.</span></span> <span data-ttu-id="33c05-1047">Representa la prioridad de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1047">Represents deadlock priority.</span></span> <span data-ttu-id="33c05-1048">En ciertos casos, el [!INCLUDE[ssDE](../includes/ssde-md.md)] puede optar por modificar la prioridad de interbloqueo durante una breve duración para conseguir una mejor simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-1048">In certain cases, the [!INCLUDE[ssDE](../includes/ssde-md.md)] may opt to alter the deadlock priority for a short duration to achieve better concurrency.</span></span><br /><br /> <span data-ttu-id="33c05-1049">**logused**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1049">**logused**.</span></span> <span data-ttu-id="33c05-1050">Espacio de registro utilizado por la tarea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1050">Log space used by the task.</span></span><br /><br /> <span data-ttu-id="33c05-1051">**owner id**. El Id. de la transacción que tiene el control de la solicitud.</span><span class="sxs-lookup"><span data-stu-id="33c05-1051">**owner id**. The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="33c05-1052">**status**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1052">**status**.</span></span> <span data-ttu-id="33c05-1053">Estado de la tarea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1053">State of the task.</span></span> <span data-ttu-id="33c05-1054">Es uno de los siguientes valores:</span><span class="sxs-lookup"><span data-stu-id="33c05-1054">It is one of the following values:</span></span><br /><br /> <span data-ttu-id="33c05-1055">>> **pending**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1055">>> **pending**.</span></span> <span data-ttu-id="33c05-1056">Esperando un subproceso de trabajo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1056">Waiting for a worker thread.</span></span><br /><br /> <span data-ttu-id="33c05-1057">>> **runnable**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1057">>> **runnable**.</span></span> <span data-ttu-id="33c05-1058">Preparado para ejecutarse pero esperando un cuanto.</span><span class="sxs-lookup"><span data-stu-id="33c05-1058">Ready to run but waiting for a quantum.</span></span><br /><br /> <span data-ttu-id="33c05-1059">>> **running**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1059">>> **running**.</span></span> <span data-ttu-id="33c05-1060">Ejecutándose actualmente en el programador.</span><span class="sxs-lookup"><span data-stu-id="33c05-1060">Currently running on the scheduler.</span></span><br /><br /> <span data-ttu-id="33c05-1061">>> **suspended**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1061">>> **suspended**.</span></span> <span data-ttu-id="33c05-1062">La ejecución se ha suspendido.</span><span class="sxs-lookup"><span data-stu-id="33c05-1062">Execution is suspended.</span></span><br /><br /> <span data-ttu-id="33c05-1063">>> **done**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1063">>> **done**.</span></span> <span data-ttu-id="33c05-1064">La tarea se ha completado.</span><span class="sxs-lookup"><span data-stu-id="33c05-1064">Task has completed.</span></span><br /><br /> <span data-ttu-id="33c05-1065">>> **spinloop**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1065">>> **spinloop**.</span></span> <span data-ttu-id="33c05-1066">Esperando que un bloqueo por bucle esté disponible.</span><span class="sxs-lookup"><span data-stu-id="33c05-1066">Waiting for a spinlock to become free.</span></span><br /><br /> <span data-ttu-id="33c05-1067">**waitresource**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1067">**waitresource**.</span></span> <span data-ttu-id="33c05-1068">El recurso que la tarea necesita.</span><span class="sxs-lookup"><span data-stu-id="33c05-1068">The resource needed by the task.</span></span><br /><br /> <span data-ttu-id="33c05-1069">**waittime**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1069">**waittime**.</span></span> <span data-ttu-id="33c05-1070">Tiempo en milisegundos de espera del recurso.</span><span class="sxs-lookup"><span data-stu-id="33c05-1070">Time in milliseconds waiting for the resource.</span></span><br /><br /> <span data-ttu-id="33c05-1071">**schedulerid**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1071">**schedulerid**.</span></span> <span data-ttu-id="33c05-1072">Programador asociado a esta tarea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1072">Scheduler associated with this task.</span></span> <span data-ttu-id="33c05-1073">Consulte [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1073">See [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span></span><br /><br /> <span data-ttu-id="33c05-1074">**hostname**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1074">**hostname**.</span></span> <span data-ttu-id="33c05-1075">El nombre de la estación de trabajo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1075">The name of the workstation.</span></span><br /><br /> <span data-ttu-id="33c05-1076">**isolationlevel**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1076">**isolationlevel**.</span></span> <span data-ttu-id="33c05-1077">El nivel de aislamiento de transacción actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1077">The current transaction isolation level.</span></span><br /><br /> <span data-ttu-id="33c05-1078">**Xactid**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1078">**Xactid**.</span></span> <span data-ttu-id="33c05-1079">El Id. de la transacción que tiene el control de la solicitud.</span><span class="sxs-lookup"><span data-stu-id="33c05-1079">The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="33c05-1080">**currentdb**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1080">**currentdb**.</span></span> <span data-ttu-id="33c05-1081">El Id. de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1081">The ID of the database.</span></span><br /><br /> <span data-ttu-id="33c05-1082">**lastbatchstarted**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1082">**lastbatchstarted**.</span></span> <span data-ttu-id="33c05-1083">La última vez que un proceso de cliente inició la ejecución de lotes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1083">The last time a client process started batch execution.</span></span><br /><br /> <span data-ttu-id="33c05-1084">**lastbatchcompleted**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1084">**lastbatchcompleted**.</span></span> <span data-ttu-id="33c05-1085">La última vez que un proceso de cliente completó la ejecución de lotes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1085">The last time a client process completed batch execution.</span></span><br /><br /> <span data-ttu-id="33c05-1086">**clientoption1 y clientoption2**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1086">**clientoption1 and clientoption2**.</span></span> <span data-ttu-id="33c05-1087">Opciones establecidas en esta conexión de cliente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1087">Set options on this client connection.</span></span> <span data-ttu-id="33c05-1088">Se trata de una máscara de bits que incluye información acerca de las opciones controladas normalmente por instrucciones SET, como SET NOCOUNT y SET XACTABORT.</span><span class="sxs-lookup"><span data-stu-id="33c05-1088">This is a bitmask that includes information about options usually controlled by SET statements such as SET NOCOUNT and SET XACTABORT.</span></span><br /><br /> <span data-ttu-id="33c05-1089">**associatedObjectId**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1089">**associatedObjectId**.</span></span> <span data-ttu-id="33c05-1090">Representa el Id. del árbol b o montón (HoBT).</span><span class="sxs-lookup"><span data-stu-id="33c05-1090">Represents the HoBT (heap or b-tree) ID.</span></span>|  
|<span data-ttu-id="33c05-1091">Atributos del recurso</span><span class="sxs-lookup"><span data-stu-id="33c05-1091">Resource attributes</span></span>|<span data-ttu-id="33c05-1092">**RID**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1092">**RID**.</span></span> <span data-ttu-id="33c05-1093">Identifica la única fila de una tabla en la que se mantiene o se solicita un bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1093">Identifies the single row within a table on which a lock is held or requested.</span></span> <span data-ttu-id="33c05-1094">RID se representa como RID: *db_id:file_id:page_no:row_no*.</span><span class="sxs-lookup"><span data-stu-id="33c05-1094">RID is represented as RID: *db_id:file_id:page_no:row_no*.</span></span> <span data-ttu-id="33c05-1095">Por ejemplo, `RID: 6:1:20789:0`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1095">For example, `RID: 6:1:20789:0`.</span></span><br /><br /> <span data-ttu-id="33c05-1096">**OBJECT**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1096">**OBJECT**.</span></span> <span data-ttu-id="33c05-1097">Identifica la tabla en la que se mantiene o se solicita un bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1097">Identifies the table on which a lock is held or requested.</span></span> <span data-ttu-id="33c05-1098">OBJECT se representa como OBJECT: *db_id:object_id*.</span><span class="sxs-lookup"><span data-stu-id="33c05-1098">OBJECT is represented as OBJECT: *db_id:object_id*.</span></span> <span data-ttu-id="33c05-1099">Por ejemplo, `TAB: 6:2009058193`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1099">For example, `TAB: 6:2009058193`.</span></span><br /><br /> <span data-ttu-id="33c05-1100">**KEY**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1100">**KEY**.</span></span> <span data-ttu-id="33c05-1101">Identifica el intervalo de clave de un índice en el que se mantiene o se solicita un bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1101">Identifies the key range within an index on which a lock is held or requested.</span></span> <span data-ttu-id="33c05-1102">KEY se representa como KEY: *db_id:hobt_id* (*valor de hash de clave de índice*).</span><span class="sxs-lookup"><span data-stu-id="33c05-1102">KEY is represented as KEY: *db_id:hobt_id* (*index key hash value*).</span></span> <span data-ttu-id="33c05-1103">Por ejemplo, `KEY: 6:72057594057457664 (350007a4d329)`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1103">For example, `KEY: 6:72057594057457664 (350007a4d329)`.</span></span><br /><br /> <span data-ttu-id="33c05-1104">**PAG**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1104">**PAG**.</span></span> <span data-ttu-id="33c05-1105">Identifica el recurso de página en el que se mantiene o se solicita un bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1105">Identifies the page resource on which a lock is held or requested.</span></span> <span data-ttu-id="33c05-1106">PAG se representa como PAG: *db_id:file_id:page_no*.</span><span class="sxs-lookup"><span data-stu-id="33c05-1106">PAG is represented as PAG: *db_id:file_id:page_no*.</span></span> <span data-ttu-id="33c05-1107">Por ejemplo, `PAG: 6:1:20789`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1107">For example, `PAG: 6:1:20789`.</span></span><br /><br /> <span data-ttu-id="33c05-1108">**EXT**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1108">**EXT**.</span></span> <span data-ttu-id="33c05-1109">Identifica la estructura de extensión.</span><span class="sxs-lookup"><span data-stu-id="33c05-1109">Identifies the extent structure.</span></span> <span data-ttu-id="33c05-1110">EXT se representa como EXT: *db_id:file_id:extent_no*.</span><span class="sxs-lookup"><span data-stu-id="33c05-1110">EXT is represented as EXT: *db_id:file_id:extent_no*.</span></span> <span data-ttu-id="33c05-1111">Por ejemplo, `EXT: 6:1:9`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1111">For example, `EXT: 6:1:9`.</span></span><br /><br /> <span data-ttu-id="33c05-1112">**DB**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1112">**DB**.</span></span> <span data-ttu-id="33c05-1113">Identifica el bloqueo de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1113">Identifies the database lock.</span></span> <span data-ttu-id="33c05-1114">**DB se representa de una de las siguientes maneras:**</span><span class="sxs-lookup"><span data-stu-id="33c05-1114">**DB is represented in one of the following ways:**</span></span><br /><br /> <span data-ttu-id="33c05-1115">DB: *db_id*</span><span class="sxs-lookup"><span data-stu-id="33c05-1115">DB: *db_id*</span></span><br /><br /> <span data-ttu-id="33c05-1116">DB: *db_id*[BULK-OP-DB], que identifica el bloqueo de base de datos realizado por la copia de seguridad de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1116">DB: *db_id*[BULK-OP-DB], which identifies the database lock taken by the backup database.</span></span><br /><br /> <span data-ttu-id="33c05-1117">DB: *db_id*[BULK-OP-LOG], que identifica el bloqueo realizado por el registro de copia de seguridad de esa base de datos en concreto.</span><span class="sxs-lookup"><span data-stu-id="33c05-1117">DB: *db_id*[BULK-OP-LOG], which identifies the lock taken by the backup log for that particular database.</span></span><br /><br /> <span data-ttu-id="33c05-1118">**APP**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1118">**APP**.</span></span> <span data-ttu-id="33c05-1119">Identifica el bloqueo realizado por un recurso de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-1119">Identifies the lock taken by an application resource.</span></span> <span data-ttu-id="33c05-1120">Se representa como APP: *lock_resource*.</span><span class="sxs-lookup"><span data-stu-id="33c05-1120">APP is represented as APP: *lock_resource*.</span></span> <span data-ttu-id="33c05-1121">Por ejemplo, `APP: Formf370f478`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1121">For example, `APP: Formf370f478`.</span></span><br /><br /> <span data-ttu-id="33c05-1122">**METADATA**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1122">**METADATA**.</span></span> <span data-ttu-id="33c05-1123">Representa los recursos de metadatos implicados en un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1123">Represents metadata resources involved in a deadlock.</span></span> <span data-ttu-id="33c05-1124">Debido a que METADATA tiene muchos recursos secundarios, el valor devuelto depende del recurso secundario que se haya interbloqueado.</span><span class="sxs-lookup"><span data-stu-id="33c05-1124">Because METADATA has many subresources, the value returned depends upon the subresource that has deadlocked.</span></span> <span data-ttu-id="33c05-1125">Por ejemplo, metadatos. USER_TYPE devuelve `user_type_id =` \<*integer_value*> .</span><span class="sxs-lookup"><span data-stu-id="33c05-1125">For example, METADATA.USER_TYPE returns `user_type_id =` \<*integer_value*>.</span></span> <span data-ttu-id="33c05-1126">Para obtener más información acerca de los recursos y recursos secundarios de METADATA, vea [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1126">For more information about METADATA resources and subresources, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span><br /><br /> <span data-ttu-id="33c05-1127">**HOBT**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1127">**HOBT**.</span></span> <span data-ttu-id="33c05-1128">Representa al montón o árbol b implicados en un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1128">Represents a heap or b-tree involved in a deadlock.</span></span>|<span data-ttu-id="33c05-1129">Nada exclusivo de esta marca de seguimiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1129">None exclusive to this trace flag.</span></span>|<span data-ttu-id="33c05-1130">Nada exclusivo de esta marca de seguimiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1130">None exclusive to this trace flag.</span></span>|  
  
###### <a name="trace-flag-1204-example"></a><span data-ttu-id="33c05-1131">Ejemplo de marca de seguimiento 1204</span><span class="sxs-lookup"><span data-stu-id="33c05-1131">Trace Flag 1204 Example</span></span>  

 <span data-ttu-id="33c05-1132">En el siguiente ejemplo se muestra el resultado que se obtiene cuando se activa una marca de seguimiento 1204.</span><span class="sxs-lookup"><span data-stu-id="33c05-1132">The following example shows the output when trace flag 1204 is turned on.</span></span> <span data-ttu-id="33c05-1133">En este caso, la tabla de Node 1 es un montón sin índices, y la tabla de Node 2 es un montón con un índice no clúster.</span><span class="sxs-lookup"><span data-stu-id="33c05-1133">In this case, the table in Node 1 is a heap with no indexes, and the table in Node 2 is a heap with a nonclustered index.</span></span> <span data-ttu-id="33c05-1134">La clave de índice de Node 2 se está actualizando cuando se produce el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1134">The index key in Node 2 is being updated when the deadlock occurs.</span></span>  
  
```  
Deadlock encountered .... Printing deadlock information  
Wait-for graph  
  
Node:1  
  
RID: 6:1:20789:0               CleanCnt:3 Mode:X Flags: 0x2  
 Grant List 0:  
   Owner:0x0315D6A0 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:55 ECID:0 XactLockInfo: 0x04D9E27C  
   SPID: 55 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
BEGIN TRANSACTION  
   EXEC usp_p2  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x03A3DAD0   
     Mode: U SPID:54 BatchID:0 ECID:0 TaskProxy:(0x04976374) Value:0x315d200 Cost:(0/868)  
  
Node:2  
  
KEY: 6:72057594057457664 (350007a4d329) CleanCnt:2 Mode:X Flags: 0x0  
 Grant List 0:  
   Owner:0x0315D140 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:54 ECID:0 XactLockInfo: 0x03A3DAF4  
   SPID: 54 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
     BEGIN TRANSACTION  
       EXEC usp_p1  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
  
Victim Resource Owner:  
 ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
```  
  
###### <a name="trace-flag-1222-example"></a><span data-ttu-id="33c05-1135">Ejemplo de marca de seguimiento 1222</span><span class="sxs-lookup"><span data-stu-id="33c05-1135">Trace Flag 1222 Example</span></span>  

 <span data-ttu-id="33c05-1136">En el siguiente ejemplo se muestra el resultado que se obtiene cuando se activa una marca de seguimiento 1222.</span><span class="sxs-lookup"><span data-stu-id="33c05-1136">The following example shows the output when trace flag 1222 is turned on.</span></span> <span data-ttu-id="33c05-1137">En este caso, una tabla es un montón sin índices y la otra tabla es un montón con un índice no clúster.</span><span class="sxs-lookup"><span data-stu-id="33c05-1137">In this case, one table is a heap with no indexes, and the other table is a heap with a nonclustered index.</span></span> <span data-ttu-id="33c05-1138">En la segunda tabla, la clave de índice se está actualizando cuando se produce el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1138">In the second table, the index key is being updated when the deadlock occurs.</span></span>  
  
```  
deadlock-list  
 deadlock victim=process689978  
  process-list  
   process id=process6891f8 taskpriority=0 logused=868   
   waitresource=RID: 6:1:20789:0 waittime=1359 ownerId=310444   
   transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:42.733 XDES=0x3a3dad0   
   lockMode=U schedulerid=1 kpid=1952 status=suspended spid=54   
   sbid=0 ecid=0 priority=0 transcount=2   
   lastbatchstarted=2005-09-05T11:22:42.733   
   lastbatchcompleted=2005-09-05T11:22:42.733   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310444 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p1 line=6 stmtstart=202   
     sqlhandle=0x0300060013e6446b027cbb00c69600000100000000000000  
     UPDATE T2 SET COL1 = 3 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600856aa70f503b8104000000000000000000000000  
     EXEC usp_p1       
    inputbuf  
      BEGIN TRANSACTION  
       EXEC usp_p1  
   process id=process689978 taskpriority=0 logused=380   
   waitresource=KEY: 6:72057594057457664 (350007a4d329)     
   waittime=5015 ownerId=310462 transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:44.077 XDES=0x4d9e258 lockMode=U   
   schedulerid=1 kpid=3024 status=suspended spid=55 sbid=0 ecid=0   
   priority=0 transcount=2 lastbatchstarted=2005-09-05T11:22:44.077   
   lastbatchcompleted=2005-09-05T11:22:44.077   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310462 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p2 line=6 stmtstart=200   
     sqlhandle=0x030006004c0a396c027cbb00c69600000100000000000000  
     UPDATE T1 SET COL1 = 4 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600d688e709b85f8904000000000000000000000000  
     EXEC usp_p2       
    inputbuf  
      BEGIN TRANSACTION  
        EXEC usp_p2      
  resource-list  
   ridlock fileid=1 pageid=20789 dbid=6 objectname=AdventureWorks2012.dbo.T2   
   id=lock3136940 mode=X associatedObjectId=72057594057392128  
    owner-list  
     owner id=process689978 mode=X  
    waiter-list  
     waiter id=process6891f8 mode=U requestType=wait  
   keylock hobtid=72057594057457664 dbid=6 objectname=AdventureWorks2012.dbo.T1   
   indexname=nci_T1_COL1 id=lock3136fc0 mode=X   
   associatedObjectId=72057594057457664  
    owner-list  
     owner id=process6891f8 mode=X  
    waiter-list  
     waiter id=process689978 mode=U requestType=wait  
```  
  
###### <a name="profiler-deadlock-graph-event"></a><span data-ttu-id="33c05-1139">Evento Deadlock Graph del Analizador</span><span class="sxs-lookup"><span data-stu-id="33c05-1139">Profiler Deadlock Graph Event</span></span>  

 <span data-ttu-id="33c05-1140">Éste es un evento del [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] que presenta una descripción gráfica de las tareas y recursos implicados en un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1140">This is an event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] that presents a graphical depiction of the tasks and resources involved in a deadlock.</span></span> <span data-ttu-id="33c05-1141">En el siguiente ejemplo se muestra el resultado del [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] cuando se ha activado el evento deadlock graph.</span><span class="sxs-lookup"><span data-stu-id="33c05-1141">The following example shows the output from [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] when the deadlock graph event is turned on.</span></span>  
  
 <span data-ttu-id="33c05-1142">![Diagrama de flujo lógico que muestra el interbloqueo de procesos de usuario.](media/udb9-profilerdeadlockgraphc.gif "Diagrama de flujo lógico que muestra el interbloqueo de procesos de usuario.")</span><span class="sxs-lookup"><span data-stu-id="33c05-1142">![Logic flow diagram showing user process deadlock.](media/udb9-profilerdeadlockgraphc.gif "Logic flow diagram showing user process deadlock.")</span></span>  
  
 <span data-ttu-id="33c05-1143">Para obtener más información sobre cómo ejecutar el [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] grafo de interbloqueo, vea [guardar gráficos de interbloqueo &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span><span class="sxs-lookup"><span data-stu-id="33c05-1143">For more information about running the [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] deadlock graph, see [Save Deadlock Graphs &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span></span>  
  
#### <a name="handling-deadlocks"></a><span data-ttu-id="33c05-1144">Controlar interbloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-1144">Handling Deadlocks</span></span>  

 <span data-ttu-id="33c05-1145">Cuando una instancia del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] elige una transacción como elemento afectado por un interbloqueo, finaliza el lote actual, revierte la transacción y devuelve el mensaje de error 1205 a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-1145">When an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] chooses a transaction as a deadlock victim, it terminates the current batch, rolls back the transaction, and returns error message 1205 to the application.</span></span>  
  
 `Your transaction (process ID #52) was deadlocked on {lock | communication buffer | thread} resources with another process and has been chosen as the deadlock victim. Rerun your transaction.`  
  
 <span data-ttu-id="33c05-1146">Dado que cualquier aplicación que envía consultas [!INCLUDE[tsql](../includes/tsql-md.md)] puede elegirse como sujeto de un interbloqueo, las aplicaciones deben tener un controlador de errores que pueda interceptar el mensaje de error 1205.</span><span class="sxs-lookup"><span data-stu-id="33c05-1146">Because any application submitting [!INCLUDE[tsql](../includes/tsql-md.md)] queries can be chosen as the deadlock victim, applications should have an error handler that can trap error message 1205.</span></span> <span data-ttu-id="33c05-1147">Si una aplicación no intercepta el error, puede continuar sin ser consciente de que se ha revertido la transacción y de que se pueden producir errores.</span><span class="sxs-lookup"><span data-stu-id="33c05-1147">If an application does not trap the error, the application can proceed unaware that its transaction has been rolled back and errors can occur.</span></span>  
  
 <span data-ttu-id="33c05-1148">La implementación de un controlador de errores que intercepte el mensaje 1205 permite a una aplicación controlar la situación de interbloqueo y realizar una acción apropiada para solucionarla, por ejemplo, volver a enviar automáticamente la consulta implicada en el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1148">Implementing an error handler that traps error message 1205 allows an application to handle the deadlock situation and take remedial action (for example, automatically resubmitting the query that was involved in the deadlock).</span></span> <span data-ttu-id="33c05-1149">Si se vuelve a enviar la consulta de forma automática, no es necesario que el usuario sepa que se ha producido un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1149">By resubmitting the query automatically, the user does not need to know that a deadlock occurred.</span></span>  
  
 <span data-ttu-id="33c05-1150">La aplicación debería realizar una pausa breve antes de volver a enviar su consulta.</span><span class="sxs-lookup"><span data-stu-id="33c05-1150">The application should pause briefly before resubmitting its query.</span></span> <span data-ttu-id="33c05-1151">Esto ofrece a la otra transacción implicada en el interbloqueo una oportunidad de completarse y liberar sus bloqueos que formaban parte del ciclo de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1151">This gives the other transaction involved in the deadlock a chance to complete and release its locks that formed part of the deadlock cycle.</span></span> <span data-ttu-id="33c05-1152">Así se minimiza la probabilidad de que el interbloqueo vuelva a ocurrir cuando la consulta que se ha vuelto a enviar solicite sus bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1152">This minimizes the likelihood of the deadlock reoccurring when the resubmitted query requests its locks.</span></span>  
  
#### <a name="minimizing-deadlocks"></a><span data-ttu-id="33c05-1153">Minimizar los interbloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-1153">Minimizing Deadlocks</span></span>  

 <span data-ttu-id="33c05-1154">A pesar de que los interbloqueos no se pueden evitar totalmente, si se siguen ciertas convenciones de codificación se puede reducir su generación.</span><span class="sxs-lookup"><span data-stu-id="33c05-1154">Although deadlocks cannot be completely avoided, following certain coding conventions can minimize the chance of generating a deadlock.</span></span> <span data-ttu-id="33c05-1155">La minimización de los interbloqueos puede aumentar el rendimiento de las transacciones y reducir la sobrecarga del sistema, debido a que:</span><span class="sxs-lookup"><span data-stu-id="33c05-1155">Minimizing deadlocks can increase transaction throughput and reduce system overhead because fewer transactions are:</span></span>  
  
-   <span data-ttu-id="33c05-1156">Se revierten menos transacciones, al deshacer todo el trabajo que realiza la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1156">Rolled back, undoing all the work performed by the transaction.</span></span>  
  
-   <span data-ttu-id="33c05-1157">Las aplicaciones vuelven a enviar menos transacciones debido a que se revirtieron cuando se produjo el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1157">Resubmitted by applications because they were rolled back when deadlocked.</span></span>  
  
 <span data-ttu-id="33c05-1158">Para ayudar a reducir los interbloqueos:</span><span class="sxs-lookup"><span data-stu-id="33c05-1158">To help minimize deadlocks:</span></span>  
  
-   <span data-ttu-id="33c05-1159">Obtenga acceso a los objetos en el mismo orden.</span><span class="sxs-lookup"><span data-stu-id="33c05-1159">Access objects in the same order.</span></span>  
  
-   <span data-ttu-id="33c05-1160">Evite la interacción con los usuarios en las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1160">Avoid user interaction in transactions.</span></span>  
  
-   <span data-ttu-id="33c05-1161">Mantenga transacciones cortas y en un proceso por lotes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1161">Keep transactions short and in one batch.</span></span>  
  
-   <span data-ttu-id="33c05-1162">Utilice un nivel de aislamiento inferior.</span><span class="sxs-lookup"><span data-stu-id="33c05-1162">Use a lower isolation level.</span></span>  
  
-   <span data-ttu-id="33c05-1163">Utilice un nivel de aislamiento basado en versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1163">Use a row versioning-based isolation level.</span></span>  
  
    -   <span data-ttu-id="33c05-1164">Establezca la opción de base de datos READ_COMMITTED_SNAPSHOT en ON para que las transacciones de lectura confirmada utilicen las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1164">Set READ_COMMITTED_SNAPSHOT database option ON to enable read-committed transactions to use row versioning.</span></span>  
  
    -   <span data-ttu-id="33c05-1165">Utilice el aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1165">Use snapshot isolation.</span></span>  
  
-   <span data-ttu-id="33c05-1166">Utilice conexiones enlazadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1166">Use bound connections.</span></span>  
  
##### <a name="access-objects-in-the-same-order"></a><span data-ttu-id="33c05-1167">Obtener acceso a los objetos en el mismo orden</span><span class="sxs-lookup"><span data-stu-id="33c05-1167">Access Objects in the Same Order</span></span>  

 <span data-ttu-id="33c05-1168">Si todas las transacciones simultáneas tienen acceso a los objetos en el mismo orden, es menos probable que se produzcan interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1168">If all concurrent transactions access objects in the same order, deadlocks are less likely to occur.</span></span> <span data-ttu-id="33c05-1169">Por ejemplo, si dos transacciones simultáneas obtienen un bloqueo en la tabla **Supplier** y después en la tabla **Part**, una transacción se bloquea en la tabla **Supplier** hasta que finalice la otra transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1169">For example, if two concurrent transactions obtain a lock on the **Supplier** table and then on the **Part** table, one transaction is blocked on the **Supplier** table until the other transaction is completed.</span></span> <span data-ttu-id="33c05-1170">Una vez confirmada o revertida la primera transacción, continúa la segunda, por lo que no se produce un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1170">After the first transaction commits or rolls back, the second continues, and a deadlock does not occur.</span></span> <span data-ttu-id="33c05-1171">La utilización de procedimientos almacenados para todas las modificaciones de datos puede normalizar el orden de acceso a los objetos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1171">Using stored procedures for all data modifications can standardize the order of accessing objects.</span></span>  
  
 <span data-ttu-id="33c05-1172">![Diagrama en el que se muestra el modo de evitar un interbloqueo](media/dedlck2.gif "Diagrama en el que se muestra el modo de evitar un interbloqueo")</span><span class="sxs-lookup"><span data-stu-id="33c05-1172">![Diagram showing deadlock avoidance](media/dedlck2.gif "Diagram showing deadlock avoidance")</span></span>  
  
##### <a name="avoid-user-interaction-in-transactions"></a><span data-ttu-id="33c05-1173">Evitar la interacción con el usuario en las transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-1173">Avoid User Interaction in Transactions</span></span>  

 <span data-ttu-id="33c05-1174">Evite escribir transacciones que incluyan la intervención del usuario, ya que la velocidad de ejecución de los lotes que no requieren esta intervención es mucho mayor que la velocidad con la que el usuario debe responder manualmente a las consultas como, por ejemplo, contestar a la solicitud de un parámetro por parte de una aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-1174">Avoid writing transactions that include user interaction, because the speed of batches running without user intervention is much faster than the speed at which a user must manually respond to queries, such as replying to a prompt for a parameter requested by an application.</span></span> <span data-ttu-id="33c05-1175">Por ejemplo, si una transacción espera una entrada del usuario y éste sale a comer o no vuelve hasta pasado el fin de semana, dicho usuario retrasa la finalización de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1175">For example, if a transaction is waiting for user input and the user goes to lunch or even home for the weekend, the user delays the transaction from completing.</span></span> <span data-ttu-id="33c05-1176">De esta forma, se degrada el rendimiento del sistema, ya que los bloqueos que mantiene la transacción solo se liberan cuando se confirma o se revierte la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1176">This degrades system throughput because any locks held by the transaction are released only when the transaction is committed or rolled back.</span></span> <span data-ttu-id="33c05-1177">Aunque no surja una situación de interbloqueo, las demás transacciones que obtienen acceso a los mismos recursos se bloquean mientras esperan a que la transacción finalice.</span><span class="sxs-lookup"><span data-stu-id="33c05-1177">Even if a deadlock situation does not arise, other transactions accessing the same resources are blocked while waiting for the transaction to complete.</span></span>  
  
##### <a name="keep-transactions-short-and-in-one-batch"></a><span data-ttu-id="33c05-1178">Mantener transacciones cortas y en un proceso por lotes</span><span class="sxs-lookup"><span data-stu-id="33c05-1178">Keep Transactions Short and in One Batch</span></span>  

 <span data-ttu-id="33c05-1179">Normalmente, los interbloqueos se producen cuando varias transacciones de larga duración se ejecutan simultáneamente en la misma base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1179">A deadlock typically occurs when several long-running transactions execute concurrently in the same database.</span></span> <span data-ttu-id="33c05-1180">Cuanto más dure la transacción, más tiempo se mantendrán los bloqueos exclusivos o de actualización, con lo cual se bloquean otras actividades y se originan posibles situaciones de interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1180">The longer the transaction, the longer the exclusive or update locks are held, blocking other activity and leading to possible deadlock situations.</span></span>  
  
 <span data-ttu-id="33c05-1181">Al mantener las transacciones en un proceso por lotes, se minimizan los viajes de ida y vuelta en la red durante una transacción y se reducen los posibles retrasos al completar la transacción y liberar los bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1181">Keeping transactions in one batch minimizes network roundtrips during a transaction, reducing possible delays in completing the transaction and releasing locks.</span></span>  
  
##### <a name="use-a-lower-isolation-level"></a><span data-ttu-id="33c05-1182">Utilizar un nivel de aislamiento inferior</span><span class="sxs-lookup"><span data-stu-id="33c05-1182">Use a Lower Isolation Level</span></span>  

 <span data-ttu-id="33c05-1183">Determine si una transacción se puede ejecutar con un nivel de aislamiento inferior.</span><span class="sxs-lookup"><span data-stu-id="33c05-1183">Determine whether a transaction can run at a lower isolation level.</span></span> <span data-ttu-id="33c05-1184">Al implementar la lectura confirmada, se permite a una transacción leer los datos previamente leídos (no modificados) por otra transacción, sin tener que esperar a que la primera transacción finalice.</span><span class="sxs-lookup"><span data-stu-id="33c05-1184">Implementing read committed allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="33c05-1185">Utilizar un nivel inferior de aislamiento, como la lectura confirmada, mantiene los bloqueos compartidos durante menos tiempo que un nivel superior de aislamiento, como el nivel serializable.</span><span class="sxs-lookup"><span data-stu-id="33c05-1185">Using a lower isolation level, such as read committed, holds shared locks for a shorter duration than a higher isolation level, such as serializable.</span></span> <span data-ttu-id="33c05-1186">De esta forma, se reduce la contención de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1186">This reduces locking contention.</span></span>  
  
##### <a name="use-a-row-versioning-based-isolation-level"></a><span data-ttu-id="33c05-1187">Utilizar un nivel de aislamiento basado en versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1187">Use a Row Versioning-based Isolation Level</span></span>  

 <span data-ttu-id="33c05-1188">Si la opción de base de datos READ_COMMITTED_SNAPSHOT se ha establecido en ON, la transacción que se ejecuta con el nivel de aislamiento de lectura confirmada utiliza las versioens de fila en lugar de bloqueos compartidos durante las operaciones de lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-1188">When the READ_COMMITTED_SNAPSHOT database option is set ON, a transaction running under read committed isolation level uses row versioning rather than shared locks during read operations.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1189">Algunas aplicaciones dependen del comportamiento de los bloqueos en el aislamiento de lectura confirmada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1189">Some applications rely upon locking and blocking behavior of read committed isolation.</span></span> <span data-ttu-id="33c05-1190">En estas aplicaciones, es preciso efectuar algunos cambios antes de habilitar esta opción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1190">For these applications, some change is required before this option can be enabled.</span></span>  
  
 <span data-ttu-id="33c05-1191">El aislamiento de instantánea también utiliza las versiones de fila, que no emplean bloqueos compartidos en las operaciones de lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-1191">Snapshot isolation also uses row versioning, which does not use shared locks during read operations.</span></span> <span data-ttu-id="33c05-1192">Antes de ejecutar una transacción con aislamiento de instantánea, debe establecerse en ON la opción de base de datos ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="33c05-1192">Before a transaction can run under snapshot isolation, the ALLOW_SNAPSHOT_ISOLATION database option must be set ON.</span></span>  
  
 <span data-ttu-id="33c05-1193">Implemente estos niveles de aislamiento para reducir los interbloqueos que se pueden producir entre operaciones de lectura y escritura.</span><span class="sxs-lookup"><span data-stu-id="33c05-1193">Implement these isolation levels to minimize deadlocks that can occur between read and write operations.</span></span>  
  
##### <a name="use-bound-connections"></a><span data-ttu-id="33c05-1194">Utilizar conexiones enlazadas</span><span class="sxs-lookup"><span data-stu-id="33c05-1194">Use Bound Connections</span></span>  

 <span data-ttu-id="33c05-1195">Al utilizar conexiones enlazadas, dos o más conexiones abiertas por la misma aplicación pueden cooperar entre sí.</span><span class="sxs-lookup"><span data-stu-id="33c05-1195">Using bound connections, two or more connections opened by the same application can cooperate with each other.</span></span> <span data-ttu-id="33c05-1196">Los bloqueos adquiridos por las conexiones secundarias se mantienen como si los adquiriera la conexión principal y viceversa.</span><span class="sxs-lookup"><span data-stu-id="33c05-1196">Any locks acquired by the secondary connections are held as if they were acquired by the primary connection, and vice versa.</span></span> <span data-ttu-id="33c05-1197">Por lo tanto, no se bloquean entre sí.</span><span class="sxs-lookup"><span data-stu-id="33c05-1197">Therefore they do not block each other.</span></span>  
  
### <a name="lock-partitioning"></a><span data-ttu-id="33c05-1198">Partición de bloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-1198">Lock Partitioning</span></span>  

 <span data-ttu-id="33c05-1199">Para los grandes sistemas, los bloqueos en los objetos a los que se hace referencia asiduamente pueden convertirse en un cuello de botella para el rendimiento, puesto que la adquisición y liberación de los bloqueos genera contención en los recursos de bloqueo internos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1199">For large computer systems, locks on frequently referenced objects can become a performance bottleneck as acquiring and releasing locks place contention on internal locking resources.</span></span> <span data-ttu-id="33c05-1200">La partición de bloqueos mejora el rendimiento porque divide un solo recurso de bloqueo entre varios recursos de bloqueo más.</span><span class="sxs-lookup"><span data-stu-id="33c05-1200">Lock partitioning enhances locking performance by splitting a single lock resource into multiple lock resources.</span></span> <span data-ttu-id="33c05-1201">Esta característica solo está disponible para los sistemas con 16 o más CPU, se habilita automáticamente y no se puede deshabilitar.</span><span class="sxs-lookup"><span data-stu-id="33c05-1201">This feature is only available for systems with 16 or more CPUs, and is automatically enabled and cannot be disabled.</span></span> <span data-ttu-id="33c05-1202">Solo los bloqueos de objetos pueden tener particiones. Los bloqueos de objetos que tengan un subtipo no pueden tener particiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1202">Only object locks can be partitioned.Object locks that have a subtype are not partitioned.</span></span> <span data-ttu-id="33c05-1203">Para obtener más información, vea [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1203">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
#### <a name="understanding-lock-partitioning"></a><span data-ttu-id="33c05-1204">Descripción de partición de bloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-1204">Understanding Lock Partitioning</span></span>  

 <span data-ttu-id="33c05-1205">Las tareas de bloqueo obtienen acceso a varios recursos compartidos, dos de los cuales se optimizan mediante la partición de bloqueos:</span><span class="sxs-lookup"><span data-stu-id="33c05-1205">Locking tasks access several shared resources, two of which are optimized by lock partitioning:</span></span>  
  
-   <span data-ttu-id="33c05-1206">**Spinlock**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1206">**Spinlock**.</span></span> <span data-ttu-id="33c05-1207">Controla el acceso a un recuso de bloqueo, como una fila o una tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1207">This controls access to a lock resource, such as a row or a table.</span></span>  
  
     <span data-ttu-id="33c05-1208">Sin la partición de bloqueos, un spinlock administra todas las solicitudes de bloqueo para un solo recurso de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1208">Without lock partitioning, one spinlock manages all lock requests for a single lock resource.</span></span> <span data-ttu-id="33c05-1209">En los sistemas con un gran volumen de actividad, puede producirse contención a medida que las solicitudes de bloqueo esperan a que un spinlock esté disponible.</span><span class="sxs-lookup"><span data-stu-id="33c05-1209">On systems that experience a large volume of activity, contention can occur as lock requests wait for the spinlock to become available.</span></span> <span data-ttu-id="33c05-1210">En esta situación, la adquisición de bloqueos puede generar un cuello de botella que puede afectar negativamente al rendimiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1210">Under this situation, acquiring locks can become a bottleneck and can negatively impact performance.</span></span>  
  
     <span data-ttu-id="33c05-1211">Para reducir la contención en un solo recurso de bloqueo, la partición de bloqueos divide un recurso de bloqueo en varios recursos de bloqueo para repartir la carga entre varios spinlock.</span><span class="sxs-lookup"><span data-stu-id="33c05-1211">To reduce contention on a single lock resource, lock partitioning splits a single lock resource into multiple lock resources to distribute the load across multiple spinlocks.</span></span>  
  
-   <span data-ttu-id="33c05-1212">**Memoria**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1212">**Memory**.</span></span> <span data-ttu-id="33c05-1213">Se utiliza para almacenar las estructuras de los recursos de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1213">This is used to store the lock resource structures.</span></span>  
  
     <span data-ttu-id="33c05-1214">Cuando ya se ha adquirido el spinlock, las estructuras de bloqueo se almacenan en memoria para que, a continuación, estén disponibles para el acceso y realizar modificaciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1214">Once the spinlock is acquired, lock structures are stored in memory and then accessed and possibly modified.</span></span> <span data-ttu-id="33c05-1215">La distribución del acceso a los bloqueos entre varios recursos ayuda a eliminar la necesidad de transferir bloqueos de memoria entre CPU, lo que ayuda a mejorar el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1215">Distributing lock access across multiple resources helps to eliminate the need to transfer memory blocks between CPUs, which will help to improve performance.</span></span>  
  
#### <a name="implementing-and-monitoring-lock-partitioning"></a><span data-ttu-id="33c05-1216">Implementar y supervisar las particiones de bloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-1216">Implementing and Monitoring Lock Partitioning</span></span>  

 <span data-ttu-id="33c05-1217">La partición de bloqueos está activada de forma predeterminada para los sistemas con 16 CPU o más.</span><span class="sxs-lookup"><span data-stu-id="33c05-1217">Lock partitioning is turned on by default for systems with 16 or more CPUs.</span></span> <span data-ttu-id="33c05-1218">Cuando la partición de bloqueos está habilitada, se registra un mensaje informativo en el registro de errores de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-1218">When lock partitioning is enabled, an informational message is recorded in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>  
  
 <span data-ttu-id="33c05-1219">Al adquirir bloqueos en un recurso con particiones:</span><span class="sxs-lookup"><span data-stu-id="33c05-1219">When acquiring locks on a partitioned resource:</span></span>  
  
-   <span data-ttu-id="33c05-1220">Solo los modos de bloqueo NL, SCH-S, IS, IU e IX se adquieren en una sola partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1220">Only NL, SCH-S, IS, IU, and IX lock modes are acquired on a single partition.</span></span>  
  
-   <span data-ttu-id="33c05-1221">Los bloqueos compartidos (S), exclusivos (X) y otros bloqueos en modos que no sean NL, SCH-S, IS, IU e IX deben adquirirse en todas las particiones empezando por el Id. de partición 0 seguido del resto de Id. en orden.</span><span class="sxs-lookup"><span data-stu-id="33c05-1221">Shared (S), exclusive (X), and other locks in modes other than NL, SCH-S, IS, IU, and IX must be acquired on all partitions starting with partition ID 0 and following in partition ID order.</span></span> <span data-ttu-id="33c05-1222">Estos bloqueos en un recurso con particiones utilizarán más memoria que los bloqueos del mismo modo en un recurso sin particiones puesto que cada partición es de hecho un bloqueo independiente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1222">These locks on a partitioned resource will use more memory than locks in the same mode on a non-partitioned resource since each partition is effectively a separate lock.</span></span> <span data-ttu-id="33c05-1223">El número de particiones determina los incrementos de memoria.</span><span class="sxs-lookup"><span data-stu-id="33c05-1223">The memory increase is determined by the number of partitions.</span></span> <span data-ttu-id="33c05-1224">Los contadores de bloqueo de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] en el Monitor de rendimiento de Windows mostrarán información acerca de la memoria utilizada por los bloqueos con y sin particiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1224">The [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] lock counters in the Windows Performance Monitor will display information about memory used by partitioned and non-partitioned locks.</span></span>  
  
 <span data-ttu-id="33c05-1225">Una transacción se asigna a una partición cuando se inicia la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1225">A transaction is assigned to a partition when the transaction starts.</span></span> <span data-ttu-id="33c05-1226">Para la transacción, todas las solicitudes de bloqueo que pueden dividirse utilizan la partición asignada a esa transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1226">For the transaction, all lock requests that can be partitioned use the partition assigned to that transaction.</span></span> <span data-ttu-id="33c05-1227">Con este método, el acceso por parte de diferentes transacciones a los recursos de bloqueo del mismo objeto se distribuye a través de diferentes particiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1227">By this method, access to lock resources of the same object by different transactions is distributed across different partitions.</span></span>  
  
 <span data-ttu-id="33c05-1228">La columna resource_lock_partition de la vista de administración dinámica sys.dm_tran_locks proporciona el Id. de la partición de bloqueo para un recurso con particiones de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1228">The resource_lock_partition column in the sys.dm_tran_locks Dynamic Management View provides the lock partition ID for a lock partitioned resource.</span></span> <span data-ttu-id="33c05-1229">Para obtener más información, vea [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1229">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1230">Bajo el evento Locks en [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], la columna BigintData1 proporciona el Id. de partición de bloqueo para un recuso con particiones de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1230">Under the Locks event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], the BigintData1 column provides the lock partition ID for a lock partitioned resource.</span></span>  
  
#### <a name="working-with-lock-partitioning"></a><span data-ttu-id="33c05-1231">Trabajar con la partición de bloqueos</span><span class="sxs-lookup"><span data-stu-id="33c05-1231">Working with Lock Partitioning</span></span>  

 <span data-ttu-id="33c05-1232">En los siguientes ejemplos de código se muestra la partición de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1232">The following code examples illustrate lock partitioning.</span></span> <span data-ttu-id="33c05-1233">En estos ejemplos se ejecutan dos transacciones en dos sesiones diferentes para mostrar el comportamiento de la partición de bloqueos en sistemas grandes con 16 CPU.</span><span class="sxs-lookup"><span data-stu-id="33c05-1233">In the examples, two transactions are executed in two different sessions in order to show lock partitioning behavior on a computer system with 16 CPUs.</span></span>  
  
 <span data-ttu-id="33c05-1234">Estas instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)] crean objetos de prueba que se utilizan en los siguientes ejemplos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1234">These [!INCLUDE[tsql](../includes/tsql-md.md)] statements create test objects that are used in the examples that follow.</span></span>  
  
```sql  
-- Create a test table.  
CREATE TABLE TestTable  
    (col1        int);  
GO  
  
-- Create a clustered index on the table.  
CREATE CLUSTERED INDEX ci_TestTable   
    ON TestTable (col1);  
GO  
  
-- Populate the table.  
INSERT INTO TestTable VALUES (1);  
GO  
```  
  
##### <a name="example-a"></a><span data-ttu-id="33c05-1235">Ejemplo A</span><span class="sxs-lookup"><span data-stu-id="33c05-1235">Example A</span></span>  

 <span data-ttu-id="33c05-1236">Sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1236">Session 1:</span></span>  
  
 <span data-ttu-id="33c05-1237">Una instrucción `SELECT` se ejecuta en una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1237">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="33c05-1238">Debido a la sugerencia de bloqueo `HOLDLOCK`, esta instrucción adquirirá y retendrá un bloqueo Intención compartida (IS) en una tabla (en esta ilustración, los bloqueos de fila y página se pasan por alto).</span><span class="sxs-lookup"><span data-stu-id="33c05-1238">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="33c05-1239">El bloqueo IS solo se adquirirá en la partición asignada a la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1239">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="33c05-1240">Para este ejemplo, se supone que el bloqueo IS se adquiere en el id. 7 de la partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1240">For this example, it is assumed that the IS lock is acquired on partition ID 7.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="33c05-1241">Sesión 2:</span><span class="sxs-lookup"><span data-stu-id="33c05-1241">Session 2:</span></span>  
  
 <span data-ttu-id="33c05-1242">Se inicia una transacción y la instrucción `SELECT` que se ejecuta bajo esta transacción adquirirá y retendrá un bloqueo compartido (S) en la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1242">A transaction is started, and the `SELECT` statement running under this transaction will acquire and retain a shared (S) lock on the table.</span></span> <span data-ttu-id="33c05-1243">El bloqueo S se adquirirá en todas las particiones que tengan como resultado varios bloqueos de tabla, uno para cada partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1243">The S lock will be acquired on all partitions which results in multiple table locks, one for each partition.</span></span> <span data-ttu-id="33c05-1244">Por ejemplo, en un sistema de 16 cpu, 16 bloqueos S se emitirán por el bloqueo en los id. 0-15 de la partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1244">For example, on a 16-cpu system, 16 S locks will be issued across lock partition IDs 0-15.</span></span> <span data-ttu-id="33c05-1245">Dado que el bloqueo S es compatible con el bloqueo IS que se retiene en el id. 7 de la partición por la transacción de la sesión 1, no hay ningún bloqueo entre las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1245">Because the S lock is compatible with the IS lock being held on partition ID 7 by the transaction in session 1, there is no blocking between transactions.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCK, HOLDLOCK);  
```  
  
 <span data-ttu-id="33c05-1246">Sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1246">Session 1:</span></span>  
  
 <span data-ttu-id="33c05-1247">La siguiente instrucción `SELECT` se ejecuta bajo la transacción que todavía está activa bajo la sesión 1.</span><span class="sxs-lookup"><span data-stu-id="33c05-1247">The following `SELECT` statement is executed under the transaction that is still active under session 1.</span></span> <span data-ttu-id="33c05-1248">Debido a la sugerencia de bloqueo de tabla (X) exclusiva, la transacción intentará adquirir un bloqueo X en la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1248">Because of the exclusive (X) table lock hint, the transaction will attempt to acquire an X lock on the table.</span></span> <span data-ttu-id="33c05-1249">Sin embargo, el bloqueo S que retiene la transacción en la sesión 2 bloqueará el bloqueo X en el id. 0 de la partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1249">However, the S lock that is being held by the transaction in session 2 will block the X lock at partition ID 0.</span></span>  
  
```sql  
SELECT col1  
    FROM TestTable  
    WITH (TABLOCKX);  
```  
  
##### <a name="example-b"></a><span data-ttu-id="33c05-1250">Ejemplo B</span><span class="sxs-lookup"><span data-stu-id="33c05-1250">Example B</span></span>  

 <span data-ttu-id="33c05-1251">Sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1251">Session 1:</span></span>  
  
 <span data-ttu-id="33c05-1252">Una instrucción `SELECT` se ejecuta en una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1252">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="33c05-1253">Debido a la sugerencia de bloqueo `HOLDLOCK`, esta instrucción adquirirá y retendrá un bloqueo Intención compartida (IS) en una tabla (en esta ilustración, los bloqueos de fila y página se pasan por alto).</span><span class="sxs-lookup"><span data-stu-id="33c05-1253">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="33c05-1254">El bloqueo IS solo se adquirirá en la partición asignada a la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1254">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="33c05-1255">Para este ejemplo, se supone que el bloqueo IS se adquiere en el id. 6 de la partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1255">For this example, it is assumed that the IS lock is acquired on partition ID 6.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="33c05-1256">Sesión 2:</span><span class="sxs-lookup"><span data-stu-id="33c05-1256">Session 2:</span></span>  
  
 <span data-ttu-id="33c05-1257">Una instrucción `SELECT` se ejecuta en una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1257">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="33c05-1258">Debido a la sugerencia de bloqueo de `TABLOCKX`, la transacción intenta adquirir un bloqueo exclusivo (X) en la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1258">Because of the `TABLOCKX` lock hint, the transaction tries to acquire an exclusive (X) lock on the table.</span></span> <span data-ttu-id="33c05-1259">Recuerde que el bloqueo X se debe adquirir en todas las particiones comenzando en el id. 0 de la partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1259">Remember that the X lock must be acquired on all partitions starting with partition ID 0.</span></span> <span data-ttu-id="33c05-1260">El bloqueo X se adquirirá en los id. 0-5 de todas las particiones pero se bloqueará por el bloqueo IS adquirido por el id. 6 de la partición.</span><span class="sxs-lookup"><span data-stu-id="33c05-1260">The X lock will be acquired on all partitions IDs 0-5 but will be blocked by the IS lock that is acquired on partition ID 6.</span></span>  
  
 <span data-ttu-id="33c05-1261">En los Id. 7 a 15 de la partición que el bloqueo X aún no ha alcanzado, otras transacciones puede seguir adquiriendo bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1261">On partition IDs 7-15 that the X lock has not yet reached, other transactions can continue to acquire locks.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCKX, HOLDLOCK);  
```  
  
 <span data-ttu-id="33c05-1262">![Icono de flecha usado con el vínculo volver al principio](media/uparrow16x16.gif "Icono de flecha usado con el vínculo Volver al principio") [de esta guía](#Top)</span><span class="sxs-lookup"><span data-stu-id="33c05-1262">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="row-versioning-based-isolation-levels-in-the-database-engine"></a><a name="Row_versioning"></a><span data-ttu-id="33c05-1263">Niveles de aislamiento basados en versiones de fila en el Motor de base de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-1263">Row Versioning-based Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="33c05-1264">Desde SQL Server 2005, el motor de base de datos ofrece una implementación de un nivel de aislamiento de transacciones existente, con confirmación de lectura, que proporciona una instantánea de nivel de instrucción con versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1264">Starting with SQL Server 2005, the Database Engine offers an implementation of an existing transaction isolation level, read committed, that provides a statement level snapshot using row versioning.</span></span> <span data-ttu-id="33c05-1265">El motor de base de datos de SQL Server también ofrece un nivel de aislamiento de transacciones, instantánea, que proporciona una instantánea de nivel de transacción que también usa versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1265">SQL Server Database Engine also offers a transaction isolation level, snapshot, that provides a transaction level snapshot also using row versioning.</span></span>  
  
 <span data-ttu-id="33c05-1266">Las versiones de fila es un marco general en [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] que invoca un mecanismo de copia por escritura cuando se modifica o elimina una fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1266">Row versioning is a general framework in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] that invokes a copy-on-write mechanism when a row is modified or deleted.</span></span> <span data-ttu-id="33c05-1267">Esto requiere que, mientras se ejecuta la transacción, la versión anterior de la fila debe estar disponible para las transacciones que requieran un estado anterior transaccionalmente coherente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1267">This requires that while the transaction is running, the old version of the row must be available for transactions that require an earlier transactionally consistent state.</span></span> <span data-ttu-id="33c05-1268">Las versiones de fila hacen lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="33c05-1268">Row versioning is used to do the following:</span></span>  
  
-   <span data-ttu-id="33c05-1269">Crear las tablas **inserted** y **deleted** en desencadenadores.</span><span class="sxs-lookup"><span data-stu-id="33c05-1269">Build the **inserted** and **deleted** tables in triggers.</span></span> <span data-ttu-id="33c05-1270">Se crean versiones de las filas modificadas por el desencadenador.</span><span class="sxs-lookup"><span data-stu-id="33c05-1270">Any rows modified by the trigger are versioned.</span></span> <span data-ttu-id="33c05-1271">Esto incluye las filas modificadas por la instrucción que activó el desencadenador, así como las modificaciones de datos realizadas por el desencadenador.</span><span class="sxs-lookup"><span data-stu-id="33c05-1271">This includes the rows modified by the statement that launched the trigger, as well as any data modifications made by the trigger.</span></span>  
  
-   <span data-ttu-id="33c05-1272">Compatibilidad con los conjuntos de resultados activos múltiples (MARS).</span><span class="sxs-lookup"><span data-stu-id="33c05-1272">Support Multiple Active Result Sets (MARS).</span></span> <span data-ttu-id="33c05-1273">Si una sesión MARS emite una instrucción de modificación de datos (como INSERT, UPDATE o DELETE) en un momento en el que hay un conjunto de resultados activos, se crean versiones de las filas afectadas por la instrucción de modificación.</span><span class="sxs-lookup"><span data-stu-id="33c05-1273">If a MARS session issues a data modification statement (such as INSERT, UPDATE, or DELETE) at a time there is an active result set, the rows affected by the modification statement are versioned.</span></span>  
  
-   <span data-ttu-id="33c05-1274">Compatibilidad con las operaciones de índice que especifican la opción ONLINE.</span><span class="sxs-lookup"><span data-stu-id="33c05-1274">Support index operations that specify the ONLINE option.</span></span>  
  
-   <span data-ttu-id="33c05-1275">Compatibilidad con los niveles de aislamiento de transacción basados en versiones de fila:</span><span class="sxs-lookup"><span data-stu-id="33c05-1275">Support row versioning-based transaction isolation levels:</span></span>  
  
    -   <span data-ttu-id="33c05-1276">Nueva implementación del nivel de aislamiento de lectura confirmada que utiliza las versiones de fila para proporcionar una coherencia de lectura en las instrucciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1276">A new implementation of read committed isolation level that uses row versioning to provide statement-level read consistency.</span></span>  
  
    -   <span data-ttu-id="33c05-1277">Nuevo nivel de aislamiento de instantánea que proporciona una coherencia de lectura en las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1277">A new isolation level, snapshot, to provide transaction-level read consistency.</span></span>  
  
 <span data-ttu-id="33c05-1278">La base de datos `tempdb` debe tener espacio suficiente para el almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1278">The `tempdb` database must have enough space for the version store.</span></span> <span data-ttu-id="33c05-1279">Cuando `tempdb` esté llena, las operaciones de actualización dejarán de generar versiones y se continuarán funcionando correctamente, pero es posible que las operaciones de lectura provoquen errores porque es necesaria una determinada versión de fila que ya no existe.</span><span class="sxs-lookup"><span data-stu-id="33c05-1279">When `tempdb` is full, update operations will stop generating versions and continue to succeed, but read operations might fail because a particular row version that is needed no longer exists.</span></span> <span data-ttu-id="33c05-1280">Esto afecta a las operaciones como los desencadenadores, MARS y los índices en línea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1280">This affects operations like triggers, MARS, and online indexing.</span></span>  
  
 <span data-ttu-id="33c05-1281">La utilización de versiones de fila para las transacciones de lectura confirmada e instantáneas es un proceso de dos pasos:</span><span class="sxs-lookup"><span data-stu-id="33c05-1281">Using row versioning for read-committed and snapshot transactions is a two-step process:</span></span>  
  
1.  <span data-ttu-id="33c05-1282">Seleccione el valor ON para una de las opciones de base de datos READ_COMMITTED_SNAPSHOT y ALLOW_SNAPSHOT_ISOLATION o para ambas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1282">Set either or both the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options ON.</span></span>  
  
2.  <span data-ttu-id="33c05-1283">Seleccione el nivel de aislamiento de transacción apropiado en una aplicación:</span><span class="sxs-lookup"><span data-stu-id="33c05-1283">Set the appropriate transaction isolation level in an application:</span></span>  
  
    -   <span data-ttu-id="33c05-1284">Cuando el valor de la opción de base de datos READ_COMMITTED_SNAPSHOT sea ON, las transacciones que establezcan el nivel de aislamiento de lectura confirmada utilizarán las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1284">When the READ_COMMITTED_SNAPSHOT database option is ON, transactions setting the read committed isolation level use row versioning.</span></span>  
  
    -   <span data-ttu-id="33c05-1285">Cuando el valor de la opción de base de datos ALLOW_SNAPSHOT_ISOLATION sea ON, las transacciones podrán establecer el nivel de aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1285">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, transactions can set the snapshot isolation level.</span></span>  
  
 <span data-ttu-id="33c05-1286">Cuando el valor de la opción de base de datos READ_COMMITTED_SNAPSHOT o ALLOW_SNAPSHOT_ISOLATION está establecido en ON, el [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] asignará un número de secuencia de la transacción (XSN) a cada transacción que manipule datos que utilicen las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1286">When either READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database option is set ON, the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] assigns a transaction sequence number (XSN) to each transaction that manipulates data using row versioning.</span></span> <span data-ttu-id="33c05-1287">Las transacciones empiezan en el momento en que se ejecuta una instrucción BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="33c05-1287">Transactions start at the time a BEGIN TRANSACTION statement is executed.</span></span> <span data-ttu-id="33c05-1288">No obstante, el número de secuencia de la transacción empieza con la primera operación de lectura/escritura después de la instrucción BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="33c05-1288">However, the transaction sequence number starts with the first read or write operation after the BEGIN TRANSACTION statement.</span></span> <span data-ttu-id="33c05-1289">El número de secuencia de la transacción aumenta en incrementos de uno cada vez que se asigna.</span><span class="sxs-lookup"><span data-stu-id="33c05-1289">The transaction sequence number is incremented by one each time it is assigned.</span></span>  
  
 <span data-ttu-id="33c05-1290">Cuando el valor de las opciones de base de datos READ_COMMITTED_SNAPSHOT o ALLOW_SNAPSHOT_ISOLATION es ON, se mantienen las copias lógicas (versiones) para todas las modificaciones de datos realizadas en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1290">When either the READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database options are ON, logical copies (versions) are maintained for all data modifications performed in the database.</span></span> <span data-ttu-id="33c05-1291">Cada vez que se modifica una fila mediante una transacción determinada, la instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)] almacena una versión de la imagen previamente confirmada de la fila en `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1291">Every time a row is modified by a specific transaction, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stores a version of the previously committed image of the row in `tempdb`.</span></span> <span data-ttu-id="33c05-1292">Cada versión se marca con el número de secuencia de la transacción que realizó el cambio.</span><span class="sxs-lookup"><span data-stu-id="33c05-1292">Each version is marked with the transaction sequence number of the transaction that made the change.</span></span> <span data-ttu-id="33c05-1293">Las versiones de filas modificadas se encadenan mediante una lista de vínculos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1293">The versions of modified rows are chained using a link list.</span></span> <span data-ttu-id="33c05-1294">El valor de fila más reciente se almacena siempre en la base de datos actual y se encadena a las filas de versiones almacenadas en `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1294">The newest row value is always stored in the current database and chained to the versioned rows stored in `tempdb`.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1295">En los casos de modificación de objetos grandes (LOB), solo se copia el fragmento cambiado al almacén de versiones de `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1295">For modification of large objects (LOBs), only the changed fragment is copied to the version store in `tempdb`.</span></span>  
  
 <span data-ttu-id="33c05-1296">Las versiones de fila se conservan durante un tiempo suficiente para cumplir los requisitos de las transacciones ejecutadas con niveles de aislamiento basados en versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1296">Row versions are held long enough to satisfy the requirements of transactions running under row versioning-based isolation levels.</span></span> <span data-ttu-id="33c05-1297">El [!INCLUDE[ssDE](../includes/ssde-md.md)] realiza un seguimiento del número de secuencia de la transacción útil más antiguo y elimina periódicamente todas las versiones de filas marcadas con números de secuencia de la transacción anteriores al número de secuencia útil más antiguo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1297">The [!INCLUDE[ssDE](../includes/ssde-md.md)] tracks the earliest useful transaction sequence number and periodically deletes all row versions stamped with transaction sequence numbers that are lower than the earliest useful sequence number.</span></span>  
  
 <span data-ttu-id="33c05-1298">Cuando el valor de ambas opciones de base de datos es OFF, solo se crean versiones de las filas modificadas por desencadenadores o sesiones MARS, o bien leídas por operaciones de índice ONLINE.</span><span class="sxs-lookup"><span data-stu-id="33c05-1298">When both database options are set to OFF, only rows modified by triggers or MARS sessions, or read by ONLINE index operations, are versioned.</span></span> <span data-ttu-id="33c05-1299">Estas versiones de filas se liberan cuando dejan de ser necesarias.</span><span class="sxs-lookup"><span data-stu-id="33c05-1299">Those row versions are released when no longer needed.</span></span> <span data-ttu-id="33c05-1300">Un subproceso en segundo plano se ejecuta periódicamente para eliminar las versiones de filas obsoletas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1300">A background thread periodically executes to remove stale row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1301">En el caso de las transacciones de ejecución breve, puede que se almacene en caché una versión de una fila modificada en el grupo de búferes sin que se escriba en los archivos de disco de la base de datos `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1301">For short-running transactions, a version of a modified row may get cached in the buffer pool without getting written into the disk files of the `tempdb` database.</span></span> <span data-ttu-id="33c05-1302">Si la fila versionada no va a ser necesaria durante mucho tiempo, simplemente se eliminará del grupo de búferes y puede que no provoque una sobrecarga de E/S.</span><span class="sxs-lookup"><span data-stu-id="33c05-1302">If the need for the versioned row is short-lived, it will simply get dropped from the buffer pool and may not necessarily incur I/O overhead.</span></span>  
  
### <a name="behavior-when-reading-data"></a><span data-ttu-id="33c05-1303">Comportamiento durante la lectura de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-1303">Behavior When Reading Data</span></span>  

 <span data-ttu-id="33c05-1304">Cuando las transacciones que se ejecutan con niveles de aislamiento basados en versiones de fila leen datos, las operaciones de lectura no adquieren bloqueos compartidos (S) para los datos que se leen, por lo que no bloquean las transacciones que están modificando datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1304">When transactions running under row versioning-based isolation read data, the read operations do not acquire shared (S) locks on the data being read, and therefore do not block transactions that are modifying data.</span></span> <span data-ttu-id="33c05-1305">Asimismo, se minimiza la sobrecarga de los recursos de bloqueo, ya que se reduce el número de bloqueos adquiridos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1305">Also, the overhead of locking resources is minimized as the number of locks acquired is reduced.</span></span> <span data-ttu-id="33c05-1306">El aislamiento de lectura confirmada mediante las versiones de fila y el aislamiento de instantánea están diseñados para proporcionar una coherencia de lectura de datos con versiones en las instrucciones o las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1306">Read committed isolation using row versioning and snapshot isolation are designed to provide statement-level or transaction-level read consistencies of versioned data.</span></span>  
  
 <span data-ttu-id="33c05-1307">Todas las consultas, incluidas las transacciones que se ejecutan en niveles de aislamiento basados en versiones de fila, adquieren bloqueos de estabilidad del esquema (Sch-S) durante la compilación y la ejecución.</span><span class="sxs-lookup"><span data-stu-id="33c05-1307">All queries, including transactions running under row versioning-based isolation levels, acquire Sch-S (schema stability) locks during compilation and execution.</span></span> <span data-ttu-id="33c05-1308">Debido a ello, las consultas se bloquean cuando una transacción simultánea aloja un bloqueo de modificación del esquema (Sch-M) en la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1308">Because of this, queries are blocked when a concurrent transaction holds a Sch-M (schema modification) lock on the table.</span></span> <span data-ttu-id="33c05-1309">Por ejemplo, una operación de lenguaje de definición de datos (DDL) adquiere un bloqueo Sch-M antes de modificar la información del esquema de la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1309">For example, a data definition language (DDL) operation acquires a Sch-M lock before it modifies the schema information of the table.</span></span> <span data-ttu-id="33c05-1310">Las transacciones de consulta, incluidas las que se ejecutan en un nivel de aislamiento basado en versiones de fila, se bloquean cuando se intenta adquirir un bloqueo Sch-S.</span><span class="sxs-lookup"><span data-stu-id="33c05-1310">Query transactions, including those running under a row versioning-based isolation level, are blocked when attempting to acquire a Sch-S lock.</span></span> <span data-ttu-id="33c05-1311">A la inversa, una consulta que mantiene un bloqueo Sch-S bloquea una transacción simultánea que intenta adquirir un bloqueo Sch-M.</span><span class="sxs-lookup"><span data-stu-id="33c05-1311">Conversely, a query holding a Sch-S lock blocks a concurrent transaction that attempts to acquire a Sch-M lock.</span></span>  
  
 <span data-ttu-id="33c05-1312">Cuando se inicia una transacción con el nivel de aislamiento de instantánea, la instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)] registra todas las transacciones actualmente activas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1312">When a transaction using the snapshot isolation level starts, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] records all of the currently active transactions.</span></span> <span data-ttu-id="33c05-1313">Cuando la transacción de instantánea lee una fila que tiene una cadena de versiones, el [!INCLUDE[ssDE](../includes/ssde-md.md)] sigue la cadena y recupera la fila en la que el número de secuencia de la transacción cumple las condiciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="33c05-1313">When the snapshot transaction reads a row that has a version chain, the [!INCLUDE[ssDE](../includes/ssde-md.md)] follows the chain and retrieves the row where the transaction sequence number is:</span></span>  
  
-   <span data-ttu-id="33c05-1314">Es el más cercano al número de secuencia de la transacción de instantánea que lee la fila, pero inferior al mismo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1314">Closest to but lower than the sequence number of the snapshot transaction reading the row.</span></span>  
  
-   <span data-ttu-id="33c05-1315">No se encuentra en la lista de transacciones activas cuando se inició la transacción de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1315">Not in the list of the transactions active when the snapshot transaction started.</span></span>  
  
 <span data-ttu-id="33c05-1316">Las operaciones de lectura realizadas por una transacción de instantánea recuperan la versión más reciente de cada fila confirmada en el momento en el que empezó la transacción de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1316">Read operations performed by a snapshot transaction retrieve the last version of each row that had been committed at the time the snapshot transaction started.</span></span> <span data-ttu-id="33c05-1317">De este modo se consigue una instantánea coherente con las transacciones de los datos tal como existían en el momento de inicio de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1317">This provides a transactionally consistent snapshot of the data as it existed at the start of the transaction.</span></span>  
  
 <span data-ttu-id="33c05-1318">Las transacciones de lectura confirmada que utilizan versiones de fila funcionan de forma muy parecida.</span><span class="sxs-lookup"><span data-stu-id="33c05-1318">Read-committed transactions using row versioning operate in much the same way.</span></span> <span data-ttu-id="33c05-1319">La diferencia es que las transacciones de lectura confirmada no utilizan su propio número de secuencia de la transacción cuando eligen versiones de filas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1319">The difference is that the read-committed transaction does not use its own transaction sequence number when choosing row versions.</span></span> <span data-ttu-id="33c05-1320">Cada vez que se inicia una instrucción, la transacción de lectura confirmada lee el número de secuencia de la transacción más reciente emitido para esa instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-1320">Each time a statement is started, the read-committed transaction reads the latest transaction sequence number issued for that instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="33c05-1321">Éste es el número de secuencia de la transacción utilizado para seleccionar las versiones de filas correctas para esa instrucción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1321">This is the transaction sequence number used to select the correct row versions for that statement.</span></span> <span data-ttu-id="33c05-1322">Esto permite a las transacciones de lectura confirmada ver una instantánea de los datos tal como existían en el momento de inicio de cada instrucción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1322">This allows read-committed transactions to see a snapshot of the data as it exists at the start of each statement.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1323">Aunque las transacciones de lectura confirmada que utilizan las versiones de fila proporcionan una vista de los datos en el nivel de instrucciones coherente desde el punto de vista de las transacciones, las versiones de fila que se generan o a las que se tiene acceso con este tipo de transacción se mantienen hasta que la transacción finaliza.</span><span class="sxs-lookup"><span data-stu-id="33c05-1323">Even though read-committed transactions using row versioning provides a transactionally consistent view of the data at a statement level, row versions generated or accessed by this type of transaction are maintained until the transaction completes.</span></span>  
  
### <a name="behavior-when-modifying-data"></a><span data-ttu-id="33c05-1324">Comportamiento durante la modificación de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-1324">Behavior When Modifying Data</span></span>  

 <span data-ttu-id="33c05-1325">En las transacciones de lectura confirmada que utilizan las versiones de fila, la selección de las filas que se deben actualizar se realiza mediante un recorrido de bloqueo en el que se obtiene un bloqueo de actualización (U) en la fila de datos cuando se leen los valores de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1325">In a read-committed transaction using row versioning, the selection of rows to update is done using a blocking scan where an update (U) lock is taken on the data row as data values are read.</span></span> <span data-ttu-id="33c05-1326">Es lo mismo que una transacción de lectura confirmada que no utiliza las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1326">This is the same as a read-committed transaction that does not use row versioning.</span></span> <span data-ttu-id="33c05-1327">Si la fila de datos no cumple los criterios de actualización, se liberará el bloqueo de actualización en esa fila y se bloqueará y recorrerá la siguiente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1327">If the data row does not meet the update criteria, the update lock is released on that row and the next row is locked and scanned.</span></span>  
  
 <span data-ttu-id="33c05-1328">Las transacciones que se ejecutan con aislamiento de instantánea obtienen un enfoque optimista de la modificación de datos mediante la adquisición de bloqueos de datos antes de realizar la modificación solo para forzar restricciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1328">Transactions running under snapshot isolation take an optimistic approach to data modification by acquiring locks on data before performing the modification only to enforce constraints.</span></span> <span data-ttu-id="33c05-1329">De lo contrario, los bloqueos no se adquieren en los datos hasta que se van a modificar los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1329">Otherwise, locks are not acquired on data until the data is to be modified.</span></span> <span data-ttu-id="33c05-1330">Cuando una fila de datos cumple los criterios de actualización, la transacción de instantánea comprueba que la fila de datos no haya sido modificada por una transacción simultánea confirmada antes de que empezara la transacción de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1330">When a data row meets the update criteria, the snapshot transaction verifies that the data row has not been modified by a concurrent transaction that committed after the snapshot transaction began.</span></span> <span data-ttu-id="33c05-1331">Si se ha modificado la fila de datos fuera de la transacción de instantánea, se producirá un conflicto de actualizaciones y se finalizará la transacción de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1331">If the data row has been modified outside of the snapshot transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span> <span data-ttu-id="33c05-1332">El [!INCLUDE[ssDE](../includes/ssde-md.md)] controla el conflicto de actualizaciones; no se puede deshabilitar su detección.</span><span class="sxs-lookup"><span data-stu-id="33c05-1332">The update conflict is handled by the [!INCLUDE[ssDE](../includes/ssde-md.md)] and there is no way to disable the update conflict detection.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1333">Las operaciones de actualización que se ejecutan con aislamiento de instantánea se ejecutan internamente con aislamiento de lectura confirmada cuando la transacción de instantánea tiene acceso a cualquiera de los elementos siguientes:</span><span class="sxs-lookup"><span data-stu-id="33c05-1333">Update operations running under snapshot isolation internally execute under read committed isolation when the snapshot transaction accesses any of the following:</span></span>  
>   
>  <span data-ttu-id="33c05-1334">Una tabla con una restricción FOREIGN KEY.</span><span class="sxs-lookup"><span data-stu-id="33c05-1334">A table with a FOREIGN KEY constraint.</span></span>  
>   
>  <span data-ttu-id="33c05-1335">Una tabla a la que se hace referencia en la restricción FOREIGN KEY de otra tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1335">A table that is referenced in the FOREIGN KEY constraint of another table.</span></span>  
>   
>  <span data-ttu-id="33c05-1336">Una vista indizada que hace referencia a más de una tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1336">An indexed view referencing more than one table.</span></span>  
>   
>  <span data-ttu-id="33c05-1337">No obstante, incluso en estas condiciones, la operación de actualización seguirá comprobando que los datos no hayan sido modificados por otra transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1337">However, even under these conditions the update operation will continue to verify that the data has not been modified by another transaction.</span></span> <span data-ttu-id="33c05-1338">Si se han modificado, la transacción de instantánea detectará un conflicto de actualización y terminará.</span><span class="sxs-lookup"><span data-stu-id="33c05-1338">If data has been modified by another transaction, the snapshot transaction encounters an update conflict and is terminated.</span></span>  
  
### <a name="behavior-in-summary"></a><span data-ttu-id="33c05-1339">Resumen del comportamiento</span><span class="sxs-lookup"><span data-stu-id="33c05-1339">Behavior in Summary</span></span>  

 <span data-ttu-id="33c05-1340">En la tabla siguiente se resumen las diferencias entre el aislamiento de instantánea y el aislamiento de lectura confirmada mediante las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1340">The following table summarizes the differences between snapshot isolation and read committed isolation using row versioning.</span></span>  
  
|<span data-ttu-id="33c05-1341">Propiedad</span><span class="sxs-lookup"><span data-stu-id="33c05-1341">Property</span></span>|<span data-ttu-id="33c05-1342">Nivel de aislamiento de lectura confirmada mediante las versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1342">Read-committed isolation level using row versioning</span></span>|<span data-ttu-id="33c05-1343">Nivel de aislamiento de instantánea</span><span class="sxs-lookup"><span data-stu-id="33c05-1343">Snapshot isolation level</span></span>|  
|--------------|----------------------------------------------------------|------------------------------|  
|<span data-ttu-id="33c05-1344">La opción de base de datos cuyo valor debe ser ON para habilitar la compatibilidad necesaria.</span><span class="sxs-lookup"><span data-stu-id="33c05-1344">The database option that must be set to ON to enable the required support.</span></span>|<span data-ttu-id="33c05-1345">READ_COMMITTED_SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="33c05-1345">READ_COMMITTED_SNAPSHOT</span></span>|<span data-ttu-id="33c05-1346">ALLOW_SNAPSHOT_ISOLATION</span><span class="sxs-lookup"><span data-stu-id="33c05-1346">ALLOW_SNAPSHOT_ISOLATION</span></span>|  
|<span data-ttu-id="33c05-1347">Forma en la que una sesión solicita el tipo específico de versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1347">How a session requests the specific type of row versioning.</span></span>|<span data-ttu-id="33c05-1348">Utilice el nivel de aislamiento de lectura confirmada predeterminado o ejecute la instrucción SET TRANSACTION ISOLATION LEVEL para especificar el nivel de aislamiento READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="33c05-1348">Use the default read-committed isolation level, or run the SET TRANSACTION ISOLATION LEVEL statement to specify the READ COMMITTED isolation level.</span></span> <span data-ttu-id="33c05-1349">Se puede hacer una vez iniciada la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1349">This can be done after the transaction starts.</span></span>|<span data-ttu-id="33c05-1350">Requiere la ejecución de SET TRANSACTION ISOLATION LEVEL para especificar el nivel de aislamiento SNAPSHOT antes de que se inicie otra transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1350">Requires the execution of SET TRANSACTION ISOLATION LEVEL to specify the SNAPSHOT isolation level before the start of the transaction.</span></span>|  
|<span data-ttu-id="33c05-1351">La versión de los datos leídos por las instrucciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1351">The version of data read by statements.</span></span>|<span data-ttu-id="33c05-1352">Todos los datos confirmados antes del inicio de cada instrucción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1352">All data that was committed before the start of each statement.</span></span>|<span data-ttu-id="33c05-1353">Todos los datos confirmados antes del inicio de cada transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1353">All data that was committed before the start of each transaction.</span></span>|  
|<span data-ttu-id="33c05-1354">Modo de control de las actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1354">How updates are handled.</span></span>|<span data-ttu-id="33c05-1355">Vuelve desde las versiones de filas a los datos reales para seleccionar las filas que se actualizarán y utiliza bloqueos de actualización en las filas de datos seleccionadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1355">Reverts from row versions to actual data to select rows to update and uses update locks on the data rows selected.</span></span> <span data-ttu-id="33c05-1356">Adquiere bloqueos exclusivos en las filas de datos reales que se modificarán.</span><span class="sxs-lookup"><span data-stu-id="33c05-1356">Acquires exclusive locks on actual data rows to be modified.</span></span> <span data-ttu-id="33c05-1357">Sin detección de conflictos de actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1357">No update conflict detection.</span></span>|<span data-ttu-id="33c05-1358">Utiliza las versiones de filas para seleccionar las filas que se actualizarán.</span><span class="sxs-lookup"><span data-stu-id="33c05-1358">Uses row versions to select rows to update.</span></span> <span data-ttu-id="33c05-1359">Intenta adquirir un bloqueo exclusivo en la fila de datos real que se modificará y, si otra transacción ha modificado los datos, se producirá un conflicto de actualizaciones y se finalizará la transacción de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1359">Tries to acquire an exclusive lock on the actual data row to be modified, and if the data has been modified by another transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span>|  
|<span data-ttu-id="33c05-1360">Detección de conflictos de actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1360">Update conflict detection.</span></span>|<span data-ttu-id="33c05-1361">Ninguno.</span><span class="sxs-lookup"><span data-stu-id="33c05-1361">None.</span></span>|<span data-ttu-id="33c05-1362">Compatibilidad integrada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1362">Integrated support.</span></span> <span data-ttu-id="33c05-1363">No se puede deshabilitar.</span><span class="sxs-lookup"><span data-stu-id="33c05-1363">Cannot be disabled.</span></span>|  
  
### <a name="row-versioning-resource-usage"></a><span data-ttu-id="33c05-1364">Uso de recursos de versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1364">Row Versioning Resource Usage</span></span>  

 <span data-ttu-id="33c05-1365">El marco de las versiones de fila admite las siguientes características disponibles en [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="33c05-1365">The row versioning framework supports the following features available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span></span>  
  
-   <span data-ttu-id="33c05-1366">Desencadenadores</span><span class="sxs-lookup"><span data-stu-id="33c05-1366">Triggers</span></span>  
  
-   <span data-ttu-id="33c05-1367">Conjuntos de resultados activos múltiples (MARS)</span><span class="sxs-lookup"><span data-stu-id="33c05-1367">Multiple Active Results Sets (MARS)</span></span>  
  
-   <span data-ttu-id="33c05-1368">Índices en línea</span><span class="sxs-lookup"><span data-stu-id="33c05-1368">Online indexing</span></span>  
  
 <span data-ttu-id="33c05-1369">El marco de las versiones de fila también admite los siguientes niveles de aislamiento de transacción basado en las versiones de fila que, de forma predeterminada, no se habilitan:</span><span class="sxs-lookup"><span data-stu-id="33c05-1369">The row versioning framework also supports the following row versioning-based transaction isolation levels, which by default are not enabled:</span></span>  
  
-   <span data-ttu-id="33c05-1370">Cuando la opción de base de datos READ_COMMITTED_SNAPSHOT es ON, las transacciones READ_COMMITTED proporcionan coherencia de lectura de nivel de instrucciones con versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1370">When the READ_COMMITTED_SNAPSHOT database option is ON, READ_COMMITTED transactions provide statement-level read consistency using row versioning.</span></span>  
  
-   <span data-ttu-id="33c05-1371">Cuando la opción de base de datos ALLOW_SNAPSHOT_ISOLATION es ON, las transacciones SNAPSHOT proporcionan coherencia de lectura de nivel de instrucciones con versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1371">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, SNAPSHOT transactions provide transaction-level read consistency using row versioning.</span></span>  
  
 <span data-ttu-id="33c05-1372">Los niveles de aislamiento basado en las versiones de fila reducen el número de bloqueos adquiridos por transacción mediante la eliminación del uso de bloqueos compartidos en operaciones de lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-1372">Row versioning-based isolation levels reduce the number of locks acquired by transaction by eliminating the use of shared locks on read operations.</span></span> <span data-ttu-id="33c05-1373">Esto aumenta el rendimiento del sistema al reducir los recursos utilizados para administrar bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1373">This increases system performance by reducing the resources used to manage locks.</span></span> <span data-ttu-id="33c05-1374">El rendimiento también aumenta al reducir el número de veces que una transacción se bloquea mediante bloqueos adquiridos por otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1374">Performance is also increased by reducing the number of times a transaction is blocked by locks acquired by other transactions.</span></span>  
  
 <span data-ttu-id="33c05-1375">Los niveles de aislamiento basados en las versiones de fila aumentan los recursos necesarios para la modificación de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1375">Row versioning-based isolation levels increase the resources needed by data modifications.</span></span> <span data-ttu-id="33c05-1376">Al habilitar estas opciones se crean versiones de filas de todas las modificaciones de datos para la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1376">Enabling these options causes all data modifications for the database to be versioned.</span></span> <span data-ttu-id="33c05-1377">Se guarda una copia de los datos sin modificar en tempdb aunque no haya ninguna transacción activa que utilice el aislamiento basado en las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1377">A copy of the data before modification is stored in tempdb even when there are no active transactions using row versioning-based isolation.</span></span> <span data-ttu-id="33c05-1378">Los datos modificados incluyen un puntero a los datos con versiones almacenados en tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1378">The data after modification includes a pointer to the versioned data stored in tempdb.</span></span> <span data-ttu-id="33c05-1379">En el caso de objetos grandes, solo se copia en tempdb la parte del objeto modificada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1379">For large objects, only part of the object that changed is copied to tempdb.</span></span>  
  
#### <a name="space-used-in-tempdb"></a><span data-ttu-id="33c05-1380">Espacio utilizado en tempdb</span><span class="sxs-lookup"><span data-stu-id="33c05-1380">Space Used in tempdb</span></span>  

 <span data-ttu-id="33c05-1381">En cada instancia de [!INCLUDE[ssDE](../includes/ssde-md.md)], tempdb debe disponer de espacio suficiente para contener las versiones de fila generadas por todas las bases de datos de la instancia.</span><span class="sxs-lookup"><span data-stu-id="33c05-1381">For each instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], tempdb must have enough space to hold the row versions generated for every database in the instance.</span></span> <span data-ttu-id="33c05-1382">El administrador de la base de datos debe asegurarse de que tempdb cuenta con espacio más que suficiente para dar cabida al almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1382">The database administrator must ensure that tempdb has ample space to support the version store.</span></span> <span data-ttu-id="33c05-1383">Existen dos almacenes de versiones en tempdb:</span><span class="sxs-lookup"><span data-stu-id="33c05-1383">There are two version stores in tempdb:</span></span>  
  
-   <span data-ttu-id="33c05-1384">El almacén de versiones de generación de índices en línea se utiliza para generar índices en línea en todas las bases de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1384">The online index build version store is used for online index builds in all databases.</span></span>  
  
-   <span data-ttu-id="33c05-1385">El almacén de versiones común se utiliza en las demás operaciones de modificación de datos de todas las bases de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1385">The common version store is used for all other data modification operations in all databases.</span></span>  
  
 <span data-ttu-id="33c05-1386">Las versiones de filas deben estar almacenadas mientras una transacción activa necesite tener acceso a ella.</span><span class="sxs-lookup"><span data-stu-id="33c05-1386">Row versions must be stored for as long as an active transaction needs to access it.</span></span> <span data-ttu-id="33c05-1387">Cada minuto, un subproceso en segundo plano elimina las versiones de filas que ya no se necesitan y libera el espacio de versiones en tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1387">Once every minute, a background thread removes row versions that are no longer needed and frees up the version space in tempdb.</span></span> <span data-ttu-id="33c05-1388">Una transacción de larga duración impide que se libere el espacio del almacén de versiones si se cumple alguna de las siguientes condiciones:</span><span class="sxs-lookup"><span data-stu-id="33c05-1388">A long-running transaction prevents space in the version store from being released if it meets any of the following conditions:</span></span>  
  
-   <span data-ttu-id="33c05-1389">Se utiliza el aislamiento basado en las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1389">It uses row versioning-based isolation.</span></span>  
  
-   <span data-ttu-id="33c05-1390">Se utilizan desencadenadores, MARS u operaciones de generación de índices en línea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1390">It uses triggers, MARS, or online index build operations.</span></span>  
  
-   <span data-ttu-id="33c05-1391">Se generan versiones de filas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1391">It generates row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1392">Cuando se invoca un desencadenador dentro de una transacción, las versiones de filas creadas por el desencadenador se mantienen hasta el final de la transacción, incluso cuando las versiones de filas dejan de necesitarse una vez completado el desencadenador.</span><span class="sxs-lookup"><span data-stu-id="33c05-1392">When a trigger is invoked inside a transaction, the row versions created by the trigger are maintained until the end of the transaction, even though the row versions are no longer needed after the trigger completes.</span></span> <span data-ttu-id="33c05-1393">Esto también se aplica a las transacciones de lectura confirmada que usan las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1393">This also applies to read-committed transactions that use row versioning.</span></span> <span data-ttu-id="33c05-1394">Con este tipo de transacción, solo se necesita una vista de la base de datos transaccionalmente coherente para cada instrucción de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1394">With this type of transaction, a transactionally consistent view of the database is needed only for each statement in the transaction.</span></span> <span data-ttu-id="33c05-1395">De este modo, las versiones de filas creadas para una instrucción de la transacción dejan de necesitarse una vez completada la instrucción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1395">This means that the row versions created for a statement in the transaction are no longer needed after the statement completes.</span></span> <span data-ttu-id="33c05-1396">No obstante, las versiones de filas creadas por cada instrucción de la transacción se mantienen hasta que se complete la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1396">However, row versions created by each statement in the transaction are maintained until the transaction completes.</span></span>  
  
 <span data-ttu-id="33c05-1397">Cuando tempdb se queda sin espacio, [!INCLUDE[ssDE](../includes/ssde-md.md)] fuerza la reducción de los almacenes de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1397">When tempdb runs out of space, the [!INCLUDE[ssDE](../includes/ssde-md.md)] forces the version stores to shrink.</span></span> <span data-ttu-id="33c05-1398">Durante el proceso de reducción, las transacciones de mayor duración que todavía no han generado versiones de filas se marcan como sujetos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1398">During the shrink process, the longest running transactions that have not yet generated row versions are marked as victims.</span></span> <span data-ttu-id="33c05-1399">Se genera el mensaje 3967 en el registro de errores para cada transacción marcada como sujeto.</span><span class="sxs-lookup"><span data-stu-id="33c05-1399">A message 3967 is generated in the error log for each victim transaction.</span></span> <span data-ttu-id="33c05-1400">Si una traducción se marca como sujeto, no podrá leer las versiones de filas del almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1400">If a transaction is marked as a victim, it can no longer read the row versions in the version store.</span></span> <span data-ttu-id="33c05-1401">Cuando intenta leer versiones de filas, se genera el mensaje 3966 y la transacción se revierte.</span><span class="sxs-lookup"><span data-stu-id="33c05-1401">When it attempts to read row versions, message 3966 is generated and the transaction is rolled back.</span></span> <span data-ttu-id="33c05-1402">Si el proceso de reducción se realiza correctamente, pasa a quedar espacio disponible en tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1402">If the shrinking process succeeds, space becomes available in tempdb.</span></span> <span data-ttu-id="33c05-1403">Si no, tempdb se queda sin espacio y se produce lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="33c05-1403">Otherwise, tempdb runs out of space and the following occurs:</span></span>  
  
-   <span data-ttu-id="33c05-1404">Las operaciones de escritura continúan, pero no generan versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1404">Write operations continue to execute but do not generate versions.</span></span> <span data-ttu-id="33c05-1405">Aparece un mensaje informativo (3959) en el registro de errores, pero la transacción que escribe datos no se ve afectada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1405">An information message (3959) appears in the error log, but the transaction that writes data is not affected.</span></span>  
  
-   <span data-ttu-id="33c05-1406">Las transacciones que intentan obtener acceso a versiones de filas que no se generaron debido a una reversión completa de tempdb terminan en un error 3958.</span><span class="sxs-lookup"><span data-stu-id="33c05-1406">Transactions that attempt to access row versions that were not generated because of a tempdb full rollback terminate with an error 3958.</span></span>  
  
#### <a name="space-used-in-data-rows"></a><span data-ttu-id="33c05-1407">Espacio utilizado en filas de datos</span><span class="sxs-lookup"><span data-stu-id="33c05-1407">Space Used in Data Rows</span></span>  

 <span data-ttu-id="33c05-1408">Cada fila de base de datos puede utilizar hasta 14 bytes al final de la fila para información de las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1408">Each database row may use up to 14 bytes at the end of the row for row versioning information.</span></span> <span data-ttu-id="33c05-1409">La información de versiones de fila contiene el número de secuencia de la transacción que confirmó la versión y el puntero a la fila cuya versión se ha creado.</span><span class="sxs-lookup"><span data-stu-id="33c05-1409">The row versioning information contains the transaction sequence number of the transaction that committed the version and the pointer to the versioned row.</span></span> <span data-ttu-id="33c05-1410">Estos 14 bytes se agregan la primera vez que se modifica una fila o se inserta una nueva fila, si se cumple alguna de las siguientes condiciones:</span><span class="sxs-lookup"><span data-stu-id="33c05-1410">These 14 bytes are added the first time the row is modified, or when a new row is inserted, under any of these conditions:</span></span>  
  
-   <span data-ttu-id="33c05-1411">La opción READ_COMMITTED_SNAPSHOT o ALLOW_SNAPSHOT_ISOLATION está en ON.</span><span class="sxs-lookup"><span data-stu-id="33c05-1411">READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION options are ON.</span></span>  
  
-   <span data-ttu-id="33c05-1412">La tabla tiene un desencadenador.</span><span class="sxs-lookup"><span data-stu-id="33c05-1412">The table has a trigger.</span></span>  
  
-   <span data-ttu-id="33c05-1413">Se utilizan conjuntos de resultados activos múltiples (MARS)</span><span class="sxs-lookup"><span data-stu-id="33c05-1413">Multiple Active Results Sets (MARS) is being used.</span></span>  
  
-   <span data-ttu-id="33c05-1414">En la actualidad, se ejecutan en la tabla operaciones de compilación de índices en línea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1414">Online index build operations are currently running on the table.</span></span>  
  
 <span data-ttu-id="33c05-1415">Estos 14 bytes se eliminan de la fila de base de datos la primera vez que se modifica la fila si se cumplen todas estas condiciones:</span><span class="sxs-lookup"><span data-stu-id="33c05-1415">These 14 bytes are removed from the database row the first time the row is modified under all of these conditions:</span></span>  
  
-   <span data-ttu-id="33c05-1416">Las opciones READ_COMMITTED_SNAPSHOT y ALLOW_SNAPSHOT_ISOLATION están en OFF.</span><span class="sxs-lookup"><span data-stu-id="33c05-1416">READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION options are OFF.</span></span>  
  
-   <span data-ttu-id="33c05-1417">El desencadenador ya no existe en la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1417">The trigger no longer exists on the table.</span></span>  
  
-   <span data-ttu-id="33c05-1418">No se utiliza MARS.</span><span class="sxs-lookup"><span data-stu-id="33c05-1418">MARS is not being used.</span></span>  
  
-   <span data-ttu-id="33c05-1419">No se ejecutan en ese momento operaciones de generación de índices en línea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1419">Online index build operations are not currently running.</span></span>  
  
 <span data-ttu-id="33c05-1420">Si se utiliza alguna de las características de versiones de fila, puede que sea necesario asignar espacio de disco adicional para que la base de datos dé cabida a los 14 bytes por fila de base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1420">If you use any of the row versioning features, you might need to allocate additional disk space for the database to accommodate the 14 bytes per database row.</span></span> <span data-ttu-id="33c05-1421">Al agregar información de versiones de fila puede provocarse la división de la página de índices o la asignación de una nueva página de datos si no hay suficiente especio disponible en la página actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1421">Adding the row versioning information can cause index page splits or the allocation of a new data page if there is not enough space available on the current page.</span></span> <span data-ttu-id="33c05-1422">Por ejemplo, si la longitud media de fila es 100 bytes, los 14 bytes adicionales hacen que una tabla existente crezca hasta un 14 por ciento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1422">For example, if the average row length is 100 bytes, the additional 14 bytes cause an existing table to grow up to 14 percent.</span></span>  
  
 <span data-ttu-id="33c05-1423">Si se reduce el [factor de relleno](../relational-databases/indexes/specify-fill-factor-for-an-index.md), se puede impedir o reducir la fragmentación de las páginas de índice.</span><span class="sxs-lookup"><span data-stu-id="33c05-1423">Decreasing the [fill factor](../relational-databases/indexes/specify-fill-factor-for-an-index.md) might help to prevent or decrease fragmentation of index pages.</span></span> <span data-ttu-id="33c05-1424">Para ver la información de fragmentación de los datos y los índices de una tabla o vista, puede usar [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1424">To view fragmentation information for the data and indexes of a table or view, you can use [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span></span>  
  
#### <a name="space-used-in-large-objects"></a><span data-ttu-id="33c05-1425">Espacio utilizado en objetos grandes</span><span class="sxs-lookup"><span data-stu-id="33c05-1425">Space Used in Large Objects</span></span>  

 <span data-ttu-id="33c05-1426">[!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] admite seis tipos de datos que pueden contener cadenas grandes de hasta dos gigabytes (GB) de longitud: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text` e `image`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1426">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] supports six data types that can hold large strings up to 2 gigabytes (GB) in length: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text`, and `image`.</span></span> <span data-ttu-id="33c05-1427">Las cadenas grandes almacenadas con estos tipos de datos se almacenan en una serie de fragmentos de datos que se vinculan a la fila de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1427">Large strings stored using these data types are stored in a series of data fragments that are linked to the data row.</span></span> <span data-ttu-id="33c05-1428">La información de versiones de fila se almacena en cada uno de los fragmentos utilizados para almacenar estas cadenas grandes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1428">Row versioning information is stored in each fragment used to store these large strings.</span></span> <span data-ttu-id="33c05-1429">Los fragmentos de datos son una colección de páginas dedicadas a objetos grandes en una tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1429">Data fragments are a collection of pages dedicated to large objects in a table.</span></span>  
  
 <span data-ttu-id="33c05-1430">A medida que se agregan nuevos valores grandes a una base de datos, se asignan utilizando un máximo de 8.040 bytes de datos por fragmento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1430">As new large values are added to a database, they are allocated using a maximum of 8040 bytes of data per fragment.</span></span> <span data-ttu-id="33c05-1431">En versiones anteriores del [!INCLUDE[ssDE](../includes/ssde-md.md)] se almacenaban hasta 8.080 bytes de datos `ntext`, `text` o `image` por fragmento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1431">Earlier versions of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stored up to 8080 bytes of `ntext`, `text`, or `image` data per fragment.</span></span>  
  
 <span data-ttu-id="33c05-1432">Los datos de objetos grandes (LOB) `ntext`, `text` e `image` existentes no se actualizan para dejar espacio para la información de versiones de fila cuando una base de datos se actualiza a [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] desde una versión anterior de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-1432">Existing `ntext`, `text`, and `image` large object (LOB) data is not updated to make space for the row versioning information when a database is upgraded to [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] from an earlier version of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="33c05-1433">Sin embargo, la primera vez que se modifican los datos de LOB, se actualizan dinámicamente para habilitar el almacenamiento de información del control de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1433">However, the first time the LOB data is modified, it is dynamically upgraded to enable storage of versioning information.</span></span> <span data-ttu-id="33c05-1434">Esto sucederá aunque no se generen versiones de filas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1434">This will happen even if row versions are not generated.</span></span> <span data-ttu-id="33c05-1435">Una vez actualizados los datos de LOB, el número máximo de bytes almacenados por fragmento se reduce de 8.080 bytes a 8.040 bytes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1435">After the LOB data is upgraded, the maximum number of bytes stored per fragment is reduced from 8080 bytes to 8040 bytes.</span></span> <span data-ttu-id="33c05-1436">El proceso de actualización es equivalente a eliminar el valor de LOB y volver a insertar el mismo valor.</span><span class="sxs-lookup"><span data-stu-id="33c05-1436">The upgrade process is equivalent to deleting the LOB value and reinserting the same value.</span></span> <span data-ttu-id="33c05-1437">Los datos de LOB se actualizan aunque solo se haya modificado un solo byte.</span><span class="sxs-lookup"><span data-stu-id="33c05-1437">The LOB data is upgraded even if only one byte is modified.</span></span> <span data-ttu-id="33c05-1438">Esta operación se realiza una sola vez para cada columna `ntext`, `text` o `image`, pero, dependiendo del tamaño de los datos de LOB, puede que cada operación genere gran cantidad de asignaciones de página y actividad de E/S.</span><span class="sxs-lookup"><span data-stu-id="33c05-1438">This is a one-time operation for each `ntext`, `text`, or `image` column, but each operation may generate a large amount of page allocations and I/O activity depending upon the size of the LOB data.</span></span> <span data-ttu-id="33c05-1439">Puede que también se genere gran cantidad de actividad de registro si la modificación se registra por completo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1439">It may also generate a large amount of logging activity if the modification is fully logged.</span></span> <span data-ttu-id="33c05-1440">Las operaciones WRITETEXT y UPDATETEXT se registran mínimamente si el modo de recuperación de la base de datos no se establece en FULL.</span><span class="sxs-lookup"><span data-stu-id="33c05-1440">WRITETEXT and UPDATETEXT operations are minimally logged if database recovery mode is not set to FULL.</span></span>  
  
 <span data-ttu-id="33c05-1441">Los tipos de datos `nvarchar(max)`, `varchar(max)` y `varbinary(max)` no están disponibles en versiones anteriores de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-1441">The `nvarchar(max)`, `varchar(max)`, and `varbinary(max)` data types are not available in earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="33c05-1442">Por lo tanto, no presentan problemas de actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-1442">Therefore, they have no upgrade issues.</span></span>  
  
 <span data-ttu-id="33c05-1443">Debe asignarse suficiente espacio de disco para dar cabida a este requisito.</span><span class="sxs-lookup"><span data-stu-id="33c05-1443">Enough disk space should be allocated to accommodate this requirement.</span></span>  
  
#### <a name="monitoring-row-versioning-and-the-version-store"></a><span data-ttu-id="33c05-1444">Supervisar las versiones de fila y el almacén de versiones</span><span class="sxs-lookup"><span data-stu-id="33c05-1444">Monitoring Row Versioning and the Version Store</span></span>  

 <span data-ttu-id="33c05-1445">Para los procesos de supervisión de versiones de fila, almacén de versiones y aislamiento de instantánea en cuanto al rendimiento y otros problemas, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] proporciona herramientas en forma de Vistas de administración dinámica (DMV) y contadores de rendimiento del Monitor de sistema de Windows.</span><span class="sxs-lookup"><span data-stu-id="33c05-1445">For monitoring row versioning, version store, and snapshot isolation processes for performance and problems, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] provides tools in the form of Dynamic Management Views (DMVs) and performance counters in Windows System Monitor.</span></span>  
  
##### <a name="dmvs"></a><span data-ttu-id="33c05-1446">DMV</span><span class="sxs-lookup"><span data-stu-id="33c05-1446">DMVs</span></span>  

 <span data-ttu-id="33c05-1447">Las siguientes DMV proporcionan información sobre el estado actual del sistema de tempdb y el almacén de versiones, así como de las transacciones que utilizan las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1447">The following DMVs provide information about the current system state of tempdb and the version store, as well as transactions using row versioning.</span></span>  
  
 <span data-ttu-id="33c05-1448">sys.dm_db_file_space_usage.</span><span class="sxs-lookup"><span data-stu-id="33c05-1448">sys.dm_db_file_space_usage.</span></span> <span data-ttu-id="33c05-1449">Devuelve información de uso del espacio para cada fila de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1449">Returns space usage information for each file in the database.</span></span> <span data-ttu-id="33c05-1450">Para obtener más información, consulte [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1450">For more information, see [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1451">sys.dm_db_session_space_usage.</span><span class="sxs-lookup"><span data-stu-id="33c05-1451">sys.dm_db_session_space_usage.</span></span> <span data-ttu-id="33c05-1452">Devuelve la actividad de asignación y desasignación de páginas por sesión de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1452">Returns page allocation and deallocation activity by session for the database.</span></span> <span data-ttu-id="33c05-1453">Para obtener más información, consulte [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1453">For more information, see [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1454">sys.dm_db_task_space_usage.</span><span class="sxs-lookup"><span data-stu-id="33c05-1454">sys.dm_db_task_space_usage.</span></span> <span data-ttu-id="33c05-1455">Devuelve la actividad de asignación y desasignación de páginas por tarea de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1455">Returns page allocation and deallocation activity by task for the database.</span></span> <span data-ttu-id="33c05-1456">Para obtener más información, consulte [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1456">For more information, see [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1457">sys.dm_tran_top_version_generators.</span><span class="sxs-lookup"><span data-stu-id="33c05-1457">sys.dm_tran_top_version_generators.</span></span> <span data-ttu-id="33c05-1458">Devuelve una tabla virtual para los objetos que producen la mayoría de las versiones del almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1458">Returns a virtual table for the objects producing the most versions in the version store.</span></span> <span data-ttu-id="33c05-1459">Agrupa las 256 longitudes de registro principales agregadas mediante su database_id y rowset_id.</span><span class="sxs-lookup"><span data-stu-id="33c05-1459">It groups the top 256 aggregated record lengths by database_id and rowset_id.</span></span> <span data-ttu-id="33c05-1460">Use esta función para encontrar los principales consumidores del almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1460">Use this function to find the largest consumers of the version store.</span></span> <span data-ttu-id="33c05-1461">Para obtener más información, consulte [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1461">For more information, see [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1462">sys.dm_tran_version_store.</span><span class="sxs-lookup"><span data-stu-id="33c05-1462">sys.dm_tran_version_store.</span></span> <span data-ttu-id="33c05-1463">Devuelve una tabla virtual que muestra todos los registros de versión del almacén de versiones común.</span><span class="sxs-lookup"><span data-stu-id="33c05-1463">Returns a virtual table that displays all version records in the common version store.</span></span> <span data-ttu-id="33c05-1464">Para obtener más información, consulte [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1464">For more information, see [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1465">La ejecución de las funciones sys.dm_tran_top_version_generators y sys.dm_tran_version_store puede ser muy costosa, puesto que ambas consultan todo el almacén de versiones, que puede ser muy grande.</span><span class="sxs-lookup"><span data-stu-id="33c05-1465">sys.dm_tran_top_version_generators and sys.dm_tran_version_store are potentially very expensive functions to run, since both query the entire version store, which could be very large.</span></span>  
  
 <span data-ttu-id="33c05-1466">sys.dm_tran_active_snapshot_database_transactions.</span><span class="sxs-lookup"><span data-stu-id="33c05-1466">sys.dm_tran_active_snapshot_database_transactions.</span></span> <span data-ttu-id="33c05-1467">Devuelve una tabla virtual para todas las transacciones activas de todas las bases de datos en la instancia de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] que utiliza versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1467">Returns a virtual table for all active transactions in all databases within the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] instance that use row versioning.</span></span> <span data-ttu-id="33c05-1468">Las transacciones del sistema no aparecen en esta DMV.</span><span class="sxs-lookup"><span data-stu-id="33c05-1468">System transactions do not appear in this DMV.</span></span> <span data-ttu-id="33c05-1469">Para obtener más información, consulte [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1469">For more information, see [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1470">sys.dm_tran_transactions_snapshot.</span><span class="sxs-lookup"><span data-stu-id="33c05-1470">sys.dm_tran_transactions_snapshot.</span></span> <span data-ttu-id="33c05-1471">Devuelve una tabla virtual que muestra las instantáneas tomadas por cada transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1471">Returns a virtual table that displays snapshots taken by each transaction.</span></span> <span data-ttu-id="33c05-1472">La instantánea contiene el número de secuencia de las transacciones activas que utilizan versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1472">The snapshot contains the sequence number of the active transactions that use row versioning.</span></span> <span data-ttu-id="33c05-1473">Para obtener más información, consulte [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1473">For more information, see [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1474">sys.dm_tran_current_transaction.</span><span class="sxs-lookup"><span data-stu-id="33c05-1474">sys.dm_tran_current_transaction.</span></span> <span data-ttu-id="33c05-1475">Devuelve una sola fila que muestra información de estado relacionada con las versiones de fila de la transacción de la sesión actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1475">Returns a single row that displays row versioning-related state information of the transaction in the current session.</span></span> <span data-ttu-id="33c05-1476">Para obtener más información, consulte [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1476">For more information, see [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1477">sys.dm_tran_current_snapshot.</span><span class="sxs-lookup"><span data-stu-id="33c05-1477">sys.dm_tran_current_snapshot.</span></span> <span data-ttu-id="33c05-1478">Devuelve una tabla virtual que muestra todas las transacciones activas en el momento en que se inicia la transacción actual de aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1478">Returns a virtual table that displays all active transactions at the time the current snapshot isolation transaction starts.</span></span> <span data-ttu-id="33c05-1479">Si la transacción actual está usando un aislamiento de instantáneas, esta función no devuelve filas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1479">If the current transaction is using snapshot isolation, this function returns no rows.</span></span> <span data-ttu-id="33c05-1480">La función sys.dm_tran_current_snapshot es similar a sys.dm_tran_transactions_snapshot, excepto en que solo devuelve las transacciones activas de la instantánea actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1480">sys.dm_tran_current_snapshot is similar to sys.dm_tran_transactions_snapshot, except that it returns only the active transactions for the current snapshot.</span></span> <span data-ttu-id="33c05-1481">Para obtener más información, consulte [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1481">For more information, see [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span></span>  
  
##### <a name="performance-counters"></a><span data-ttu-id="33c05-1482">Contadores de rendimiento</span><span class="sxs-lookup"><span data-stu-id="33c05-1482">Performance Counters</span></span>  

 <span data-ttu-id="33c05-1483">Los contadores de rendimiento de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] proporcionan información sobre el rendimiento del sistema afectado por los procesos de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-1483">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] performance counters provide information about the system performance impacted by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] processes.</span></span> <span data-ttu-id="33c05-1484">Los siguientes contadores de rendimiento supervisan tempdb y el almacén de versiones, así como las transacciones que utilizan versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1484">The following performance counters monitor tempdb and the version store, as well as transactions using row versioning.</span></span> <span data-ttu-id="33c05-1485">Los contadores de rendimiento se encuentran en el objeto de rendimiento SQLServer:Transactions.</span><span class="sxs-lookup"><span data-stu-id="33c05-1485">The performance counters are contained in the SQLServer:Transactions performance object.</span></span>  
  
 <span data-ttu-id="33c05-1486">**Espacio disponible en tempdb (KB)** .</span><span class="sxs-lookup"><span data-stu-id="33c05-1486">**Free Space in tempdb (KB)**.</span></span> <span data-ttu-id="33c05-1487">Supervisa la cantidad, en kilobytes (KB), de espacio libre en la base de datos tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1487">Monitors the amount, in kilobytes (KB), of free space in the tempdb database.</span></span> <span data-ttu-id="33c05-1488">Debe haber suficiente espacio libre en tempdb para controlar el almacén de versiones que admite aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1488">There must be enough free space in tempdb to handle the version store that supports snapshot isolation.</span></span>  
  
 <span data-ttu-id="33c05-1489">La fórmula siguiente ofrece una estimación aproximada del tamaño del almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1489">The following formula provides a rough estimate of the size of the version store.</span></span> <span data-ttu-id="33c05-1490">En el caso de transacciones de larga duración, puede que sea conveniente supervisar la velocidad de generación y limpieza para estimar el tamaño máximo del almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1490">For long-running transactions, it may be useful to monitor the generation and cleanup rate to estimate the maximum size of the version store.</span></span>  
  
 <span data-ttu-id="33c05-1491">[tamaño del almacén de versiones común] = 2 \* [datos del almacén de versiones generados por minuto] \* [mayor tiempo de ejecución (minutos) de la transacción]</span><span class="sxs-lookup"><span data-stu-id="33c05-1491">[size of common version store] = 2 \* [version store data generated per minute] \* [longest running time (minutes) of the transaction]</span></span>  
  
 <span data-ttu-id="33c05-1492">El mayor tiempo de ejecución de transacciones no debe incluir generaciones de índices en línea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1492">The longest running time of transactions should not include online index builds.</span></span> <span data-ttu-id="33c05-1493">Dado que estas operaciones pueden llevar mucho tiempo en tablas muy grandes, las generaciones de índices en línea utilizan un almacén de versiones independiente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1493">Because these operations may take a long time on very large tables, online index builds use a separate version store.</span></span> <span data-ttu-id="33c05-1494">El tamaño aproximado del almacén de versiones de generaciones de índices en línea equivale a la cantidad de datos modificados en la tabla, incluidos todos los índices, mientras la generación de índices en línea esté activa.</span><span class="sxs-lookup"><span data-stu-id="33c05-1494">The approximate size of the online index build version store equals the amount of data modified in the table, including all indexes, while the online index build is active.</span></span>  
  
 <span data-ttu-id="33c05-1495">**Tamaño de almacén de versiones (KB)** .</span><span class="sxs-lookup"><span data-stu-id="33c05-1495">**Version Store Size (KB)**.</span></span> <span data-ttu-id="33c05-1496">Supervisa el tamaño en KB de todos los almacenes de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1496">Monitors the size in KB of all version stores.</span></span> <span data-ttu-id="33c05-1497">Esta información ayuda a determinar el espacio necesario para el almacén de versiones en la base de datos tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1497">This information helps determine the amount of space needed in the tempdb database for the version store.</span></span> <span data-ttu-id="33c05-1498">La supervisión de este contador durante cierto tiempo proporciona una estimación útil del espacio adicional necesario para tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1498">Monitoring this counter over a period of time provides a useful estimate of additional space needed for tempdb.</span></span>  
  
 <span data-ttu-id="33c05-1499">`Version Generation rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1499">`Version Generation rate (KB/s)`.</span></span> <span data-ttu-id="33c05-1500">Supervisa la velocidad de generación de versión en KB por segundo en todos los almacenes de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1500">Monitors the version generation rate in KB per second in all version stores.</span></span>  
  
 <span data-ttu-id="33c05-1501">`Version Cleanup rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1501">`Version Cleanup rate (KB/s)`.</span></span> <span data-ttu-id="33c05-1502">Supervisa la velocidad de limpieza de versión en KB por segundo en todos los almacenes de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1502">Monitors the version cleanup rate in KB per second in all version stores.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1503">La información procedente de Velocidad de generación de versión (KB/seg.) y Velocidad de limpieza de versión (KB/seg.) se puede utilizar para predecir los requisitos de espacio de tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1503">Information from Version Generation rate (KB/s) and Version Cleanup rate (KB/s) can be used to predict tempdb space requirements.</span></span>  
  
 <span data-ttu-id="33c05-1504">**Recuento de unidad de almacén de versiones**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1504">**Version Store unit count**.</span></span> <span data-ttu-id="33c05-1505">Supervisa el recuento de unidades del almacén de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1505">Monitors the count of version store units.</span></span>  
  
 <span data-ttu-id="33c05-1506">**Creación de unidad de almacén de versiones**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1506">**Version Store unit creation**.</span></span> <span data-ttu-id="33c05-1507">Supervisa el número total de unidades del almacén de versiones creadas para almacenar versiones de filas desde que se inició la instancia.</span><span class="sxs-lookup"><span data-stu-id="33c05-1507">Monitors the total number of version store units created to store row versions since the instance was started.</span></span>  
  
 <span data-ttu-id="33c05-1508">**Truncamiento de unidad de almacén de versiones**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1508">**Version Store unit truncation**.</span></span> <span data-ttu-id="33c05-1509">Supervisa el número total de unidades del almacén de versiones truncadas desde que se inició la instancia.</span><span class="sxs-lookup"><span data-stu-id="33c05-1509">Monitors the total number of version store units truncated since the instance was started.</span></span> <span data-ttu-id="33c05-1510">Una unidad del almacén de versiones se trunca cuando [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determina que no se necesita ninguna de las filas de versiones almacenadas en la unidad del almacén de versiones para ejecutar transacciones activas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1510">A version store unit is truncated when [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines that none of the version rows stored in the version store unit are needed to run active transactions.</span></span>  
  
 <span data-ttu-id="33c05-1511">**Frecuencia de conflictos de actualización**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1511">**Update conflict ratio**.</span></span> <span data-ttu-id="33c05-1512">Supervisa la frecuencia de las transacciones de instantánea que tienen conflictos de actualización con respecto al número total de transacciones de instantánea de actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-1512">Monitors the ratio of update snapshot transaction that have update conflicts to the total number of update snapshot transactions.</span></span>  
  
 <span data-ttu-id="33c05-1513">**Tiempo mayor de ejecución de transacción**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1513">**Longest Transaction Running Time**.</span></span> <span data-ttu-id="33c05-1514">Supervisa el tiempo mayor de ejecución en segundos de cualquier transacción que utilice versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1514">Monitors the longest running time in seconds of any transaction using row versioning.</span></span> <span data-ttu-id="33c05-1515">Esto permite determinar si una transacción se ejecuta durante una cantidad de tiempo desproporcionada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1515">This can be used to determine if any transaction is running for an unreasonable amount of time.</span></span>  
  
 <span data-ttu-id="33c05-1516">**Transacciones**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1516">**Transactions**.</span></span> <span data-ttu-id="33c05-1517">Supervisa el número total de transacciones activas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1517">Monitors the total number of active transactions.</span></span> <span data-ttu-id="33c05-1518">No incluye las transacciones del sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-1518">This does not include system transactions.</span></span>  
  
 <span data-ttu-id="33c05-1519">`Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1519">`Snapshot Transactions`.</span></span> <span data-ttu-id="33c05-1520">Supervisa el número total de transacciones de instantáneas activas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1520">Monitors the total number of active snapshot transactions.</span></span>  
  
 <span data-ttu-id="33c05-1521">`Update Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1521">`Update Snapshot Transactions`.</span></span> <span data-ttu-id="33c05-1522">Supervisa el número total de transacciones de instantáneas activas que realizan operaciones de actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-1522">Monitors the total number of active snapshot transactions that perform update operations.</span></span>  
  
 <span data-ttu-id="33c05-1523">`NonSnapshot Version Transactions`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1523">`NonSnapshot Version Transactions`.</span></span> <span data-ttu-id="33c05-1524">Supervisa el número total de transacciones que no son instantáneas activas que generan registros de versión.</span><span class="sxs-lookup"><span data-stu-id="33c05-1524">Monitors the total number of active non-snapshot transactions that generate version records.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1525">La suma de Transacciones de instantáneas de actualización y Transacciones de versión que no son instantáneas representa el número total de transacciones que participan en la generación de versiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1525">The sum of Update Snapshot Transactions and NonSnapshot Version Transactions represents the total number of transactions that participate in version generation.</span></span> <span data-ttu-id="33c05-1526">La diferencia entre Transacciones de instantáneas y Transacciones de instantáneas de actualización notifica el número de transacciones de instantáneas de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-1526">The difference of Snapshot Transactions and Update Snapshot Transactions reports the number of read-only snapshot transactions.</span></span>  
  
### <a name="row-versioning-based-isolation-level-example"></a><span data-ttu-id="33c05-1527">Ejemplo de nivel de aislamiento basado en versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1527">Row Versioning-based Isolation Level Example</span></span>  

 <span data-ttu-id="33c05-1528">En los siguientes ejemplos se muestran las diferencias de comportamiento entre transacciones de aislamiento de instantánea y transacciones de lectura confirmada que usan las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1528">The following examples show the differences in behavior between snapshot isolation transactions and read-committed transactions that use row versioning.</span></span>  
  
#### <a name="a-working-with-snapshot-isolation"></a><span data-ttu-id="33c05-1529">A.</span><span class="sxs-lookup"><span data-stu-id="33c05-1529">A.</span></span> <span data-ttu-id="33c05-1530">Trabajar con aislamiento de instantánea</span><span class="sxs-lookup"><span data-stu-id="33c05-1530">Working with snapshot isolation</span></span>  

 <span data-ttu-id="33c05-1531">En este ejemplo, una transacción que se ejecuta con aislamiento de instantánea lee los datos que a continuación modifica otra transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1531">In this example, a transaction running under snapshot isolation reads data that is then modified by another transaction.</span></span> <span data-ttu-id="33c05-1532">La transacción de instantáneas no bloquea la operación de actualización ejecutada por la otra transacción y sigue leyendo datos de la fila con versiones, omitiendo la modificación de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1532">The snapshot transaction does not block the update operation executed by the other transaction, and it continues to read data from the versioned row, ignoring the data modification.</span></span> <span data-ttu-id="33c05-1533">No obstante, cuando la transacción de instantáneas intenta modificar los datos que ya han sido modificados por la otra transacción, genera un error y finaliza.</span><span class="sxs-lookup"><span data-stu-id="33c05-1533">However, when the snapshot transaction attempts to modify the data that has already been modified by the other transaction, the snapshot transaction generates an error and is terminated.</span></span>  
  
 <span data-ttu-id="33c05-1534">En la sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1534">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or the 2008 or 2008R2 version of the AdventureWorks database.  
GO  
  
-- Enable snapshot isolation on the database.  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
GO  
  
-- Start a snapshot transaction  
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="33c05-1535">En la sesión 2:</span><span class="sxs-lookup"><span data-stu-id="33c05-1535">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under snapshot isolation shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="33c05-1536">En la sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1536">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this shows  
    -- the employee having 48 vacation hours.  The  
    -- snapshot transaction is still reading data from  
    -- the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="33c05-1537">En la sesión 2:</span><span class="sxs-lookup"><span data-stu-id="33c05-1537">On session 2:</span></span>  
  
```sql  
-- Commit the transaction; this commits the data  
-- modification.  
COMMIT TRANSACTION;  
GO  
```  
  
 <span data-ttu-id="33c05-1538">En la sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1538">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still   
    -- shows the employee having 48 vacation hours  
    -- even after the other transaction has committed  
    -- the data modification.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- Because the data has been modified outside of the  
    -- snapshot transaction, any further data changes to   
    -- that data by the snapshot transaction will cause   
    -- the snapshot transaction to fail. This statement   
    -- will generate a 3960 error and the transaction will   
    -- terminate.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION  
GO  
```  
  
#### <a name="b-working-with-read-committed-using-row-versioning"></a><span data-ttu-id="33c05-1539">B.</span><span class="sxs-lookup"><span data-stu-id="33c05-1539">B.</span></span> <span data-ttu-id="33c05-1540">Trabajar con transacciones de lectura confirmada utilizando las versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1540">Working with read-committed using row versioning</span></span>  

 <span data-ttu-id="33c05-1541">En este ejemplo, una transacción de lectura confirmada que utiliza las versiones de fila se ejecuta simultáneamente con otra transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1541">In this example, a read-committed transaction using row versioning runs concurrently with another transaction.</span></span> <span data-ttu-id="33c05-1542">La transacción de lectura confirmada se comporta de diferente manera que una transacción de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1542">The read-committed transaction behaves differently than a snapshot transaction.</span></span> <span data-ttu-id="33c05-1543">Al igual que una transacción de instantáneas, la transacción de lectura confirmada lee filas con versiones incluso después de que la otra transacción haya modificado los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1543">Like a snapshot transaction, the read-committed transaction will read versioned rows even after the other transaction has modified data.</span></span> <span data-ttu-id="33c05-1544">Sin embargo, a diferencia de una transacción de instantáneas, la transacción de lectura confirmada:</span><span class="sxs-lookup"><span data-stu-id="33c05-1544">However, unlike a snapshot transaction, the read-committed transaction will:</span></span>  
  
-   <span data-ttu-id="33c05-1545">Leerá los datos modificados después de que la otra transacción confirme los cambios en los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1545">Read the modified data after the other transaction commits the data changes.</span></span>  
  
-   <span data-ttu-id="33c05-1546">Podrá actualizar los datos modificados por la otra transacción cuando la transacción de instantáneas no pueda.</span><span class="sxs-lookup"><span data-stu-id="33c05-1546">Be able to update the data modified by the other transaction where the snapshot transaction could not.</span></span>  
  
 <span data-ttu-id="33c05-1547">En la sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1547">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or any earlier version of the AdventureWorks database.  
GO  
  
-- Enable READ_COMMITTED_SNAPSHOT on the database.  
-- For this statement to succeed, this session  
-- must be the only connection to the AdventureWorks2012  
-- database.  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
GO  
  
-- Start a read-committed transaction  
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="33c05-1548">En la sesión 2:</span><span class="sxs-lookup"><span data-stu-id="33c05-1548">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under read-committed using row versioning shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="33c05-1549">En la sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1549">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still shows  
    -- the employee having 48 vacation hours.  The  
    -- read-committed transaction is still reading data   
    -- from the versioned row and the other transaction   
    -- has not committed the data changes yet.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="33c05-1550">En la sesión 2:</span><span class="sxs-lookup"><span data-stu-id="33c05-1550">On session 2:</span></span>  
  
```sql  
-- Commit the transaction.  
COMMIT TRANSACTION;  
GO  
  
```  
  
 <span data-ttu-id="33c05-1551">En la sesión 1:</span><span class="sxs-lookup"><span data-stu-id="33c05-1551">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement which now shows the   
    -- employee having 40 vacation hours.  Being   
    -- read-committed, this transaction is reading the   
    -- committed data. This is different from snapshot  
    -- isolation which reads from the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- This statement, which caused the snapshot transaction   
    -- to fail, will succeed with read-committed using row versioning.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION;  
GO  
```  
  
### <a name="enabling-row-versioning-based-isolation-levels"></a><span data-ttu-id="33c05-1552">Habilitar niveles de aislamiento basado en versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1552">Enabling Row Versioning-Based Isolation Levels</span></span>  

 <span data-ttu-id="33c05-1553">Los administradores de bases de datos determinan la configuración de la base de datos para versiones de fila mediante las opciones de base de datos READ_COMMITTED_SNAPSHOT y ALLOW_SNAPSHOT_ISOLATION de la instrucción ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="33c05-1553">Database administrators control the database-level settings for row versioning by using the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options in the ALTER DATABASE statement.</span></span>  
  
 <span data-ttu-id="33c05-1554">Cuando se establece la opción de base de datos READ_COMMITTED_SNAPSHOT en ON, se activan inmediatamente los mecanismos utilizados para admitir la opción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1554">When the READ_COMMITTED_SNAPSHOT database option is set ON, the mechanisms used to support the option are activated immediately.</span></span> <span data-ttu-id="33c05-1555">Al establecer la opción READ_COMMITTED_SNAPSHOT, solo se permite en la base de datos la conexión que ejecuta el comando ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="33c05-1555">When setting the READ_COMMITTED_SNAPSHOT option, only the connection executing the ALTER DATABASE command is allowed in the database.</span></span> <span data-ttu-id="33c05-1556">No debe haber ninguna otra conexión de base de datos abierta hasta que ALTER DATABASE haya finalizado.</span><span class="sxs-lookup"><span data-stu-id="33c05-1556">There must be no other open connection in the database until ALTER DATABASE is complete.</span></span> <span data-ttu-id="33c05-1557">La base de datos no tiene que estar en modo de usuario único.</span><span class="sxs-lookup"><span data-stu-id="33c05-1557">The database does not have to be in single-user mode.</span></span>  
  
 <span data-ttu-id="33c05-1558">La siguiente instrucción [!INCLUDE[tsql](../includes/tsql-md.md)] habilita READ_COMMITTED_SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="33c05-1558">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement enables READ_COMMITTED_SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
```  
  
 <span data-ttu-id="33c05-1559">Si la opción de base de datos ALLOW_SNAPSHOT_ISOLATION se establece en ON, la instancia del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] no genera versiones de filas para datos modificados hasta que finalicen todas las transacciones activas que han modificado los datos en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1559">When the ALLOW_SNAPSHOT_ISOLATION database option is set ON, the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] does not generate row versions for modified data until all active transactions that have modified data in the database complete.</span></span> <span data-ttu-id="33c05-1560">Si hay transacciones de modificación activas, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] establece el estado de la opción en PENDING_ON.</span><span class="sxs-lookup"><span data-stu-id="33c05-1560">If there are active modification transactions, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] sets the state of the option to PENDING_ON.</span></span> <span data-ttu-id="33c05-1561">Una vez finalizadas todas las transacciones de modificación, el estado de la opción cambia a ON.</span><span class="sxs-lookup"><span data-stu-id="33c05-1561">After all of the modification transactions complete, the state of the option is changed to ON.</span></span> <span data-ttu-id="33c05-1562">Los usuarios no pueden iniciar una transacción de instantáneas en la base de datos hasta que la opción esté completamente en ON.</span><span class="sxs-lookup"><span data-stu-id="33c05-1562">Users cannot start a snapshot transaction in that database until the option is fully ON.</span></span> <span data-ttu-id="33c05-1563">La base de datos pasa a un estado PENDING_OFF cuando el administrador de la base de datos establece la opción ALLOW_SNAPSHOT_ISOLATION en OFF.</span><span class="sxs-lookup"><span data-stu-id="33c05-1563">The database passes through a PENDING_OFF state when the database administrator sets the ALLOW_SNAPSHOT_ISOLATION option to OFF.</span></span>  
  
 <span data-ttu-id="33c05-1564">La siguiente instrucción [!INCLUDE[tsql](../includes/tsql-md.md)] habilita ALLOW_SNAPSHOT_ISOLATION:</span><span class="sxs-lookup"><span data-stu-id="33c05-1564">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement will enable ALLOW_SNAPSHOT_ISOLATION:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
```  
  
 <span data-ttu-id="33c05-1565">En la tabla siguiente se enumeran y describen los estados de la opción ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="33c05-1565">The following table lists and describes the states of the ALLOW_SNAPSHOT_ISOLATION option.</span></span> <span data-ttu-id="33c05-1566">El uso de ALTER DATABASE con la opción ALLOW_SNAPSHOT_ISOLATION no bloquea a los usuarios que actualmente tienen acceso a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1566">Using ALTER DATABASE with the ALLOW_SNAPSHOT_ISOLATION option does not block users who are currently accessing the database data.</span></span>  
  
|<span data-ttu-id="33c05-1567">Estado del marco de aislamiento de instantánea para la base de datos actual</span><span class="sxs-lookup"><span data-stu-id="33c05-1567">State of snapshot isolation framework for current database</span></span>|<span data-ttu-id="33c05-1568">Descripción</span><span class="sxs-lookup"><span data-stu-id="33c05-1568">Description</span></span>|  
|----------------------------------------------------------------|-----------------|  
|<span data-ttu-id="33c05-1569">Apagado</span><span class="sxs-lookup"><span data-stu-id="33c05-1569">OFF</span></span>|<span data-ttu-id="33c05-1570">La compatibilidad de transacciones de aislamiento de instantánea no está activada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1570">The support for snapshot isolation transactions is not activated.</span></span> <span data-ttu-id="33c05-1571">No se permiten transacciones de aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1571">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="33c05-1572">PENDING_ON</span><span class="sxs-lookup"><span data-stu-id="33c05-1572">PENDING_ON</span></span>|<span data-ttu-id="33c05-1573">La compatibilidad de transacciones de aislamiento de instantánea se encuentra en estado de transición (de OFF a ON).</span><span class="sxs-lookup"><span data-stu-id="33c05-1573">The support for snapshot isolation transactions is in transition state (from OFF to ON).</span></span> <span data-ttu-id="33c05-1574">Las operaciones abiertas deben finalizar.</span><span class="sxs-lookup"><span data-stu-id="33c05-1574">Open transactions must complete.</span></span><br /><br /> <span data-ttu-id="33c05-1575">No se permiten transacciones de aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1575">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="33c05-1576">ACTIVAR</span><span class="sxs-lookup"><span data-stu-id="33c05-1576">ON</span></span>|<span data-ttu-id="33c05-1577">La compatibilidad de transacciones de aislamiento de instantánea está activada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1577">The support for snapshot isolation transactions is activated.</span></span><br /><br /> <span data-ttu-id="33c05-1578">Se permiten transacciones de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1578">Snapshot transactions are allowed.</span></span>|  
|<span data-ttu-id="33c05-1579">PENDING_OFF</span><span class="sxs-lookup"><span data-stu-id="33c05-1579">PENDING_OFF</span></span>|<span data-ttu-id="33c05-1580">La compatibilidad de transacciones de aislamiento de instantánea se encuentra en estado de transición (de ON a OFF).</span><span class="sxs-lookup"><span data-stu-id="33c05-1580">The support for snapshot isolation transactions is in transition state (from ON to OFF).</span></span><br /><br /> <span data-ttu-id="33c05-1581">Las transacciones de instantáneas iniciadas con posterioridad no tienen acceso a esta base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1581">Snapshot transactions started after this time cannot access this database.</span></span> <span data-ttu-id="33c05-1582">La actualización de transacciones sigue pagando el costo de crear versiones en esta base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1582">Update transactions still pay the cost of versioning in this database.</span></span> <span data-ttu-id="33c05-1583">Las transacciones de instantáneas existentes siguen teniendo acceso a la base de datos sin problema.</span><span class="sxs-lookup"><span data-stu-id="33c05-1583">Existing snapshot transactions can still access this database without a problem.</span></span> <span data-ttu-id="33c05-1584">El estado PENDING_OFF no pasa a OFF hasta que finalicen las transacciones de instantáneas que estaban activas cuando el estado de aislamiento de instantánea de base de datos estaba en ON.</span><span class="sxs-lookup"><span data-stu-id="33c05-1584">The state PENDING_OFF does not become OFF until all snapshot transactions that were active when the database snapshot isolation state was ON finish.</span></span>|  
  
 <span data-ttu-id="33c05-1585">Utilice la vista de catálogo sys.databases para determinar el estado de ambas opciones de base de datos para las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1585">Use the sys.databases catalog view to determine the state of both row versioning database options.</span></span>  
  
 <span data-ttu-id="33c05-1586">Todas las actualizaciones de tablas de usuario y algunas tablas de sistema almacenadas en la base de datos maestra y msdb generan versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="33c05-1586">All updates to user tables and some system tables stored in master and msdb generate row versions.</span></span>  
  
 <span data-ttu-id="33c05-1587">La opción ALLOW_SNAPSHOT_ISOLATION se establece automáticamente en ON en las bases de datos maestra y msdb, y no puede deshabilitarse.</span><span class="sxs-lookup"><span data-stu-id="33c05-1587">The ALLOW_SNAPSHOT_ISOLATION option is automatically set ON in the master and msdb databases, and cannot be disabled.</span></span>  
  
 <span data-ttu-id="33c05-1588">Los usuarios no pueden establecer en ON la opción READ_COMMITTED_SNAPSHOT en la bases de datos maestra, tempdb ni msdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1588">Users cannot set the READ_COMMITTED_SNAPSHOT option ON in master, tempdb, or msdb.</span></span>  
  
### <a name="using-row-versioning-based-isolation-levels"></a><span data-ttu-id="33c05-1589">Usar niveles de aislamiento basados en versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1589">Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="33c05-1590">El marco de versiones de fila está siempre habilitado en [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] y lo utilizan varias características.</span><span class="sxs-lookup"><span data-stu-id="33c05-1590">The row versioning framework is always enabled in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], and is used by multiple features.</span></span> <span data-ttu-id="33c05-1591">Además de proporcionar niveles de aislamiento basados en versiones de fila, se utiliza para admitir las modificaciones efectuadas en desencadenadores y sesiones de conjuntos de resultados activos múltiples (MARS), así como para admitir lecturas de datos en operaciones de índice ONLINE.</span><span class="sxs-lookup"><span data-stu-id="33c05-1591">Besides providing row versioning-based isolation levels, it is used to support modifications made in triggers and multiple active result sets (MARS) sessions, and to support data reads for ONLINE index operations.</span></span>  
  
 <span data-ttu-id="33c05-1592">Los niveles de aislamiento basados en versiones de fila se habilitan en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1592">Row versioning-based isolation levels are enabled at the database level.</span></span> <span data-ttu-id="33c05-1593">Cualquier aplicación que tenga acceso a objetos de bases de datos habilitadas puede ejecutar consultas con los siguientes niveles de aislamiento:</span><span class="sxs-lookup"><span data-stu-id="33c05-1593">Any application accessing objects from enabled databases can run queries using the following isolation levels:</span></span>  
  
-   <span data-ttu-id="33c05-1594">Lectura de confirmadas, que utiliza versiones de fila al establecer la opción de base de datos `READ_COMMITTED_SNAPSHOT` en `ON`, como se muestra en el siguiente ejemplo de código:</span><span class="sxs-lookup"><span data-stu-id="33c05-1594">Read-committed that uses row versioning by setting the `READ_COMMITTED_SNAPSHOT` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET READ_COMMITTED_SNAPSHOT ON;  
    ```  
  
     <span data-ttu-id="33c05-1595">Cuando la base de datos se habilita para READ_COMMITTED_SNAPSHOT, todas las consultas que se ejecutan en el nivel de aislamiento de lectura de confirmadas utilizan versiones de fila, lo que significa que las operaciones de lectura no bloquean las operaciones de actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-1595">When the database is enabled for READ_COMMITTED_SNAPSHOT, all queries running under the read committed isolation level use row versioning, which means that read operations do not block update operations.</span></span>  
  
-   <span data-ttu-id="33c05-1596">Puede habilitar el aislamiento de instantáneas configurando la opción de base de datos `ALLOW_SNAPSHOT_ISOLATION` en `ON`, como se muestra en el ejemplo de código siguiente:</span><span class="sxs-lookup"><span data-stu-id="33c05-1596">Snapshot isolation by setting the `ALLOW_SNAPSHOT_ISOLATION` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET ALLOW_SNAPSHOT_ISOLATION ON;  
    ```  
  
     <span data-ttu-id="33c05-1597">Una transacción que se ejecute en aislamiento de instantánea puede tener acceso a tablas de la base de datos que se hayan habilitado para instantáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1597">A transaction running under snapshot isolation can access tables in the database that have been enabled for snapshot.</span></span> <span data-ttu-id="33c05-1598">Para obtener acceso a tablas que no se han habilitado para instantáneas, debe cambiarse el nivel de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1598">To access tables that have not been enabled for snapshot, the isolation level must be changed.</span></span> <span data-ttu-id="33c05-1599">El siguiente ejemplo de código muestra una instrucción `SELECT` que une dos tablas mientras se ejecuta en una transacción de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1599">For example, the following code example shows a `SELECT` statement that joins two tables while running under a snapshot transaction.</span></span> <span data-ttu-id="33c05-1600">Una tabla pertenece a una base de datos en la que no se habilitó el aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1600">One table belongs to a database in which snapshot isolation is not enabled.</span></span> <span data-ttu-id="33c05-1601">Cuando la instrucción `SELECT` se ejecuta en aislamiento de instantánea, no lo hace correctamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1601">When the `SELECT` statement runs under snapshot isolation, it fails to execute successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
     <span data-ttu-id="33c05-1602">El siguiente ejemplo de código muestra la misma instrucción `SELECT` modificada para cambiar el nivel de aislamiento de transacción a lectura de confirmadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1602">The following code example shows the same `SELECT` statement that has been modified to change the transaction isolation level to read-committed.</span></span> <span data-ttu-id="33c05-1603">Gracias a este cambio, la instrucción `SELECT` se ejecuta correctamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1603">Because of this change, the `SELECT` statement executes successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            WITH (READCOMMITTED)  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
#### <a name="limitations-of-transactions-using-row-versioning-based-isolation-levels"></a><span data-ttu-id="33c05-1604">Limitaciones de transacciones con niveles de aislamiento basados en versiones de fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1604">Limitations of Transactions Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="33c05-1605">Tenga en cuenta las siguientes limitaciones cuando trabaje con niveles de aislamiento basados en versiones de fila:</span><span class="sxs-lookup"><span data-stu-id="33c05-1605">Consider the following limitations when working with row versioning-based isolation levels:</span></span>  
  
-   <span data-ttu-id="33c05-1606">No se puede habilitar READ_COMMITTED_SNAPSHOT en tempdb, msdb ni master.</span><span class="sxs-lookup"><span data-stu-id="33c05-1606">READ_COMMITTED_SNAPSHOT cannot be enabled in tempdb, msdb, or master.</span></span>  
  
-   <span data-ttu-id="33c05-1607">Las tablas temporales globales se almacenan en tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1607">Global temp tables are stored in tempdb.</span></span> <span data-ttu-id="33c05-1608">Cuando se obtiene acceso a tablas temporales globales en una transacción de instantáneas, debe realizarse alguna de las siguientes acciones:</span><span class="sxs-lookup"><span data-stu-id="33c05-1608">When accessing global temp tables inside a snapshot transaction, one of the following must happen:</span></span>  
  
    -   <span data-ttu-id="33c05-1609">Establecer la opción de base de datos ALLOW_SNAPSHOT_ISOLATION como ON en tempdb.</span><span class="sxs-lookup"><span data-stu-id="33c05-1609">Set the ALLOW_SNAPSHOT_ISOLATION database option ON in tempdb.</span></span>  
  
    -   <span data-ttu-id="33c05-1610">Usar una sugerencia de aislamiento para cambiar el nivel de aislamiento de la instrucción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1610">Use an isolation hint to change the isolation level for the statement.</span></span>  
  
-   <span data-ttu-id="33c05-1611">Las transacciones de instantáneas provocan errores cuando:</span><span class="sxs-lookup"><span data-stu-id="33c05-1611">Snapshot transactions fail when:</span></span>  
  
    -   <span data-ttu-id="33c05-1612">Una base de datos pasa a ser de solo lectura una vez iniciada la transacción de instantáneas, pero antes de que ésta obtenga acceso a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1612">A database is made read-only after the snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span>  
  
    -   <span data-ttu-id="33c05-1613">Si al tener acceso a objetos de varias bases de datos, el estado de una base de datos se modificó de forma que la recuperación de la base de datos se produjo después del inicio de la transacción, pero antes del acceso de la transacción de instantáneas a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1613">If accessing objects from multiple databases, a database state was changed in such a way that database recovery occurred after a snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span> <span data-ttu-id="33c05-1614">Por ejemplo, la base de datos se estableció en OFFLINE y luego en ONLINE, cierre automático y apertura de base de datos, o adjuntar y separar una base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1614">For example: the database was set to OFFLINE and then to ONLINE, database autoclose and open, or database detach and attach.</span></span>  
  
-   <span data-ttu-id="33c05-1615">Las transacciones distribuidas, incluidas las consultas de bases de datos con particiones distribuidas, no se admiten en aislamiento de instantánea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1615">Distributed transactions, including queries in distributed partitioned databases, are not supported under snapshot isolation.</span></span>  
  
-   [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="33c05-1616">no mantiene varias versiones de los metadatos del sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-1616">does not keep multiple versions of system metadata.</span></span> <span data-ttu-id="33c05-1617">Las instrucciones del lenguaje de definición de datos (DDL) de tablas y otros objetos de base de datos (índices, vistas, tipos de datos, procedimientos almacenados y funciones de CLR (Common Language Runtime)) cambian los metadatos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1617">Data definition language (DDL) statements on tables and other database objects (indexes, views, data types, stored procedures, and common language runtime functions) change metadata.</span></span> <span data-ttu-id="33c05-1618">Si una instrucción DDL modifica un objeto, cualquier referencia simultánea al objeto en aislamiento de instantánea provoca errores en la transacción de instantáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1618">If a DDL statement modifies an object, any concurrent reference to the object under snapshot isolation causes the snapshot transaction to fail.</span></span> <span data-ttu-id="33c05-1619">Las transacciones de lectura de confirmadas no tienen esta limitación cuando la opción de base de datos READ_COMMITTED_SNAPSHOT es ON.</span><span class="sxs-lookup"><span data-stu-id="33c05-1619">Read-committed transactions do not have this limitation when the READ_COMMITTED_SNAPSHOT database option is ON.</span></span>  
  
     <span data-ttu-id="33c05-1620">Por ejemplo, el administrador de la base de datos ejecuta la siguiente instrucción `ALTER INDEX`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1620">For example, a database administrator executes the following `ALTER INDEX` statement.</span></span>  
  
    ```sql  
    USE AdventureWorks2012;  
    GO  
    ALTER INDEX AK_Employee_LoginID  
        ON HumanResources.Employee REBUILD;  
    GO  
    ```  
  
     <span data-ttu-id="33c05-1621">Cualquier transacción de instantáneas que esté activa cuando se ejecuta la instrucción `ALTER INDEX` recibirá un error si intenta hacer referencia a la tabla `HumanResources.Employee` una vez ejecutada la instrucción `ALTER INDEX`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1621">Any snapshot transaction that is active when the `ALTER INDEX` statement is executed receives an error if it attempts to reference the `HumanResources.Employee` table after the `ALTER INDEX` statement is executed.</span></span> <span data-ttu-id="33c05-1622">Las transacciones de lectura de confirmadas que utilicen versiones de fila no se verán afectadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1622">Read-committed transactions using row versioning are not affected.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="33c05-1623">Las operaciones BULK INSERT pueden provocar cambios en los metadatos de la tabla de destino (por ejemplo, al deshabilitar las comprobaciones de restricciones).</span><span class="sxs-lookup"><span data-stu-id="33c05-1623">BULK INSERT operations may cause changes to target table metadata (for example, when disabling constraint checks).</span></span> <span data-ttu-id="33c05-1624">Cuando esto sucede, las transacciones simultáneas de aislamiento de instantánea que obtengan acceso a tablas de inserciones masivas generarán un error.</span><span class="sxs-lookup"><span data-stu-id="33c05-1624">When this happens, concurrent snapshot isolation transactions accessing bulk inserted tables fail.</span></span>  
  
 <span data-ttu-id="33c05-1625">![Icono de flecha usado con el vínculo volver al principio](media/uparrow16x16.gif "Icono de flecha usado con el vínculo Volver al principio") [de esta guía](#Top)</span><span class="sxs-lookup"><span data-stu-id="33c05-1625">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="customizing-locking-and-row-versioning"></a><span data-ttu-id="33c05-1626">Personalizar las versiones de fila y bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-1626">Customizing Locking and Row Versioning</span></span>  
  
### <a name="customizing-the-lock-time-out"></a><span data-ttu-id="33c05-1627">Personalizar el tiempo de espera de bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-1627">Customizing the Lock Time-Out</span></span>  

 <span data-ttu-id="33c05-1628">Cuando una instancia del [!INCLUDE[msCoName](../includes/msconame-md.md)] de [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] no puede conceder un bloqueo a una transacción porque otra transacción ya posee un bloqueo en conflicto para el recurso, la primera transacción queda bloqueada a la espera de que se libere el bloqueo existente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1628">When an instance of the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] cannot grant a lock to a transaction because another transaction already owns a conflicting lock on the resource, the first transaction becomes blocked waiting for the existing lock to be released.</span></span> <span data-ttu-id="33c05-1629">De forma predeterminada no hay un tiempo de espera obligatorio, ni tampoco existe ningún modo de comprobar si un recurso está bloqueado antes de intentar bloquearlo, excepto intentar tener acceso a los datos (con el riesgo de quedar bloqueado indefinidamente).</span><span class="sxs-lookup"><span data-stu-id="33c05-1629">By default, there is no mandatory time-out period and no way to test whether a resource is locked before locking it, except to attempt to access the data (and potentially get blocked indefinitely).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1630">En [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use la vista de administración dinámica **sys.dm_os_waiting_tasks** para determinar si un proceso está bloqueado y quién lo bloquea.</span><span class="sxs-lookup"><span data-stu-id="33c05-1630">In [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sys.dm_os_waiting_tasks** dynamic management view to determine whether a process is being blocked and who is blocking it.</span></span> <span data-ttu-id="33c05-1631">En versiones anteriores de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use el procedimiento almacenado del sistema **sp_who**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1631">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sp_who** system stored procedure.</span></span>  
  
 <span data-ttu-id="33c05-1632">El parámetro LOCK_TIMEOUT permite a una aplicación establecer el tiempo máximo que una instrucción esperará a un recurso bloqueado.</span><span class="sxs-lookup"><span data-stu-id="33c05-1632">The LOCK_TIMEOUT setting allows an application to set a maximum time that a statement waits on a blocked resource.</span></span> <span data-ttu-id="33c05-1633">Cuando una instrucción ha esperado más tiempo del indicado en LOCK_TIMEOUT, la instrucción bloqueada se cancela automáticamente y se devuelve el mensaje de error 1222 (`Lock request time-out period exceeded`) a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="33c05-1633">When a statement has waited longer than the LOCK_TIMEOUT setting, the blocked statement is canceled automatically, and error message 1222 (`Lock request time-out period exceeded`) is returned to the application.</span></span> <span data-ttu-id="33c05-1634">Sin embargo, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] no cancela ni revierte ninguna transacción que contenga la instrucción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1634">Any transaction containing the statement, however, is not rolled back or canceled by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="33c05-1635">Por consiguiente, la aplicación debe tener un controlador de errores que pueda interceptar el mensaje de error 1222.</span><span class="sxs-lookup"><span data-stu-id="33c05-1635">Therefore, the application must have an error handler that can trap error message 1222.</span></span> <span data-ttu-id="33c05-1636">Si una aplicación no intercepta el error, puede continuar sin ser consciente de que se ha cancelado una instrucción individual de la transacción y de que esto puede producir errores, ya que las instrucciones posteriores de la transacción podrían depender de la instrucción que nunca se ejecutó.</span><span class="sxs-lookup"><span data-stu-id="33c05-1636">If an application does not trap the error, the application can proceed unaware that an individual statement within a transaction has been canceled, and errors can occur because statements later in the transaction might depend on the statement that was never executed.</span></span>  
  
 <span data-ttu-id="33c05-1637">Al implementar un controlador de errores que intercepte el mensaje de error 1222 se permite a una aplicación controlar la situación de tiempo de espera y realizar una acción apropiada para solucionarla, como volver a enviar automáticamente la instrucción bloqueada o revertir la transacción completa.</span><span class="sxs-lookup"><span data-stu-id="33c05-1637">Implementing an error handler that traps error message 1222 allows an application to handle the time-out situation and take remedial action, such as: automatically resubmitting the statement that was blocked or rolling back the entire transaction.</span></span>  
  
 <span data-ttu-id="33c05-1638">Para determinar el valor de LOCK_TIMEOUT actual, ejecute la @LOCK_TIMEOUT función @:</span><span class="sxs-lookup"><span data-stu-id="33c05-1638">To determine the current LOCK_TIMEOUT setting, execute the @@LOCK_TIMEOUT function:</span></span>  
  
```sql  
SELECT @@lock_timeout;  
GO  
```  
  
### <a name="customizing-transaction-isolation-level"></a><span data-ttu-id="33c05-1639">Personalizar el nivel de aislamiento de transacción</span><span class="sxs-lookup"><span data-stu-id="33c05-1639">Customizing Transaction Isolation Level</span></span>  

 <span data-ttu-id="33c05-1640">READ COMMITTED es el nivel de aislamiento predeterminado del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] de [!INCLUDE[msCoName](../includes/msconame-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-1640">READ COMMITTED is the default isolation level for the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="33c05-1641">Cuando es necesario utilizar una aplicación en un nivel de aislamiento distinto, se pueden utilizar los métodos que se indican a continuación para configurar el nivel de aislamiento:</span><span class="sxs-lookup"><span data-stu-id="33c05-1641">If an application must operate at a different isolation level, it can use the following methods to set the isolation level:</span></span>  
  
-   <span data-ttu-id="33c05-1642">Ejecute la instrucción [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1642">Run the [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="33c05-1643">En las aplicaciones ADO.NET que utilizan el espacio de nombres administrado System.Data.SqlClient, especifique una opción *IsolationLevel* mediante el método SqlConnection.BeginTransaction.</span><span class="sxs-lookup"><span data-stu-id="33c05-1643">ADO.NET applications that use the System.Data.SqlClient managed namespace can specify an *IsolationLevel* option by using the SqlConnection.BeginTransaction method.</span></span>  
  
-   <span data-ttu-id="33c05-1644">Las aplicaciones que usan ADO pueden establecer la propiedad `Autocommit Isolation Levels`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1644">Applications that use ADO can set the `Autocommit Isolation Levels` property.</span></span>  
  
-   <span data-ttu-id="33c05-1645">Al iniciar una transacción, las aplicaciones que utilicen OLE DB pueden llamar a ITransactionLocal::StartTransaction con la propiedad *isoLevel* establecida en el nivel de aislamiento de transacción deseado.</span><span class="sxs-lookup"><span data-stu-id="33c05-1645">When starting a transaction, applications using OLE DB can call ITransactionLocal::StartTransaction with *isoLevel* set to the desired transaction isolation level.</span></span> <span data-ttu-id="33c05-1646">Si se especifica el nivel de aislamiento en el modo de confirmación automática, para las aplicaciones que utilicen OLE DB se puede establecer la propiedad DBPROPSET_SESSION, DBPROP_SESS_AUTOCOMMITISOLEVELS en el nivel de aislamiento de transacción deseado.</span><span class="sxs-lookup"><span data-stu-id="33c05-1646">When specifying the isolation level in autocommit mode, applications that use OLE DB can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to the desired transaction isolation level.</span></span>  
  
-   <span data-ttu-id="33c05-1647">Las aplicaciones que utilizan ODBC pueden establecer el atributo SQL_COPT_SS_TXN_ISOLATION mediante SQLSetConnectAttr.</span><span class="sxs-lookup"><span data-stu-id="33c05-1647">Applications that use ODBC can set the SQL_COPT_SS_TXN_ISOLATION attribute by using SQLSetConnectAttr.</span></span>  
  
 <span data-ttu-id="33c05-1648">Si se especifica el nivel de aislamiento, el bloqueo de todas las consultas e instrucciones del lenguaje de manipulación de datos (DML) en la sesión de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] se aplica en ese nivel de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1648">When the isolation level is specified, the locking behavior for all queries and data manipulation language (DML) statements in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] session operates at that isolation level.</span></span> <span data-ttu-id="33c05-1649">El nivel de aislamiento permanece vigente hasta que finaliza la sesión o hasta que se cambia la configuración del nivel de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1649">The isolation level remains in effect until the session terminates or until the isolation level is set to another level.</span></span>  
  
 <span data-ttu-id="33c05-1650">En el siguiente ejemplo, se configura el nivel de aislamiento `SERIALIZABLE`:</span><span class="sxs-lookup"><span data-stu-id="33c05-1650">The following example sets the `SERIALIZABLE` isolation level:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
SELECT BusinessEntityID  
    FROM HumanResources.Employee;  
GO  
```  
  
 <span data-ttu-id="33c05-1651">El nivel de aislamiento se puede pasar por alto, si es necesario, para consultas o instrucciones DML individuales. Para ello debe especificarse una sugerencia de tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1651">The isolation level can be overridden for individual query or DML statements, if necessary, by specifying a table-level hint.</span></span> <span data-ttu-id="33c05-1652">El hecho de especificar una sugerencia de tabla no afecta a las demás instrucciones de la sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-1652">Specifying a table-level hint does not affect other statements in the session.</span></span> <span data-ttu-id="33c05-1653">Se recomienda que las sugerencias de tabla solo se utilicen para modificar el comportamiento predeterminado en los casos estrictamente necesarios.</span><span class="sxs-lookup"><span data-stu-id="33c05-1653">We recommend that table-level hints be used to change the default behavior only when absolutely necessary.</span></span>  
  
 <span data-ttu-id="33c05-1654">Es posible que [!INCLUDE[ssDE](../includes/ssde-md.md)] tenga que adquirir bloqueos al leer los metadatos incluso si el nivel de aislamiento se ha establecido en un nivel en el que no se soliciten bloqueos compartidos al leer los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1654">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata even when the isolation level is set to a level where share locks are not requested when reading data.</span></span> <span data-ttu-id="33c05-1655">Por ejemplo, una transacción que se ejecute en el nivel de aislamiento de lectura sin confirmar no adquiere bloqueos compartidos al leer datos, pero es probable que tenga que solicitar bloqueos en alguna ocasión al leer una vista de catálogo del sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-1655">For example, a transaction running at the read-uncommitted isolation level does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="33c05-1656">Esto significa que es posible que una transacción con lectura sin confirmar provoque un bloqueo cuando ejecute consultas en una tabla mientras otra transacción simultánea modifica los metadatos de la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1656">This means it is possible for a read uncommitted transaction to cause blocking when querying a table when a concurrent transaction is modifying the metadata of that table.</span></span>  
  
 <span data-ttu-id="33c05-1657">Para determinar el nivel de aislamiento de transacción que está establecido actualmente, utilice la instrucción `DBCC USEROPTIONS` como se indica en el siguiente ejemplo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1657">To determine the transaction isolation level currently set, use the `DBCC USEROPTIONS` statement as shown in the following example.</span></span> <span data-ttu-id="33c05-1658">El conjunto de resultados puede variar según el conjunto de resultados del sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-1658">The result set may vary from the result set on your system.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;  
GO  
DBCC USEROPTIONS;  
GO  
```  
  
 [!INCLUDE[ssResult](../includes/ssresult-md.md)]  
  
 `Set Option                   Value`  
  
 `---------------------------- -------------------------------------------`  
  
 `textsize                     2147483647`  
  
 `language                     us_english`  
  
 `dateformat                   mdy`  
  
 `datefirst                    7`  
  
 `...                          ...`  
  
 `Isolation level              repeatable read`  
  
 ``  
  
 `(14 row(s) affected)`  
  
 ``  
  
 `DBCC execution completed. If DBCC printed error messages, contact your system administrator.`  
  
### <a name="locking-hints"></a><span data-ttu-id="33c05-1659">Sugerencias de bloqueo</span><span class="sxs-lookup"><span data-stu-id="33c05-1659">Locking Hints</span></span>  

 <span data-ttu-id="33c05-1660">Se pueden especificar sugerencias de bloqueo para referencias de tablas individuales en las instrucciones SELECT, INSERT, UPDATE y DELETE.</span><span class="sxs-lookup"><span data-stu-id="33c05-1660">Locking hints can be specified for individual table references in the SELECT, INSERT, UPDATE, and DELETE statements.</span></span> <span data-ttu-id="33c05-1661">Las sugerencias especifican el tipo de bloqueo o las versiones de fila que utiliza la instancia de [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] para los datos de la tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1661">The hints specify the type of locking or row versioning the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses for the table data.</span></span> <span data-ttu-id="33c05-1662">Se pueden utilizar las sugerencias de bloqueo de tabla cuando se requiere un control más ajustado de los tipos de bloqueo adquiridos en un objeto.</span><span class="sxs-lookup"><span data-stu-id="33c05-1662">Table-level locking hints can be used when a finer control of the types of locks acquired on an object is required.</span></span> <span data-ttu-id="33c05-1663">Estas sugerencias de bloqueo suplantan el nivel de aislamiento de la transacción actual durante la sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-1663">These locking hints override the current transaction isolation level for the session.</span></span>  
  
 <span data-ttu-id="33c05-1664">Para obtener más información sobre las sugerencias de bloqueo específicas y sus comportamientos, vea [Sugerencias &#40;Transact-SQL&#41; - tabla](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="33c05-1664">For more information about the specific locking hints and their behaviors, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1665">El optimizador de consultas del [!INCLUDE[ssDE](../includes/ssde-md.md)] suele elegir el nivel de bloqueo correcto.</span><span class="sxs-lookup"><span data-stu-id="33c05-1665">The [!INCLUDE[ssDE](../includes/ssde-md.md)] query optimizer almost always chooses the correct locking level.</span></span> <span data-ttu-id="33c05-1666">Se recomienda utilizar las sugerencias de bloqueo de tabla para modificar el comportamiento de bloqueo predeterminado en los casos estrictamente necesarios.</span><span class="sxs-lookup"><span data-stu-id="33c05-1666">We recommend that table-level locking hints be used to change the default locking behavior only when necessary.</span></span> <span data-ttu-id="33c05-1667">Impedir un nivel de bloqueo puede ir en detrimento de la simultaneidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-1667">Disallowing a locking level can adversely affect concurrency.</span></span>  
  
 <span data-ttu-id="33c05-1668">El [!INCLUDE[ssDE](../includes/ssde-md.md)] podría verse forzado a adquirir bloqueos al leer los metadatos, incluso cuando procese una instrucción SELECT con una sugerencia de bloqueo que impida a las solicitudes compartir bloqueos al leer los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1668">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata, even when processing a select with a locking hint that prevents requests for share locks when reading data.</span></span> <span data-ttu-id="33c05-1669">Por ejemplo, una instrucción SELECT que utiliza la sugerencia NOLOCK no adquiere bloqueos compartidos al leer los datos, pero podría solicitar bloqueos en alguna oportunidad al leer la vista de catálogo del sistema.</span><span class="sxs-lookup"><span data-stu-id="33c05-1669">For example, a SELECT using the NOLOCK hint does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="33c05-1670">Esto significa que es posible que una instrucción SELECT que utilice NOLOCK esté bloqueada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1670">This means it is possible for a SELECT statement using NOLOCK to be blocked.</span></span>  
  
 <span data-ttu-id="33c05-1671">Según se muestra en el siguiente ejemplo, si se establece el nivel de aislamiento de la transacción en `SERIALIZABLE` y se utiliza la sugerencia de bloqueo de nivel de tabla `NOLOCK` con la instrucción `SELECT`, no se aplican los bloqueos de intervalos de claves usados normalmente para mantener las transacciones serializables.</span><span class="sxs-lookup"><span data-stu-id="33c05-1671">As shown in the following example, if the transaction isolation level is set to `SERIALIZABLE`, and the table-level locking hint `NOLOCK` is used with the `SELECT` statement, key-range locks typically used to maintain serializable transactions are not taken.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
GO  
SELECT JobTitle  
    FROM HumanResources.Employee WITH (NOLOCK);  
GO  
  
-- Get information about the locks held by   
-- the transaction.  
SELECT    
        resource_type,   
        resource_subtype,   
        request_mode  
    FROM sys.dm_tran_locks  
    WHERE request_session_id = @@spid;  
  
-- End the transaction.  
ROLLBACK;  
GO  
```  
  
 <span data-ttu-id="33c05-1672">El único bloqueo utilizado que hace referencia a `HumanResources.Employee` es un bloqueo de estabilidad de esquema (Sch-S).</span><span class="sxs-lookup"><span data-stu-id="33c05-1672">The only lock taken that references `HumanResources.Employee` is a schema stability (Sch-S) lock.</span></span> <span data-ttu-id="33c05-1673">En este caso, ya no se garantiza la serialidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-1673">In this case, serializability is no longer guaranteed.</span></span>  
  
 <span data-ttu-id="33c05-1674">En [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], la opción LOCK_ESCALATION de ALTER TABLE puede penalizar los bloqueos de tabla y habilitar los bloqueos HoBT en tablas con particiones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1674">In [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], the LOCK_ESCALATION option of ALTER TABLE can disfavor table locks, and enable HoBT locks on partitioned tables.</span></span> <span data-ttu-id="33c05-1675">Esta opción no es una sugerencia de bloqueo, pero puede utilizarse para reducir la extensión de los bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1675">This option is not a locking hint, but can but used to reduce lock escalation.</span></span> <span data-ttu-id="33c05-1676">Para obtener más información, vea [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1676">For more information, see [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
###  <a name="customizing-locking-for-an-index"></a><a name="Customize"></a> <span data-ttu-id="33c05-1677">Personalizar el bloqueo de un índice</span><span class="sxs-lookup"><span data-stu-id="33c05-1677">Customizing Locking for an Index</span></span>  

 <span data-ttu-id="33c05-1678">[!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utiliza una estrategia de bloqueo dinámico que, en la mayoría de casos, elige automáticamente la mejor granularidad de bloqueo para las consultas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1678">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy that automatically chooses the best locking granularity for queries in most cases.</span></span> <span data-ttu-id="33c05-1679">Se recomienda no invalidar los niveles de bloqueo predeterminados, que tienen el bloqueo de página y fila habilitados, a menos que se tenga un conocimiento claro de los patrones de acceso a tablas o índices y de que estos sean coherentes, y de que se surja un problema de contención de recursos que haya que resolver.</span><span class="sxs-lookup"><span data-stu-id="33c05-1679">We recommend that you do not override the default locking levels, which have page and row locking on, unless table or index access patterns are well understood and consistent, and there is a resource contention problem to solve.</span></span> <span data-ttu-id="33c05-1680">Si se invalida un nivel de bloqueo, se puede obstaculizar considerablemente el acceso simultáneo a una tabla o índice.</span><span class="sxs-lookup"><span data-stu-id="33c05-1680">Overriding a locking level can significantly impede concurrent access to a table or index.</span></span> <span data-ttu-id="33c05-1681">Por ejemplo, si se especifican bloqueos solamente para el nivel de tabla en una tabla de gran tamaño a la que los usuarios obtienen acceso frecuentemente, se pueden producir cuellos de botella, ya que los usuarios deben esperar a que se libere el bloqueo de la tabla para tener acceso a ella.</span><span class="sxs-lookup"><span data-stu-id="33c05-1681">For example, specifying only table-level locks on a large table that users access heavily can cause bottlenecks because users must wait for the table-level lock to be released before accessing the table.</span></span>  
  
 <span data-ttu-id="33c05-1682">Hay algunos casos en lo que puede ser conveniente impedir los bloqueos de página o fila, siempre y cuando se comprendan perfectamente los patrones y estos sean coherentes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1682">There are a few cases where disallowing page or row locking can be beneficial, if the access patterns are well understood and consistent.</span></span> <span data-ttu-id="33c05-1683">Por ejemplo, una aplicación de bases de datos utiliza una tabla de búsqueda que se actualiza semanalmente en un proceso por lotes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1683">For example, a database application uses a lookup table that is updated weekly in a batch process.</span></span> <span data-ttu-id="33c05-1684">Los lectores simultáneos tienen acceso a la tabla con un bloqueo compartido (S) y las actualizaciones por lotes semanales obtienen acceso a la tabla con un bloqueo exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="33c05-1684">Concurrent readers access the table with a shared (S) lock and the weekly batch update accesses the table with an exclusive (X) lock.</span></span> <span data-ttu-id="33c05-1685">Al desactivar el bloqueo de página y fila en la tabla se reduce la sobrecarga de bloqueo durante la semana, ya que los lectores pueden tener acceso simultáneo a la tabla a través de bloqueos de tabla compartidos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1685">Turning off page and row locking on the table reduces the locking overhead throughout the week by allowing readers to concurrently access the table through shared table locks.</span></span> <span data-ttu-id="33c05-1686">Cuando se ejecuta el trabajo por lotes, este puede completar la actualización de forma eficaz porque obtiene un bloqueo de tabla exclusivo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1686">When the batch job runs, it can complete the update efficiently because it obtains an exclusive table lock.</span></span>  
  
 <span data-ttu-id="33c05-1687">La desactivación del bloqueo de página y fila podría o no ser aceptable, ya que la actualización por lotes semanal impedirá que los lectores simultáneos tengan acceso a la tabla mientras se ejecuta la actualización.</span><span class="sxs-lookup"><span data-stu-id="33c05-1687">Turning off page and row locking might or might not be acceptable because the weekly batch update will block the concurrent readers from accessing the table while the update runs.</span></span> <span data-ttu-id="33c05-1688">Si el trabajo por lotes solamente cambia unas cuantas filas o páginas, puede modificar el nivel de bloqueo para permitir el bloqueo de nivel de fila o página y, de esta forma, permitir que otras sesiones lean la tabla sin bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1688">If the batch job only changes a few rows or pages, you can change the locking level to allow row or page level locking, which will enable other sessions to read from the table without blocking.</span></span> <span data-ttu-id="33c05-1689">Si el trabajo por lotes tiene un gran número de actualizaciones, la obtención de un bloqueo exclusivo sobre la tabla puede ser la forma más eficaz de asegurarse de que el trabajo por lotes finaliza de modo eficaz.</span><span class="sxs-lookup"><span data-stu-id="33c05-1689">If the batch job has a large number of updates, obtaining an exclusive lock on the table may be the best way to ensure the batch job finishes efficiently.</span></span>  
  
 <span data-ttu-id="33c05-1690">En ocasiones se puede producir un interbloqueo si dos operaciones simultáneas adquieren bloqueos de fila en la misma tabla y se bloquean porque necesitan bloquear la página.</span><span class="sxs-lookup"><span data-stu-id="33c05-1690">Occasionally a deadlock occurs when two concurrent operations acquire row locks on the same table and then block because they both need to lock the page.</span></span> <span data-ttu-id="33c05-1691">Al impedir los bloqueos de fila se obliga a una de las operaciones a que espere y se evita el interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1691">Disallowing row locks forces one of the operations to wait, avoiding the deadlock.</span></span>  
  
 <span data-ttu-id="33c05-1692">La granularidad del bloqueo utilizado en un índice se puede establecer mediante las instrucciones CREATE INDEX y ALTER INDEX.</span><span class="sxs-lookup"><span data-stu-id="33c05-1692">The granularity of locking used on an index can be set using the CREATE INDEX and ALTER INDEX statements.</span></span> <span data-ttu-id="33c05-1693">La configuración del bloqueo se aplica a las páginas de índice y a las páginas de tabla.</span><span class="sxs-lookup"><span data-stu-id="33c05-1693">The lock settings apply to both the index pages and the table pages.</span></span> <span data-ttu-id="33c05-1694">Además, las instrucciones CREATE TABLE y ALTER TABLE se pueden utilizar para establecer la granularidad del bloqueo en las restricciones PRIMARY KEY y UNIQUE.</span><span class="sxs-lookup"><span data-stu-id="33c05-1694">In addition, the CREATE TABLE and ALTER TABLE statements can be used to set locking granularity on PRIMARY KEY and UNIQUE constraints.</span></span> <span data-ttu-id="33c05-1695">Por compatibilidad con versiones anteriores, el procedimiento almacenado del sistema **sp_indexoption** también puede establecer la granularidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-1695">For backwards compatibility, the **sp_indexoption** system stored procedure can also set the granularity.</span></span> <span data-ttu-id="33c05-1696">Para mostrar la opción de bloqueo actual de un determinado índice, utilice la función INDEXPROPERTY.</span><span class="sxs-lookup"><span data-stu-id="33c05-1696">To display the current locking option for a given index, use the INDEXPROPERTY function.</span></span> <span data-ttu-id="33c05-1697">Se pueden impedir los bloqueos de página, los de fila o una combinación de bloqueos de página y fila para un determinado índice.</span><span class="sxs-lookup"><span data-stu-id="33c05-1697">Page-level locks, row-level locks, or a combination of page-level and row-level locks can be disallowed for a given index.</span></span>  
  
|<span data-ttu-id="33c05-1698">Bloqueos no permitidos</span><span class="sxs-lookup"><span data-stu-id="33c05-1698">Disallowed locks</span></span>|<span data-ttu-id="33c05-1699">Tienen acceso al índice</span><span class="sxs-lookup"><span data-stu-id="33c05-1699">Index accessed by</span></span>|  
|----------------------|-----------------------|  
|<span data-ttu-id="33c05-1700">De página</span><span class="sxs-lookup"><span data-stu-id="33c05-1700">Page level</span></span>|<span data-ttu-id="33c05-1701">Bloqueos de fila y tabla</span><span class="sxs-lookup"><span data-stu-id="33c05-1701">Row-level and table-level locks</span></span>|  
|<span data-ttu-id="33c05-1702">De fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1702">Row level</span></span>|<span data-ttu-id="33c05-1703">Bloqueos de página y tabla</span><span class="sxs-lookup"><span data-stu-id="33c05-1703">Page-level and table-level locks</span></span>|  
|<span data-ttu-id="33c05-1704">De página y fila</span><span class="sxs-lookup"><span data-stu-id="33c05-1704">Page level and row level</span></span>|<span data-ttu-id="33c05-1705">Bloqueos de tabla</span><span class="sxs-lookup"><span data-stu-id="33c05-1705">Table-level locks</span></span>|  
  
 <span data-ttu-id="33c05-1706">![Icono de flecha usado con el vínculo volver al principio](media/uparrow16x16.gif "Icono de flecha usado con el vínculo Volver al principio") [de esta guía](#Top)</span><span class="sxs-lookup"><span data-stu-id="33c05-1706">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="advanced-transaction-information"></a><a name="Advanced"></a> <span data-ttu-id="33c05-1707">Información avanzada sobre transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-1707">Advanced Transaction Information</span></span>  
  
### <a name="nesting-transactions"></a><span data-ttu-id="33c05-1708">Anidar transacciones</span><span class="sxs-lookup"><span data-stu-id="33c05-1708">Nesting Transactions</span></span>  

 <span data-ttu-id="33c05-1709">Las transacciones explícitas se pueden anidar.</span><span class="sxs-lookup"><span data-stu-id="33c05-1709">Explicit transactions can be nested.</span></span> <span data-ttu-id="33c05-1710">El objetivo principal de esto es aceptar transacciones en procedimientos almacenados a los que se puede llamar desde un proceso que ya esté en una transacción o desde procesos que no tengan transacciones activas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1710">This is primarily intended to support transactions in stored procedures that can be called either from a process already in a transaction or from processes that have no active transaction.</span></span>  
  
 <span data-ttu-id="33c05-1711">En el ejemplo siguiente se muestra el uso para el que están diseñadas las transacciones anidadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1711">The following example shows the intended use of nested transactions.</span></span> <span data-ttu-id="33c05-1712">El procedimiento `TransProc` exige su transacción, sin tener en cuenta el modo de transacción del proceso que lo ejecute.</span><span class="sxs-lookup"><span data-stu-id="33c05-1712">The procedure `TransProc` enforces its transaction regardless of the transaction mode of any process that executes it.</span></span> <span data-ttu-id="33c05-1713">Si se llama a `TransProc` cuando una transacción está activa, la transacción anidada de `TransProc` se pasará por alto y se confirmarán o revertirán sus instrucciones INSERT basándose en la acción final adoptada para la transacción externa.</span><span class="sxs-lookup"><span data-stu-id="33c05-1713">If `TransProc` is called when a transaction is active, the nested transaction in `TransProc` is largely ignored, and its INSERT statements are committed or rolled back based on the final action taken for the outer transaction.</span></span> <span data-ttu-id="33c05-1714">Si un proceso que no tiene ninguna transacción pendiente ejecuta `TransProc`, la instrucción COMMIT TRANSACTION al final del procedimiento confirmará de manera efectiva las instrucciones INSERT.</span><span class="sxs-lookup"><span data-stu-id="33c05-1714">If `TransProc` is executed by a process that does not have an outstanding transaction, the COMMIT TRANSACTION at the end of the procedure effectively commits the INSERT statements.</span></span>  
  
```sql  
SET QUOTED_IDENTIFIER OFF;  
GO  
SET NOCOUNT OFF;  
GO  
CREATE TABLE TestTrans(Cola INT PRIMARY KEY,  
               Colb CHAR(3) NOT NULL);  
GO  
CREATE PROCEDURE TransProc @PriKey INT, @CharCol CHAR(3) AS  
BEGIN TRANSACTION InProc  
INSERT INTO TestTrans VALUES (@PriKey, @CharCol)  
INSERT INTO TestTrans VALUES (@PriKey + 1, @CharCol)  
COMMIT TRANSACTION InProc;  
GO  
/* Start a transaction and execute TransProc. */  
BEGIN TRANSACTION OutOfProc;  
GO  
EXEC TransProc 1, 'aaa';  
GO  
/* Roll back the outer transaction, this will  
   roll back TransProc's nested transaction. */  
ROLLBACK TRANSACTION OutOfProc;  
GO  
EXECUTE TransProc 3,'bbb';  
GO  
/* The following SELECT statement shows only rows 3 and 4 are   
   still in the table. This indicates that the commit  
   of the inner transaction from the first EXECUTE statement of  
   TransProc was overridden by the subsequent rollback. */  
SELECT * FROM TestTrans;  
GO  
```  
  
 <span data-ttu-id="33c05-1715">[!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] omite la confirmación de las transacciones internas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1715">Committing inner transactions is ignored by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="33c05-1716">La transacción se confirma o se revierte basándose en la acción realizada al final de la transacción más externa.</span><span class="sxs-lookup"><span data-stu-id="33c05-1716">The transaction is either committed or rolled back based on the action taken at the end of the outermost transaction.</span></span> <span data-ttu-id="33c05-1717">Si se confirma la transacción externa, también se confirmarán las transacciones anidadas internas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1717">If the outer transaction is committed, the inner nested transactions are also committed.</span></span> <span data-ttu-id="33c05-1718">Si se revierte la transacción externa, también se revertirán todas las transacciones internas, independientemente de si se confirmaron individualmente o no.</span><span class="sxs-lookup"><span data-stu-id="33c05-1718">If the outer transaction is rolled back, then all inner transactions are also rolled back, regardless of whether or not the inner transactions were individually committed.</span></span>  
  
 <span data-ttu-id="33c05-1719">Cada llamada a COMMIT TRANSACTION o COMMIT WORK se aplica a la última instrucción BEGIN TRANSACTION ejecutada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1719">Each call to COMMIT TRANSACTION or COMMIT WORK applies to the last executed BEGIN TRANSACTION.</span></span> <span data-ttu-id="33c05-1720">Si las instrucciones BEGIN TRANSACTION están anidadas, la instrucción COMMIT solo se aplica a la última transacción anidada, que es la más interna.</span><span class="sxs-lookup"><span data-stu-id="33c05-1720">If the BEGIN TRANSACTION statements are nested, then a COMMIT statement applies only to the last nested transaction, which is the innermost transaction.</span></span> <span data-ttu-id="33c05-1721">Aunque una instrucción COMMIT TRANSACTION *transaction_name* dentro de una transacción anidada haga referencia al nombre de transacción de la transacción externa, la confirmación se aplica solo a la transacción más interna.</span><span class="sxs-lookup"><span data-stu-id="33c05-1721">Even if a COMMIT TRANSACTION *transaction_name* statement within a nested transaction refers to the transaction name of the outer transaction, the commit applies only to the innermost transaction.</span></span>  
  
 <span data-ttu-id="33c05-1722">No es válido que el parámetro *transaction_name* de una instrucción ROLLBACK TRANSACTION haga referencia a las transacciones internas de un conjunto de transacciones anidadas con nombre.</span><span class="sxs-lookup"><span data-stu-id="33c05-1722">It is not legal for the *transaction_name* parameter of a ROLLBACK TRANSACTION statement to refer to the inner transactions of a set of named nested transactions.</span></span> <span data-ttu-id="33c05-1723">*transaction_name* solo puede hacer referencia al nombre de la transacción más externa.</span><span class="sxs-lookup"><span data-stu-id="33c05-1723">*transaction_name* can refer only to the transaction name of the outermost transaction.</span></span> <span data-ttu-id="33c05-1724">Si se ejecuta una instrucción ROLLBACK TRANSACTION *transaction_name* con el nombre de la transacción externa en cualquier nivel de un conjunto de transacciones anidadas, se revertirán todas las transacciones anidadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1724">If a ROLLBACK TRANSACTION *transaction_name* statement using the name of the outer transaction is executed at any level of a set of nested transactions, all of the nested transactions are rolled back.</span></span> <span data-ttu-id="33c05-1725">Si se ejecuta una instrucción ROLLBACK WORK o ROLLBACK TRANSACTION sin un parámetro *transaction_name* en cualquier nivel de un conjunto de transacciones anidadas, se revierten todas las transacciones anidadas, incluida la transacción más externa.</span><span class="sxs-lookup"><span data-stu-id="33c05-1725">If a ROLLBACK WORK or ROLLBACK TRANSACTION statement without a *transaction_name* parameter is executed at any level of a set of nested transaction, it rolls back all of the nested transactions, including the outermost transaction.</span></span>  
  
 <span data-ttu-id="33c05-1726">La @TRANCOUNT función @ registra el nivel de anidamiento de la transacción actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1726">The @@TRANCOUNT function records the current transaction nesting level.</span></span> <span data-ttu-id="33c05-1727">Cada instrucción BEGIN TRANSACTION incrementa @ @TRANCOUNT en uno.</span><span class="sxs-lookup"><span data-stu-id="33c05-1727">Each BEGIN TRANSACTION statement increments @@TRANCOUNT by one.</span></span> <span data-ttu-id="33c05-1728">Cada instrucción COMMIT TRANSACTION o COMMIT WORK disminuye @ @TRANCOUNT en uno.</span><span class="sxs-lookup"><span data-stu-id="33c05-1728">Each COMMIT TRANSACTION or COMMIT WORK statement decrements @@TRANCOUNT by one.</span></span> <span data-ttu-id="33c05-1729">Una instrucción ROLLBACK WORK o ROLLBACK TRANSACTION que no tenga un nombre de transacción revierte todas las transacciones anidadas y reduce @ @TRANCOUNT a 0.</span><span class="sxs-lookup"><span data-stu-id="33c05-1729">A ROLLBACK WORK or a ROLLBACK TRANSACTION statement that does not have a transaction name rolls back all nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="33c05-1730">Una instrucción ROLLBACK TRANSACTION que utiliza el nombre de transacción de la transacción más externa en un conjunto de transacciones anidadas revierte todas las transacciones anidadas y reduce @ @TRANCOUNT a 0.</span><span class="sxs-lookup"><span data-stu-id="33c05-1730">A ROLLBACK TRANSACTION that uses the transaction name of the outermost transaction in a set of nested transactions rolls back all of the nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="33c05-1731">Si no está seguro de si ya está en una transacción, seleccione @ @TRANCOUNT para determinar si es 1 o más.</span><span class="sxs-lookup"><span data-stu-id="33c05-1731">When you are unsure if you are already in a transaction, SELECT @@TRANCOUNT to determine if it is 1 or more.</span></span> <span data-ttu-id="33c05-1732">Si @ @TRANCOUNT es 0, no está en una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1732">If @@TRANCOUNT is 0, you are not in a transaction.</span></span>  
  
### <a name="using-bound-sessions"></a><span data-ttu-id="33c05-1733">Usar sesiones enlazadas</span><span class="sxs-lookup"><span data-stu-id="33c05-1733">Using Bound Sessions</span></span>  

 <span data-ttu-id="33c05-1734">Las sesiones enlazadas facilitan la coordinación de las acciones entre varias sesiones iniciadas en un mismo servidor.</span><span class="sxs-lookup"><span data-stu-id="33c05-1734">Bound sessions ease the coordination of actions across multiple sessions on the same server.</span></span> <span data-ttu-id="33c05-1735">Permiten que dos o más sesiones compartan la misma transacción y los mismos bloqueos, además de trabajar con los mismos datos sin que surjan conflictos de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1735">Bound sessions allow two or more sessions to share the same transaction and locks, and can work on the same data without lock conflicts.</span></span> <span data-ttu-id="33c05-1736">Se pueden crear sesiones enlazadas a partir de varias sesiones con la misma aplicación o desde varias aplicaciones con sesiones independientes.</span><span class="sxs-lookup"><span data-stu-id="33c05-1736">Bound sessions can be created from multiple sessions within the same application or from multiple applications with separate sessions.</span></span>  
  
 <span data-ttu-id="33c05-1737">Para participar en una sesión enlazada, una sesión llama a **sp_getbindtoken** o **srv_getbindtoken** (mediante Servicios abiertos de datos) para obtener un token de enlace.</span><span class="sxs-lookup"><span data-stu-id="33c05-1737">To participate in a bound session, a session calls **sp_getbindtoken** or **srv_getbindtoken** (through Open Data Services) to get a bind token.</span></span> <span data-ttu-id="33c05-1738">Un token de enlace es una cadena de caracteres que identifica de forma única cada transacción enlazada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1738">A bind token is a character string that uniquely identifies each bound transaction.</span></span> <span data-ttu-id="33c05-1739">El token de enlace se envía a las otras sesiones que se van a enlazar a la sesión actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1739">The bind token is then sent to the other sessions to be bound with the current session.</span></span> <span data-ttu-id="33c05-1740">Las demás sesiones se enlazan con la transacción llamando a **sp_bindsession** con el token de enlace recibido de la primera sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-1740">The other sessions bind to the transaction by calling **sp_bindsession**, using the bind token received from the first session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="33c05-1741">Una sesión debe tener una transacción de usuario activa para que **sp_getbindtoken** o **srv_getbindtoken** se realicen correctamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1741">A session must have an active user transaction in order for **sp_getbindtoken** or **srv_getbindtoken** to succeed.</span></span>  
  
 <span data-ttu-id="33c05-1742">Los tokens de enlace deben transmitirse desde el código de la aplicación que establece la primera sesión al código de la aplicación que enlaza posteriormente sus sesiones a la primera sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-1742">Bind tokens must be transmitted from the application code that makes the first session to the application code that subsequently binds their sessions to the first session.</span></span> <span data-ttu-id="33c05-1743">No existe ninguna una instrucción [!INCLUDE[tsql](../includes/tsql-md.md)] o función de API que pueda utilizar una aplicación para obtener el token de enlace de una transacción iniciada por otro proceso.</span><span class="sxs-lookup"><span data-stu-id="33c05-1743">There is no [!INCLUDE[tsql](../includes/tsql-md.md)] statement or API function that an application can use to get the bind token for a transaction started by another process.</span></span> <span data-ttu-id="33c05-1744">A continuación se indican algunos métodos que se pueden utilizar para transmitir un token de enlace:</span><span class="sxs-lookup"><span data-stu-id="33c05-1744">Some of the methods that can be used to transmit a bind token include the following:</span></span>  
  
-   <span data-ttu-id="33c05-1745">Si se han iniciado todas las sesiones desde el mismo proceso de aplicación, se pueden guardar los tokens de enlace en la memoria global, o bien se pueden pasar como un parámetro a las funciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1745">If the sessions are all initiated from the same application process, bind tokens can be stored in global memory or passed into functions as a parameter.</span></span>  
  
-   <span data-ttu-id="33c05-1746">Si se han establecido las sesiones desde procesos de aplicación independientes, los tokens de enlace se pueden transmitir mediante la comunicación entre procesos (IPC), como una llamada a un procedimiento remoto (RPC) o el intercambio dinámico de datos (DDE).</span><span class="sxs-lookup"><span data-stu-id="33c05-1746">If the sessions are made from separate application processes, bind tokens can be transmitted using interprocess communication (IPC), such as a remote procedure call (RPC) or dynamic data exchange (DDE).</span></span>  
  
-   <span data-ttu-id="33c05-1747">Los tokens de enlace se pueden guardar en una tabla de una instancia del [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] que puedan leer los procesos que deseen enlazar a la primera sesión.</span><span class="sxs-lookup"><span data-stu-id="33c05-1747">Bind tokens can be stored in a table in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] that can be read by processes wanting to bind to the first session.</span></span>  
  
 <span data-ttu-id="33c05-1748">Solo puede haber una sesión activa a la vez en un conjunto de sesiones enlazadas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1748">Only one session in a set of bound sessions can be active at any time.</span></span> <span data-ttu-id="33c05-1749">Si una sesión ejecuta una instrucción en la instancia o tiene resultados pendientes de la instancia, ninguna otra sesión enlazada podrá tener acceso a la instancia hasta que la sesión actual finalice el procesamiento o cancele la instrucción actual.</span><span class="sxs-lookup"><span data-stu-id="33c05-1749">If one session is executing a statement on the instance or has results pending from the instance, no other session bound to it can access the instance until the current session finishes processing or cancels the current statement.</span></span> <span data-ttu-id="33c05-1750">Si la instancia está ocupada procesando una instrucción de otra de las sesiones enlazadas, se producirá un error que indica que el espacio de la transacción está en uso y que la sesión debería volver a intentarlo más tarde.</span><span class="sxs-lookup"><span data-stu-id="33c05-1750">If the instance is busy processing a statement from another of the bound sessions, an error occurs indicating that the transaction space is in use and the session should retry later.</span></span>  
  
 <span data-ttu-id="33c05-1751">Cuando se enlazan sesiones, cada una de ellas mantiene su nivel de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="33c05-1751">When you bind sessions, each session retains its isolation level setting.</span></span> <span data-ttu-id="33c05-1752">Si se utiliza SET TRANSACTION ISOLATION LEVEL para cambiar el valor del nivel de aislamiento de una sesión, no se verán afectados los valores de las sesiones enlazadas a ella.</span><span class="sxs-lookup"><span data-stu-id="33c05-1752">Using SET TRANSACTION ISOLATION LEVEL to change the isolation level setting of one session does not affect the setting of any other session bound to it.</span></span>  
  
#### <a name="types-of-bound-sessions"></a><span data-ttu-id="33c05-1753">Tipos de sesiones enlazadas</span><span class="sxs-lookup"><span data-stu-id="33c05-1753">Types of Bound Sessions</span></span>  

 <span data-ttu-id="33c05-1754">Los dos tipos de sesiones enlazadas son local y distribuido.</span><span class="sxs-lookup"><span data-stu-id="33c05-1754">The two types of bound sessions are local and distributed.</span></span>  
  
-   <span data-ttu-id="33c05-1755">Sesión enlazada local</span><span class="sxs-lookup"><span data-stu-id="33c05-1755">Local bound session</span></span>  
  
     <span data-ttu-id="33c05-1756">Permite enlazar sesiones para compartir el espacio de transacciones de una sola transacción en una única instancia del [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="33c05-1756">Allows bound sessions to share the transaction space of a single transaction in a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span>  
  
-   <span data-ttu-id="33c05-1757">Sesión enlazada distribuida</span><span class="sxs-lookup"><span data-stu-id="33c05-1757">Distributed bound session</span></span>  
  
     <span data-ttu-id="33c05-1758">Permite que las sesiones enlazadas compartan la misma transacción entre dos o más instancias hasta que toda la transacción se haya confirmado o revertido mediante el Coordinador de transacciones distribuidas de [!INCLUDE[msCoName](../includes/msconame-md.md)] (MS DTC).</span><span class="sxs-lookup"><span data-stu-id="33c05-1758">Allows bound sessions to share the same transaction across two or more instances until the entire transaction is either committed or rolled back by using [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC).</span></span>  
  
 <span data-ttu-id="33c05-1759">Las sesiones enlazadas distribuidas no se identifican mediante el token de enlace de una cadena de caracteres, sino mediante números de identificación de transacciones distribuidas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1759">Distributed bound sessions are not identified by a character string bind token; they are identified by distributed transaction identification numbers.</span></span> <span data-ttu-id="33c05-1760">Si una sesión enlazada está implicada en un transacción local y ejecuta un RPC en un servidor remoto con SET REMOTE_PROC_TRANSACTIONS ON, MS DTC promueve automáticamente el nivel de la transacción enlazada local a transacción enlazada distribuida y se inicia una sesión de MS DTC.</span><span class="sxs-lookup"><span data-stu-id="33c05-1760">If a bound session is involved in a local transaction and executes an RPC on a remote server with SET REMOTE_PROC_TRANSACTIONS ON, the local bound transaction is automatically promoted to a distributed bound transaction by MS DTC and an MS DTC session is started.</span></span>  
  
#### <a name="when-to-use-bound-sessions"></a><span data-ttu-id="33c05-1761">Cuándo utilizar sesiones enlazadas</span><span class="sxs-lookup"><span data-stu-id="33c05-1761">When to Use Bound Sessions</span></span>  

 <span data-ttu-id="33c05-1762">En versiones anteriores de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], las sesiones enlazadas se utilizaban básicamente para desarrollar procedimientos almacenados extendidos que tenían que ejecutar instrucciones [!INCLUDE[tsql](../includes/tsql-md.md)] en nombre del proceso que los llamaba.</span><span class="sxs-lookup"><span data-stu-id="33c05-1762">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], bound sessions were primarily used in developing extended stored procedures that must execute [!INCLUDE[tsql](../includes/tsql-md.md)] statements on behalf of the process that calls them.</span></span> <span data-ttu-id="33c05-1763">Pasar el proceso que realiza la llamada en un token de enlace como un parámetro del procedimiento almacenado extendido permite al procedimiento combinar el espacio de transacciones del proceso que realiza la llamada y, por ello, integrar el procedimiento almacenado extendido con el proceso que realiza la llamada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1763">Having the calling process pass in a bind token as one parameter of the extended stored procedure allows the procedure to join the transaction space of the calling process, thereby integrating the extended stored procedure with the calling process.</span></span>  
  
 <span data-ttu-id="33c05-1764">En el [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], los procedimientos almacenados escritos mediante CLR son más seguros, escalables y estables que los procedimientos almacenados extendidos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1764">In the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], stored procedures written using CLR are more secure, scalable, and stable than extended stored procedures.</span></span> <span data-ttu-id="33c05-1765">Los procedimientos almacenados de CLR utilizan el objeto **SqlContext** para combinar el contexto de la sesión que realiza la llamada, no **sp_bindsession**.</span><span class="sxs-lookup"><span data-stu-id="33c05-1765">CLR-stored procedures use the **SqlContext** object to join the context of the calling session, not **sp_bindsession**.</span></span>  
  
 <span data-ttu-id="33c05-1766">Se pueden utilizar sesiones enlazadas para desarrollar aplicaciones de tres niveles en las que la lógica comercial se incorpora mediante programas independientes que funcionan en colaboración en una sola transacción comercial.</span><span class="sxs-lookup"><span data-stu-id="33c05-1766">Bound sessions can be used to develop three-tier applications in which business logic is incorporated into separate programs that work cooperatively on a single business transaction.</span></span> <span data-ttu-id="33c05-1767">Estos programas deben codificarse de forma que coordinen con precisión su acceso a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1767">These programs must be coded to carefully coordinate their access to a database.</span></span> <span data-ttu-id="33c05-1768">Dado que las dos sesiones comparten los mismos bloqueos, ambos programas deben evitar intentar modificar los mismos datos a la vez.</span><span class="sxs-lookup"><span data-stu-id="33c05-1768">Because the two sessions share the same locks, the two programs must not try to modify the same data at the same time.</span></span> <span data-ttu-id="33c05-1769">En cualquier momento solo puede haber una sesión que realice el trabajo como parte de la transacción. No se permiten ejecuciones en paralelo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1769">At any point in time, only one session can be doing work as part of the transaction; there can be no parallel execution.</span></span> <span data-ttu-id="33c05-1770">La transacción solo se puede cambiar entre sesiones y en puntos de rendimiento bien definidos, como el momento en que han finalizado todas las instrucciones DML y se han recuperado todos los resultados.</span><span class="sxs-lookup"><span data-stu-id="33c05-1770">The transaction can only be switched between sessions at well-defined yield points, such as when all DML statements have completed and their results have been retrieved.</span></span>  
  
### <a name="coding-efficient-transactions"></a><span data-ttu-id="33c05-1771">Codificar transacciones eficaces</span><span class="sxs-lookup"><span data-stu-id="33c05-1771">Coding Efficient Transactions</span></span>  

 <span data-ttu-id="33c05-1772">Es importante que las transacciones sean tan cortas como sea posible.</span><span class="sxs-lookup"><span data-stu-id="33c05-1772">It is important to keep transactions as short as possible.</span></span> <span data-ttu-id="33c05-1773">Cuando se inicia una transacción, un sistema de administración de bases de datos (DBMS) debe contener muchos recursos hasta el final de la transacción para proteger las propiedades de atomicidad, coherencia, aislamiento y durabilidad (ACID) de la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1773">When a transaction is started, a database management system (DBMS) must hold many resources until the end of the transaction to protect the atomicity, consistency, isolation, and durability (ACID) properties of the transaction.</span></span> <span data-ttu-id="33c05-1774">Si se modifican datos, se deben proteger las filas modificadas con bloqueos exclusivos que impidan que otra transacción lea las filas, y se deben mantener bloqueos exclusivos hasta que se confirme o se revierta la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1774">If data is modified, the modified rows must be protected with exclusive locks that prevent any other transaction from reading the rows, and exclusive locks must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="33c05-1775">Dependiendo de la configuración del nivel de aislamiento de la transacción, las instrucciones SELECT pueden adquirir bloqueos que deben mantenerse hasta que la transacción se confirme o se revierta.</span><span class="sxs-lookup"><span data-stu-id="33c05-1775">Depending on transaction isolation level settings, SELECT statements may acquire locks that must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="33c05-1776">Especialmente en sistemas con muchos usuarios, las transacciones deben ser tan cortas como sea posible para reducir el conflicto de bloqueos de recursos entre conexiones simultáneas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1776">Especially in systems with many users, transactions must be kept as short as possible to reduce locking contention for resources between concurrent connections.</span></span> <span data-ttu-id="33c05-1777">Es posible que las transacciones de larga duración y poco eficaces no constituyan un problema cuando hay un pequeño número de usuarios, pero son intolerables en sistemas con miles de usuarios.</span><span class="sxs-lookup"><span data-stu-id="33c05-1777">Long-running, inefficient transactions may not be a problem with small numbers of users, but they are intolerable in a system with thousands of users.</span></span> <span data-ttu-id="33c05-1778">A partir de [!INCLUDE[ssSQL14](../includes/sssql14-md.md)], [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] admite las transacciones durables diferidas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1778">Beginning with [!INCLUDE[ssSQL14](../includes/sssql14-md.md)][!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] supports delayed durable transactions.</span></span> <span data-ttu-id="33c05-1779">Las transacciones durables diferidas no garantizan la durabilidad.</span><span class="sxs-lookup"><span data-stu-id="33c05-1779">Delayed durable transactions do not guarantee durability.</span></span> <span data-ttu-id="33c05-1780">Vea el tema [Durabilidad de las transacciones](../relational-databases/logs/control-transaction-durability.md) para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="33c05-1780">See the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md) for more information.</span></span>  
  
#### <a name="coding-guidelines"></a><span data-ttu-id="33c05-1781">Instrucciones de codificación</span><span class="sxs-lookup"><span data-stu-id="33c05-1781">Coding Guidelines</span></span>  

 <span data-ttu-id="33c05-1782">A continuación se muestran las instrucciones para codificar transacciones eficaces:</span><span class="sxs-lookup"><span data-stu-id="33c05-1782">These are guidelines for coding efficient transactions:</span></span>  
  
-   <span data-ttu-id="33c05-1783">No pida entradas de los usuarios durante una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1783">Do not require input from users during a transaction.</span></span>  
  
     <span data-ttu-id="33c05-1784">Obtenga todas las entradas necesarias de los usuarios antes de iniciar la transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1784">Get all required input from users before a transaction is started.</span></span> <span data-ttu-id="33c05-1785">Si se necesita una entrada adicional del usuario durante una transacción, revierta la transacción actual y reinicie la transacción después de que el usuario proporcione la entrada.</span><span class="sxs-lookup"><span data-stu-id="33c05-1785">If additional user input is required during a transaction, roll back the current transaction and restart the transaction after the user input is supplied.</span></span> <span data-ttu-id="33c05-1786">Aunque los usuarios respondan inmediatamente, los tiempos de reacción de las personas son mucho menores que la velocidad del equipo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1786">Even if users respond immediately, human reaction times are vastly slower than computer speeds.</span></span> <span data-ttu-id="33c05-1787">Todos los recursos que mantiene la transacción se conservan durante un tiempo extremadamente largo que, en potencia, puede provocar problemas de bloqueos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1787">All resources held by the transaction are held for an extremely long time, which has the potential to cause blocking problems.</span></span> <span data-ttu-id="33c05-1788">Si los usuarios no responden, la transacción permanece activa y bloquea recursos críticos hasta que lo hagan, lo que puede tardar en suceder varios minutos o incluso horas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1788">If users do not respond, the transaction remains active, locking critical resources until they respond, which may not happen for several minutes or even hours.</span></span>  
  
-   <span data-ttu-id="33c05-1789">No abra una transacción mientras examina los datos si es posible.</span><span class="sxs-lookup"><span data-stu-id="33c05-1789">Do not open a transaction while browsing through data, if at all possible.</span></span>  
  
     <span data-ttu-id="33c05-1790">No puede iniciar las transacciones hasta que haya completado todos los análisis preliminares de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1790">Transactions should not be started until all preliminary data analysis has been completed.</span></span>  
  
-   <span data-ttu-id="33c05-1791">Haga la transacción lo más corta posible.</span><span class="sxs-lookup"><span data-stu-id="33c05-1791">Keep the transaction as short as possible.</span></span>  
  
     <span data-ttu-id="33c05-1792">Una vez que sepa las modificaciones que debe realizar, inicie una transacción, ejecute las instrucciones de modificación e, inmediatamente, confirme o revierta las operaciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1792">After you know the modifications that have to be made, start a transaction, execute the modification statements, and then immediately commit or roll back.</span></span> <span data-ttu-id="33c05-1793">No abra la transacción antes de que sea necesario.</span><span class="sxs-lookup"><span data-stu-id="33c05-1793">Do not open the transaction before it is required.</span></span>  
  
-   <span data-ttu-id="33c05-1794">Para reducir el bloqueo, considere la posibilidad de utilizar un nivel de aislamiento basado en versiones de fila para las consultas de solo lectura.</span><span class="sxs-lookup"><span data-stu-id="33c05-1794">To reduce blocking, consider using a row versioning-based isolation level for read-only queries.</span></span>  
  
-   <span data-ttu-id="33c05-1795">Haga un uso inteligente de los niveles más bajos de aislamiento de las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1795">Make intelligent use of lower transaction isolation levels.</span></span>  
  
     <span data-ttu-id="33c05-1796">Se pueden codificar rápidamente muchas aplicaciones para que utilicen un nivel de aislamiento de lectura confirmada de las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1796">Many applications can be readily coded to use a read-committed transaction isolation level.</span></span> <span data-ttu-id="33c05-1797">No todas las transacciones necesitan el nivel de aislamiento serializable de las transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1797">Not all transactions require the serializable transaction isolation level.</span></span>  
  
-   <span data-ttu-id="33c05-1798">Haga un uso inteligente de las opciones de simultaneidad más bajas de los cursores, como las opciones de simultaneidad optimista.</span><span class="sxs-lookup"><span data-stu-id="33c05-1798">Make intelligent use of lower cursor concurrency options, such as optimistic concurrency options.</span></span>  
  
     <span data-ttu-id="33c05-1799">En un sistema que tenga pocas probabilidades de que se produzcan actualizaciones simultáneas, la sobrecarga que produce encontrar el error ocasional "alguien cambió los datos después de su lectura" puede ser mucho menor que la sobrecarga que produce bloquear siempre las filas a medida que se leen.</span><span class="sxs-lookup"><span data-stu-id="33c05-1799">In a system with a low probability of concurrent updates, the overhead of dealing with an occasional "somebody else changed your data after you read it" error can be much lower than the overhead of always locking rows as they are read.</span></span>  
  
-   <span data-ttu-id="33c05-1800">Tenga acceso a la menor cantidad de datos posible en una transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1800">Access the least amount of data possible while in a transaction.</span></span>  
  
     <span data-ttu-id="33c05-1801">Así reduce el número de filas bloqueadas y, por lo tanto, disminuye el conflicto entre transacciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1801">This lessens the number of locked rows, thereby reducing contention between transactions.</span></span>  
  
#### <a name="avoiding-concurrency-and-resource-problems"></a><span data-ttu-id="33c05-1802">Evitar problemas de simultaneidad y de recursos</span><span class="sxs-lookup"><span data-stu-id="33c05-1802">Avoiding Concurrency and Resource Problems</span></span>  

 <span data-ttu-id="33c05-1803">Para evitar los problemas de simultaneidad y de recursos, administre cuidadosamente las transacciones implícitas.</span><span class="sxs-lookup"><span data-stu-id="33c05-1803">To prevent concurrency and resource problems, manage implicit transactions carefully.</span></span> <span data-ttu-id="33c05-1804">Cuando utilice transacciones implícitas, la siguiente instrucción [!INCLUDE[tsql](../includes/tsql-md.md)] después de COMMIT o ROLLBACK inicia automáticamente una nueva transacción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1804">When using implicit transactions, the next [!INCLUDE[tsql](../includes/tsql-md.md)] statement after COMMIT or ROLLBACK automatically starts a new transaction.</span></span> <span data-ttu-id="33c05-1805">Esto puede hacer que se abra una nueva transacción mientras la aplicación examina los datos o, incluso, cuando pide una entrada del usuario.</span><span class="sxs-lookup"><span data-stu-id="33c05-1805">This can cause a new transaction to be opened while the application browses through data, or even when it requires input from the user.</span></span> <span data-ttu-id="33c05-1806">Tras concluir la última transacción necesaria para proteger las modificaciones de los datos, desactive las transacciones implícitas hasta que se necesite de nuevo una transacción para proteger las modificaciones de los datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1806">After completing the last transaction required to protect data modifications, turn off implicit transactions until a transaction is once again required to protect data modifications.</span></span> <span data-ttu-id="33c05-1807">Este proceso permite que el [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utilice el modo de confirmación automática mientras la aplicación examina los datos y obtiene la entrada del usuario.</span><span class="sxs-lookup"><span data-stu-id="33c05-1807">This process lets the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] use autocommit mode while the application is browsing data and getting input from the user.</span></span>  
  
 <span data-ttu-id="33c05-1808">Además, cuando el nivel de aislamiento de instantánea está habilitado, aunque una transacción nueva no mantenga bloqueos, una transacción de larga duración impedirá que las versiones anteriores se eliminen de `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="33c05-1808">In addition, when the snapshot isolation level is enabled, although a new transaction will not hold locks, a long-running transaction will prevent the old versions from being removed from `tempdb`.</span></span>  
  
### <a name="managing-long-running-transactions"></a><span data-ttu-id="33c05-1809">Administrar las transacciones de ejecución prolongada</span><span class="sxs-lookup"><span data-stu-id="33c05-1809">Managing Long-Running Transactions</span></span>  

 <span data-ttu-id="33c05-1810">Una *transacción de larga duración* es una transacción activa que no se ha confirmado ni revertido puntualmente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1810">A *long-running transaction* is an active transaction that has not been committed or roll backed the transaction in a timely manner.</span></span> <span data-ttu-id="33c05-1811">Por ejemplo, si el usuario controla el inicio y la finalización de una transacción, una causa frecuente de las transacciones de ejecución prolongada es que un usuario inicie una transacción y se ausente mientras la transacción queda en espera de una respuesta suya.</span><span class="sxs-lookup"><span data-stu-id="33c05-1811">For example, if the beginning and end of a transaction is controlled by the user, a typical cause of a long-running transaction is a user starting a transaction and then leaving while the transaction waits for a response from the user.</span></span>  
  
 <span data-ttu-id="33c05-1812">Una transacción de larga duración puede provocar graves problemas para una base de datos de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="33c05-1812">A long running transaction can cause serious problems for a database, as follows:</span></span>  
  
-   <span data-ttu-id="33c05-1813">Si se cierra una instancia de servidor después de que una transacción activa haya realizado muchas modificaciones no confirmadas, la fase de recuperación del siguiente reinicio puede tardar mucho más que el tiempo especificado por la opción de configuración del servidor **Recovery Interval** o la instrucción ALTER DATABASE... ESTABLEZCA TARGET_RECOVERY_TIME opción.</span><span class="sxs-lookup"><span data-stu-id="33c05-1813">If a server instance is shut down after an active transaction has performed many uncommitted modifications, the recovery phase of the subsequent restart can take much longer than the time specified by the **recovery interval** server configuration option or by the ALTER DATABASE... SET TARGET_RECOVERY_TIME option.</span></span> <span data-ttu-id="33c05-1814">Estas opciones controlan la frecuencia de puntos de comprobación activos e indirectos, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="33c05-1814">These options control the frequency of active and indirect checkpoints, respectively.</span></span> <span data-ttu-id="33c05-1815">Para obtener más información sobre los tipos de puntos de comprobación, consulte [Puntos de comprobación de base de datos &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="33c05-1815">For more information about the types of checkpoints, see [Database Checkpoints &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span></span>  
  
-   <span data-ttu-id="33c05-1816">Y, lo que es más importante, aunque la transacción en espera genere muy poco registro, la transacción retiene el truncamiento del registro de manera indefinida y provoca el excesivo crecimiento y llenado del mismo.</span><span class="sxs-lookup"><span data-stu-id="33c05-1816">More importantly, although a waiting transaction might generate very little log, it holds up log truncation indefinitely, causing the transaction log to grow and possibly fill up.</span></span> <span data-ttu-id="33c05-1817">Si el registro de la transacción se llena, la base de datos no puede realizar más actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="33c05-1817">If the transaction log fills up, the database cannot perform any more updates.</span></span> <span data-ttu-id="33c05-1818">Para obtener más información, vea [solucionar problemas de un registro de transacciones lleno &#40;SQL Server Error 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md), así como [el registro de transacciones &#40;SQL Server ](../relational-databases/logs/the-transaction-log-sql-server.md)&#41;.</span><span class="sxs-lookup"><span data-stu-id="33c05-1818">For more information, see [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md), and [The Transaction Log &#40;SQL Server&#41;](../relational-databases/logs/the-transaction-log-sql-server.md).</span></span>  
  
#### <a name="discovering-long-running-transactions"></a><span data-ttu-id="33c05-1819">Descubrir transacciones de ejecución prolongada</span><span class="sxs-lookup"><span data-stu-id="33c05-1819">Discovering Long-Running Transactions</span></span>  

 <span data-ttu-id="33c05-1820">Para buscar las transacciones de ejecución prolongada, use una de las opciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="33c05-1820">To look for long-running transactions, use one of the following:</span></span>  
  
-   <span data-ttu-id="33c05-1821">**sys.dm_tran_database_transactions**</span><span class="sxs-lookup"><span data-stu-id="33c05-1821">**sys.dm_tran_database_transactions**</span></span>  
  
     <span data-ttu-id="33c05-1822">Esta vista de administración dinámica devuelve información sobre las transacciones en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1822">This dynamic management view returns information about transactions at the database level.</span></span> <span data-ttu-id="33c05-1823">En una transacción de ejecución prolongada, las columnas de especial interés incluyen la hora de la primera entrada del registro (**database_transaction_begin_time**), el estado actual de la transacción (**database_transaction_state**) y el número de flujo de registro (LSN) del registro inicial del registro de transacciones (**database_transaction_begin_lsn**).</span><span class="sxs-lookup"><span data-stu-id="33c05-1823">For a long-running transaction, columns of particular interest include the time of the first log record (**database_transaction_begin_time**), the current state of the transaction (**database_transaction_state**), and the log sequence number (LSN) of the begin record in the transaction log (**database_transaction_begin_lsn**).</span></span>  
  
     <span data-ttu-id="33c05-1824">Para obtener más información, consulte [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1824">For more information, see [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span></span>  
  
-   <span data-ttu-id="33c05-1825">DBCC OPENTRAN</span><span class="sxs-lookup"><span data-stu-id="33c05-1825">DBCC OPENTRAN</span></span>  
  
     <span data-ttu-id="33c05-1826">Esta instrucción permite identificar el Id. de usuario del propietario de la transacción, por lo que se puede realizar un seguimiento del origen de la misma para terminarla de forma más ordenada (confirmándola en lugar de revirtiéndola).</span><span class="sxs-lookup"><span data-stu-id="33c05-1826">This statement lets you identify the user ID of the owner of the transaction, so you can potentially track down the source of the transaction for a more orderly termination (committing it rather than rolling it back).</span></span> <span data-ttu-id="33c05-1827">Para obtener más información, vea [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1827">For more information, see [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span></span>  
  
#### <a name="stopping-a-transaction"></a><span data-ttu-id="33c05-1828">Detener una transacción</span><span class="sxs-lookup"><span data-stu-id="33c05-1828">Stopping a Transaction</span></span>  

 <span data-ttu-id="33c05-1829">Puede que deba utilizar la instrucción KILL.</span><span class="sxs-lookup"><span data-stu-id="33c05-1829">You may have to use the KILL statement.</span></span> <span data-ttu-id="33c05-1830">Sin embargo, utilice esta instrucción con sumo cuidado, especialmente cuando se estén ejecutando procesos críticos.</span><span class="sxs-lookup"><span data-stu-id="33c05-1830">Use this statement very carefully, however, especially when critical processes are running.</span></span> <span data-ttu-id="33c05-1831">Para obtener más información, consulte [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="33c05-1831">For more information, see [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span></span>  
  
 <span data-ttu-id="33c05-1832">![Icono de flecha usado con el vínculo volver al principio](media/uparrow16x16.gif "Icono de flecha usado con el vínculo Volver al principio") [de esta guía](#Top)</span><span class="sxs-lookup"><span data-stu-id="33c05-1832">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="33c05-1833">Consulte también</span><span class="sxs-lookup"><span data-stu-id="33c05-1833">See Also</span></span>  

 <span data-ttu-id="33c05-1834">[Aislamiento de transacción basado en versiones de fila de SQL Server 2005](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span><span class="sxs-lookup"><span data-stu-id="33c05-1834">[SQL Server 2005 Row Versioning-Based Transaction Isolation](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span></span>  
 <span data-ttu-id="33c05-1835">[Overhead of Row Versioning](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx)  (Sobrecarga de las versiones de fila)</span><span class="sxs-lookup"><span data-stu-id="33c05-1835">[Overhead of Row Versioning](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span></span>  
 [<span data-ttu-id="33c05-1836">Cómo crear una transacción autónoma en SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="33c05-1836">How to create an autonomous transaction in SQL Server 2008</span></span>](https://blogs.msdn.com/b/sqlprogrammability/archive/2008/08/22/how-to-create-an-autonomous-transaction-in-sql-server-2008.aspx)  
  
  
