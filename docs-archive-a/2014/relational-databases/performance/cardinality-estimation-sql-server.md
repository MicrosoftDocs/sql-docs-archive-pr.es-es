---
title: Estimación de cardinalidad (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 11/24/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- cardinality estimator
- CE (cardinality estimator)
- estimating cardinality
ms.assetid: baa8a304-5713-4cfe-a699-345e819ce6df
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: aa56127f649d71bfcc8825322f8bf729175d41df
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/04/2020
ms.locfileid: "87677612"
---
# <a name="cardinality-estimation-sql-server"></a><span data-ttu-id="858e9-102">Estimación de cardinalidad (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="858e9-102">Cardinality Estimation (SQL Server)</span></span>
  <span data-ttu-id="858e9-103">La lógica de estimación de la cardinalidad, denominada estimador de cardinalidad, se ha rediseñado en [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] para mejorar la calidad de los planes de consulta y, por tanto, mejorar el rendimiento de las consultas.</span><span class="sxs-lookup"><span data-stu-id="858e9-103">The cardinality estimation logic, called the cardinality estimator, is re-designed in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] to improve the quality of query plans, and therefore to improve query performance.</span></span> <span data-ttu-id="858e9-104">El nuevo estimador de cardinalidad incorpora suposiciones y algoritmos que funcionan bien en las cargas de trabajo OLTP y de almacenamiento de datos modernas.</span><span class="sxs-lookup"><span data-stu-id="858e9-104">The new cardinality estimator incorporates assumptions and algorithms that work well on modern OLTP and data warehousing workloads.</span></span> <span data-ttu-id="858e9-105">Se basa en un profundo estudio sobre la estimación de cardinalidad en las cargas de trabajo modernas y en lo que hemos aprendido durante los últimos 15 años para mejorar el estimador de cardinalidad de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="858e9-105">It is based on in-depth cardinality estimation research on modern workloads, and our learnings over the past 15 years of improving the SQL Server cardinality estimator.</span></span> <span data-ttu-id="858e9-106">Los comentarios de los clientes indican que si bien la mayoría de las consultas se beneficiarán del cambio o no cambiarán, un número reducido puede mostrar regresiones en comparación con el estimador de cardinalidad anterior.</span><span class="sxs-lookup"><span data-stu-id="858e9-106">Feedback from customers shows that while most queries will benefit from the change or remain unchanged, a small number might show regressions compared to the previous cardinality estimator.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="858e9-107">Las estimaciones de cardinalidad son una predicción del número de filas del resultado de la consulta.</span><span class="sxs-lookup"><span data-stu-id="858e9-107">Cardinality estimates are a prediction of the number of rows in the query result.</span></span> <span data-ttu-id="858e9-108">El optimizador de consultas utiliza estas estimaciones a la hora de elegir un plan para ejecutar la consulta.</span><span class="sxs-lookup"><span data-stu-id="858e9-108">The query optimizer uses these estimates to choose a plan for executing the query.</span></span> <span data-ttu-id="858e9-109">La calidad del plan de consulta tiene un impacto directo sobre la mejora del rendimiento de las consultas.</span><span class="sxs-lookup"><span data-stu-id="858e9-109">The quality of the query plan has a direct impact on improving query performance.</span></span>  
  
## <a name="performance-testing-and-tuning-recommendations"></a><span data-ttu-id="858e9-110">Recomendaciones sobre las pruebas y la optimización del rendimiento</span><span class="sxs-lookup"><span data-stu-id="858e9-110">Performance Testing and Tuning Recommendations</span></span>  
 <span data-ttu-id="858e9-111">El nuevo estimador de cardinalidad está habilitado para todas las bases de datos nuevas creadas en [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span><span class="sxs-lookup"><span data-stu-id="858e9-111">The new cardinality estimator is enabled for all new databases created in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span></span> <span data-ttu-id="858e9-112">Sin embargo, la actualización a [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] no habilita el nuevo estimador de cardinalidad en las bases de datos existentes.</span><span class="sxs-lookup"><span data-stu-id="858e9-112">However, upgrading to [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] does not enable the new cardinality estimator on existing databases.</span></span>  
  
 <span data-ttu-id="858e9-113">Para garantizar el máximo rendimiento de las consultas, siga estas recomendaciones para probar la carga de trabajo con el nuevo estimador de cardinalidad antes de habilitarlo en el sistema de producción.</span><span class="sxs-lookup"><span data-stu-id="858e9-113">To ensure the best query performance, use these recommendations to test your workload with the new cardinality estimator before enabling it on your production system.</span></span>  
  
1.  <span data-ttu-id="858e9-114">Actualice todas las bases de datos existentes para que utilicen el nuevo estimador de cardinalidad.</span><span class="sxs-lookup"><span data-stu-id="858e9-114">Upgrade all existing databases to use the new cardinality estimator.</span></span> <span data-ttu-id="858e9-115">Para ello, use el [nivel de compatibilidad de Alter database &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) para establecer el nivel de compatibilidad de la base de datos en 120.</span><span class="sxs-lookup"><span data-stu-id="858e9-115">To do this, use [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 120.</span></span>  
  
2.  <span data-ttu-id="858e9-116">Ejecute la carga de trabajo de prueba con el nuevo estimador de cardinalidad y solucione cualquier problema nuevo de rendimiento del mismo modo que lo hace ahora.</span><span class="sxs-lookup"><span data-stu-id="858e9-116">Run your test workload with the new cardinality estimator, and then troubleshoot any new performance issues in the same manner you currently troubleshoot performance issues.</span></span>  
  
3.  <span data-ttu-id="858e9-117">Una vez que la carga de trabajo se está ejecutando con el nuevo estimador de cardinalidad (nivel de compatibilidad de la base de datos 120 [SQL Server 2014]) y se ha realizado la regresión de una consulta concreta, puede ejecutar la consulta con la marca de seguimiento 9481 para usar la versión del estimador de cardinalidad utilizada en [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] y versiones anteriores.</span><span class="sxs-lookup"><span data-stu-id="858e9-117">Once your workload is running with the new cardinality estimator (database compatibility level 120 (SQL Server 2014)), and a specific query has regressed, you can run the query with trace flag 9481 to use the version of the cardinality estimator used in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] and earlier.</span></span> <span data-ttu-id="858e9-118">Para ejecutar una consulta con una marca de seguimiento, vea el artículo de KB [Habilitar el plan afecta al comportamiento del optimizador de consultas de SQL Server, que se puede controlar mediante distintas marcas de seguimiento en un nivel de consulta específico](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="858e9-118">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
4.  <span data-ttu-id="858e9-119">Si no puede cambiar todas las bases de datos a la vez para usar el nuevo estimador de cardinalidad, puede usar el estimador de cardinalidad anterior para todas las bases de datos mediante el [nivel de compatibilidad de Alter database &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) para establecer el nivel de compatibilidad de la base de datos en 110.</span><span class="sxs-lookup"><span data-stu-id="858e9-119">If you cannot change all of the databases at once to use the new cardinality estimator, you can use the former cardinality estimator for all databases by using [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 110.</span></span>  
  
5.  <span data-ttu-id="858e9-120">Si la carga de trabajo se está ejecutando con el nivel de compatibilidad de base de datos 110 y desea probar o ejecutar una consulta concreta con el nuevo estimador de cardinalidad, puede ejecutar la consulta con la marca de seguimiento 2312 para utilizar la versión de SQL Server 2014 del estimador de cardinalidad.</span><span class="sxs-lookup"><span data-stu-id="858e9-120">If your workload is running with database compatibility level 110 and you want to test or run a specific query with the new cardinality estimator, you can run the query with trace flag 2312 to use the SQL Server 2014 version of the cardinality estimator.</span></span>  <span data-ttu-id="858e9-121">Para ejecutar una consulta con una marca de seguimiento, vea el artículo de KB [Habilitar el plan afecta al comportamiento del optimizador de consultas de SQL Server, que se puede controlar mediante distintas marcas de seguimiento en un nivel de consulta específico](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="858e9-121">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
## <a name="new-xevents"></a><span data-ttu-id="858e9-122">Nuevos XEvents</span><span class="sxs-lookup"><span data-stu-id="858e9-122">New XEvents</span></span>  
 <span data-ttu-id="858e9-123">Hay dos nuevos XEvents query_optimizer_estimate_cardinality para admitir los nuevos planes de consulta.</span><span class="sxs-lookup"><span data-stu-id="858e9-123">There are two new query_optimizer_estimate_cardinality XEvents to support the new query plans.</span></span>  
  
-   <span data-ttu-id="858e9-124">*query_optimizer_estimate_cardinality* se produce cuando el optimizador de consultas calcula la cardinalidad de una expresión relacional.</span><span class="sxs-lookup"><span data-stu-id="858e9-124">*query_optimizer_estimate_cardinality* occurs when the query optimizer estimates the cardinality on a relational expression.</span></span>  
  
-   <span data-ttu-id="858e9-125">*query_optimizer_force_both_cardinality_estimation*_behaviors se produce cuando están habilitadas las marcas de seguimiento 2312 y 9481, intentando forzar el comportamiento anterior y nuevo de la estimación de cardinalidad al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="858e9-125">*query_optimizer_force_both_cardinality_estimation*_behaviors occurs when both traceflags 2312 and 9481 are enabled, attempting to force both old and new cardinality estimation behavior at the same time.</span></span>  
  
## <a name="examples"></a><span data-ttu-id="858e9-126">Ejemplos</span><span class="sxs-lookup"><span data-stu-id="858e9-126">Examples</span></span>  
 <span data-ttu-id="858e9-127">En los ejemplos siguientes se muestran algunos cambios en las nuevas estimaciones de cardinalidad.</span><span class="sxs-lookup"><span data-stu-id="858e9-127">The following examples show some of the changes in the new cardinality estimates.</span></span> <span data-ttu-id="858e9-128">Se ha vuelto a escribir el código para estimar la cardinalidad.</span><span class="sxs-lookup"><span data-stu-id="858e9-128">The code for estimating cardinality has been rewritten.</span></span> <span data-ttu-id="858e9-129">La lógica es compleja y no es posible proporcionar una lista exhaustiva de todos los cambios.</span><span class="sxs-lookup"><span data-stu-id="858e9-129">The logic is complex and it is not possible to provide an exhaustive list of all changes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="858e9-130">Estos ejemplos se proporcionan como información conceptual.</span><span class="sxs-lookup"><span data-stu-id="858e9-130">These examples are provided as conceptual information.</span></span> <span data-ttu-id="858e9-131">No se requiere ninguna acción por su parte para cambiar la manera de diseñar las bases de datos y las consultas.</span><span class="sxs-lookup"><span data-stu-id="858e9-131">No action is required on your part to change the way you design databases and queries.</span></span>  
  
### <a name="example-a-new-cardinality-estimates-use-an-average-cardinality-for-recently-added-ascending-data"></a><span data-ttu-id="858e9-132">Ejemplo A. Las nuevas estimaciones de cardinalidad utilizan una cardinalidad promedio para los datos ascendentes recién agregados.</span><span class="sxs-lookup"><span data-stu-id="858e9-132">Example A. New cardinality estimates use an average cardinality for recently added ascending data</span></span>  
 <span data-ttu-id="858e9-133">En este ejemplo se muestra cómo el nuevo estimador de cardinalidad puede mejorar las estimaciones de cardinalidad para los datos ascendentes que superan el valor máximo de la tabla durante la actualización de estadísticas más reciente.</span><span class="sxs-lookup"><span data-stu-id="858e9-133">This example demonstrates how the new cardinality estimator can improve cardinality estimates for ascending data that exceeds the maximum value in the table during the most recent statistics update.</span></span>  
  
```  
SELECT item, category, amount FROM dbo.Sales AS s WHERE Date = '2013-12-19';  
```  
  
 <span data-ttu-id="858e9-134">En este ejemplo, se agregan nuevas filas a la tabla Sales cada día, la consulta solicita las ventas realizadas el 19/12/2013 y las estadísticas se actualizaron por última vez el 18/12/2013.</span><span class="sxs-lookup"><span data-stu-id="858e9-134">In this example, new rows are added to the Sales table each day, the query asks for sales that occurred on 12/19/2013, and statistics were last updated on 12/18/2013.</span></span> <span data-ttu-id="858e9-135">El estimador de cardinalidad anterior supone que los valores de 19/12/2013 no existen porque la fecha supera la fecha máxima y las estadísticas no se han actualizado para incluir los valores de 19/12/2013.</span><span class="sxs-lookup"><span data-stu-id="858e9-135">The previous cardinality estimator assumes the 12/19/2013 values do not exist since the date exceeds the maximum date and statistics have not been updated to include the 12/19/2013 values.</span></span> <span data-ttu-id="858e9-136">Esta situación, conocida como el problema de clave ascendente, se producirá si carga datos durante el día y ejecuta consultas en los datos antes de que se actualicen las estadísticas.</span><span class="sxs-lookup"><span data-stu-id="858e9-136">This situation, known as the ascending key problem, will occur if you load data during the day, and then run queries against the data before statistics are updated.</span></span>  
  
 <span data-ttu-id="858e9-137">Este comportamiento ha cambiado.</span><span class="sxs-lookup"><span data-stu-id="858e9-137">This behavior has changed.</span></span> <span data-ttu-id="858e9-138">Ahora, incluso aunque no se hayan actualizado las estadísticas para los datos ascendentes más recientes que se agregan desde la última actualización de las estadísticas, el nuevo estimador de cardinalidad supone que existen los valores y utiliza la cardinalidad promedio para cada valor de la columna como la estimación de cardinalidad.</span><span class="sxs-lookup"><span data-stu-id="858e9-138">Now, even if statistics have not been updated for the most recent ascending data that is added since the last statistics update, the new cardinality estimator assumes the values exist and uses the average cardinality for each value in the column as the cardinality estimate.</span></span>  
  
### <a name="example-b-new-cardinality-estimates-assume-filtered-predicates-on-the-same-table-have-some-correlation"></a><span data-ttu-id="858e9-139">Ejemplo B. Las nuevas estimaciones de cardinalidad suponen que los predicados filtrados en la misma tabla tienen alguna correlación.</span><span class="sxs-lookup"><span data-stu-id="858e9-139">Example B. New cardinality estimates assume filtered predicates on the same table have some correlation</span></span>  
 <span data-ttu-id="858e9-140">En este ejemplo, suponga que la tabla Cars tiene 1000 filas, Make tiene 200 coincidencias de 'Honda', Model tiene 50 coincidencias de 'Civic' y que todos los Civics son Honda.</span><span class="sxs-lookup"><span data-stu-id="858e9-140">For this example, assume the table Cars as 1000 rows, Make has 200 matches for 'Honda', Model has 50 matches for 'Civic', and that all of the Civics are Hondas.</span></span> <span data-ttu-id="858e9-141">Por tanto, el 20 % de los valores de la columna Make son 'Honda', el 5 % de los valores de la columna Model son 'Civic' y el número real de Honda Civics es 50.</span><span class="sxs-lookup"><span data-stu-id="858e9-141">Therefore, 20% of the values in the Make column are 'Honda', 5% of the values in the Model column are 'Civic', and the actual number of Honda Civics is 50.</span></span> <span data-ttu-id="858e9-142">Las estimaciones de cardinalidad anteriores suponen que los valores de las columnas Make y Model son independientes unos de otros.</span><span class="sxs-lookup"><span data-stu-id="858e9-142">The previous cardinality estimates assume the values in the Make and the Model columns are independent of each other.</span></span> <span data-ttu-id="858e9-143">El optimizador de consultas anterior estima que hay 10 Honda cívica (. 05 \* 20 \* 1000 Rows = 10 filas).</span><span class="sxs-lookup"><span data-stu-id="858e9-143">The previous query optimizer estimates there are 10 Honda Civics (.05 \* .20 \* 1000 rows = 10 rows).</span></span>  
  
```  
SELECT year, purchase_price FROM dbo.Cars WHERE Make = 'Honda' AND Model = 'Civic';  
```  
  
 <span data-ttu-id="858e9-144">Este comportamiento ha cambiado.</span><span class="sxs-lookup"><span data-stu-id="858e9-144">This behavior has changed.</span></span> <span data-ttu-id="858e9-145">Ahora, las nuevas estimaciones de cardinalidad suponen que las columnas Make y Model tienen *alguna* correlación.</span><span class="sxs-lookup"><span data-stu-id="858e9-145">Now, the new cardinality estimates assume the Make and Model columns have *some* correlation.</span></span> <span data-ttu-id="858e9-146">El optimizador de consultas estima una cardinalidad mayor al agregar un componente exponencial a la ecuación de estimación.</span><span class="sxs-lookup"><span data-stu-id="858e9-146">The query optimizer estimates a higher cardinality by adding an exponential component to the estimation equation.</span></span> <span data-ttu-id="858e9-147">Ahora, el optimizador de consultas estima que 22,36 filas (0,05 \* SQRT (. 20) \* 1000 filas = 22,36 filas) coinciden con el predicado.</span><span class="sxs-lookup"><span data-stu-id="858e9-147">The query optimizer now estimates that 22.36 rows ( .05 \* SQRT(.20) \* 1000 rows = 22.36 rows ) match the predicate.</span></span> <span data-ttu-id="858e9-148">En este escenario y en esta distribución de datos específica, 22,36 filas es un valor más cercano a las 50 filas reales que devolverá la consulta.</span><span class="sxs-lookup"><span data-stu-id="858e9-148">For this scenario and specific data distribution, 22.36 rows is closer to the actual 50 rows that the query will return.</span></span>  
  
 <span data-ttu-id="858e9-149">Tenga en cuenta que la nueva lógica del estimador de cardinalidad ordena las selectividades de predicado y aumenta el exponente.</span><span class="sxs-lookup"><span data-stu-id="858e9-149">Note, the new cardinality estimator logic sorts the predicate selectivities and increases the exponent.</span></span> <span data-ttu-id="858e9-150">Por ejemplo, si el predicado selectividades fueran era 0,05, 20 y 0,25, la estimación de cardinalidad sería (. 05 \* SQRT (. 20) \* sqrt (sqrt (. 25))).</span><span class="sxs-lookup"><span data-stu-id="858e9-150">For example, if the predicate selectivities were .05, .20, and .25, the cardinality estimate would be (.05 \* SQRT(.20) \* SQRT(SQRT(.25)) ).</span></span>  
  
### <a name="example-c-new-cardinality-estimates-assume-filtered-predicates-on-different-tables-are-independent"></a><span data-ttu-id="858e9-151">Ejemplo C. Las nuevas estimaciones de cardinalidad suponen que los predicados filtrados en tablas diferentes son independientes.</span><span class="sxs-lookup"><span data-stu-id="858e9-151">Example C. New cardinality estimates assume filtered predicates on different tables are independent</span></span>  
 <span data-ttu-id="858e9-152">En este ejemplo, el estimador de cardinalidad anterior supone que los filtros de predicado s.type y r.date están correlacionados.</span><span class="sxs-lookup"><span data-stu-id="858e9-152">For this example, the previous cardinality estimator assumes that the predicate filters s.type and r.date are correlated.</span></span> <span data-ttu-id="858e9-153">Sin embargo, los resultados de las pruebas en cargas de trabajo modernas mostraron que los filtros de predicados en columnas de tablas diferentes no suelen estar correlacionados entre sí.</span><span class="sxs-lookup"><span data-stu-id="858e9-153">However, test results on modern workloads showed that predicate filters on columns in different tables are usually not correlated with each other.</span></span>  
  
```  
SELECT s.ticket, s.customer, r.store FROM dbo.Sales AS s CROSS JOIN dbo.Returns AS r  
WHERE s.ticket = r.ticket AND s.type = 'toy' AND r.date = '2013-12-19';  
```  
  
 <span data-ttu-id="858e9-154">Este comportamiento ha cambiado.</span><span class="sxs-lookup"><span data-stu-id="858e9-154">This behavior has changed.</span></span> <span data-ttu-id="858e9-155">Ahora, la nueva lógica del estimador de cardinalidad supone que s.type no está correlacionado con r.date.</span><span class="sxs-lookup"><span data-stu-id="858e9-155">Now, the new cardinality estimator logic assumes that s.type is not correlated with r.date.</span></span> <span data-ttu-id="858e9-156">En la práctica, la suposición es que se devuelven juguetes todos los días y no solo un día determinado.</span><span class="sxs-lookup"><span data-stu-id="858e9-156">In practical terms, the assumption is that toys are returned every day and not only on a specific day.</span></span> <span data-ttu-id="858e9-157">En este caso, las nuevas estimaciones de cardinalidad serán un número menor que las estimaciones de cardinalidad anteriores.</span><span class="sxs-lookup"><span data-stu-id="858e9-157">In this case, the new cardinality estimates will be a smaller number than the previous cardinality estimates.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="858e9-158">Consulte también</span><span class="sxs-lookup"><span data-stu-id="858e9-158">See Also</span></span>  
 [<span data-ttu-id="858e9-159">Supervisión y optimización del rendimiento</span><span class="sxs-lookup"><span data-stu-id="858e9-159">Monitor and Tune for Performance</span></span>](monitor-and-tune-for-performance.md)  
  
  
