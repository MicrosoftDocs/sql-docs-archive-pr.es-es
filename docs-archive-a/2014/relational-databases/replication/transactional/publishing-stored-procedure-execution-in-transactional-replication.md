---
title: Publicación de la ejecución de procedimientos almacenados en la replicación transaccional | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publishing [SQL Server replication], stored procedure execution
- articles [SQL Server replication], stored procedures and
- transactional replication, publishing stored procedure execution
ms.assetid: f4686f6f-c224-4f07-a7cb-92f4dd483158
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0fb5c40db46772cabcb5d1df19e03aced749e1c6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/04/2020
ms.locfileid: "87748725"
---
# <a name="publishing-stored-procedure-execution-in-transactional-replication"></a><span data-ttu-id="68a95-102">Publicar la ejecución de procedimientos almacenados en la replicación transaccional</span><span class="sxs-lookup"><span data-stu-id="68a95-102">Publishing Stored Procedure Execution in Transactional Replication</span></span>
  <span data-ttu-id="68a95-103">Si tiene uno o más procedimientos almacenados que se ejecutan en el publicador y afectan a las tablas publicadas, considere la posibilidad de incluir esos procedimientos en la publicación como artículos de ejecución de procedimientos almacenados.</span><span class="sxs-lookup"><span data-stu-id="68a95-103">If you have one or more stored procedures that execute at the Publisher and affect published tables, consider including those stored procedures in your publication as stored procedure execution articles.</span></span> <span data-ttu-id="68a95-104">La definición del procedimiento (la instrucción CREATE PROCEDURE) se replica en el suscriptor cuando se inicializa la suscripción; cuando el procedimiento se ejecuta en el publicador, la replicación ejecuta el procedimiento correspondiente en el suscriptor.</span><span class="sxs-lookup"><span data-stu-id="68a95-104">The definition of the procedure (the CREATE PROCEDURE statement) is replicated to the Subscriber when the subscription is initialized; when the procedure is executed at the Publisher, replication executes the corresponding procedure at the Subscriber.</span></span> <span data-ttu-id="68a95-105">Esto puede proporcionar un rendimiento significativamente mejor en los casos en los que se llevan a cabo grandes operaciones por lotes, debido a que únicamente se replica la ejecución del procedimiento, evitando la necesidad de replicar los cambios individuales de cada fila.</span><span class="sxs-lookup"><span data-stu-id="68a95-105">This can provide significantly better performance for cases where large batch operations are performed, because only the procedure execution is replicated, bypassing the need to replicate the individual changes for each row.</span></span> <span data-ttu-id="68a95-106">Por ejemplo, supongamos que crea el siguiente procedimiento almacenado en la base de datos de publicaciones:</span><span class="sxs-lookup"><span data-stu-id="68a95-106">For example, assume you create the following stored procedure in the publication database:</span></span>  
  
```  
CREATE PROC give_raise AS  
UPDATE EMPLOYEES SET salary = salary * 1.10  
```  
  
 <span data-ttu-id="68a95-107">Este procedimiento aumenta el salario de los 10.000 empleados de la compañía en un 10 por ciento.</span><span class="sxs-lookup"><span data-stu-id="68a95-107">This procedure gives each of the 10,000 employees in your company a 10 percent pay increase.</span></span> <span data-ttu-id="68a95-108">Cuando ejecute este procedimiento almacenado en el publicador, actualizará el salario de todos los empleados.</span><span class="sxs-lookup"><span data-stu-id="68a95-108">When you execute this stored procedure at the Publisher, it updates the salary for each employee.</span></span> <span data-ttu-id="68a95-109">Sin la replicación de la ejecución del procedimiento almacenado, la actualización se envía a los suscriptores como una transacción de gran tamaño compuesta por varios pasos:</span><span class="sxs-lookup"><span data-stu-id="68a95-109">Without the replication of stored procedure execution, the update would be sent to Subscribers as a large, multi-step transaction:</span></span>  
  
```  
BEGIN TRAN  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 1'  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 2'  
```  
  
 <span data-ttu-id="68a95-110">Y esto se repite para 10.000 actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="68a95-110">And this repeats for 10,000 updates.</span></span>  
  
 <span data-ttu-id="68a95-111">Con la replicación de la ejecución del procedimiento almacenado, la replicación solo envía el comando para ejecutar el procedimiento almacenado en el suscriptor, en vez de tener que escribir todas las actualizaciones en la base de datos de distribución y enviarlas después a través de la red al suscriptor:</span><span class="sxs-lookup"><span data-stu-id="68a95-111">With the replication of stored procedure execution, replication sends only the command to execute the stored procedure at the Subscriber, rather than writing all the updates to the distribution database and then sending them over the network to the Subscriber:</span></span>  
  
```  
EXEC give_raise  
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="68a95-112">La replicación de procedimientos almacenados no es apropiada para todas las aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="68a95-112">Stored procedure replication is not appropriate for all applications.</span></span> <span data-ttu-id="68a95-113">Si se filtra un artículo de forma horizontal, de modo que existen conjuntos de filas diferentes en el publicador y en el suscriptor, la ejecución del mismo procedimiento almacenado en ambos produce resultados diferentes.</span><span class="sxs-lookup"><span data-stu-id="68a95-113">If an article is filtered horizontally, so that there are different sets of rows at the Publisher than at the Subscriber, executing the same stored procedure at both returns different results.</span></span> <span data-ttu-id="68a95-114">De forma similar, si una actualización se basa en una subconsulta de otra tabla no replicada, la ejecución del mismo procedimiento almacenado en ambos produce resultados diferentes.</span><span class="sxs-lookup"><span data-stu-id="68a95-114">Similarly, if an update is based on a subquery of another, nonreplicated table, executing the same stored procedure at both the Publisher and Subscriber returns different results.</span></span>  
  
 <span data-ttu-id="68a95-115">**Para publicar la ejecución de un procedimiento almacenado**</span><span class="sxs-lookup"><span data-stu-id="68a95-115">**To publish the execution of a stored procedure**</span></span>  
  
-   <span data-ttu-id="68a95-116">SQL Server Management Studio: [Publicar la ejecución de un procedimiento almacenado en una publicación transaccional &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span><span class="sxs-lookup"><span data-stu-id="68a95-116">SQL Server Management Studio: [Publish the Execution of a Stored Procedure in a Transactional Publication &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span></span>  
  
-   <span data-ttu-id="68a95-117">Programación de la replicación con Transact-SQL: ejecute [sp_addarticle &#40;&#41;de Transact-SQL](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) y especifique un valor de ' serializable proc exec ' (recomendado) o ' proc exec ' para el parámetro **@type** .</span><span class="sxs-lookup"><span data-stu-id="68a95-117">Replication Transact-SQL Programming: execute [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) and specify a value of 'serializable proc exec' (recommended) or 'proc exec' for the parameter **@type**.</span></span> <span data-ttu-id="68a95-118">Para obtener más información sobre la definición de artículos, vea [Definir un artículo](../publish/define-an-article.md).</span><span class="sxs-lookup"><span data-stu-id="68a95-118">For more information about defining articles, see [Define an Article](../publish/define-an-article.md).</span></span>  
  
## <a name="modifying-the-procedure-at-the-subscriber"></a><span data-ttu-id="68a95-119">Modificar el procedimiento en el suscriptor</span><span class="sxs-lookup"><span data-stu-id="68a95-119">Modifying the Procedure at the Subscriber</span></span>  
 <span data-ttu-id="68a95-120">De forma predeterminada, la definición del procedimiento almacenado del publicador se propaga a todos los suscriptores.</span><span class="sxs-lookup"><span data-stu-id="68a95-120">By default, the stored procedure definition at the Publisher is propagated to each Subscriber.</span></span> <span data-ttu-id="68a95-121">No obstante, también puede modificar el procedimiento almacenado en el suscriptor.</span><span class="sxs-lookup"><span data-stu-id="68a95-121">However, you can also modify the stored procedure at the Subscriber.</span></span> <span data-ttu-id="68a95-122">Esto es útil si desea ejecutar una lógica diferente en el publicador y en el suscriptor.</span><span class="sxs-lookup"><span data-stu-id="68a95-122">This is useful if you want different logic to be executed at the Publisher and Subscriber.</span></span> <span data-ttu-id="68a95-123">Por ejemplo, observe **sp_big_delete**, un procedimiento almacenado en el publicador que tiene dos funciones: elimina 1.000.000 de filas de la tabla replicada **big_table1** y actualiza la tabla no replicada **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="68a95-123">For example, consider **sp_big_delete**, a stored procedure at the Publisher that has two functions: it deletes 1,000,000 rows from the replicated table **big_table1** and updates the nonreplicated table **big_table2**.</span></span> <span data-ttu-id="68a95-124">Para reducir la demanda de recursos de red, debe propagar la eliminación del millón de filas como un procedimiento almacenado mediante la publicación de **sp_big_delete**.</span><span class="sxs-lookup"><span data-stu-id="68a95-124">To reduce the demand on network resources, you should propagate the 1 million row delete as a stored procedure by publishing **sp_big_delete**.</span></span> <span data-ttu-id="68a95-125">En el suscriptor, puede modificar **sp_big_delete** de forma que solamente elimine el millón de filas y no haga la posterior actualización de la tabla **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="68a95-125">At the Subscriber, you can modify **sp_big_delete** to delete only the 1 million rows and not perform the subsequent update to **big_table2**.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="68a95-126">De forma predeterminada, los cambios efectuados mediante ALTER PROCEDURE en el publicador se propagan al suscriptor.</span><span class="sxs-lookup"><span data-stu-id="68a95-126">By default, any changes made using ALTER PROCEDURE at the Publisher are propagated to the Subscriber.</span></span> <span data-ttu-id="68a95-127">Para evitarlo, deshabilite la propagación de los cambios de esquema antes de ejecutar ALTER PROCEDURE.</span><span class="sxs-lookup"><span data-stu-id="68a95-127">To prevent this, disable the propagation of schema changes before executing ALTER PROCEDURE.</span></span> <span data-ttu-id="68a95-128">Para obtener información sobre los cambios de esquema, vea [Realizar cambios de esquema en bases de datos de publicaciones](../publish/make-schema-changes-on-publication-databases.md).</span><span class="sxs-lookup"><span data-stu-id="68a95-128">For information about schema changes, see [Make Schema Changes on Publication Databases](../publish/make-schema-changes-on-publication-databases.md).</span></span>  
  
## <a name="types-of-stored-procedure-execution-articles"></a><span data-ttu-id="68a95-129">Tipos de artículos de ejecución de procedimientos almacenados</span><span class="sxs-lookup"><span data-stu-id="68a95-129">Types of Stored Procedure Execution Articles</span></span>  
 <span data-ttu-id="68a95-130">Hay dos maneras diferentes en las que se puede publicar la ejecución de un procedimiento almacenado: artículo de ejecución de procedimiento serializable y artículo de ejecución de procedimiento.</span><span class="sxs-lookup"><span data-stu-id="68a95-130">There are two different ways in which the execution of a stored procedure can be published: serializable procedure execution article and procedure execution article.</span></span>  
  
-   <span data-ttu-id="68a95-131">Se recomienda la opción serializable puesto que replica la ejecución del procedimiento solamente si éste se ejecuta dentro del contexto de una transacción serializable.</span><span class="sxs-lookup"><span data-stu-id="68a95-131">The serializable option is recommended because it replicates the procedure execution only if the procedure is executed within the context of a serializable transaction.</span></span> <span data-ttu-id="68a95-132">Si el procedimiento almacenado se ejecuta fuera de una transacción serializable, los cambios efectuados en los datos de las tablas publicadas se replican como una serie de instrucciones DML.</span><span class="sxs-lookup"><span data-stu-id="68a95-132">If the stored procedure is executed from outside a serializable transaction, changes to data in published tables are replicated as a series of DML statements.</span></span> <span data-ttu-id="68a95-133">Este comportamiento contribuye a hacer que los datos del suscriptor sean coherentes con los datos del publicador.</span><span class="sxs-lookup"><span data-stu-id="68a95-133">This behavior contributes to making data at the Subscriber consistent with data at the Publisher.</span></span> <span data-ttu-id="68a95-134">Esto es especialmente útil en operaciones por lotes, como grandes operaciones de limpieza.</span><span class="sxs-lookup"><span data-stu-id="68a95-134">This is especially useful for batch operations, such as large cleanup operations.</span></span>  
  
-   <span data-ttu-id="68a95-135">Con la opción de ejecución del procedimiento, es posible que la ejecución se pueda replicar en todos los suscriptores independientemente de que las instrucciones individuales del procedimiento almacenado se hayan ejecutado correctamente o no.</span><span class="sxs-lookup"><span data-stu-id="68a95-135">With the procedure execution option, it is possible that execution could be replicated to all Subscribers regardless of whether individual statements in the stored procedure were successful.</span></span> <span data-ttu-id="68a95-136">Además, como los cambios que el procedimiento almacenado efectúa en los datos pueden ocurrir en varias transacciones, los datos de los suscriptores podrían no ser coherentes con los del publicador.</span><span class="sxs-lookup"><span data-stu-id="68a95-136">Furthermore, because changes made to data by the stored procedure can occur within multiple transactions, data at the Subscribers might not be consistent with data at the Publisher.</span></span> <span data-ttu-id="68a95-137">Para resolver estos problemas, se requiere que los suscriptores sean de solo lectura y que se use un nivel de aislamiento mayor que READ UNCOMMITTED.</span><span class="sxs-lookup"><span data-stu-id="68a95-137">To address these issues, it is required that Subscribers are read-only and that you use an isolation level greater than read uncommitted.</span></span> <span data-ttu-id="68a95-138">Si utiliza READ UNCOMMITED, los cambios en los datos de las tablas publicadas se replican como una serie de instrucciones DML.</span><span class="sxs-lookup"><span data-stu-id="68a95-138">If you use read uncommitted, changes to data in published tables are replicated as a series of DML statements.</span></span>  
  
 <span data-ttu-id="68a95-139">En el siguiente ejemplo se ilustra por qué se recomienda configurar la replicación de procedimientos como artículos de procedimientos serializables.</span><span class="sxs-lookup"><span data-stu-id="68a95-139">The following example illustrates why it is recommended that you set up replication of procedures as serializable procedure articles.</span></span>  
  
```  
BEGIN TRANSACTION T1  
SELECT @var = max(col1) FROM tableA  
UPDATE tableA SET col2 = <value>   
   WHERE col1 = @var   
  
BEGIN TRANSACTION T2  
INSERT tableA VALUES <values>  
COMMIT TRANSACTION T2  
```  
  
 <span data-ttu-id="68a95-140">En el ejemplo anterior, se asume que la instrucción SELECT en la transacción T1 ocurre antes que la instrucción INSERT en la transacción T2.</span><span class="sxs-lookup"><span data-stu-id="68a95-140">In the previous example, it is assumed that the SELECT in transaction T1 happens before the INSERT in transaction T2.</span></span>  
  
 <span data-ttu-id="68a95-141">Si el proceso no se ejecuta en una transacción serializable (con el valor de nivel de aislamiento establecido en SERIALIZABLE), la transacción T2 podrá insertar una nueva fila en el intervalo de la instrucción SELECT en T1 y se confirmará antes que T1.</span><span class="sxs-lookup"><span data-stu-id="68a95-141">If the procedure is not executed within a serializable transaction (with isolation level set to SERIALIZABLE), transaction T2 will be allowed to insert a new row within the range of the SELECT statement in T1 and it will commit before T1.</span></span> <span data-ttu-id="68a95-142">Esto también quiere decir que se aplicará en el suscriptor antes que T1.</span><span class="sxs-lookup"><span data-stu-id="68a95-142">This also means that it will be applied at the Subscriber before T1.</span></span> <span data-ttu-id="68a95-143">Cuando se aplica T1 en el suscriptor, la instrucción SELECT puede devolver potencialmente un valor diferente que en el publicador y puede ofrecer un resultado distinto de UPDATE.</span><span class="sxs-lookup"><span data-stu-id="68a95-143">When T1 is applied at the Subscriber, the SELECT can potentially return a different value than at the Publisher and can result in a different outcome from the UPDATE.</span></span>  
  
 <span data-ttu-id="68a95-144">Si el procedimiento se ejecuta en una transacción serializable, la transacción T2 no podrá insertar en el intervalo que abarca la instrucción SELECT en T2.</span><span class="sxs-lookup"><span data-stu-id="68a95-144">If the procedure is executed within a serializable transaction, transaction T2 will not be allowed to insert within the range covered by the SELECT statement in T2.</span></span> <span data-ttu-id="68a95-145">Estará bloqueada hasta que T1 confirme que garantiza los mismos resultados en el suscriptor.</span><span class="sxs-lookup"><span data-stu-id="68a95-145">It will be blocked until T1 commits ensuring the same results at the Subscriber.</span></span>  
  
 <span data-ttu-id="68a95-146">Los bloqueos se mantendrán hasta que ejecute el procedimiento en una transacción serializable y puede dar como resultado una simultaneidad reducida.</span><span class="sxs-lookup"><span data-stu-id="68a95-146">Locks will be held longer when you execute the procedure within a serializable transaction and may result in reduced concurrency.</span></span>  
  
## <a name="the-xact_abort-setting"></a><span data-ttu-id="68a95-147">Configuración de XACT_ABORT</span><span class="sxs-lookup"><span data-stu-id="68a95-147">The XACT_ABORT Setting</span></span>  
 <span data-ttu-id="68a95-148">Al replicar la ejecución del procedimiento almacenado, la configuración de la sesión que ejecuta el procedimiento almacenado debe especificar XACT_ABORT ON.</span><span class="sxs-lookup"><span data-stu-id="68a95-148">When replicating stored procedure execution, the setting for the session executing the stored procedure should specify XACT_ABORT ON.</span></span> <span data-ttu-id="68a95-149">Si XACT_ABORT se establece en OFF, y se produce un error durante la ejecución del procedimiento en el publicador, el mismo error ocurrirá en el suscriptor y el Agente de distribución no funcionará.</span><span class="sxs-lookup"><span data-stu-id="68a95-149">If XACT_ABORT is set to OFF, and an error occurs during execution of the procedure at the Publisher, the same error will occur at the Subscriber, causing the Distribution Agent to fail.</span></span> <span data-ttu-id="68a95-150">Si se especifica XACT_ABORT ON, se garantiza que cualquier error que se produzca durante la ejecución en el publicador hará que toda la ejecución se revierta, con lo que se evita que se produzca un error en el Agente de distribución.</span><span class="sxs-lookup"><span data-stu-id="68a95-150">Specifying XACT_ABORT ON ensures that any errors encountered during execution at the Publisher cause the entire execution to be rolled back, avoiding the Distribution Agent failure.</span></span> <span data-ttu-id="68a95-151">Para obtener más información sobre la configuración de XACT_ABORT, vea [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="68a95-151">For more information about setting XACT_ABORT, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="68a95-152">Si necesita una configuración de XACT_ABORT OFF, especifique el parámetro **-SkipErrors** para el Agente de distribución.</span><span class="sxs-lookup"><span data-stu-id="68a95-152">If you require a setting of XACT_ABORT OFF, specify the **-SkipErrors** parameter for the Distribution Agent.</span></span> <span data-ttu-id="68a95-153">De esta forma permitirá que el agente continúe aplicando cambios en el suscriptor incluso si se produce un error.</span><span class="sxs-lookup"><span data-stu-id="68a95-153">This allows the agent to continue applying changes at the Subscriber even if an error is encountered.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="68a95-154">Consulte también</span><span class="sxs-lookup"><span data-stu-id="68a95-154">See Also</span></span>  
 [<span data-ttu-id="68a95-155">Article Options for Transactional Replication</span><span class="sxs-lookup"><span data-stu-id="68a95-155">Article Options for Transactional Replication</span></span>](article-options-for-transactional-replication.md)  
  
  
