---
title: Usar la función EVENTDATA | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- EVENTDATA function
- DDL triggers, EVENTDATA function
ms.assetid: 675b8320-9c73-4526-bd2f-91ba42c1b604
author: rothja
ms.author: jroth
ms.openlocfilehash: 57fb59a3954fb00ab943944c58cccd352c7270d2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/04/2020
ms.locfileid: "87676910"
---
# <a name="use-the-eventdata-function"></a><span data-ttu-id="d0c58-102">Usar la función EVENTDATA</span><span class="sxs-lookup"><span data-stu-id="d0c58-102">Use the EVENTDATA Function</span></span>
  <span data-ttu-id="d0c58-103">La información acerca de un evento que activa un desencadenador DDL se captura mediante la función EVENTDATA.</span><span class="sxs-lookup"><span data-stu-id="d0c58-103">Information about an event that fires a DDL trigger is captured by using the EVENTDATA function.</span></span> <span data-ttu-id="d0c58-104">Esta función devuelve un valor `xml`.</span><span class="sxs-lookup"><span data-stu-id="d0c58-104">This function returns an `xml` value.</span></span> <span data-ttu-id="d0c58-105">El esquema XML incluye información acerca de lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="d0c58-105">The XML schema includes information about the following:</span></span>  
  
-   <span data-ttu-id="d0c58-106">La hora del evento.</span><span class="sxs-lookup"><span data-stu-id="d0c58-106">The time of the event.</span></span>  
  
-   <span data-ttu-id="d0c58-107">El Id. de proceso del sistema (SPID) de la conexión en la cual se ha ejecutado el desencadenador.</span><span class="sxs-lookup"><span data-stu-id="d0c58-107">The System Process ID (SPID) of the connection when the trigger executed.</span></span>  
  
-   <span data-ttu-id="d0c58-108">El tipo de evento que ha activado el desencadenador.</span><span class="sxs-lookup"><span data-stu-id="d0c58-108">The type of event that fired the trigger.</span></span>  
  
 <span data-ttu-id="d0c58-109">En función del tipo de evento, el esquema incluirá información adicional, como la base de datos en la que se ha producido el evento, el objeto en el que se ha producido el evento y la instrucción [!INCLUDE[tsql](../../includes/tsql-md.md)] del evento.</span><span class="sxs-lookup"><span data-stu-id="d0c58-109">Depending on the event type, the schema then includes additional information such as the database in which the event occurred, the object against which the event occurred, and the [!INCLUDE[tsql](../../includes/tsql-md.md)] statement of the event.</span></span> <span data-ttu-id="d0c58-110">Para más información, consulte [DDL Triggers](ddl-triggers.md).</span><span class="sxs-lookup"><span data-stu-id="d0c58-110">For more information, see [DDL Triggers](ddl-triggers.md).</span></span>  
  
 <span data-ttu-id="d0c58-111">Por ejemplo, el siguiente desencadenador DDL se crea en la base de datos de ejemplo [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] :</span><span class="sxs-lookup"><span data-stu-id="d0c58-111">For example, the following DDL trigger is created in the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database:</span></span>  
  
```  
CREATE TRIGGER safety   
ON DATABASE   
FOR CREATE_TABLE   
AS   
    PRINT 'CREATE TABLE Issued.'  
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)')  
   RAISERROR ('New tables cannot be created in this database.', 16, 1)   
   ROLLBACK  
;  
```  
  
 <span data-ttu-id="d0c58-112">Se ejecutará la siguiente instrucción `CREATE TABLE` :</span><span class="sxs-lookup"><span data-stu-id="d0c58-112">The following `CREATE TABLE` statement is then run:</span></span>  
  
 `CREATE TABLE NewTable (Column1 int);`  
  
 <span data-ttu-id="d0c58-113">La instrucción `EVENTDATA()` del desencadenador DDL captura el texto de la instrucción `CREATE TABLE` que no se admite.</span><span class="sxs-lookup"><span data-stu-id="d0c58-113">The `EVENTDATA()` statement in the DDL trigger captures the text of the `CREATE TABLE` statement that is not allowed.</span></span> <span data-ttu-id="d0c58-114">Esto se logra mediante el uso de una instrucción XQuery en los `xml` datos generados por EVENTDATA y la recuperación del \<CommandText> elemento.</span><span class="sxs-lookup"><span data-stu-id="d0c58-114">This is achieved by using an XQuery statement against the `xml` data that is generated by EVENTDATA and retrieving the \<CommandText> element.</span></span> <span data-ttu-id="d0c58-115">Para obtener más información, vea [Referencia del lenguaje XQuery &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span><span class="sxs-lookup"><span data-stu-id="d0c58-115">For more information, see [XQuery Language Reference &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="d0c58-116">EVENTDATA captura los datos de los eventos CREATE_SCHEMA, así como el >schema_element< de la definición CREATE SCHEMA correspondiente, si existe.</span><span class="sxs-lookup"><span data-stu-id="d0c58-116">EVENTDATA captures the data of CREATE_SCHEMA events as well as the <schema_element> of the corresponding CREATE SCHEMA definition, if any exists.</span></span> <span data-ttu-id="d0c58-117">Además, EVENTDATA reconoce la definición <schema_element> como un evento aparte.</span><span class="sxs-lookup"><span data-stu-id="d0c58-117">Additionally, EVENTDATA recognizes the <schema_element> definition as a separate event.</span></span> <span data-ttu-id="d0c58-118">Por lo tanto, un desencadenador DDL creado en un evento CREATE_SCHEMA y en un evento representado por el <schema_element> de la definición CREATE SCHEMA, puede devolver los mismos datos de evento dos veces, por ejemplo, datos `TSQLCommand`.</span><span class="sxs-lookup"><span data-stu-id="d0c58-118">Therefore, a DDL trigger created on both a CREATE_SCHEMA event, and an event represented by the <schema_element> of the CREATE SCHEMA definition, may return the same event data twice, such as the `TSQLCommand` data.</span></span> <span data-ttu-id="d0c58-119">Por ejemplo, considere un desencadenador DDL creado en los eventos CREATE_SCHEMA y CREATE_TABLE, y que se ejecute el siguiente lote:</span><span class="sxs-lookup"><span data-stu-id="d0c58-119">For example, consider a DDL trigger that is created on both the CREATE_SCHEMA and CREATE_TABLE events and the following batch is run:</span></span>  
>   
>  `CREATE SCHEMA s`  
>   
>  `CREATE TABLE t1 (col1 int)`  
>   
>  <span data-ttu-id="d0c58-120">Si la aplicación recupera los datos de `TSQLCommand` del evento CREATE_TABLE, tenga en cuenta que estos datos pueden aparecer dos veces: una vez cuando tiene lugar el evento CREATE_SCHEMA, y otra cuando tiene lugar el evento CREATE_TABLE.</span><span class="sxs-lookup"><span data-stu-id="d0c58-120">If the application retrieves the `TSQLCommand` data of the CREATE_TABLE event, be aware that this data may appear two times: once when the CREATE_SCHEMA event occurs, and again when the CREATE_TABLE event occurs.</span></span> <span data-ttu-id="d0c58-121">Evite crear desencadenadores DDL en los eventos CREATE_SCHEMA y en los textos <schema_element> de cualquier definición CREATE SCHEMA correspondiente, o cree la lógica en su aplicación para que el mismo evento no se procese dos veces.</span><span class="sxs-lookup"><span data-stu-id="d0c58-121">Avoid creating DDL triggers on both the CREATE_SCHEMA events and the <schema_element> texts of any corresponding CREATE SCHEMA definitions, or build logic into your application so that the same event is not processed twice.</span></span>  
  
## <a name="alter-table-and-alter-database-events"></a><span data-ttu-id="d0c58-122">Eventos ALTER TABLE y ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="d0c58-122">ALTER TABLE and ALTER DATABASE Events</span></span>  
 <span data-ttu-id="d0c58-123">Los datos de evento para los eventos ALTER_TABLE y ALTER_DATABASE también incluyen los nombres y los tipos de otros objetos afectados por la instrucción DDL y la acción realizada en estos objetos.</span><span class="sxs-lookup"><span data-stu-id="d0c58-123">The event data for the ALTER_TABLE and ALTER_DATABASE events also includes the names and types of other objects affected by the DDL statement and the action performed on these objects.</span></span> <span data-ttu-id="d0c58-124">Los datos del evento ALTER_TABLE incluyen los nombres de las columnas, restricciones o desencadenadores afectados por la instrucción ALTER TABLE y la acción (crear, modificar, quitar, habilitar o deshabilitar) realizada en los objetos afectados.</span><span class="sxs-lookup"><span data-stu-id="d0c58-124">The ALTER_TABLE event data includes the names of the columns, constraints, or triggers affected by the ALTER TABLE statement and the action (create, alter, drop, enable, or disable) performed on the affected objects.</span></span> <span data-ttu-id="d0c58-125">Los datos del evento ALTER_DATABASE incluyen los nombres de los archivos o grupos de archivos afectados por la instrucción ALTER DATABASE y la acción (crear, modificar o quitar) realizada en los objetos afectados.</span><span class="sxs-lookup"><span data-stu-id="d0c58-125">The ALTER_DATABASE event data includes the names of any files or filegroups affected by the ALTER DATABASE statement and the action (create, alter, or drop) performed on the affected objects.</span></span>  
  
 <span data-ttu-id="d0c58-126">Por ejemplo, cree el siguiente desencadenador DDL en la base de datos de ejemplo AdventureWorks:</span><span class="sxs-lookup"><span data-stu-id="d0c58-126">For example, create the following DDL trigger in the AdventureWorks sample database:</span></span>  
  
```  
CREATE TRIGGER ColumnChanges  
ON DATABASE   
FOR ALTER_TABLE  
AS  
-- Detect whether a column was created/altered/dropped.  
SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]', 'nvarchar(max)')  
RAISERROR ('Table schema cannot be modified in this database.', 16, 1);  
ROLLBACK;  
```  
  
 <span data-ttu-id="d0c58-127">A continuación, ejecute la siguiente instrucción ALTER TABLE que infringe una restricción:</span><span class="sxs-lookup"><span data-stu-id="d0c58-127">Then execute the following ALTER TABLE statement that violates a constraint:</span></span>  
  
```  
ALTER TABLE Person.Address ALTER COLUMN ModifiedDate date;   
```  
  
 <span data-ttu-id="d0c58-128">La instrucción EVENTDATA() del desencadenador DDL captura el texto de la instrucción `ALTER TABLE` que no se permite.</span><span class="sxs-lookup"><span data-stu-id="d0c58-128">The EVENTDATA() statement in the DDL trigger captures the text of the `ALTER TABLE` statement that is not permitted.</span></span>  
  
## <a name="example"></a><span data-ttu-id="d0c58-129">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="d0c58-129">Example</span></span>  
 <span data-ttu-id="d0c58-130">Puede utilizar la función EVENTDATA para crear un registro de eventos.</span><span class="sxs-lookup"><span data-stu-id="d0c58-130">You can use the EVENTDATA function to create a log of events.</span></span> <span data-ttu-id="d0c58-131">En el siguiente ejemplo, una tabla se crea para almacenar la información del evento.</span><span class="sxs-lookup"><span data-stu-id="d0c58-131">In the following example, a table is created to store event information.</span></span> <span data-ttu-id="d0c58-132">A continuación, se crea un desencadenador DDL en la base de datos actual que rellena la tabla con la siguiente información siempre que tiene lugar un evento DDL en la base de datos:</span><span class="sxs-lookup"><span data-stu-id="d0c58-132">A DDL trigger is then created on the current database that populates the table with the following information whenever any database-level DDL event occurs:</span></span>  
  
-   <span data-ttu-id="d0c58-133">La hora del evento (mediante la función GETDATE).</span><span class="sxs-lookup"><span data-stu-id="d0c58-133">The time of the event (using the GETDATE function).</span></span>  
  
-   <span data-ttu-id="d0c58-134">El usuario de la base de datos contra cuya sesión se ha producido el evento (mediante la función CURRENT_USER).</span><span class="sxs-lookup"><span data-stu-id="d0c58-134">The database user against whose session the event occurred (using the CURRENT_USER function).</span></span>  
  
-   <span data-ttu-id="d0c58-135">El tipo de evento.</span><span class="sxs-lookup"><span data-stu-id="d0c58-135">The type of the event.</span></span>  
  
-   <span data-ttu-id="d0c58-136">La instrucción [!INCLUDE[tsql](../../includes/tsql-md.md)] que contenía el evento.</span><span class="sxs-lookup"><span data-stu-id="d0c58-136">The [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that comprised the event.</span></span>  
  
 <span data-ttu-id="d0c58-137">Una vez más, los dos últimos elementos se capturan mediante XQuery con los datos `xml` generados por EVENTDATA.</span><span class="sxs-lookup"><span data-stu-id="d0c58-137">Again, the last two items are captured by using XQuery against the `xml` data that is generated by EVENTDATA.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE TABLE ddl_log (PostTime datetime, DB_User nvarchar(100), Event nvarchar(100), TSQL nvarchar(2000));  
GO  
CREATE TRIGGER log   
ON DATABASE   
FOR DDL_DATABASE_LEVEL_EVENTS   
AS  
DECLARE @data XML  
SET @data = EVENTDATA()  
INSERT ddl_log   
   (PostTime, DB_User, Event, TSQL)   
   VALUES   
   (GETDATE(),   
   CONVERT(nvarchar(100), CURRENT_USER),   
   @data.value('(/EVENT_INSTANCE/EventType)[1]', 'nvarchar(100)'),   
   @data.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'nvarchar(2000)') ) ;  
GO  
--Test the trigger  
CREATE TABLE TestTable (a int)  
DROP TABLE TestTable ;  
GO  
SELECT * FROM ddl_log ;  
GO  
```  
  
> [!NOTE]  
>  <span data-ttu-id="d0c58-138">Para devolver datos de eventos, se recomienda usar el método XQuery `value()` en lugar del método `query()`.</span><span class="sxs-lookup"><span data-stu-id="d0c58-138">To return event data, we recommend that you use the XQuery `value()` method instead of the `query()` method.</span></span> <span data-ttu-id="d0c58-139">El método `query()` devuelve XML e instancias de retorno de carro y avance de línea (CRLF) con caracteres de escape de Y comercial en el resultado, mientras que en el método `value()` las instancias CRLF no están visibles en el resultado.</span><span class="sxs-lookup"><span data-stu-id="d0c58-139">The `query()` method returns XML and ampersand-escaped carriage return and line-feed (CRLF) instances in the output, while the `value()` method renders CRLF instances invisible in the output.</span></span>  
  
 <span data-ttu-id="d0c58-140">Un ejemplo de desencadenador DDL parecido se proporciona con la base de datos de ejemplo [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="d0c58-140">A similar DDL trigger example is provided with the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database.</span></span> <span data-ttu-id="d0c58-141">Para obtener el ejemplo, localice la carpeta Database Triggers mediante [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d0c58-141">To obtain the example, locate the Database Triggers folder by using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="d0c58-142">Esta carpeta se encuentra en la carpeta **Programación** de la base de datos [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="d0c58-142">This folder is located under the **Programmability** folder of the [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] database.</span></span> <span data-ttu-id="d0c58-143">Haga clic con el botón derecho en **ddlDatabaseTriggerLog** y seleccione **Script Database Trigger as** (desencadenador de base de datos de script como).</span><span class="sxs-lookup"><span data-stu-id="d0c58-143">Right-click **ddlDatabaseTriggerLog** and select **Script Database Trigger as**.</span></span> <span data-ttu-id="d0c58-144">De forma predeterminada, el desencadenador DDL **ddlDatabaseTriggerLog** está deshabilitado.</span><span class="sxs-lookup"><span data-stu-id="d0c58-144">By default, DDL trigger **ddlDatabaseTriggerLog** is disabled.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d0c58-145">Consulte también</span><span class="sxs-lookup"><span data-stu-id="d0c58-145">See Also</span></span>  
 <span data-ttu-id="d0c58-146">[Eventos DDL](../triggers/ddl-events.md) </span><span class="sxs-lookup"><span data-stu-id="d0c58-146">[DDL Events](../triggers/ddl-events.md) </span></span>  
 [<span data-ttu-id="d0c58-147">Grupos de eventos DDL</span><span class="sxs-lookup"><span data-stu-id="d0c58-147">DDL Event Groups</span></span>](../triggers/ddl-event-groups.md)  
  
  
