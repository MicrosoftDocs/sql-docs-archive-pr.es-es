---
title: Administrar y supervisar la captura de datos modificados (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data capture [SQL Server], monitoring
- change data capture [SQL Server], administering
- change data capture [SQL Server], jobs
ms.assetid: 23bda497-67b2-4e7b-8e4d-f1f9a2236685
author: rothja
ms.author: jroth
ms.openlocfilehash: 8d97929ead145d1b0de1a1f83becb15ade397683
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/04/2020
ms.locfileid: "87674682"
---
# <a name="administer-and-monitor-change-data-capture-sql-server"></a><span data-ttu-id="07c3c-102">Administrar y supervisar la captura de datos modificados (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="07c3c-102">Administer and Monitor Change Data Capture (SQL Server)</span></span>
  <span data-ttu-id="07c3c-103">En este tema se describe cómo administrar y supervisar la captura de datos modificados.</span><span class="sxs-lookup"><span data-stu-id="07c3c-103">This topic describes how to administer and monitor change data capture.</span></span>  
  
##  <a name="capture-job"></a><a name="Capture"></a> <span data-ttu-id="07c3c-104">Trabajo de captura</span><span class="sxs-lookup"><span data-stu-id="07c3c-104">Capture Job</span></span>  
 <span data-ttu-id="07c3c-105">El trabajo de captura se inicia ejecutando el procedimiento almacenado sin parámetros `sp_MScdc_capture_job`.</span><span class="sxs-lookup"><span data-stu-id="07c3c-105">The capture job is initiated by running the parameterless stored procedure `sp_MScdc_capture_job`.</span></span> <span data-ttu-id="07c3c-106">Este procedimiento almacenado empieza extrayendo los valores configurados para *maxtrans*, *maxscans*, *continuous*y *pollinginterval* para el trabajo de captura desde msdb.dbo.cdc_jobs.</span><span class="sxs-lookup"><span data-stu-id="07c3c-106">This stored procedure starts by extracting the configured values for *maxtrans*, *maxscans*, *continuous*, and *pollinginterval* for the capture job from msdb.dbo.cdc_jobs.</span></span> <span data-ttu-id="07c3c-107">A continuación, estos valores configurados se pasan como parámetros al procedimiento almacenado `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="07c3c-107">These configured values are then passed as parameters to the stored procedure `sp_cdc_scan`.</span></span> <span data-ttu-id="07c3c-108">Esto se utiliza para llamar a `sp_replcmds` con el fin de realizar el examen del registro.</span><span class="sxs-lookup"><span data-stu-id="07c3c-108">This is used to invoke `sp_replcmds` to perform the log scan.</span></span>  
  
### <a name="capture-job-parameters"></a><span data-ttu-id="07c3c-109">Parámetros de trabajo de captura</span><span class="sxs-lookup"><span data-stu-id="07c3c-109">Capture Job Parameters</span></span>  
 <span data-ttu-id="07c3c-110">Para entender el comportamiento del trabajo de captura, debe saber cómo `sp_cdc_scan` utiliza los parámetros configurables.</span><span class="sxs-lookup"><span data-stu-id="07c3c-110">To understand capture job behavior, you must understand how the configurable parameters are used by `sp_cdc_scan`.</span></span>  
  
#### <a name="maxtrans-parameter"></a><span data-ttu-id="07c3c-111">Parámetro maxtrans</span><span class="sxs-lookup"><span data-stu-id="07c3c-111">maxtrans Parameter</span></span>  
 <span data-ttu-id="07c3c-112">El parámetro *maxtrans* especifica el número máximo de transacciones que se pueden procesar en un único ciclo de examen del registro.</span><span class="sxs-lookup"><span data-stu-id="07c3c-112">The *maxtrans* parameter specifies the maximum number of transactions that can be processed in a single scan cycle of the log.</span></span> <span data-ttu-id="07c3c-113">Si, durante el examen, el número de transacciones que se van a procesar alcanza este límite, no se incluye ninguna transacción adicional en el examen actual.</span><span class="sxs-lookup"><span data-stu-id="07c3c-113">If, during the scan, the number of transactions to be processed reaches this limit, no additional transactions are included in the current scan.</span></span> <span data-ttu-id="07c3c-114">Cuando finaliza un ciclo de examen, el número de transacciones que se procesaron siempre será menor o igual que *maxtrans*.</span><span class="sxs-lookup"><span data-stu-id="07c3c-114">After a scan cycle is complete, the number of transactions that were processed will always be less than or equal to *maxtrans*.</span></span>  
  
#### <a name="maxscans-parameter"></a><span data-ttu-id="07c3c-115">Parámetro maxscans</span><span class="sxs-lookup"><span data-stu-id="07c3c-115">maxscans Parameter</span></span>  
 <span data-ttu-id="07c3c-116">El parámetro *maxscans* especifica el número máximo de ciclos de examen que se intentan para agotar el registro antes de devolver (continuous = 0) o ejecutar waitfor (continuous = 1).</span><span class="sxs-lookup"><span data-stu-id="07c3c-116">The *maxscans* parameter specifies the maximum number of scan cycles that are attempted to drain the log before either returning (continuous = 0) or executing a waitfor (continuous = 1).</span></span>  
  
#### <a name="continuous-parameter"></a><span data-ttu-id="07c3c-117">continuous (parámetro)</span><span class="sxs-lookup"><span data-stu-id="07c3c-117">continuous Parameter</span></span>  
 <span data-ttu-id="07c3c-118">El parámetro *Continuous* controla si `sp_cdc_scan` renuncia el control después de agotar el registro o de ejecutar el número máximo de ciclos de recorrido (modo de una instantánea).</span><span class="sxs-lookup"><span data-stu-id="07c3c-118">The *continuous* parameter controls whether `sp_cdc_scan` relinquishes control in after either draining the log or executing the maximum number of scan cycles (one shot mode).</span></span> <span data-ttu-id="07c3c-119">También controla si `sp_cdc_scan` continúa ejecutándose hasta detenerse explícitamente (modo continuo).</span><span class="sxs-lookup"><span data-stu-id="07c3c-119">It also controles whether `sp_cdc_scan` continues to run until explicitly stopped (continuous mode).</span></span>  
  
##### <a name="one-shot-mode"></a><span data-ttu-id="07c3c-120">Modo de una instantánea</span><span class="sxs-lookup"><span data-stu-id="07c3c-120">One Shot Mode</span></span>  
 <span data-ttu-id="07c3c-121">En el modo de una instantánea, el trabajo de captura solicita `sp_cdc_scan` realizar hasta *maxtrans* exámenes para intentar agotar el registro y volver.</span><span class="sxs-lookup"><span data-stu-id="07c3c-121">In one shot mode, the capture job requests `sp_cdc_scan` to perform up to *maxtrans* scans to try to drain the log and return.</span></span> <span data-ttu-id="07c3c-122">Cualquier transacción adicional a *maxtrans* que se encuentre en el registro se procesará en exámenes posteriores.</span><span class="sxs-lookup"><span data-stu-id="07c3c-122">Any transactions in addition to *maxtrans* that are present in the log will be processed in later scans.</span></span>  
  
 <span data-ttu-id="07c3c-123">El modo de una instantánea se utiliza en pruebas controladas, en las que se conoce el volumen de las transacciones que se van a procesar, y hay ventajas en el hecho de que el trabajo se cierra automáticamente en cuanto finaliza.</span><span class="sxs-lookup"><span data-stu-id="07c3c-123">One shot mode is used in controlled tests, where the volume of transactions to be processed is known, and there are advantages to the fact that the job closes automatically on when it is finished.</span></span> <span data-ttu-id="07c3c-124">Este modo no se recomienda para usarse en producción.</span><span class="sxs-lookup"><span data-stu-id="07c3c-124">One shot mode is not recommended for production use.</span></span> <span data-ttu-id="07c3c-125">Esto se debe a que se basa en la programación de trabajos para administrar la frecuencia con la que se ejecuta el ciclo de examen.</span><span class="sxs-lookup"><span data-stu-id="07c3c-125">This is because t relies on the job schedule to manage how frequently the scan cycle is run.</span></span>  
  
 <span data-ttu-id="07c3c-126">La ejecución en el modo de una instantánea permite calcular un límite superior en el rendimiento esperado del trabajo de captura, expresado en transacciones por segundo, mediante el cálculo siguiente:</span><span class="sxs-lookup"><span data-stu-id="07c3c-126">When running in one shot mode, you can compute an upper bound on expected throughput of the capture job, expressed in transactions per second by using the following computation:</span></span>  
  
 `(maxtrans * maxscans) / number of seconds between scans`  
  
 <span data-ttu-id="07c3c-127">Incluso si el tiempo que se necesitase para examinar el registro y rellenar las tablas de cambios no fuese significativamente diferente de 0, el rendimiento medio del trabajo podría no superar el valor obtenido dividiendo el resultado de multiplicar el número máximo de transacciones permitidas para un solo examen por el número máximo permitido de exámenes entre el número de segundos que separan el procesamiento de registros.</span><span class="sxs-lookup"><span data-stu-id="07c3c-127">Even if the time that is required to scan the log and populate the change tables were not significantly different from 0, the average throughput of the job could not exceed the value obtained by dividing the maximum allowed transactions for a single scan multiplied by the maximum allowed scans by the number of seconds separating log processing.</span></span>  
  
 <span data-ttu-id="07c3c-128">Si se fuera a usar el modo de una instantánea para regular el examen de registros, la programación del trabajo tendría que regir el número de segundos entre el procesamiento de registros.</span><span class="sxs-lookup"><span data-stu-id="07c3c-128">If one shot mode were to be used to regulate log scanning, the number of seconds between log processing would have to be governed by the job schedule.</span></span> <span data-ttu-id="07c3c-129">Cuando se desea este tipo de comportamiento, ejecutar el trabajo de captura en el modo continuo es el método mejor para administrar la reprogramación del examen de registros.</span><span class="sxs-lookup"><span data-stu-id="07c3c-129">When this kind of behavior is desired, running the capture job in continuous mode is a better way to manage rescheduling the log scan.</span></span>  
  
##### <a name="continuous-mode-and-the-polling-interval"></a><span data-ttu-id="07c3c-130">Modo continuo e intervalo de sondeo</span><span class="sxs-lookup"><span data-stu-id="07c3c-130">Continuous Mode and the Polling Interval</span></span>  
 <span data-ttu-id="07c3c-131">En el modo continuo, el trabajo de captura solicita que `sp_cdc_scan` se ejecute continuamente.</span><span class="sxs-lookup"><span data-stu-id="07c3c-131">In continuous mode, the capture job requests that `sp_cdc_scan` run continuously.</span></span> <span data-ttu-id="07c3c-132">Esto permite que el procedimiento almacenado administre su propio bucle de espera proporcionando no solo los valores de los parámetros maxtrans y maxscans sino también un valor para el número de segundos entre el procesamiento de registros (el intervalo de sondeo).</span><span class="sxs-lookup"><span data-stu-id="07c3c-132">This lets the stored procedure manage its own wait loop by providing not only for maxtrans and maxscans but also a value for the number of seconds between log processing (the polling interval).</span></span> <span data-ttu-id="07c3c-133">Al ejecutarse en este modo, el trabajo de captura sigue estando activo, ejecutando un `WAITFOR` entre el examen de registros.</span><span class="sxs-lookup"><span data-stu-id="07c3c-133">Running in this mode, the capture job remains active, executing a `WAITFOR` between log scanning.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="07c3c-134">Cuando el valor del intervalo de sondeo es mayor que 0, el mismo límite superior para el rendimiento del trabajo de una instantánea repetido se aplica también al funcionamiento del trabajo en el modo continuo.</span><span class="sxs-lookup"><span data-stu-id="07c3c-134">When the value of the polling interval is greater than 0, the same upper limit on throughput for the recurring one shot job also applies to the job operation in continuous mode.</span></span> <span data-ttu-id="07c3c-135">Es decir, (*maxtrans* \* *maxscans*) dividido entre un intervalo de sondeo distinto de cero impondrá un límite superior en el número medio de transacciones que pueden ser procesadas por el trabajo de captura.</span><span class="sxs-lookup"><span data-stu-id="07c3c-135">That is, (*maxtrans* \* *maxscans*) divided by a nonzero polling interval will put an upper bound on the average number of transactions that can be processed by the capture job.</span></span>  
  
### <a name="capture-job-customization"></a><span data-ttu-id="07c3c-136">Personalización del trabajo de captura</span><span class="sxs-lookup"><span data-stu-id="07c3c-136">Capture Job Customization</span></span>  
 <span data-ttu-id="07c3c-137">En el trabajo de captura se puede aplicar una lógica adicional para determinar si un examen nuevo comienza inmediatamente o si se impone una suspensión antes de iniciarse en lugar de basarse en un intervalo de sondeo fijo.</span><span class="sxs-lookup"><span data-stu-id="07c3c-137">For the capture job, you can apply additional logic to determine whether a new scan begins immediately or whether a sleep is imposed before it starts a new scan instead of rely on a fixed polling interval.</span></span> <span data-ttu-id="07c3c-138">La opción podría basarse simplemente en la hora del día, exigiendo quizás suspensiones muy largas durante las horas de actividad máxima, e incluso el paso a un intervalo de sondeo igual a 0 al final del día, cuando es importante completar el procesamiento de los días y preparar las ejecuciones nocturnas.</span><span class="sxs-lookup"><span data-stu-id="07c3c-138">The choice could be based merely on time of the day, perhaps enforcing very long sleeps during peak activity times, and even moving to a polling interval of 0 at close of day when it is important to complete the days processing and prepare for nightly runs.</span></span> <span data-ttu-id="07c3c-139">El progreso del proceso de captura también se puede supervisar para determinar el momento en que todas las transacciones confirmadas a media noche han sido examinadas y depositadas en las tablas de cambios.</span><span class="sxs-lookup"><span data-stu-id="07c3c-139">Capture process progress could also be monitored to determine when all transactions committed by mid-night had been scanned and deposited in change tables.</span></span> <span data-ttu-id="07c3c-140">Esto permite que el trabajo de captura finalice y se reinicie de la forma programada diariamente.</span><span class="sxs-lookup"><span data-stu-id="07c3c-140">This lets the capture job end, to be restarted by a scheduled daily restart.</span></span> <span data-ttu-id="07c3c-141">Al reemplazar el paso de trabajo entregado llamando a `sp_cdc_scan` con una llamada a un contenedor escrito por el usuario para `sp_cdc_scan`, se puede obtener un comportamiento muy personalizado con poco esfuerzo adicional.</span><span class="sxs-lookup"><span data-stu-id="07c3c-141">By replacing the delivered job step calling `sp_cdc_scan` with a call to a user written wrapper for `sp_cdc_scan`, highly customized behavior can be obtained with little additional effort.</span></span>  
  
##  <a name="cleanup-job"></a><a name="Cleanup"></a> <span data-ttu-id="07c3c-142">Trabajo de limpieza</span><span class="sxs-lookup"><span data-stu-id="07c3c-142">Cleanup Job</span></span>  
 <span data-ttu-id="07c3c-143">En esta sección se proporciona información sobre cómo funciona el trabajo de limpieza de la captura de datos modificados.</span><span class="sxs-lookup"><span data-stu-id="07c3c-143">This section provides information about how the change data capture cleanup job works.</span></span>  
  
### <a name="structure-of-the-cleanup-job"></a><span data-ttu-id="07c3c-144">Estructura del trabajo de limpieza</span><span class="sxs-lookup"><span data-stu-id="07c3c-144">Structure of the Cleanup Job</span></span>  
 <span data-ttu-id="07c3c-145">La captura de datos modificados utiliza una estrategia de limpieza basada en la retención para administrar el tamaño de la tabla de cambios.</span><span class="sxs-lookup"><span data-stu-id="07c3c-145">Change data capture uses a retention based cleanup strategy to manage change table size.</span></span> <span data-ttu-id="07c3c-146">El mecanismo de limpieza consta de un trabajo del Agente [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[tsql](../../includes/tsql-md.md)] que se crea cuando se habilita la primera tabla de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="07c3c-146">The cleanup mechanism consists of a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent [!INCLUDE[tsql](../../includes/tsql-md.md)] job that is created when the first database table is enabled.</span></span> <span data-ttu-id="07c3c-147">Un único trabajo de limpieza controla la limpieza para todas las tablas de cambios de base de datos y aplica el mismo valor de retención a todas las instancias de captura definidas.</span><span class="sxs-lookup"><span data-stu-id="07c3c-147">A single cleanup job handles cleanup for all database change tables and applies the same retention value to all defined capture instances.</span></span>  
  
 <span data-ttu-id="07c3c-148">El trabajo de limpieza se inicia ejecutando el procedimiento almacenado sin parámetros `sp_MScdc_cleanup_job`.</span><span class="sxs-lookup"><span data-stu-id="07c3c-148">The cleanup job is initiated by running the parameterless stored procedure `sp_MScdc_cleanup_job`.</span></span> <span data-ttu-id="07c3c-149">Este procedimiento almacenado comienza extrayendo los valores configurados para la retención y el umbral del trabajo de limpieza de `msdb.dbo.cdc_jobs`.</span><span class="sxs-lookup"><span data-stu-id="07c3c-149">This stored procedure starts by extracting the configured retention and threshold values for the cleanup job from `msdb.dbo.cdc_jobs`.</span></span> <span data-ttu-id="07c3c-150">El valor de retención se utiliza para calcular una nueva marca de límite inferior para las tablas de cambios.</span><span class="sxs-lookup"><span data-stu-id="07c3c-150">The retention value is used to compute a new low watermark for the change tables.</span></span> <span data-ttu-id="07c3c-151">El número especificado de minutos se resta del valor de *tran_end_time* máximo de la `cdc.lsn_time_mapping` tabla para obtener la nueva marca de límite inferior expresada como un valor de fecha y hora.</span><span class="sxs-lookup"><span data-stu-id="07c3c-151">The specified number of minutes is subtracted from the maximum *tran_end_time* value from the `cdc.lsn_time_mapping` table to obtain the new low water mark expressed as a datetime value.</span></span> <span data-ttu-id="07c3c-152">A continuación, la tabla CDC.lsn_time_mapping se utiliza para convertir este valor datetime en un valor de `lsn` correspondiente.</span><span class="sxs-lookup"><span data-stu-id="07c3c-152">The CDC.lsn_time_mapping table is then used to convert this datetime value to a corresponding `lsn` value.</span></span> <span data-ttu-id="07c3c-153">Si varias entradas comparten el mismo tiempo de confirmación en la tabla, el `lsn` que corresponde a la entrada que tiene el valor de `lsn` más bajo se elige como nueva marca de límite inferior.</span><span class="sxs-lookup"><span data-stu-id="07c3c-153">If the same commit time is shared by multiple entries in the table, the `lsn` that corresponds to the entry that has the smallest `lsn` is chosen as the new low watermark.</span></span> <span data-ttu-id="07c3c-154">Este valor de `lsn` se pasa al procedimiento `sp_cdc_cleanup_change_tables` para quitar las entradas de las tablas de cambios de base de datos.</span><span class="sxs-lookup"><span data-stu-id="07c3c-154">This `lsn` value is passed to `sp_cdc_cleanup_change_tables` to remove change table entries from the database change tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="07c3c-155">La ventaja de utilizar el tiempo de confirmación de la transacción reciente como base para calcular la nueva marca de límite inferior es que permite que los cambios permanezcan en las tablas de cambios durante el tiempo especificado.</span><span class="sxs-lookup"><span data-stu-id="07c3c-155">The advantage of using the commit time of the recent transaction as the base for computing the new low watermark is that it lets the changes remain in change tables for the specified time.</span></span> <span data-ttu-id="07c3c-156">Esto sucede incluso cuando el proceso de captura se ejecuta en segundo plano.</span><span class="sxs-lookup"><span data-stu-id="07c3c-156">This happens even when the capture process is running behind.</span></span> <span data-ttu-id="07c3c-157">Todas las entradas que tienen el mismo tiempo de confirmación que la marca de límite inferior actual continúan siendo representadas dentro de las tablas de cambios si se elige el valor de `lsn` más bajo que tenga el tiempo de confirmación compartido para la marca de límite inferior real.</span><span class="sxs-lookup"><span data-stu-id="07c3c-157">All entries that have the same commit time as the current low watermark continue to be represented within the change tables by choosing the smallest `lsn` that has the shared commit time for the actual low watermark.</span></span>  
  
 <span data-ttu-id="07c3c-158">Cuando se realiza una limpieza, la marca de límite inferior para todas las instancias de captura se actualiza inicialmente en una única transacción.</span><span class="sxs-lookup"><span data-stu-id="07c3c-158">When a cleanup is performed, the low watermark for all capture instances is initially updated in a single transaction.</span></span> <span data-ttu-id="07c3c-159">A continuación, intenta quitar las entradas obsoletas de las tablas de cambios y de la tabla cdc.lsn_time_mapping.</span><span class="sxs-lookup"><span data-stu-id="07c3c-159">It then tries to remove obsolete entries from the change tables and the cdc.lsn_time_mapping table.</span></span> <span data-ttu-id="07c3c-160">El valor de umbral configurable limita el número de entradas que se eliminan en una única instrucción.</span><span class="sxs-lookup"><span data-stu-id="07c3c-160">The configurable threshold value limits how many entries are deleted in any single statement.</span></span> <span data-ttu-id="07c3c-161">El que no se pueda realizar la eliminación en alguna tabla individual no impide que la operación se intente en las tablas restantes.</span><span class="sxs-lookup"><span data-stu-id="07c3c-161">Failure to perform the delete on any individual table will not prevent the operation from being attempted on the remaining tables.</span></span>  
  
### <a name="cleanup-job-customization"></a><span data-ttu-id="07c3c-162">Personalización del trabajo de limpieza</span><span class="sxs-lookup"><span data-stu-id="07c3c-162">Cleanup Job Customization</span></span>  
 <span data-ttu-id="07c3c-163">La posibilidad de personalización de los trabajos de limpieza radica en la estrategia que se usa para determinar qué entradas de la tabla de cambios se van a descartar.</span><span class="sxs-lookup"><span data-stu-id="07c3c-163">For the cleanup job, the possibility for customization is in the strategy used to determine which change table entries are to be discarded.</span></span> <span data-ttu-id="07c3c-164">La única estrategia admitida en el trabajo de limpieza entregado es la que se basa en el tiempo.</span><span class="sxs-lookup"><span data-stu-id="07c3c-164">The only supported strategy in the delivered cleanup job is a time-based one.</span></span> <span data-ttu-id="07c3c-165">En esa situación, la nueva marca de límite inferior se calcula restando el período de retención permitido del tiempo de confirmación de la última transacción procesada.</span><span class="sxs-lookup"><span data-stu-id="07c3c-165">In that situation, the new low watermark is computed by subtracting the allowed retention period from the commit time of the last transaction processed.</span></span> <span data-ttu-id="07c3c-166">Como los procedimientos de limpieza subyacentes se basan en `lsn` en lugar de en el tiempo, se puede usar cualquier cantidad de estrategias para determinar el valor `lsn` más bajo que se debe conservar en las tablas de cambios.</span><span class="sxs-lookup"><span data-stu-id="07c3c-166">Because the underlying cleanup procedures are based on `lsn` instead of time, any number of strategies can be used to determine the smallest `lsn` to keep in the change tables.</span></span> <span data-ttu-id="07c3c-167">Solo algunas se basan estrictamente en el tiempo.</span><span class="sxs-lookup"><span data-stu-id="07c3c-167">Only some of these are strictly time-based.</span></span> <span data-ttu-id="07c3c-168">Por ejemplo, el conocimiento sobre los clientes se puede utilizar para proporcionar un seguro si los procesos de niveles inferiores que requieren acceso a las tablas de cambios no se pueden ejecutar.</span><span class="sxs-lookup"><span data-stu-id="07c3c-168">Knowledge about the clients, for example, could be used to provide a failsafe if downstream processes that require access to the change tables cannot run.</span></span> <span data-ttu-id="07c3c-169">Además, aunque la estrategia predeterminada aplica el mismo `lsn` para limpiar las tablas de cambios de todas las bases de datos, también se puede llamar al procedimiento de limpieza subyacente para limpiar en el nivel de la instancia de captura.</span><span class="sxs-lookup"><span data-stu-id="07c3c-169">Also, although the default strategy applies the same `lsn` to clean up all the databases' change tables, the underlying cleanup procedure, can also be called to clean up at the capture instance level.</span></span>  
  
##  <a name="monitor-the-change-data-capture-process"></a><a name="Monitor"></a> <span data-ttu-id="07c3c-170">Supervisar el proceso de captura de datos modificados</span><span class="sxs-lookup"><span data-stu-id="07c3c-170">Monitor the Change Data Capture Process</span></span>  
 <span data-ttu-id="07c3c-171">Supervisar el proceso de captura de datos modificados permite determinar si los cambios se están escribiendo correctamente y con una latencia razonable en las tablas de cambios.</span><span class="sxs-lookup"><span data-stu-id="07c3c-171">Monitoring the change data capture process lets you determine if changes are being written correctly and with a reasonable latency to the change tables.</span></span> <span data-ttu-id="07c3c-172">La supervisión también puede ayudar a identificar los errores que puedan producirse.</span><span class="sxs-lookup"><span data-stu-id="07c3c-172">Monitoring can also help you to identify any errors that might occur.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="07c3c-173">incluye dos vistas de administración dinámica para ayudar a supervisar la captura de datos modificados: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) y [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span><span class="sxs-lookup"><span data-stu-id="07c3c-173">includes two dynamic management views to help you monitor change data capture: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) and [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span></span>  
  
### <a name="identify-sessions-with-empty-result-sets"></a><span data-ttu-id="07c3c-174">Identificar las sesiones con conjuntos de resultados vacíos</span><span class="sxs-lookup"><span data-stu-id="07c3c-174">Identify Sessions with Empty Result Sets</span></span>  
 <span data-ttu-id="07c3c-175">Cada fila de sys.dm_cdc_log_scan_sessions representa una sesión de examen del registro (excepto la fila con el identificador 0).</span><span class="sxs-lookup"><span data-stu-id="07c3c-175">Every row in sys.dm_cdc_log_scan_sessions represents a log scan session (except the row with an ID of 0).</span></span> <span data-ttu-id="07c3c-176">Una sesión de examen del registro es equivalente a una ejecución de [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="07c3c-176">A log scan session is equivalent to one execution of [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span></span> <span data-ttu-id="07c3c-177">Durante una sesión, el examen puede devolver los cambios o un resultado vacío.</span><span class="sxs-lookup"><span data-stu-id="07c3c-177">During a session, the scan can either return changes or return an empty result.</span></span> <span data-ttu-id="07c3c-178">Si el conjunto de resultados está vacío, la columna empty_scan_count de sys.dm_cdc_log_scan_sessions se establece en 1.</span><span class="sxs-lookup"><span data-stu-id="07c3c-178">If the result set is empty, the empty_scan_count column in sys.dm_cdc_log_scan_sessions is set to 1.</span></span> <span data-ttu-id="07c3c-179">Si hay conjuntos de resultados vacíos consecutivos, por ejemplo si el trabajo de captura se está ejecutando continuamente, el valor empty_scan_count de la última fila existente se incrementa.</span><span class="sxs-lookup"><span data-stu-id="07c3c-179">If there are consecutive empty result sets, such as if the capture job is running continuously, the empty_scan_count in the last existing row is incremented.</span></span> <span data-ttu-id="07c3c-180">Por ejemplo, si sys.dm_cdc_log_scan_sessions ya contiene 10 filas para los exámenes que devolvieron los cambios y hay seguidos cinco resultados vacíos, la vista contiene 11 filas.</span><span class="sxs-lookup"><span data-stu-id="07c3c-180">For example, if sys.dm_cdc_log_scan_sessions already contains 10 rows for scans that returned changes and there are five empty results in a row, the view contains 11 rows.</span></span> <span data-ttu-id="07c3c-181">La última fila tiene el valor 5 en la columna empty_scan_count.</span><span class="sxs-lookup"><span data-stu-id="07c3c-181">The last row has a value of 5 in the empty_scan_count column.</span></span> <span data-ttu-id="07c3c-182">Para determinar las sesiones que tenían un examen vacío, ejecute la consulta siguiente:</span><span class="sxs-lookup"><span data-stu-id="07c3c-182">To determine sessions that had an empty scan, run the following query:</span></span>  
  
```sql
SELECT * from sys.dm_cdc_log_scan_sessions where empty_scan_count <> 0
```
  
### <a name="determine-latency"></a><span data-ttu-id="07c3c-183">Determinar la latencia</span><span class="sxs-lookup"><span data-stu-id="07c3c-183">Determine Latency</span></span>  
 <span data-ttu-id="07c3c-184">La vista de administración sys.dm_cdc_log_scan_sessions incluye una columna que registra la latencia de cada sesión de captura.</span><span class="sxs-lookup"><span data-stu-id="07c3c-184">The sys.dm_cdc_log_scan_sessions management view includes a column that records the latency for each capture session.</span></span> <span data-ttu-id="07c3c-185">La latencia se define como el tiempo transcurrido entre que una transacción se confirma en una tabla de origen y la confirmación en la tabla de cambios de la última transacción capturada.</span><span class="sxs-lookup"><span data-stu-id="07c3c-185">Latency is defined as the elapsed time between a transaction being committed on a source table and the last captured transaction being committed on the change table.</span></span> <span data-ttu-id="07c3c-186">La columna de latencia solo se rellena para las sesiones activas.</span><span class="sxs-lookup"><span data-stu-id="07c3c-186">The latency column is populated only for active sessions.</span></span> <span data-ttu-id="07c3c-187">Para las sesiones con un valor mayor que 0 en la columna empty_scan_count, la columna de latencia se establece en 0.</span><span class="sxs-lookup"><span data-stu-id="07c3c-187">For sessions with a value greater than 0 in the empty_scan_count column, the latency column is set to 0.</span></span> <span data-ttu-id="07c3c-188">La consulta siguiente devuelve la latencia promedio para las sesiones más recientes:</span><span class="sxs-lookup"><span data-stu-id="07c3c-188">The following query returns the average latency for the most recent sessions:</span></span>  
  
```sql
SELECT latency FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
 <span data-ttu-id="07c3c-189">Puede utilizar los datos de la latencia para determinar la rapidez o lentitud con que el proceso de captura procesa las transacciones.</span><span class="sxs-lookup"><span data-stu-id="07c3c-189">You can use latency data to determine how fast or slow the capture process is processing transactions.</span></span> <span data-ttu-id="07c3c-190">Estos datos son muy útiles cuando el proceso de captura se está ejecutando continuamente.</span><span class="sxs-lookup"><span data-stu-id="07c3c-190">This data is most useful when the capture process is running continuously.</span></span> <span data-ttu-id="07c3c-191">Si el proceso de captura se ejecuta según una programación, la latencia puede ser alta debido a la diferencia temporal entre las transacciones que se confirman en la tabla de origen y el proceso de captura que se ejecuta en su momento programado.</span><span class="sxs-lookup"><span data-stu-id="07c3c-191">If the capture process is running on a schedule, latency can be high because of the lag between transactions being committed on the source table and the capture process running at its scheduled time.</span></span>  
  
 <span data-ttu-id="07c3c-192">Otra medida importante de la eficacia del proceso de captura es el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="07c3c-192">Another important measure of capture process efficiency is throughput.</span></span> <span data-ttu-id="07c3c-193">Se trata del número promedio de comandos por segundo que se procesan durante cada sesión.</span><span class="sxs-lookup"><span data-stu-id="07c3c-193">This is the average number of commands per second that are processed during each session.</span></span> <span data-ttu-id="07c3c-194">Para determinar el rendimiento de una sesión, divida el valor de la columna command_count por el valor de la columna de duración.</span><span class="sxs-lookup"><span data-stu-id="07c3c-194">To determine the throughput of a session, divide the value in the command_count column by the value in the duration column.</span></span> <span data-ttu-id="07c3c-195">La consulta siguiente devuelve el rendimiento promedio para las sesiones más recientes:</span><span class="sxs-lookup"><span data-stu-id="07c3c-195">The following query returns the average throughput for the most recent sessions:</span></span>  
  
```sql
SELECT command_count/duration AS [Throughput] FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
### <a name="use-data-collector-to-collect-sampling-data"></a><span data-ttu-id="07c3c-196">Usar el recopilador de datos para recopilar datos de muestreo</span><span class="sxs-lookup"><span data-stu-id="07c3c-196">Use Data Collector to Collect Sampling Data</span></span>  
 <span data-ttu-id="07c3c-197">El recopilador de datos de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permite reunir instantáneas de datos de cualquier tabla o vista de administración dinámica y generar un almacenamiento de datos de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="07c3c-197">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data collector lets you collect snapshots of data from any table or dynamic management view and build a performance data warehouse.</span></span> <span data-ttu-id="07c3c-198">Cuando la captura de datos modificados está habilitada en una base de datos, es útil tomar instantáneas de las vistas sys.dm_cdc_log_scan_sessions y sys.dm_cdc_errors a intervalos regulares para analizarlas posteriormente.</span><span class="sxs-lookup"><span data-stu-id="07c3c-198">When change data capture is enabled on a database, it is useful to take snapshots of the sys.dm_cdc_log_scan_sessions view and the sys.dm_cdc_errors view at regular intervals for later analysis.</span></span> <span data-ttu-id="07c3c-199">El procedimiento siguiente configura un recopilador de datos para reunir datos de muestra de la vista de administración sys.dm_cdc_log_scan_sessions.</span><span class="sxs-lookup"><span data-stu-id="07c3c-199">The following procedure sets up a data collector for collecting sample data from the sys.dm_cdc_log_scan_sessions management view.</span></span>  
  
 <span data-ttu-id="07c3c-200">**Configuración de la recopilación de datos**</span><span class="sxs-lookup"><span data-stu-id="07c3c-200">**Configuring Data Collection**</span></span>  
  
1.  <span data-ttu-id="07c3c-201">Habilite el recopilador de datos y configure un almacén de administración de datos.</span><span class="sxs-lookup"><span data-stu-id="07c3c-201">Enable data collector and configure a management data warehouse.</span></span> <span data-ttu-id="07c3c-202">Para obtener más información, vea [Administrar la recopilación de datos](../data-collection/data-collection.md).</span><span class="sxs-lookup"><span data-stu-id="07c3c-202">For more information, see [Manage Data Collection](../data-collection/data-collection.md).</span></span>  
  
2.  <span data-ttu-id="07c3c-203">Ejecute el código siguiente para crear un recopilador personalizado para la captura de datos modificados.</span><span class="sxs-lookup"><span data-stu-id="07c3c-203">Execute the following code to create a custom collector for change data capture.</span></span>  
  
    ```sql  
    USE msdb;  
  
    DECLARE @schedule_uid uniqueidentifier;  
  
    -- Collect and upload data every 5 minutes  
    SELECT @schedule_uid = (  
    SELECT schedule_uid from sysschedules_localserver_view   
    WHERE name = N'CollectorSchedule_Every_5min')  
  
    DECLARE @collection_set_id int;  
  
    EXEC dbo.sp_syscollector_create_collection_set  
    @name = N' CDC Performance Data Collector',  
    @schedule_uid = @schedule_uid,          
    @collection_mode = 0,                   
    @days_until_expiration = 30,                
    @description = N'This collection set collects CDC metadata',  
    @collection_set_id = @collection_set_id output;  
  
    -- Create a collection item using statistics from   
    -- the change data capture dynamic management view.  
    DECLARE @parameters xml;  
    DECLARE @collection_item_id int;  
  
    SELECT @parameters = CONVERT(xml,   
        N'<TSQLQueryCollector>  
            <Query>  
              <Value>SELECT * FROM sys.dm_cdc_log_scan_sessions</Value>  
              <OutputTable>cdc_log_scan_data</OutputTable>  
            </Query>  
          </TSQLQueryCollector>');  
  
    EXEC dbo.sp_syscollector_create_collection_item  
    @collection_set_id = @collection_set_id,  
    @collector_type_uid = N'302E93D1-3424-4BE7-AA8E-84813ECF2419',  
    @name = ' CDC Performance Data Collector',  
    @frequency = 5,   
    @parameters = @parameters,  
    @collection_item_id = @collection_item_id output;  
  
    GO  
    ```  
  
3.  <span data-ttu-id="07c3c-204">En [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], expanda **Administración**y, a continuación, expanda **Recopilación de datos**.</span><span class="sxs-lookup"><span data-stu-id="07c3c-204">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], expand **Management**, and then expand **Data Collection**.</span></span> <span data-ttu-id="07c3c-205">Haga clic con el botón secundario en **Recopilador de datos de rendimiento de CDC**y, a continuación, haga clic en **Iniciar conjunto de recopilación de datos**.</span><span class="sxs-lookup"><span data-stu-id="07c3c-205">Right click **CDC Performance Data Collector**, and then click **Start Data Collection Set**.</span></span>  
  
4.  <span data-ttu-id="07c3c-206">En el almacenamiento de datos que configuró en el paso 1, busque la tabla custom_snapshots.cdc_log_scan_data.</span><span class="sxs-lookup"><span data-stu-id="07c3c-206">In the data warehouse you configured in step 1, locate the table custom_snapshots.cdc_log_scan_data.</span></span> <span data-ttu-id="07c3c-207">En esta tabla se proporciona una instantánea histórica de los datos de las sesiones de examen del registro.</span><span class="sxs-lookup"><span data-stu-id="07c3c-207">This table provides a historical snapshot of data from log scan sessions.</span></span> <span data-ttu-id="07c3c-208">Estos datos se pueden utilizar para analizar la latencia, el rendimiento y otras medidas de rendimiento a lo largo del tiempo.</span><span class="sxs-lookup"><span data-stu-id="07c3c-208">This data can be used to analyze latency, throughput, and other performance measures over time.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="07c3c-209">Consulte también</span><span class="sxs-lookup"><span data-stu-id="07c3c-209">See Also</span></span>  
 <span data-ttu-id="07c3c-210">[Seguimiento de cambios de datos &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="07c3c-210">[Track Data Changes &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span></span>  
 <span data-ttu-id="07c3c-211">[Acerca de la captura de datos modificados &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="07c3c-211">[About Change Data Capture &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="07c3c-212">[Habilitar y deshabilitar la captura de datos modificados &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="07c3c-212">[Enable and Disable Change Data Capture &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span></span>  
 [<span data-ttu-id="07c3c-213">Trabajar con datos modificados &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="07c3c-213">Work with Change Data &#40;SQL Server&#41;</span></span>](work-with-change-data-sql-server.md)  
  
  
